import{Vec3 as e,TreeItem as t,Color as s,Plane as a,Camera as r,Disc as i,LDRImage as o,Label as n,Material as h,GeomItem as _,Xfo as l,VideoStreamImage2D as m,Cuboid as c,Lines as d,Quat as u,BaseItem as f,Registry as g}from"../../zea-engine/dist/index.esm.js";import{UndoRedoManager as p,SelectionManager as v}from"../../zea-ux/dist/index.rawimport.js";function I(){}function w(){w.init.call(this)}function C(e){return void 0===e._maxListeners?w.defaultMaxListeners:e._maxListeners}function y(e,t,s){if(t)e.call(s);else for(var a=e.length,r=O(e,a),i=0;i<a;++i)r[i].call(s)}function P(e,t,s,a){if(t)e.call(s,a);else for(var r=e.length,i=O(e,r),o=0;o<r;++o)i[o].call(s,a)}function R(e,t,s,a,r){if(t)e.call(s,a,r);else for(var i=e.length,o=O(e,i),n=0;n<i;++n)o[n].call(s,a,r)}function b(e,t,s,a,r,i){if(t)e.call(s,a,r,i);else for(var o=e.length,n=O(e,o),h=0;h<o;++h)n[h].call(s,a,r,i)}function D(e,t,s,a){if(t)e.apply(s,a);else for(var r=e.length,i=O(e,r),o=0;o<r;++o)i[o].apply(s,a)}function A(e,t,s,a){var r,i,o,n;if("function"!=typeof s)throw new TypeError('"listener" argument must be a function');if((i=e._events)?(i.newListener&&(e.emit("newListener",t,s.listener?s.listener:s),i=e._events),o=i[t]):(i=e._events=new I,e._eventsCount=0),o){if("function"==typeof o?o=i[t]=a?[s,o]:[o,s]:a?o.unshift(s):o.push(s),!o.warned&&(r=C(e))&&r>0&&o.length>r){o.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=e,h.type=t,h.count=o.length,n=h,"function"==typeof console.warn?console.warn(n):console.log(n)}}else o=i[t]=s,++e._eventsCount;return e}function E(e,t,s){var a=!1;function r(){e.removeListener(t,r),a||(a=!0,s.apply(e,arguments))}return r.listener=s,r}function M(e){var t=this._events;if(t){var s=t[e];if("function"==typeof s)return 1;if(s)return s.length}return 0}function O(e,t){for(var s=new Array(t);t--;)s[t]=e[t];return s}I.prototype=Object.create(null),w.EventEmitter=w,w.usingDomains=!1,w.prototype.domain=void 0,w.prototype._events=void 0,w.prototype._maxListeners=void 0,w.defaultMaxListeners=10,w.init=function(){this.domain=null,w.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new I,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},w.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},w.prototype.getMaxListeners=function(){return C(this)},w.prototype.emit=function(e){var t,s,a,r,i,o,n,h="error"===e;if(o=this._events)h=h&&null==o.error;else if(!h)return!1;if(n=this.domain,h){if(t=arguments[1],!n){if(t instanceof Error)throw t;var _=new Error('Uncaught, unspecified "error" event. ('+t+")");throw _.context=t,_}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=n,t.domainThrown=!1,n.emit("error",t),!1}if(!(s=o[e]))return!1;var l="function"==typeof s;switch(a=arguments.length){case 1:y(s,l,this);break;case 2:P(s,l,this,arguments[1]);break;case 3:R(s,l,this,arguments[1],arguments[2]);break;case 4:b(s,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(r=new Array(a-1),i=1;i<a;i++)r[i-1]=arguments[i];D(s,l,this,r)}return!0},w.prototype.addListener=function(e,t){return A(this,e,t,!1)},w.prototype.on=w.prototype.addListener,w.prototype.prependListener=function(e,t){return A(this,e,t,!0)},w.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,E(this,e,t)),this},w.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,E(this,e,t)),this},w.prototype.removeListener=function(e,t){var s,a,r,i,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(a=this._events))return this;if(!(s=a[e]))return this;if(s===t||s.listener&&s.listener===t)0==--this._eventsCount?this._events=new I:(delete a[e],a.removeListener&&this.emit("removeListener",e,s.listener||t));else if("function"!=typeof s){for(r=-1,i=s.length;i-- >0;)if(s[i]===t||s[i].listener&&s[i].listener===t){o=s[i].listener,r=i;break}if(r<0)return this;if(1===s.length){if(s[0]=void 0,0==--this._eventsCount)return this._events=new I,this;delete a[e]}else!function(e,t){for(var s=t,a=s+1,r=e.length;a<r;s+=1,a+=1)e[s]=e[a];e.pop()}(s,r);a.removeListener&&this.emit("removeListener",e,o||t)}return this},w.prototype.removeAllListeners=function(e){var t,s;if(!(s=this._events))return this;if(!s.removeListener)return 0===arguments.length?(this._events=new I,this._eventsCount=0):s[e]&&(0==--this._eventsCount?this._events=new I:delete s[e]),this;if(0===arguments.length){for(var a,r=Object.keys(s),i=0;i<r.length;++i)"removeListener"!==(a=r[i])&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=new I,this._eventsCount=0,this}if("function"==typeof(t=s[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},w.prototype.listeners=function(e){var t,s=this._events;return s&&(t=s[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),s=0;s<t.length;++s)t[s]=e[s].listener||e[s];return t}(t):[]},w.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):M.call(e,t)},w.prototype.listenerCount=M,w.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var S=w.EventEmitter;const U=globalThis.debug?debug("zea-collab"):function(){const e=new URLSearchParams(window.location.search).has("zea-collab");return t=>{e&&console.log(t)}}(),T={JOIN_ROOM:"join-room",PING_ROOM:"ping-room",LEAVE_ROOM:"leave-room"};class X{constructor(e,t){this.userData=e,this.socketUrl=t,this.users={},this.userStreams={},this.callbacks={},this.envIsBrowser="undefined"!=typeof window}stopCamera(e=!0){this.stream&&(this.stream.getVideoTracks()[0].enabled=!1,e&&this.pub(X.actions.USER_VIDEO_STOPPED,{}))}startCamera(e=!0){this.stream&&(this.stream.getVideoTracks()[0].enabled=!0,e&&this.pub(X.actions.USER_VIDEO_STARTED,{}))}muteAudio(e=!0){this.stream&&(this.stream.getAudioTracks()[0].enabled=!1,e&&this.pub(X.actions.USER_AUDIO_STOPPED,{}))}unmuteAudio(e=!0){this.stream&&(this.stream.getAudioTracks()[0].enabled=!0,e&&this.pub(X.actions.USER_AUDIO_STARTED,{}))}getVideoStream(e){return this.userStreams[e]}setVideoStream(e,t){if(this.userStreams[t])return;const s=document.createElement("video");s.srcObject=e,this.userStreams[t]=s,s.onloadedmetadata=()=>{s.play()},document.body.appendChild(s)}isJoiningTheSameRoom(e){return this.roomId===e}joinRoom(e){this.roomId=e,this.leaveRoom(),this.socket=io(this.socketUrl,{"sync disconnect on unload":!0,query:`userId=${this.userData.id}&roomId=${this.roomId}`}),function(e){var t=(e||S).prototype.emit;function s(e){var s=e.data||[];return null!=e.id&&s.push(this.ack(e.id)),t.call(this,"*",e),t.apply(this,s)}return function(e,t){return e.onevent!==s&&(e.onevent=s),t?t():null}}(io.Manager)(this.socket),this.socket.on("*",e=>{const[t,s]=e.data;t in T||this._emit(t,s.payload,s.userId)}),this.envIsBrowser&&window.addEventListener("beforeunload",()=>{this.leaveRoom()}),this.pub(T.JOIN_ROOM),this.socket.on(T.JOIN_ROOM,e=>{U(`${T.JOIN_ROOM}:\n%O`,e),this.pub(T.PING_ROOM);const t=e.userData;this._addUserIfNew(t)}),this.socket.on(T.LEAVE_ROOM,e=>{U(`${T.LEAVE_ROOM}:\n%O`,e);const t=e.userData,s=t.id;if(s in this.users)return delete this.users[s],void this._emit(X.actions.USER_LEFT,t);U("Outgoing user was not found in room.")}),this.socket.on(T.PING_ROOM,e=>{U(`${T.PING_ROOM}:\n%O`,e);const t=e.userData;this._addUserIfNew(t)})}_prepareMediaStream(){return this.__streamPromise||(this.__streamPromise=new window.Promise((e,t)=>{this.stream?e():navigator.mediaDevices.getUserMedia({audio:!0,video:{width:400,height:300}}).then(t=>{this.stream=t,this.stopCamera(!1),this.muteAudio(!1),e()}).catch(e=>{t(e)})})),this.__streamPromise}leaveRoom(){this._emit(X.actions.LEFT_ROOM),this.users={},this.socket&&this.pub(T.LEAVE_ROOM,void 0,()=>{this.socket.close()})}_addUserIfNew(e){e.id in this.users||(this.users[e.id]=e,this._emit(X.actions.USER_JOINED,e))}getUsers(){return this.users}getUser(e){return this.users[e]}pub(e,t,s){if(!e)throw new Error("Missing messageType");this.socket.emit(e,{userData:this.userData,userId:this.userData.id,payload:t},s)}_emit(e,t,s){if(s&&!this.users[s])return void U(`Ignoring message for user not in session: ${e}. User id: ${s}`);const a=this.callbacks[e];a&&a.forEach(e=>e(t,s))}sub(e,t){if(!e)throw new Error("Missing messageType");if(!t)throw new Error("Missing callback");this.callbacks[e];this.callbacks[e]=this.callbacks[e]||[],this.callbacks[e].push(t);return()=>{this.callbacks[e].splice(this.callbacks[e].indexOf(t),1)}}}X.actions={USER_JOINED:"user-joined",USER_VIDEO_STARTED:"user-video-started",USER_VIDEO_STOPPED:"user-video-stopped",USER_AUDIO_STARTED:"user-audio-started",USER_AUDIO_STOPPED:"user-audio-stopped",USER_LEFT:"user-left",LEFT_ROOM:"left-room",TEXT_MESSAGE:"text-message",COMMAND_ADDED:"command-added",COMMAND_UPDATED:"command-updated",FILE_WITH_PROGRESS:"file-with-progress"};class L{static setSocketURL(e){this.socketUrl=e}static getInstance(e,t,s,a){if(!this.session){if(!this.socketUrl)throw new Error("Missing #socketUrl. Call #setSocketURL first.");this.session=new X(e,this.socketUrl)}return this.session.isJoiningTheSameRoom(t,s,a)||this.session.joinRoom(t,s,a),this.session}static getCurrentSession(){return this.session}}class V{constructor(e){this.session=e;{const e=["https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png"],t={};let s,a,r,i=!1;this.__startRecording=()=>{if(i)return;i=!0;const o=(n=e.length,Math.floor(Math.random()*Math.floor(n)));var n;s={id:"_"+Math.random().toString(36).substr(2,9),picture:e[o],name:"Presenter"+Object.keys(t).length},r=[];let h={messageType:"user-joined",payload:s},_=performance.now();a=this.session.pub,this.session.pub=(e,t)=>{const s=performance.now();h.ms=s-_,r.push(h),h={messageType:e,payload:t},_=s,a.call(this.session,e,t)}},this.__stopRecording=()=>{r.push({messageType:"user-left",payload:s}),t[s.id]=r,this.session.pub=a,this.__playRecording(t)}}}startRecording(){this.__startRecording()}stopRecording(){this.__stopRecording()}__stopPlayback(){for(let e in this.__timeoutIds)clearTimeout(this.__timeoutIds[e]);this.__timeoutIds={}}__play(e,t,s){let a=0;const r=()=>{const i=t[a];this.session._emit(i.messageType,i.payload,e),a++,a<t.length?this.__timeoutIds[e]=setTimeout(r,i.ms):s()};this.__timeoutIds[e]=setTimeout(r,1e3)}__playRecording(e){this.__stopPlayback();let t=0;this.__timeoutIds={};for(let s in e)t++,this.__play(s,e[s],()=>{t--,0==t&&this.__playRecording(e)})}downloadAndPlayRecording(e){this.__recordings[name];fetch(new Request(e)).then(e=>{if(!e.ok)throw new Error("404 Error: File not found.");e.json().then(e=>{this.__playRecording(e)})})}}const G=new e(0,0,1);class k{constructor(m,c,d=!1){if(this.__appData=m,this.__userData=c,this.__currentUserAvatar=d,this.__treeItem=new t(this.__userData.id),this.__appData.renderer.addTreeItem(this.__treeItem),this.__avatarColor=new s(c.color||"#0000ff"),this.__hilightPointerColor=this.__avatarColor,this.__plane=new a(1,1),this.__uiGeomIndex=-1,!this.__currentUserAvatar){let t;this.__camera=new r,this.__cameraBound=!1;let a=new i(.5,64);if(this.__userData.picture&&""!=this.__userData.picture)t=new o("user"+this.__userData.id+"AvatarImage"),t.setImageURL(this.__userData.picture);else{const e=this.__userData.name||this.__userData.given_name||"",s=this.__userData.lastName||this.__userData.family_name||"";t=new n("Name"),t.getParameter("BackgroundColor").setValue(this.__avatarColor),t.getParameter("FontSize").setValue(42),t.getParameter("BorderRadius").setValue(0),t.getParameter("BorderWidth").setValue(0),t.getParameter("Margin").setValue(12),t.getParameter("StrokeBackgroundOutline").setValue(!1),t.getParameter("Text").setValue(`${e.charAt(0)}${s.charAt(0)}`),t.on("labelRendered",e=>{this.__avatarImageXfo.sc.set(.15,.15,1),this.__avatarImageGeomItem.setLocalXfo(this.__avatarImageXfo)})}const m=new h("user"+this.__userData.id+"AvatarImageMaterial","FlatSurfaceShader");m.getParameter("BaseColor").setValue(this.__avatarColor),m.getParameter("BaseColor").setImage(t),m.visibleInGeomDataBuffer=!1,this.__avatarImageGeomItem=new _("avatarImage",a,m),this.__avatarImageXfo=new l,this.__avatarImageXfo.sc.set(.2,.2,1),this.__avatarImageXfo.ori.setFromAxisAndAngle(new e(0,1,0),Math.PI),this.__avatarImageGeomItem.setLocalXfo(this.__avatarImageXfo);const c=new h("avatarImageBorderMaterial","FlatSurfaceShader");c.getParameter("BaseColor").setValue(new s(0,0,0,1)),c.visibleInGeomDataBuffer=!1;const d=new _("avatarImageBorder",a,c),u=new l;u.sc.set(1.1,1.1,1.1),u.tr.set(0,0,-.001),d.setLocalXfo(u),this.__avatarImageGeomItem.addChild(d,!1)}}attachRTCStream(e){if(!this.__avatarCamGeomItem){const t=new m("webcamStream");t.setVideoStream(e),this.__avatarCamMaterial=new h("user"+this.__userData.id+"AvatarImageMaterial","FlatSurfaceShader"),this.__avatarCamMaterial.getParameter("BaseColor").setValue(this.__avatarColor),this.__avatarCamMaterial.getParameter("BaseColor").setImage(t),this.__avatarCamMaterial.visibleInGeomDataBuffer=!1,this.__avatarCamGeomItem=new _("avatarImage",this.__plane,this.__avatarCamMaterial);const s=.02;this.__avatarCamXfo=new l,this.__avatarCamXfo.sc.set(16*s,9*s,1),this.__avatarCamXfo.tr.set(0,0,-.1*s),this.__avatarCamGeomItem.setLocalXfo(this.__avatarCamXfo);const a=e.videoWidth/e.videoHeight;this.__avatarCamXfo.sc.x=this.__avatarCamXfo.sc.y*a,this.__avatarImageGeomItem.setLocalXfo(this.__avatarCamXfo)}"CameraAndPointer"==this.__currentViewMode&&(this.__treeItem.getChild(0).removeAllChildren(),this.__treeItem.getChild(0).addChild(this.__avatarCamGeomItem,!1))}detachRTCStream(){if("CameraAndPointer"==this.__currentViewMode){this.__treeItem.getChild(0).removeAllChildren();const e=.02;this.__avatarImageXfo.sc.set(9*e,9*e,1),this.__avatarImageXfo.tr.set(0,0,-.1*e),this.__avatarImageGeomItem.setLocalXfo(this.__avatarImageXfo),this.__treeItem.getChild(0).addChild(this.__avatarImageGeomItem,!1)}}getCamera(){return this.__camera}bindCamera(){this.__cameraBound=!0;const e=this.__camera.getOwner();e&&e.traverse(e=>{e!=this.__camera&&e.setVisible(!1)})}unbindCamera(){this.__cameraBound=!1;const e=this.__camera.getOwner();e&&e.traverse(e=>{e!=this.__camera&&e.setVisible(!0)})}setCameraAndPointerRepresentation(){if(this.__treeItem.removeAllChildren(),this.__currentViewMode="CameraAndPointer",this.__currentUserAvatar)return;const t=new c(.32,.18,.06,!0),a=new e(.1,.1,1);t.getVertex(0).multiplyInPlace(a),t.getVertex(1).multiplyInPlace(a),t.getVertex(2).multiplyInPlace(a),t.getVertex(3).multiplyInPlace(a),t.computeVertexNormals();const r=new h("user"+this.__userData.id+"Material","SimpleSurfaceShader");r.visibleInGeomDataBuffer=!1,r.getParameter("BaseColor").setValue(new s(.5,.5,.5,1));const i=new _("camera",t,r),o=new l;i.setGeomOffsetXfo(o);const n=new d;n.setNumVertices(2),n.setNumSegments(1),n.setSegment(0,0,1),n.getVertex(0).set(0,0,0),n.getVertex(1).set(0,0,1),n.setBoundingBoxDirty(),this.pointerXfo=new l,this.pointerXfo.sc.set(1,1,0),this.__pointermat=new h("pointermat","LinesShader"),this.__pointermat.getParameter("BaseColor").setValue(this.__avatarColor),this.__pointerItem=new _("Pointer",n,this.__pointermat),this.__pointerItem.setLocalXfo(this.pointerXfo),this.__avatarCamGeomItem?i.addChild(this.__avatarCamGeomItem,!1):this.__avatarImageGeomItem&&(this.__avatarImageXfo.sc.set(.18,.18,1),this.__avatarImageXfo.tr.set(0,0,-.002),this.__avatarImageGeomItem.setLocalXfo(this.__avatarImageXfo),i.addChild(this.__avatarImageGeomItem,!1)),this.__audioItem&&i.addChild(this.__audioItem,!1),this.__treeItem.addChild(i,!1),this.__treeItem.addChild(this.__pointerItem,!1),this.__treeItem.addChild(this.__camera,!1),this.__cameraBound&&i.setVisible(!1)}updateCameraAndPointerPose(e){if(!this.__currentUserAvatar)if(e.viewXfo){if(e.focalDistance){const t=e.focalDistance/5;t>1&&e.viewXfo.sc.set(t,t,t)}this.__treeItem.getChild(0).setLocalXfo(e.viewXfo),this.pointerXfo.sc.z=0,this.__treeItem.getChild(1).setLocalXfo(this.pointerXfo)}else e.movePointer?(this.pointerXfo.tr=e.movePointer.start,this.pointerXfo.ori.setFromDirectionAndUpvector(e.movePointer.dir,G),this.pointerXfo.sc.z=e.movePointer.length,this.__treeItem.getChild(1).setLocalXfo(this.pointerXfo)):e.hilightPointer?this.__pointermat.getParameter("BaseColor").setValue(this.__hilightPointerColor):e.unhilightPointer?this.__pointermat.getParameter("BaseColor").setValue(this.__avatarColor):e.hidePointer&&(this.pointerXfo.sc.z=0,this.__treeItem.getChild(1).setLocalXfo(this.pointerXfo))}setVRRepresentation(s){this.__treeItem.removeAllChildren(),this.__currentViewMode="VR";const a=new t("hmdHolder");if(this.__audioItem&&a.addChild(this.__audioItem),this.__avatarImageGeomItem&&(this.__avatarImageXfo.sc.set(.12,.12,1),this.__avatarImageXfo.tr.set(0,-.04,-.135),this.__avatarImageGeomItem.setLocalXfo(this.__avatarImageXfo),a.addChild(this.__avatarImageGeomItem,!1)),this.__treeItem.addChild(a),this.__camera&&a.addChild(this.__camera,!1),this.__hmdGeomItem)this.__currentUserAvatar||a.addChild(this.__hmdGeomItem,!1),this.__cameraBound&&this.__hmdGeomItem.setVisible(!1);else{const t=this.__appData.scene.getResourceLoader();let r;switch(s.hmd){case"Vive":r="ZeaEngine/Vive.vla";break;case"Oculus":r="ZeaEngine/Oculus.vla";break;default:r="ZeaEngine/Vive.vla"}if(!this.__vrAsset){const s=t.resolveFilePathToId(r);s&&(this.__vrAsset=this.__appData.scene.loadCommonAssetResource(s),this.__vrAsset.on("geomsLoaded",()=>{const t=this.__vrAsset.getMaterialLibrary(),s=t.getMaterialNames();for(const e of s){const s=t.getMaterial(e,!1);s&&(s.visibleInGeomDataBuffer=!1,s.setShaderName("SimpleSurfaceShader"))}if(!this.__currentUserAvatar){const t=this.__vrAsset.getChildByName("HMD").clone(),s=t.getLocalXfo();s.tr.set(0,-.03,-.03),s.ori.setFromAxisAndAngle(new e(0,1,0),Math.PI),s.sc.set(.001),t.setLocalXfo(s),this.__hmdGeomItem=t,this.__cameraBound&&this.__hmdGeomItem.setVisible(!1),a.addChild(this.__hmdGeomItem,!1)}}))}}this.__controllerTrees=[]}updateVRPose(s){const a=s=>{if(this.__controllerTrees[s])this.__treeItem.addChild(this.__controllerTrees[s],!1);else{const a=new t("handleHolder"+s);this.__controllerTrees[s]=a,this.__treeItem.addChild(this.__controllerTrees[s],!1);const r=()=>{let t;0==s?t=this.__vrAsset.getChildByName("LeftController"):1==s&&(t=this.__vrAsset.getChildByName("RightController")),t||(t=this.__vrAsset.getChildByName("Controller"));const r=t.clone(),i=new l(new e(0,-.035,-.085),new u({setFromAxisAndAngle:[new e(0,1,0),Math.PI]}),new e(.001,.001,.001));r.setLocalXfo(i),a.addChild(r,!1)};this.__vrAsset.on("geomsLoaded",()=>{r()})}};if(s.viewXfo&&this.__treeItem.getChild(0).setGlobalXfo(s.viewXfo),s.controllers)for(let e=0;e<s.controllers.length;e++)s.controllers[e]&&!this.__controllerTrees[e]&&a(e),this.__controllerTrees[e].setGlobalXfo(s.controllers[e].xfo);if(s.showUIPanel){if(!this.__uiGeomItem){const t=new h("uimat","FlatSurfaceShader");t.getParameter("BaseColor").setValue(this.__avatarColor),this.__uiGeomOffsetXfo=new l,this.__uiGeomOffsetXfo.sc.set(s.showUIPanel.size.x,s.showUIPanel.size.y,1),this.__uiGeomOffsetXfo.ori.setFromAxisAndAngle(new e(0,1,0),Math.PI),this.__uiGeomItem=new _("VRControllerUI",this.__plane,t),this.__uiGeomItem.setGeomOffsetXfo(this.__uiGeomOffsetXfo);const a=new l;a.fromJSON(s.showUIPanel.localXfo),this.__uiGeomItem.setLocalXfo(a)}this.__uiGeomIndex=this.__controllerTrees[s.showUIPanel.controllerId].addChild(this.__uiGeomItem,!1)}else s.updateUIPanel?this.__uiGeomItem&&(this.__uiGeomOffsetXfo.sc.set(s.updateUIPanel.size.x,s.updateUIPanel.size.y,1),this.__uiGeomItem.setGeomOffsetXfo(this.__uiGeomOffsetXfo)):s.hideUIPanel&&this.__uiGeomIndex>=0&&(this.__controllerTrees[s.hideUIPanel.controllerId].removeChild(this.__uiGeomIndex),this.__uiGeomIndex=-1)}updatePose(e){switch(e.interfaceType){case"CameraAndPointer":"CameraAndPointer"!==this.__currentViewMode&&this.setCameraAndPointerRepresentation(),this.updateCameraAndPointerPose(e);break;case"Vive":case"VR":"VR"!==this.__currentViewMode&&this.setVRRepresentation(e),this.updateVRPose(e)}}destroy(){this.__appData.renderer.removeTreeItem(this.__treeItem)}}const N=e=>{if(null!=e){if(e instanceof f)return"::"+e.getPath();if(e.toJSON){const t=e.toJSON();return t.typeName=g.getBlueprintName(e.constructor),t}if(Array.isArray(e)){const t=[];for(const s of e)t.push(N(s));return t}if("object"==typeof e){const t={};for(const s in e)t[s]=N(e[s]);return t}return e}},x=(e,t)=>{if(null!=e){if("string"==typeof e&&e.startsWith("::"))return t.getRoot().resolvePath(e,1);if(e.typeName){const t=g.getBlueprint(e.typeName).create();return t.fromJSON(e),t}if(Array.isArray(e)){const s=[];for(const a of e)s.push(x(a,t));return s}if("object"==typeof e){const s={};for(const a in e)s[a]=x(e[a],t);return s}return e}};class B{constructor(e,t,s,a){this.session=e,this.appData=t;const r={},i=()=>{const s=t.renderer.getViewport().getCamera();e.pub("poseChanged",N({interfaceType:"CameraAndPointer",viewXfo:s.getGlobalXfo(),focalDistance:s.getParameter("focalDistance").getValue()}))};if(e.sub(X.actions.USER_JOINED,e=>{e.id in r||(r[e.id]={undoRedoManager:new p,avatar:new k(t,e),selectionManager:new v(t,{...a,enableXfoHandles:!1,setItemsSelected:!1})},t.renderer&&i())}),e.sub(X.actions.USER_LEFT,e=>{r[e.id]?(r[e.id].avatar.destroy(),delete r[e.id]):console.warn("User id not in session:",e.id)}),e.sub(X.actions.USER_VIDEO_STARTED,(t,s)=>{if(!r[s])return void console.warn("User id not in session:",s);const a=e.getVideoStream(s);a&&r[s].avatar.attachRTCStream(a)}),e.sub(X.actions.USER_VIDEO_STOPPED,(t,a)=>{r[a]?(console.log("USER_VIDEO_STOPPED:",a," us:",s.id),r[a].avatar&&r[a].avatar.detachRTCStream(e.getVideoStream(a))):console.warn("User id not in session:",a)}),t.renderer){const s=t.renderer.getViewport();this.mouseDownId=s.on("mouseDown",t=>{e.pub("poseChanged",{interfaceType:"CameraAndPointer",hilightPointer:{}})}),this.mouseUpId=s.on("mouseUp",t=>{e.pub("poseChanged",N({interfaceType:"CameraAndPointer",unhilightPointer:{}}))}),this.mouseMoveId=s.on("mouseMove",t=>{const s=t.viewport.getGeomDataAtPos(t.mousePos,t.mouseRay),a=s?s.dist:5,r={interfaceType:"CameraAndPointer",movePointer:{start:t.mouseRay.start,dir:t.mouseRay.dir,length:a}};e.pub("poseChanged",N(r))}),s.on("mouseLeave",t=>{e.pub("poseChanged",{interfaceType:"CameraAndPointer",hidePointer:{}})});let a=0;t.renderer.on("viewChanged",t=>{a++;const s="VR"==t.interfaceType;if(s&&a%2!=0)return;const r={interfaceType:t.interfaceType,viewXfo:t.viewXfo};if(t.focalDistance)r.focalDistance=t.focalDistance;else if(s){r.controllers=[];for(const e of t.controllers)r.controllers.push({xfo:e.getTreeItem().getGlobalXfo()})}e.pub("poseChanged",N(r))}),e.sub("poseChanged",(e,s)=>{if(!r[s])return void console.warn("User id not in session:",s);const a=x(e,t.scene);r[s].avatar.updatePose(a)}),i()}if(t.undoRedoManager){const s=t.scene.getRoot();t.undoRedoManager.on("changeAdded",a=>{const{change:r}=a,i={appData:t,makeRelative:e=>e,resolvePath:(e,t)=>{if(!e)throw"Path not spcecified";const a=s.resolvePath(e);a?t(a):console.warn("Path unable to be resolved:"+e)}},o={changeData:r.toJSON(i),changeClass:p.getChangeClassName(r)};e.pub(X.actions.COMMAND_ADDED,o)}),t.undoRedoManager.on("changeUpdated",t=>{const s=N(t);e.pub(X.actions.COMMAND_UPDATED,s)}),e.sub(X.actions.COMMAND_ADDED,(e,s)=>{if(!r[s])return void console.warn("User id not in session:",s);const a=r[s].undoRedoManager,i=a.constructChange(e.changeClass),o={appData:{selectionManager:r[s].selectionManager,scene:t.scene}};i.fromJSON(e.changeData,o),a.addChange(i)}),e.sub(X.actions.COMMAND_UPDATED,(e,s)=>{if(!r[s])return void console.warn("User id not in session:",s);const a=r[s].undoRedoManager,i=x(e,t.scene);a.getCurrentChange().update(i)}),t.undoRedoManager.on("changeUndone",()=>{e.pub("UndoRedoManager_changeUndone",{})}),e.sub("UndoRedoManager_changeUndone",(e,t)=>{r[t].undoRedoManager.undo()}),t.undoRedoManager.on("changeRedone",()=>{e.pub("UndoRedoManager_changeRedone",{})}),e.sub("UndoRedoManager_changeRedone",(e,t)=>{r[t].undoRedoManager.redo()})}}syncStateMachines(e){e.on("stateChanged",t=>{this.session.pub("StateMachine_stateChanged",{stateMachine:e.getPath(),stateName:t.name})}),this.session.sub("StateMachine_stateChanged",(t,s)=>{e.activateState(t.stateName)})}}export{k as Avatar,X as Session,L as SessionFactory,V as SessionRecorder,B as SessionSync};
