"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@zeainc/zea-engine");const t={},o={},s=[];class a{constructor(){this.__undoStack=[],this.__redoStack=[],this.__currChangeUpdated=this.__currChangeUpdated.bind(this)}flush(){for(const e of this.__undoStack)e.destroy();this.__undoStack=[];for(const e of this.__redoStack)e.destroy();this.__redoStack=[]}addChange(e){this.getCurrentChange()&&this.getCurrentChange().updated.disconnect(this.__currChangeUpdated),this.__undoStack.push(e),e.updated.connect(this.__currChangeUpdated);for(const e of this.__redoStack)e.destroy();this.__redoStack=[],this.emit("changeAdded",{change:e})}getCurrentChange(){return this.__undoStack[this.__undoStack.length-1]}__currChangeUpdated(e){this.emit("changeUpdated",e)}undo(e=!0){if(this.__undoStack.length>0){const t=this.__undoStack.pop();t.undo(),e&&(this.__redoStack.push(t),this.emit("changeUndone"))}}redo(){if(this.__redoStack.length>0){const e=this.__redoStack.pop();e.redo(),this.__undoStack.push(e),this.emit("changeRedone")}}constructChange(e){return new t[e]}static isChangeClassRegistered(e){return-1!=s.indexOf(e.constructor)}static getChangeClassName(e){const t=s.indexOf(e.constructor);return o[t]?o[t]:(console.warn("Change not registered:",e.constructor.name),"")}static registerChange(e,a){-1!=s.indexOf(a)&&console.warn("Class already registered:",e);const i=s.length;s.push(a),t[e]=a,o[i]=e}}class i extends e.EventEmitter{constructor(e){super(),this.name=e||a.getChangeClassName(this)}undo(){throw new Error("Implement me")}redo(){throw new Error("Implement me")}update(e){throw new Error("Implement me")}toJSON(e){return{}}fromJSON(e,t){}changeFromJSON(e){this.update(e)}destroy(){}}class n extends e.TreeItem{constructor(e){super(e),this.captured=!1}highlight(){}unhighlight(){}getManipulationPlane(){const t=this.getGlobalXfo();return new e.Ray(t.tr,t.ori.getZaxis())}onMouseEnter(e){this.highlight()}onMouseLeave(e){this.unhighlight()}onMouseDown(e){e.setCapture(this),e.stopPropagation(),this.captured=!0,e.viewport?this.handleMouseDown(e):e.vrviewport&&this.onVRControllerButtonDown(e)}onMouseMove(e){this.captured&&(e.stopPropagation(),e.viewport?this.handleMouseMove(e):e.vrviewport&&this.onVRPoseChanged(e))}onMouseUp(e){this.captured&&(e.releaseCapture(),e.stopPropagation(),this.captured=!1,e.viewport?this.handleMouseUp(e):e.vrviewport&&this.onVRControllerButtonUp(e))}onWheel(e){}handleMouseDown(e){this.gizmoRay=this.getManipulationPlane();const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.grabPos=e.mouseRay.pointAtDist(t),this.onDragStart(e),!0}handleMouseMove(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.holdPos=e.mouseRay.pointAtDist(t),this.onDrag(e),!0}handleMouseUp(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.releasePos=e.mouseRay.pointAtDist(t),this.onDragEnd(e),!0}onVRControllerButtonDown(e){this.activeController=e.controller;const t=this.activeController.getTipXfo().clone(),o=this.getManipulationPlane(),s=t.tr.subtract(o.start),a=t.tr.subtract(o.dir.scale(s.dot(o.dir)));return e.grabPos=a,this.onDragStart(e),!0}onVRPoseChanged(e){if(this.activeController){const t=this.activeController.getTipXfo(),o=this.getManipulationPlane(),s=t.tr.subtract(o.start),a=t.tr.subtract(o.dir.scale(s.dot(o.dir)));return e.holdPos=a,this.onDrag(e),!0}}onVRControllerButtonUp(e){if(this.activeController==e.controller){const t=this.activeController.getTipXfo();return this.onDragEnd(e,t.tr),this.activeController=void 0,!0}}onDragStart(e){console.log("onDragStart",e)}onDrag(e){console.log("onDrag",e)}onDragEnd(e){console.log("onDragEnd",e)}}class r extends n{constructor(e){super(e)}handleMouseDown(e){this.gizmoRay=this.getManipulationPlane(),this.grabDist=e.mouseRay.intersectRayVector(this.gizmoRay)[1];const t=this.gizmoRay.pointAtDist(this.grabDist);return e.grabDist=this.grabDist,e.grabPos=t,this.onDragStart(e),!0}handleMouseMove(e){const t=e.mouseRay.intersectRayVector(this.gizmoRay)[1],o=this.gizmoRay.pointAtDist(t);e.holdDist=t,e.holdPos=o,e.value=t,e.delta=t-this.grabDist,this.onDrag(e)}handleMouseUp(e){const t=e.mouseRay.intersectRayVector(this.gizmoRay)[1],o=this.gizmoRay.pointAtDist(t);return e.releasePos=o,this.onDragEnd(e),!0}onVRControllerButtonDown(e){this.gizmoRay=this.getManipulationPlane(),this.activeController=e.controller;const t=this.activeController.getTipXfo();this.grabDist=t.tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir);const o=this.gizmoRay.start.add(this.gizmoRay.dir.scale(this.grabDist));return e.grabPos=o,this.onDragStart(e),!0}onVRPoseChanged(e){const t=this.activeController.getTipXfo().tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir),o=this.gizmoRay.start.add(this.gizmoRay.dir.scale(t));return e.value=t,e.holdPos=o,e.delta=t-this.grabDist,this.onDrag(e),!0}onVRControllerButtonUp(e){if(this.activeController==e.controller)return this.onDragEnd(),this.activeController=void 0,!0}}class h extends i{constructor(t,o,s=e.ValueSetMode.USER_SETVALUE){t?(super(t?t.getName()+" Changed":"ParameterValueChange"),this.__prevValue=t.getValue(),this.__param=t,this.__mode=s,null!=o&&(this.__nextValue=o,this.__param.setValue(this.__nextValue,s))):super()}undo(){this.__param&&this.__param.setValue(this.__prevValue,this.__mode)}redo(){this.__param&&this.__param.setValue(this.__nextValue,this.__mode)}update(e){if(!this.__param)return;this.__nextValue=e.value;const t=e.mode?e.mode:this.__mode;this.__param.setValue(this.__nextValue,t),this.updated.emit(e)}toJSON(e){const t={name:this.name,paramPath:this.__param.getPath()};return null!=this.__nextValue&&(this.__nextValue.toJSON?t.value=this.__nextValue.toJSON():t.value=this.__nextValue),t}fromJSON(t,o){const s=o.appData.scene.getRoot().resolvePath(t.paramPath,1);s&&s instanceof e.Parameter?(this.__param=s,this.__prevValue=this.__param.getValue(),this.__prevValue.clone?this.__nextValue=this.__prevValue.clone():this.__nextValue=this.__prevValue,this.name=t.name,null!=t.value&&this.changeFromJSON(t)):console.warn("resolvePath is unable to resolve",t.paramPath)}changeFromJSON(t){this.__param&&(this.__nextValue.fromJSON?this.__nextValue.fromJSON(t.value):this.__nextValue=t.value,this.__param.setValue(this.__nextValue,e.ValueSetMode.REMOTEUSER_SETVALUE))}}a.registerChange("ParameterValueChange",h);class l extends r{constructor(t,o,s,a){super(t),this.__color=a,this.__hilightedColor=new e.Color(1,1,1),this.colorParam=this.addParameter(new e.ColorParameter("BaseColor",a));const i=new e.Material("handle","HandleShader");i.getParameter("maintainScreenSize").setValue(1),i.replaceParameter(this.colorParam);const n=new e.Cylinder(s,o,64);n.getParameter("baseZAtZero").setValue(!0);const r=new e.Cone(4*s,10*s,64,!0),h=new e.GeomItem("handle",n,i),l=new e.GeomItem("tip",r,i),c=new e.Xfo;c.tr.set(0,0,o),r.transformVertices(c),this.addChild(h),this.addChild(l)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new h(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.grabPos),o=this.baseXfo.clone();o.tr.addInPlace(t),this.change?this.change.update({value:o}):this.param.setValue(o)}onDragEnd(e){this.change=null}}class c extends n{constructor(e){super(e),this.fullXfoManipulationInVR=!0}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new h(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.grabPos),o=this.baseXfo.clone();if(o.tr.addInPlace(t),this.change)this.change.update({value:o});else{this.getTargetParam().setValue(o)}}onDragEnd(e){this.change=null}onVRControllerButtonDown(e){if(this.fullXfoManipulationInVR){this.activeController=e.controller;const t=this.activeController.getTipXfo(),o=this.getGlobalXfo();this.grabOffset=t.inverse().multiply(o)}else super.onVRControllerButtonDown(e);return!0}onVRPoseChanged(e){if(this.fullXfoManipulationInVR){const e=this.activeController.getTipXfo().multiply(this.grabOffset);if(this.change)this.change.update({value:e});else{this.getTargetParam().setValue(e)}}else super.onVRPoseChanged(e)}onVRControllerButtonUp(e){this.fullXfoManipulationInVR?this.change=null:super.onVRControllerButtonUp(e)}}class d extends n{constructor(e){super(e)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(t){this.baseXfo=this.getGlobalXfo().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new e.Xfo;const o=this.getTargetParam(),s=o.getValue();this.offsetXfo=this.baseXfo.inverse().multiply(s),this.vec0=t.grabPos.subtract(this.baseXfo.tr),this.grabCircleRadius=this.vec0.length(),this.vec0.normalizeInPlace(),t.undoRedoManager&&(this.change=new h(o),t.undoRedoManager.addChange(this.change))}onDrag(t){const o=t.holdPos.subtract(this.baseXfo.tr),s=o.length();o.normalizeInPlace();const a=s/this.grabCircleRadius;let i=this.vec0.angleTo(o)*a;if(this.vec0.cross(o).dot(this.baseXfo.ori.getZaxis())<0&&(i=-i),this.range&&(i=Math.clamp(i,this.range[0],this.range[1])),t.shiftKey){const e=Math.degToRad(22.5);i=Math.floor(i/e)*e}this.deltaXfo.ori.setFromAxisAndAngle(new e.Vec3(0,0,1),i);const n=this.baseXfo.multiply(this.deltaXfo).multiply(this.offsetXfo);if(this.change)this.change.update({value:n});else{this.getTargetParam().setValue(n)}}onDragEnd(e){this.change=null}}class u extends d{constructor(t,o,s,a){super(t),this.__color=a,this.__hilightedColor=new e.Color(1,1,1),this.radiusParam=this.addParameter(new e.NumberParameter("radius",o)),this.colorParam=this.addParameter(new e.ColorParameter("BaseColor",a));const i=new e.Material("handle","HandleShader");i.getParameter("maintainScreenSize").setValue(1),i.replaceParameter(this.colorParam);const n=new e.Torus(s,o,64);this.handle=new e.GeomItem("handle",n,i),this.handleXfo=new e.Xfo,this.radiusParam.on("valueChanged",()=>{o=this.radiusParam.getValue(),n.getParameter("radius").setValue(o),n.getParameter("height").setValue(.02*o)}),this.addChild(this.handle)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}getBaseXfo(){return this.getParameter("GlobalXfo").getValue()}onDragStart(t){super.onDragStart(t),this.colorParam.setValue(new e.Color(1,1,1))}onDrag(e){super.onDrag(e)}onDragEnd(e){super.onDragEnd(e),this.colorParam.setValue(this.__color)}}class g extends r{constructor(t,o,s,a){super(t),this.__color=a,this.__hilightedColor=new e.Color(1,1,1),this.colorParam=this.addParameter(new e.ColorParameter("BaseColor",a));const i=new e.Material("handle","HandleShader");i.getParameter("maintainScreenSize").setValue(1),i.replaceParameter(this.colorParam);const n=new e.Cylinder(s,o-10*s,64);n.getParameter("baseZAtZero").setValue(!0);const r=new e.Cuboid(10*s,10*s,10*s),h=new e.GeomItem("handle",n,i),l=new e.GeomItem("tip",r,i),c=new e.Xfo;c.tr.set(0,0,o-10*s),r.transformVertices(c),this.addChild(h),this.addChild(l)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabDist=e.grabDist,this.oriXfo=this.getGlobalXfo(),this.tmplocalXfo=this.getLocalXfo();const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new h(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=this.baseXfo.clone(),o=e.holdDist/this.grabDist;o<1e-4||(t.sc.set(this.baseXfo.sc.x*o,this.baseXfo.sc.y*o,this.baseXfo.sc.z*o),this.tmplocalXfo.sc.set(1,1,o),this.setLocalXfo(this.tmplocalXfo),this.change?this.change.update({value:t}):this.param.setValue(t))}onDragEnd(e){this.change=null,this.tmplocalXfo.sc.set(1,1,1),this.setLocalXfo(this.tmplocalXfo);const t=this.getChildByName("tip"),o=t.getLocalXfo();o.sc.set(1,1,1),t.setLocalXfo(o)}}class m extends n{constructor(t,o,s){super(t),this.radius=o;const a=new e.Material("mask","HandleShader");a.getParameter("maintainScreenSize").setValue(1),a.getParameter("BaseColor").setValue(s);const i=new e.Sphere(o,64),n=new e.GeomItem("mask",i,a);this.addChild(n)}highlight(){}unhighlight(){}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}handleMouseDown(e){return!0}handleMouseMove(e){return!0}handleMouseUp(e){return!0}onDragStart(t){this.baseXfo=this.getGlobalXfo(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new e.Xfo;const o=this.getTargetParam();this.offsetXfo=this.baseXfo.inverse().multiply(o.getValue()),this.vec0=t.grabPos.subtract(this.baseXfo.tr),this.vec0.normalizeInPlace(),this.colorParam.setValue(new e.Color(1,1,1)),t.undoRedoManager&&(this.change=new ParameterValueChange(o),t.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.baseXfo.tr);t.normalizeInPlace();const o=this.vec0.angleTo(t)*modulator,s=this.vec0.cross(t).normalize();this.deltaXfo.ori.setFromAxisAndAngle(s,o);const a=this.baseXfo.multiply(this.deltaXfo),i=a.multiply(this.offsetXfo);if(this.change)this.change.update({value:i});else{this.getTargetParam().setValue(a)}}onDragEnd(e){this.change=null,this.colorParam.setValue(this.__color)}}class p extends c{constructor(t,o,s,a){super(t),this.__color=s,this.__hilightedColor=new e.Color(1,1,1),this.sizeParam=this.addParameter(new e.NumberParameter("size",o)),this.colorParam=this.addParameter(new e.ColorParameter("BaseColor",s));const i=new e.Material("handle","HandleShader");i.getParameter("maintainScreenSize").setValue(1),i.replaceParameter(this.colorParam);const n=new e.Cuboid(o,o,.02*o),r=new e.Xfo;r.tr=a,n.transformVertices(r),this.handle=new e.GeomItem("handle",n,i),this.sizeParam.on("valueChanged",()=>{o=this.sizeParam.getValue(),n.getParameter("size").setValue(o),n.getParameter("height").setValue(.02*o)}),this.addChild(this.handle)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}}class _ extends e.TreeItem{constructor(t,o){super("XfoHandle");const s=new e.TreeItem("Translate");s.setVisible(!1),this.addChild(s);const a=new e.Color(1,.1,.1),i=new e.Color("#32CD32"),n=new e.Color("#1E90FF");a.a=.8,i.a=.8,n.a=.8;{const i=new l("linearX",t,o,a),n=new e.Xfo;n.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),.5*Math.PI),i.getParameter("LocalXfo").setValue(n),s.addChild(i)}{const a=new l("linearY",t,o,i),n=new e.Xfo;n.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),-.5*Math.PI),a.getParameter("LocalXfo").setValue(n),s.addChild(a)}{const e=new l("linearZ",t,o,n);s.addChild(e)}const r=.35*t;{const t=new p("planarXY",r,i,new e.Vec3(.5*r,.5*r,0)),o=new e.Xfo;t.getParameter("LocalXfo").setValue(o),s.addChild(t)}{const t=new p("planarYZ",r,a,new e.Vec3(-.5*r,.5*r,0)),o=new e.Xfo;o.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(o),s.addChild(t)}{const t=new p("planarXZ",r,n,new e.Vec3(.5*r,.5*r,0)),o=new e.Xfo;o.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(o),s.addChild(t)}const h=new e.TreeItem("Rotate");h.setVisible(!1),this.addChild(h);{const s=new m("rotation",t-o,new e.Color(1,1,1,.4));h.addChild(s)}{const s=new u("rotationX",t,o,a),i=new e.Xfo;i.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),.5*Math.PI),s.getParameter("LocalXfo").setValue(i),h.addChild(s)}{const s=new u("rotationY",t,o,i),a=new e.Xfo;a.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),.5*Math.PI),s.getParameter("LocalXfo").setValue(a),h.addChild(s)}{const e=new u("rotationZ",t,o,n);h.addChild(e)}const c=new e.TreeItem("Scale");c.setVisible(!1),this.addChild(c);const d=.95*t;{const t=new g("scaleX",d,o,a),s=new e.Xfo;s.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(s),c.addChild(t)}{const t=new g("scaleY",d,o,i),s=new e.Xfo;s.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),-.5*Math.PI),t.getParameter("LocalXfo").setValue(s),c.addChild(t)}{const e=new g("scaleZ",d,o,n);c.addChild(e)}}_cleanGlobalXfo(e){const t=this.getParentItem();if(void 0!==t){const e=t.getGlobalXfo().clone();return e.sc.set(1,1,1),e.multiply(this.__localXfoParam.getValue())}return this.__localXfoParam.getValue()}showHandles(e){this.traverse(e=>{if(e!=this)return e.setVisible(!1),!1});const t=this.getChildByName(e);t&&t.setVisible(!0)}setTargetParam(e){this.param=e,this.traverse(t=>{t instanceof n&&t.setTargetParam(e,!1)})}}class f extends e.Group{constructor(t){let o,s;super(),t.selectionOutlineColor?o=t.selectionOutlineColor:(o=new e.Color("#03E3AC"),o.a=.1),t.branchSelectionOutlineColor?s=t.branchSelectionOutlineColor:(s=o.lerp(new e.Color("white"),.5),s.a=.1),this.getParameter("HighlightColor").setValue(o),this.addParameter(new e.ColorParameter("SubtreeHighlightColor",s)),this.propagatingSelectionToItems=0!=t.setItemsSelected,this.getParameter("InitialXfoMode").setValue(e.Group.INITIAL_XFO_MODES.average),this.__itemsParam.setFilterFn(t=>t instanceof e.BaseItem)}clone(e){const t=new f;return t.copyFrom(this,e),t}rebindInitialXfos(){Array.from(this.__itemsParam.getValue()).forEach((t,o)=>{t instanceof e.TreeItem&&(this.__initialXfos[o]=t.getGlobalXfo())})}__bindItem(t,o){this.propagatingSelectionToItems&&t.setSelected(this);const s={};if(t instanceof e.TreeItem){const a=this.getParameter("HighlightColor").getValue();a.a=this.getParameter("HighlightFill").getValue();const i=this.getParameter("SubtreeHighlightColor").getValue();t.addHighlight("selected"+this.getId(),a,!1),t.getChildren().forEach(t=>{t instanceof e.TreeItem&&t.addHighlight("branchselected"+this.getId(),i,!0)}),s.globalXfoChangedIndex=t.on("globalXfoChanged",e=>{this.calculatingGroupXfo||this.propagatingXfoToItems||(this.__initialXfos[o]=t.getGlobalXfo(),this.groupXfoDirty=!0,this._setGlobalXfoDirty())}),this.__initialXfos[o]=t.getGlobalXfo(),this.groupXfoDirty=!0}this.__signalIndices[o]=s}__unbindItem(t,o){this.propagatingSelectionToItems&&t.setSelected(!1),t instanceof e.TreeItem&&(t.removeHighlight("selected"+this.getId()),t.getChildren().forEach(t=>{t instanceof e.TreeItem&&t.removeHighlight("branchselected"+this.getId(),!0)}),t.removeListenerById("globalXfoChanged",this.__signalIndices[o].globalXfoChangedIndex),this.__initialXfos.splice(o,1),this.groupXfoDirty=!0),this.__signalIndices.splice(o,1)}_propagateDirtyXfoToItems(){if(this.groupXfoDirty||this.calculatingGroupXfo)return;const t=Array.from(this.__itemsParam.getValue());if(!this.calculatingGroupXfo&&t.length>0&&this.invGroupXfo&&!this.dirty){const o=this.__globalXfoParam.getValue().multiply(this.invGroupXfo);this.propagatingXfoToItems=!0;const s=(e,t)=>{const s=e.getParameter("GlobalXfo"),a=o.multiply(t);s.setValue(a)};t.forEach((t,o)=>{t instanceof e.TreeItem&&s(t,this.__initialXfos[o])}),this.propagatingXfoToItems=!1}}}class v extends i{constructor(e,t,o){super("SelectionChange"),this.__selectionManager=e,this.__prevSelection=t,this.__newSelection=o}undo(){this.__selectionManager.setSelection(this.__prevSelection,!1)}redo(){this.__selectionManager.setSelection(this.__newSelection,!1)}toJSON(e){const t=super.toJSON(e),o=[];for(const e of this.__newSelection)o.push(e.getPath());return t.itemPaths=o,t}fromJSON(e,t){super.fromJSON(e,t),this.__selectionManager=t.appData.selectionManager,this.__prevSelection=new Set(this.__selectionManager.getSelection());const o=t.appData.scene.getRoot(),s=new Set;for(const t of e.itemPaths)s.add(o.resolvePath(t,1));this.__newSelection=s,this.__selectionManager.setSelection(this.__newSelection,!1)}}a.registerChange("SelectionChange",v);class C extends i{constructor(e,t){super("Selection Visibility Change"),this.selection=e,this.state=t,this.do(this.state)}undo(){this.do(!this.state)}redo(){this.do(this.state)}do(e){for(const t of this.selection)t.getParameter("Visible").setValue(e)}}a.registerChange("ToggleSelectionVisibility",C);class I extends e.EventEmitter{constructor(e,t={}){if(super(),this.appData=e,this.leadSelection=void 0,this.selectionGroup=new f(t),!0===t.enableXfoHandles){const e=.1,t=.02*e;this.xfoHandle=new _(e,t),this.xfoHandle.setTargetParam(this.selectionGroup.getParameter("GlobalXfo"),!1),this.xfoHandle.setVisible(!1),this.selectionGroup.addChild(this.xfoHandle)}this.appData.renderer&&this.setRenderer(this.appData.renderer)}setRenderer(e){this.__renderer=e,this.__renderer.addTreeItem(this.selectionGroup)}setXfoMode(e){this.xfoHandle&&(this.selectionGroup.rebindInitialXfos(),this.selectionGroup.getParameter("InitialXfoMode").setValue(e))}showHandles(e){if(this.xfoHandle&&this.currMode!=e){this.currMode=e;for(const t in this.handleGroup)this.handleGroup[t].emit(e==t);this.xfoHandle.showHandles(e)}}updateHandleVisiblity(){if(!this.xfoHandle)return;const e=this.selectionGroup.getItems(),t=Array.from(e).length>0;this.xfoHandle.setVisible(t),this.__renderer.requestRedraw()}getSelection(){return this.selectionGroup.getItems()}setSelection(e,t=!0){const o=new Set(this.selectionGroup.getItems()),s=new Set(o);for(const t of e)o.has(t)||o.add(t);for(const t of o)e.has(t)||o.delete(t);if(this.selectionGroup.setItems(o),o.size>0?this.__setLeadSelection(o.values().next().value):this.__setLeadSelection(),this.updateHandleVisiblity(),t){const e=new v(this,s,o);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(e)}}__setLeadSelection(e){this.leadSelection!=e&&(this.leadSelection=e,this.emit("leadSelectionChanged",{treeItem:e}))}toggleItemSelection(e,t=!0){const o=new Set(this.selectionGroup.getItems()),s=new Set(o);if(t&&(1!=o.size||!o.has(e))){let t=!0;if(o.has(e)){let s=1;e.traverse(e=>{o.has(e)&&s++}),t=s!=o.size}t&&o.clear()}let a;o.has(e)?(o.delete(e),a=!1):(o.add(e),a=!0),this.selectionGroup.setItems(o),a&&1===o.size?this.__setLeadSelection(e):a||(1===o.size?this.__setLeadSelection(o.values().next().value):0===o.size&&this.__setLeadSelection());const i=new v(this,s,o);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(i),this.updateHandleVisiblity(),this.emit("selectionChanged",{prevSelection:s,selection:o})}clearSelection(e=!0){const t=new Set(this.selectionGroup.getItems());if(0==t.size)return!1;let o;if(e&&(o=new Set(t)),t.clear(),this.selectionGroup.setItems(t),this.updateHandleVisiblity(),e){const e=new v(this,o,t);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(e),this.emit("selectionChanged",{selection:t,prevSelection:o})}return!0}selectItems(e,t=!0){const o=new Set(this.selectionGroup.getItems()),s=new Set(o);t&&o.clear();for(const t of e)t.getSelected()||o.add(t);const a=new v(this,s,o);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(a),this.selectionGroup.setItems(o),1===o.size?this.__setLeadSelection(o.values().next().value):0===o.size&&this.__setLeadSelection(),this.updateHandleVisiblity(),this.emit("selectionChanged",{prevSelection:s,selection:o})}deselectItems(e){const t=this.selectionGroup.getItems(),o=new Set(t);for(const o of e)o.getSelected()&&t.delete(selectedParam);this.selectionGroup.setItems(t);const s=new v(this,o,t);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(s),1===t.size?this.__setLeadSelection(t.values().next().value):0===t.size&&this.__setLeadSelection(),this.updateHandleVisiblity(),this.emit("selectionChanged",{prevSelection:o,selection:t})}toggleSelectionVisiblity(){if(this.leadSelection){const e=this.selectionGroup.getItems(),t=!this.leadSelection.getVisible(),o=new C(e,t);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(o)}}startPickingMode(e,t,o,s){console.log(e),this.__pickCB=t,this.__pickFilter=o,this.__pickCount=s,this.__picked=[]}pickingFilter(e){return this.__pickFilter(e)}pickingModeActive(){return null!=this.__pickCB}cancelPickingMode(){this.__pickCB=void 0}pick(e){if(this.__pickCB){if(Array.isArray(e))this.__pickFilter?this.__picked=this.__picked.concat(e.filter(this.__pickFilter)):this.__picked=this.__picked.concat(e);else{if(this.__pickFilter&&!this.__pickFilter(e))return;this.__picked.push(e)}this.__picked.length==this.__pickCount&&(this.__pickCB(this.__picked),this.__pickCB=void 0)}}}class P extends i{constructor(e,t,o){e?(super(e.getName()+" Added"),this.treeItem=e,this.owner=t,this.selectionManager=o,this.prevSelection=new Set(this.selectionManager.getSelection()),this.treeItemIndex=this.owner.addChild(this.treeItem),this.selectionManager.setSelection(new Set([this.treeItem]),!1),this.treeItem.addRef(this)):super()}undo(){if(this.treeItem instanceof e.Operator){this.treeItem.detach()}else this.treeItem instanceof e.TreeItem&&this.treeItem.traverse(t=>{if(t instanceof e.Operator){t.detach()}},!1);this.owner.removeChild(this.treeItemIndex),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1)}redo(){if(this.treeItem instanceof e.Operator){this.treeItem.reattach()}else subTreeItem instanceof e.TreeItem&&this.treeItem.traverse(t=>{if(t instanceof e.Operator){t.reattach()}},!1);this.owner.addChild(this.treeItem),this.selectionManager&&this.selectionManager.setSelection(new Set([this.treeItem]),!1)}toJSON(e){return{name:this.name,treeItem:this.treeItem.toJSON(e),treeItemPath:this.treeItem.getPath(),treeItemIndex:this.treeItemIndex}}fromJSON(t,o){const s=e.sgFactory.constructClass(t.treeItem.type);s?(this.name=t.name,this.treeItem=s,this.treeItem.addRef(this),this.treeItem.fromJSON(t.treeItem,o),this.treeItemIndex=this.owner.addChild(this.treeItem,!1,!1)):console.warn("resolvePath is unable to conostruct",t.treeItem)}destroy(){this.treeItem.removeRef(this)}}a.registerChange("TreeItemAddChange",P);class w extends i{constructor(t,o){if(super(),this.items=[],this.itemOwners=[],this.itemPaths=[],this.itemIndices=[],t){this.selectionManager=o.selectionManager,this.prevSelection=new Set(this.selectionManager.getSelection()),this.items=t,this.newSelection=new Set(this.prevSelection);const s=[];this.items.forEach(t=>{const o=t.getOwner(),a=o.getChildIndex(t);if(s.push(t.getName()),t.addRef(this),this.itemOwners.push(o),this.itemPaths.push(t.getPath()),this.itemIndices.push(a),this.selectionManager&&this.newSelection.has(t)&&this.newSelection.delete(t),t instanceof e.Operator){t.detach()}else t instanceof e.TreeItem&&t.traverse(t=>{if(t instanceof e.Operator){t.detach()}this.selectionManager&&this.newSelection.has(t)&&this.newSelection.delete(t)},!1);o.removeChild(a)}),this.selectionManager.setSelection(this.newSelection,!1),this.name=s+" Deleted"}}undo(){this.items.forEach((t,o)=>{if(this.itemOwners[o].insertChild(t,this.itemIndices[o],!1,!1),t instanceof e.Operator){t.reattach()}else subTreeItem instanceof e.TreeItem&&t.traverse(t=>{if(t instanceof e.Operator){t.reattach()}},!1)}),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1)}redo(){this.selectionManager&&this.selectionManager.setSelection(this.newSelection,!1),this.items.forEach((t,o)=>{if(this.itemOwners[o].removeChild(this.itemIndices[o]),t instanceof e.Operator){t.detach()}else subTreeItem instanceof e.TreeItem&&t.traverse(t=>{if(t instanceof e.Operator){t.detach()}},!1)})}toJSON(e){const t={name:this.name,items:[],itemPaths:this.itemPaths,itemIndices:this.itemIndices};return this.items.forEach(e=>{t.items.push(e.toJSON())}),t}fromJSON(e,t){this.name=e.name,e.itemPaths.forEach(e=>{const o=t.scene.getRoot().resolvePath(e,1);if(!o)return void console.warn("resolvePath is unable to resolve",e);const s=o.getOwner();this.itemOwners.push(s),this.itemPaths.push(o.getPath()),this.itemIndices.push(s.getChildIndex(o))})}destroy(){this.items.forEach(e=>e.removeRef(this))}}a.registerChange("TreeItemsRemoveChange",w);class b extends i{constructor(e,t){e?(console.log("TreeItemMoveChange"),super(e.getName()+" Added"),this.treeItem=e,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner=t,this.newOwner.addChild(this.treeItem,!0)):super()}undo(){this.oldOwner.insertChild(this.treeItem,this.oldOwnerIndex,!0)}redo(){this.newOwner.addChild(this.treeItem,!0)}toJSON(e){return{name:this.name,treeItemPath:this.treeItem.getPath(),newOwnerPath:this.newOwner.getPath()}}fromJSON(e,t){const o=appData.scene.getRoot().resolvePath(e.treeItemPath,1);if(!o)return void console.warn("resolvePath is unable to resolve",e.treeItemPath);const s=appData.scene.getRoot().resolvePath(e.newOwnerPath,1);s?(this.name=e.name,this.treeItem=o,this.newOwner=s,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner.addChild(this.treeItem,!0)):console.warn("resolvePath is unable to resolve",e.newOwnerPath)}}a.registerChange("TreeItemMoveChange",b);class D extends e.ParameterOwner{constructor(e){super(),e||console.error("App data not provided to tool"),this.appData=e,this.__params=[],this.__installed=!1,this.__activated=!1}getName(){return this.constructor.name}isPrimaryTool(){return!1}installed(){return this.__installed}install(e){if(this.__installed)throw new Error("Tool already installed");this.index=e,this.__installed=!0,this.emit("installChanged",{installed:this.__installed})}uninstall(){this.__installed=!1,this.emit("installChanged",{installed:this.__installed})}activateTool(){if(this.__activated)throw new Error("Tool already activate");this.__activated=!0,this.emit("activatedChanged",{activated:this.__activated})}deactivateTool(){this.__activated=!1,this.emit("activatedChanged",{activated:this.__activated})}onMouseDown(e){}onMouseMove(e){}onMouseUp(e){}onDoubleClick(e){}onWheel(e){}onKeyPressed(e,t){}onKeyDown(e,t){}onKeyUp(e,t){}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onTouchCancel(e){}onDoubleTap(e){}onVRControllerButtonDown(e){}onVRControllerButtonUp(e){}onVRControllerDoubleClicked(e){}onVRPoseChanged(e){}}const M={VIEWER:0,DCC:1};class S extends D{constructor(t){super(t),this.dragging=!1,this.selectionRect=new e.Rect(1,1),this.selectionRectMat=new e.Material("marker","ScreenSpaceShader"),this.selectionRectMat.getParameter("BaseColor").setValue(new e.Color("#03E3AC")),this.selectionRectXfo=new e.Xfo,this.selectionRectXfo.tr.set(.5,.5,0),this.selectionRectXfo.sc.set(0,0,0)}activateTool(){super.activateTool(),this.rectItem||(this.rectItem=new e.GeomItem("selectionRect",this.selectionRect,this.selectionRectMat),this.rectItem.getParameter("Visible").setValue(!1),this.appData.renderer.addTreeItem(this.rectItem))}deactivateTool(){super.deactivateTool(),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.setGlobalXfo(this.selectionRectXfo)}onMouseDown(e){return 0==e.button&&!e.altKey&&(console.log("onMouseDown"),this.mouseDownPos=e.mousePos,this.dragging=!1,!0)}__resizeRect(t,o){const s=new e.Vec2(1/t.getWidth()*2,1/t.getHeight()*2),a=o.multiply(s);this.selectionRectXfo.sc.set(Math.abs(a.x),Math.abs(a.y),1);const i=this.mouseDownPos.subtract(o.scale(.5)).multiply(s).subtract(new e.Vec2(1,1));this.selectionRectXfo.tr.x=i.x,this.selectionRectXfo.tr.y=-i.y,this.rectItem.setGlobalXfo(this.selectionRectXfo)}onMouseMove(e){if(this.mouseDownPos){const t=this.mouseDownPos.subtract(e.mousePos);this.dragging&&this.__resizeRect(e.viewport,t),t.length()>4&&(this.dragging=!0,this.rectItem.getParameter("Visible").setValue(!0),this.__resizeRect(e.viewport,t))}return!0}onMouseUp(t){if(this.mouseDownPos){if(this.dragging){this.rectItem.getParameter("Visible").setValue(!1);const o=t.mousePos,s=new e.Vec2(Math.min(this.mouseDownPos.x,o.x),Math.min(this.mouseDownPos.y,o.y)),a=new e.Vec2(Math.max(this.mouseDownPos.x,o.x),Math.max(this.mouseDownPos.y,o.y)),i=t.viewport.getGeomItemsInRect(s,a);if(this.appData.selectionManager.pickingModeActive())this.appData.selectionManager.pick(i);else{const e=new Set([...i].filter(e=>!(e.getOwner()instanceof n)));t.shiftKey?this.appData.selectionManager.deselectItems(e):this.appData.selectionManager.selectItems(e,!t.ctrlKey),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.setGlobalXfo(this.selectionRectXfo)}}else{const e=t.viewport.getGeomDataAtPos(t.mousePos);if(null==e||e.geomItem.getOwner()instanceof n)this.appData.selectionManager.clearSelection();else if(this.appData.selectionManager.pickingModeActive())this.appData.selectionManager.pick(e.geomItem);else if(t.shiftKey){const t=new Set;t.add(e.geomItem),this.appData.selectionManager.deselectItems(t)}else this.appData.selectionManager.toggleItemSelection(e.geomItem,!t.ctrlKey)}return this.mouseDownPos=void 0,!0}}onVRControllerButtonDown(e){if(1==e.button){const t=e.controller.getGeomItemAtTip();if(null!=t&&!(t.geomItem.getOwner()instanceof n))return this.appData.selectionManager.toggleItemSelection(t.geomItem),!0}}}a.registerChange("SelectionTool",S);const T=function(){return{escape:function(e){return e.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")},parseExtension:e,mimeType:function(t){const o=e(t).toLowerCase();return function(){const e="application/font-woff";return{woff:e,woff2:e,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}()[o]||""},dataAsUrl:function(e,t){return"data:"+t+";base64,"+e},isDataUrl:function(e){return-1!==e.search(/^(data:)/)},canvasToBlob:function(e){return e.toBlob?new Promise((function(t){e.toBlob(t)})):function(e){return new Promise((function(t){const o=window.atob(e.toDataURL().split(",")[1]),s=o.length,a=new Uint8Array(s);for(let e=0;e<s;e++)a[e]=o.charCodeAt(e);t(new Blob([a],{type:"image/png"}))}))}(e)},resolveUrl:function(e,t){const o=document.implementation.createHTMLDocument(),s=o.createElement("base");o.head.appendChild(s);const a=o.createElement("a");return o.body.appendChild(a),s.href=t,a.href=e,a.href},getAndEncode:function(e){x.impl.options.cacheBust&&(e+=(/\?/.test(e)?"&":"?")+(new Date).getTime());return new Promise((function(t){const o=new XMLHttpRequest;let s;if(o.onreadystatechange=function(){if(4!==o.readyState)return;if(200!==o.status)return void(s?t(s):a("cannot fetch resource: "+e+", status: "+o.status));const i=new FileReader;i.onloadend=function(){const e=i.result.split(/,/)[1];t(e)},i.readAsDataURL(o.response)},o.ontimeout=function(){s?t(s):a("timeout of 30000ms occured while fetching resource: "+e)},o.responseType="blob",o.timeout=3e4,o.open("GET",e,!0),o.send(),x.impl.options.imagePlaceholder){const e=x.impl.options.imagePlaceholder.split(/,/);e&&e[1]&&(s=e[1])}function a(e){console.error(e),t("")}}))},uid:function(){let e=0;return function(){return"u"+("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)+e++}}(),delay:function(e){return function(t){return new Promise((function(o){setTimeout((function(){o(t)}),e)}))}},asArray:function(e){const t=[],o=e.length;for(let s=0;s<o;s++)t.push(e[s]);return t},escapeXhtml:function(e){return e.replace(/#/g,"%23").replace(/\n/g,"%0A")},makeImage:function(e){return new Promise((function(t,o){const s=new Image;s.onload=function(){t(s)},s.onerror=o,s.src=e}))},width:function(e){const o=t(e,"border-left-width"),s=t(e,"border-right-width");return e.scrollWidth+o+s},height:function(e){const o=t(e,"border-top-width"),s=t(e,"border-bottom-width");return e.scrollHeight+o+s}};function e(e){const t=/\.([^\.\/]*?)$/g.exec(e);return t?t[1]:""}function t(e,t){const o=window.getComputedStyle(e).getPropertyValue(t);return parseFloat(o.replace("px",""))}}(),X=function(){const e=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:function(e,a,i){return function(){return!t(e)}()?Promise.resolve(e):Promise.resolve(e).then(o).then((function(t){let o=Promise.resolve(e);return t.forEach((function(e){o=o.then((function(t){return s(t,e,a,i)}))})),o}))},shouldProcess:t,impl:{readUrls:o,inline:s}};function t(t){return-1!==t.search(e)}function o(t){const o=[];let s;for(;null!==(s=e.exec(t));)o.push(s[1]);return o.filter((function(e){return!T.isDataUrl(e)}))}function s(e,t,o,s){return Promise.resolve(t).then((function(e){return o?T.resolveUrl(e,o):e})).then(s||T.getAndEncode).then((function(e){return T.dataAsUrl(e,T.mimeType(t))})).then((function(o){return e.replace(function(e){return new RegExp("(url\\(['\"]?)("+T.escape(e)+")(['\"]?\\))","g")}(t),"$1"+o+"$3")}))}}(),V=function(){return{resolveAll:function(){return e().then((function(e){return Promise.all(e.map((function(e){return e.resolve()})))})).then((function(e){return e.join("\n")}))},impl:{readAll:e}};function e(){return Promise.resolve(T.asArray(document.styleSheets)).then((function(e){const t=[];return e.forEach((function(e){try{T.asArray(e.cssRules||[]).forEach(t.push.bind(t))}catch(t){console.log("Error while reading CSS rules from "+e.href,t.toString())}})),t})).then((function(e){return e.filter((function(e){return e.type===CSSRule.FONT_FACE_RULE})).filter((function(e){return X.shouldProcess(e.style.getPropertyValue("src"))}))})).then((function(t){return t.map(e)}));function e(e){return{resolve:function(){const t=(e.parentStyleSheet||{}).href;return X.inlineAll(e.cssText,t)},src:function(){return e.style.getPropertyValue("src")}}}}}(),y=function(){return{inlineAll:function t(o){return o instanceof Element?function(e){const t=e.style.getPropertyValue("background");return t?X.inlineAll(t).then((function(t){e.style.setProperty("background",t,e.style.getPropertyPriority("background"))})).then((function(){return e})):Promise.resolve(e)}(o).then((function(){return o instanceof HTMLImageElement?e(o).inline():Promise.all(T.asArray(o.childNodes).map((function(e){return t(e)})))})):Promise.resolve(o)},impl:{newImage:e}};function e(e){return{inline:function(t){return T.isDataUrl(e.src)?Promise.resolve():Promise.resolve(e.src).then(t||T.getAndEncode).then((function(t){return T.dataAsUrl(t,T.mimeType(e.src))})).then((function(t){return new Promise((function(o,s){e.onload=o,e.onerror=s,e.src=t}))}))}}}}(),R={imagePlaceholder:void 0,cacheBust:!1},x={toSvg:O,toPng:function(e,t){return G(e,t||{}).then((function(e){return e.toDataURL()}))},toJpeg:function(e,t){return G(e,t=t||{}).then((function(e){return e.toDataURL("image/jpeg",t.quality||1)}))},toBlob:function(e,t){return G(e,t||{}).then(T.canvasToBlob)},toPixelData:function(e,t){return G(e,t||{}).then((function(t){return t.getContext("2d").getImageData(0,0,T.width(e),T.height(e)).data}))},toCanvas:function(e,t){return G(e,t||{}).then((function(e){return e}))},impl:{fontFaces:V,images:y,util:T,inliner:X,options:{}}};function O(e,t){return function(e){void 0===e.imagePlaceholder?x.impl.options.imagePlaceholder=R.imagePlaceholder:x.impl.options.imagePlaceholder=e.imagePlaceholder;void 0===e.cacheBust?x.impl.options.cacheBust=R.cacheBust:x.impl.options.cacheBust=e.cacheBust}(t=t||{}),Promise.resolve(e).then((function(e){return function e(t,o,s){return s||!o||o(t)?Promise.resolve(t).then((function(e){return e instanceof HTMLCanvasElement?T.makeImage(e.toDataURL()):e.cloneNode(!1)})).then((function(e){return a(t,e,o)})).then((function(e){return function(e,t){return t instanceof Element?Promise.resolve().then(o).then(s).then(a).then(i).then((function(){return t})):t;function o(){var o,s;o=window.getComputedStyle(e),s=t.style,o.cssText?s.cssText=o.cssText:function(e,t){T.asArray(e).forEach((function(o){t.setProperty(o,e.getPropertyValue(o),e.getPropertyPriority(o))}))}(o,s)}function s(){[":before",":after"].forEach((function(o){!function(o){const s=window.getComputedStyle(e,o),a=s.getPropertyValue("content");if(""===a||"none"===a)return;const i=T.uid();t.className=t.className+" "+i;const n=document.createElement("style");n.appendChild(function(e,t,o){const s="."+e+":"+t,a=o.cssText?function(e){const t=e.getPropertyValue("content");return e.cssText+" content: "+t+";"}(o):function(e){return T.asArray(e).map((function(t){return t+": "+e.getPropertyValue(t)+(e.getPropertyPriority(t)?" !important":"")})).join("; ")+";"}(o);return document.createTextNode(s+"{"+a+"}")}(i,o,s)),t.appendChild(n)}(o)}))}function a(){e instanceof HTMLTextAreaElement&&(t.innerHTML=e.value),e instanceof HTMLInputElement&&t.setAttribute("value",e.value)}function i(){t instanceof SVGElement&&(t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t instanceof SVGRectElement&&["width","height"].forEach((function(e){const o=t.getAttribute(e);o&&t.style.setProperty(e,o)})))}}(t,e)})):Promise.resolve();function a(t,o,s){const a=t.childNodes;return 0===a.length?Promise.resolve(o):i(o,T.asArray(a),s).then((function(){return o}));function i(t,o,s){let a=Promise.resolve();return o.forEach((function(o){a=a.then((function(){return e(o,s)})).then((function(e){e&&t.appendChild(e)}))})),a}}}(e,t.filter,!0)})).then(k).then(A).then((function(e){t.bgcolor&&(e.style.backgroundColor=t.bgcolor);t.width&&(e.style.width=t.width+"px");t.height&&(e.style.height=t.height+"px");t.style&&Object.keys(t.style).forEach((function(o){e.style[o]=t.style[o]}));return e})).then((function(o){return function(e,t,o){return Promise.resolve(e).then((function(e){return e.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),(new XMLSerializer).serializeToString(e)})).then(T.escapeXhtml).then((function(e){return'<foreignObject x="0" y="0" width="100%" height="100%">'+e+"</foreignObject>"})).then((function(e){return'<svg xmlns="http://www.w3.org/2000/svg" width="'+t+'" height="'+o+'">'+e+"</svg>"})).then((function(e){return"data:image/svg+xml;charset=utf-8,"+e}))}(o,t.width||T.width(e),t.height||T.height(e))}))}function G(e,t){return O(e,t).then(T.makeImage).then(T.delay(100)).then((function(o){const s=function(e){const o=document.createElement("canvas");if(o.width=t.width||T.width(e),o.height=t.height||T.height(e),t.bgcolor){const e=o.getContext("2d");e.fillStyle=t.bgcolor,e.fillRect(0,0,o.width,o.height)}return o}(e);return s.getContext("2d").drawImage(o,0,0),s}))}function k(e){return V.resolveAll().then((function(t){const o=document.createElement("style");return e.appendChild(o),o.appendChild(document.createTextNode(t)),e}))}function A(e){return y.inlineAll(e).then((function(){return e}))}class E extends e.GeomItem{constructor(t,o,s){const a=new e.Material("uimat","FlatSurfaceShader");let i;a.visibleInGeomDataBuffer=!1,super("VRControllerUI",new e.Plane(1,1),a),this.appData=t,this.__vrUIDOMHolderElement=o,this.__vrUIDOMElement=s,this.__uiimage=new e.DataImage,a.getParameter("BaseColor").setValue(this.__uiimage),this.__uiGeomOffsetXfo=new e.Xfo,this.__uiGeomOffsetXfo.sc.set(0,0,1),this.__rect={width:0,height:0},this.__uiGeomOffsetXfo.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),Math.PI),this.setGeomOffsetXfo(this.__uiGeomOffsetXfo);let n=[];const r=()=>{i=null;const e=n.map(e=>this.updateElemInAtlas(e));Promise.all(e).then(()=>{this.updateUIImage(),n=[]})};this.__mutationObserver=new MutationObserver(e=>{this.mainCtx?(e.some(e=>{let t=e.target;for(;t.parentNode;){if(t==this.__vrUIDOMElement)return this.renderUIToImage(),n=[],!1;if(t.classList.contains("VRUIElement")||t==this.__vrUIDOMElement){-1==n.indexOf(t)&&n.push(t);break}t=t.parentNode}return!0}),i&&clearTimeout(i),i=setTimeout(r,50)):this.renderUIToImage()}),this.__active=!1,this.__renderRequested=!1}activate(){this.__vrUIDOMHolderElement.style.display="block",this.__active=!0,this.__mutationObserver.observe(this.__vrUIDOMElement,{attributes:!0,characterData:!0,childList:!0,subtree:!0}),this.renderUIToImage()}deactivate(){this.__vrUIDOMHolderElement.style.display="none",this.__active=!0,this.__mutationObserver.disconnect()}updateElemInAtlas(e){return new Promise((t,o)=>{x.toCanvas(e).then(o=>{const s=e.getBoundingClientRect();s.width*s.height!=0?(this.mainCtx.fillRect(s.x,s.y,s.width,s.height),this.mainCtx.drawImage(o,s.x,s.y),t()):t()})})}updateUIImage(){const e=this.mainCtx.getImageData(0,0,this.__rect.width,this.__rect.height);this.__uiimage.setData(this.__rect.width,this.__rect.height,new Uint8Array(e.data.buffer))}renderUIToImage(){x.toCanvas(this.__vrUIDOMElement).then(e=>{this.mainCtx=e.getContext("2d"),this.mainCtx.fillStyle="#FFFFFF";const t=this.__vrUIDOMElement.getBoundingClientRect();if(t.width*t.height!=0){if(t.width!=this.__rect.width||t.height!=this.__rect.height){this.__rect=t;const e=7e-4;this.__uiGeomOffsetXfo.sc.set(this.__rect.width*e,this.__rect.height*e,1),this.setGeomOffsetXfo(this.__uiGeomOffsetXfo),this.appData.session.pub("pose-message",{interfaceType:"VR",updateUIPanel:{size:this.__uiGeomOffsetXfo.sc.toJSON()}})}this.updateUIImage()}})}sendMouseEvent(e,t,o){const s=new MouseEvent(e,Object.assign({target:o,view:window,bubbles:!0,cancelable:!0},t));return o.dispatchEvent(s),s}}class U extends i{constructor(e){super("HoldObjectsChange"),this.__selection=[],this.__prevXfos=[],this.__newXfos=[],e&&this.update(e)}undo(){for(let e=0;e<this.__selection.length;e++)this.__selection[e]&&this.__selection[e].setGlobalXfo(this.__prevXfos[e])}redo(){for(let e=0;e<this.__selection.length;e++)this.__selection[e]&&this.__selection[e].setGlobalXfo(this.__newXfos[e])}update(e){if(e.newItem)this.__selection[e.newItemId]=e.newItem,this.__prevXfos[e.newItemId]=e.newItem.getGlobalXfo();else if(e.changeXfos)for(let t=0;t<e.changeXfoIds.length;t++){const o=e.changeXfoIds[t];this.__selection[o]&&(this.__selection[o].setGlobalXfo(e.changeXfos[t]),this.__newXfos[o]=e.changeXfos[t])}this.updated.emit(e)}toJSON(e){const t=super.toJSON(e),o=[];for(let e=0;e<this.__selection.length;e++)this.__selection[e]?o[e]=this.__selection[e].getPath():o.push(null);return t.itemPaths=o,t}fromJSON(e,t){super.fromJSON(e,t);const o=t.appData.scene.getRoot(),s=[];for(let t=0;t<e.itemPaths.length;t++){const a=e.itemPaths[t];a&&(s[t]=o.resolvePath(a,1))}this.__selection=s}}a.registerChange("HoldObjectsChange",U);class L extends D{constructor(e){super(e)}isPrimaryTool(){return!0}}class B extends i{constructor(e){super(e)}setParentAndXfo(e,t){this.parentItem=e;const o=this.parentItem.generateUniqueName(this.geomItem.getName());this.geomItem.setName(o),this.geomItem.setGlobalXfo(t),this.childIndex=this.parentItem.addChild(this.geomItem,!0),this.geomItem.addRef(this)}undo(){this.parentItem.removeChild(this.childIndex)}redo(){this.parentItem.addChild(this.geomItem,!1,!1)}toJSON(e){const t=super.toJSON(e);return t.parentItemPath=this.parentItem.getPath(),t.geomItemName=this.geomItem.getName(),t.geomItemXfo=this.geomItem.getParameter("LocalXfo").getValue(),t}fromJSON(t,o){const s=o.appData.scene.getRoot();this.parentItem=s.resolvePath(t.parentItemPath,1),this.geomItem.setName(this.parentItem.generateUniqueName(t.geomItemName));const a=new e.Xfo;a.fromJSON(t.geomItemXfo),this.geomItem.setLocalXfo(a),this.childIndex=this.parentItem.addChild(this.geomItem,!1)}destroy(){this.geomItem.removeRef(this)}}class H extends L{constructor(t){super(t),this.stage=0,this.removeToolOnRightClick=!0,this.cp=this.addParameter(new e.ColorParameter("Line Color",new e.Color(.7,.2,.2)))}activateTool(){super.activateTool(),this.appData.renderer.getDiv().style.cursor="crosshair",this.appData.renderer.getXRViewport().then(t=>{this.vrControllerToolTip||(this.vrControllerToolTip=new e.Cross(.05),this.vrControllerToolTipMat=new e.Material("VRController Cross","LinesShader"),this.vrControllerToolTipMat.getParameter("Color").setValue(this.cp.getValue()),this.vrControllerToolTipMat.visibleInGeomDataBuffer=!1);const o=t=>{const o=new e.GeomItem("CreateGeomToolTip",this.vrControllerToolTip,this.vrControllerToolTipMat);t.getTipItem().removeAllChildren(),t.getTipItem().addChild(o,!1)};for(const e of t.getControllers())o(e);this.addIconToControllerId=t.on("controllerAdded",o)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getDiv().style.cursor="pointer",this.appData.renderer.getXRViewport().then(e=>{e.removeListenerById("controllerAdded",this.addIconToControllerId)})}screenPosToXfo(t,o){const s=o.calcRayFromScreenPos(t),a=new e.Ray(this.constructionPlane.tr,this.constructionPlane.ori.getZaxis()),i=s.intersectRayPlane(a);if(i>0){const e=this.constructionPlane.clone();return e.tr=s.pointAtDist(i),e}const n=o.getCamera(),r=n.getGlobalXfo().clone();return r.tr=s.pointAtDist(n.getFocalDistance()),r}createStart(e,t){this.stage=1}createPoint(e){}createMove(e){}createRelease(e){}onMouseDown(t){if(0==this.stage){if(0==t.button){this.constructionPlane=new e.Xfo;const o=this.screenPosToXfo(t.mousePos,t.viewport);this.createStart(o,this.appData.scene.getRoot())}else 2==t.button&&this.removeToolOnRightClick&&this.appData.toolManager.removeTool(this.index);return!0}return 2!=t.button||(this.appData.undoRedoManager.undo(!1),this.stage=0,!0)}onMouseMove(e){if(this.stage>0){const t=this.screenPosToXfo(e.mousePos,e.viewport);return this.createMove(t.tr),!0}}onMouseUp(e){if(this.stage>0){const t=this.screenPosToXfo(e.mousePos,e.viewport);return this.createRelease(t.tr),!0}}onWheel(e){}onKeyPressed(e,t){}onKeyDown(e,t){}onKeyUp(e,t){}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onTouchCancel(e){}onVRControllerButtonDown(t){if(!this.__activeController){this.__activeController=t.controller,this.constructionPlane=new e.Xfo;const o=this.constructionPlane.clone();o.tr=this.__activeController.getTipXfo().tr,this.createStart(o,this.appData.scene.getRoot())}return!0}onVRPoseChanged(e){if(this.__activeController&&this.stage>0){const e=this.__activeController.getTipXfo();return this.createMove(e.tr),!0}}onVRControllerButtonUp(e){if(this.stage>0&&this.__activeController==e.controller){const e=this.__activeController.getTipXfo();return this.createRelease(e.tr),0==this.stage&&(this.__activeController=void 0),!0}}}class N extends B{constructor(t,o,s,a){super("Create Line"),this.line=new e.Lines(0),this.line.setNumVertices(2),this.line.setNumSegments(1),this.line.setSegment(0,0,1);const i=new e.Material("Line","LinesShader");i.getParameter("Color").setValue(new e.Color(.7,.2,.2)),this.geomItem=new e.GeomItem("Line"),this.geomItem.setGeometry(this.line),this.geomItem.setMaterial(i),s&&i.getParameter("Color").setValue(s),a&&(this.line.lineThickness=a),t&&o&&this.setParentAndXfo(t,o)}update(e){e.p1&&(this.line.getVertex(1).setFromOther(e.p1),this.line.geomDataChanged.emit()),this.updated.emit(e)}fromJSON(t,o){if(super.fromJSON(t,o),t.color){const o=new e.Color;o.fromJSON(t.color),material.getParameter("Color").setValue(o)}t.thickness&&(this.line.lineThickness=t.thickness)}}a.registerChange("CreateLineChange",N);class F extends H{constructor(t){super(t),this.tp=this.addParameter(new e.NumberParameter("Line Thickness",.06,[0,.1]))}createStart(e,t){this.change=new N(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e.inverse(),this.stage=1,this.length=0}createMove(e){const t=this.xfo.transformVec3(e);this.length=t.length(),this.change.update({p1:t})}createRelease(e){0==this.length&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.emit("actionFinished")}}class z extends B{constructor(t,o){super("Create Circle",t),this.circle=new e.Circle(0,64),this.circle.lineThickness=.05;const s=new e.Material("circle","FatLinesShader");s.getParameter("Color").setValue(new e.Color(.7,.2,.2)),this.geomItem=new e.GeomItem("Circle"),this.geomItem.setGeometry(this.circle),this.geomItem.setMaterial(s),t&&o&&this.setParentAndXfo(t,o)}update(e){this.circle.getParameter("Radius").setValue(e.radius),this.updated.emit(e)}toJSON(){const e=super.toJSON();return e.radius=this.circle.getParameter("Radius").getValue(),e}changeFromJSON(e){console.log("CreateCircleChange:",e),e.radius&&this.circle.getParameter("Radius").setValue(e.radius)}}a.registerChange("CreateCircleChange",z);class J extends B{constructor(t,o){super("Create Rect"),this.rect=new e.Rect(0,0),this.rect.lineThickness=.05;const s=new e.Material("circle","FatLinesShader");s.getParameter("Color").setValue(new e.Color(.7,.2,.2)),this.geomItem=new e.GeomItem("Rect"),this.geomItem.setGeometry(this.rect),this.geomItem.setMaterial(s),t&&o&&this.setParentAndXfo(t,o)}update(e){if(e.baseSize&&this.rect.setSize(e.baseSize[0],e.baseSize[1]),e.tr){const t=this.geomItem.getParameter("LocalXfo").getValue();t.tr.fromJSON(e.tr),this.geomItem.getParameter("LocalXfo").setValue(t)}this.updated.emit(e)}}a.registerChange("CreateRectChange",J);class Z extends B{constructor(t,o,s,a){super("Create Freehand Line"),this.used=0,this.vertexCount=100,this.line=new e.Lines,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),this.line.vertices.setValue(0,new e.Vec3);const i=new e.Material("freeHandLine","FatLinesShader");this.geomItem=new e.GeomItem("freeHandLine"),this.geomItem.setGeometry(this.line),this.geomItem.setMaterial(i),s&&i.getParameter("Color").setValue(s),a&&(this.line.lineThickness=a),t&&o&&this.setParentAndXfo(t,o)}update(e){this.used++;let t=!1;this.used>=this.line.getNumSegments()&&(this.vertexCount=this.vertexCount+100,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),t=!0),this.line.vertices.setValue(this.used,e.point),this.line.setSegment(this.used-1,this.used-1,this.used),t?this.line.geomDataTopologyChanged.emit({indicesChanged:!0}):this.line.geomDataChanged.emit({indicesChanged:!0}),this.updated.emit(e)}toJSON(e){const t=super.toJSON(e);return t.lineThickness=this.line.lineThickness,t.color=this.geomItem.getMaterial().getParameter("Color").getValue(),t}fromJSON(t,o){t.lineThickness&&(this.line.lineThickness=t.lineThickness);const s=new e.Color(.7,.2,.2);t.color&&s.fromJSON(t.color),this.geomItem.getMaterial().getParameter("Color").setValue(s),super.fromJSON(t,o)}}a.registerChange("CreateFreehandLineChange",Z);class W extends B{constructor(t,o){super("Create Sphere",t),this.sphere=new e.Sphere(0,64,32);const s=new e.Material("Sphere","SimpleSurfaceShader");this.geomItem=new e.GeomItem("Sphere"),this.geomItem.setGeometry(this.sphere),this.geomItem.setMaterial(s),t&&o&&this.setParentAndXfo(t,o)}update(e){this.sphere.radius=e.radius,this.updated.emit(e)}toJSON(){const e=super.toJSON();return e.radius=this.geomItem.getGeometry().radius,e}changeFromJSON(e){e.radius&&(this.geomItem.getGeometry().radius=e.radius)}}a.registerChange("CreateSphereChange",W);class K extends B{constructor(t,o){super("Create Cuboid"),this.cuboid=new e.Cuboid(0,0,0,!0);const s=new e.Material("Cuboid","SimpleSurfaceShader");this.geomItem=new e.GeomItem("Cuboid"),this.geomItem.setGeometry(this.cuboid),this.geomItem.setMaterial(s),t&&o&&this.setParentAndXfo(t,o)}update(e){if(e.baseSize&&this.cuboid.setBaseSize(e.baseSize[0],e.baseSize[1]),e.tr){const t=this.geomItem.getParameter("LocalXfo").getValue();t.tr.fromJSON(e.tr),this.geomItem.getParameter("LocalXfo").setValue(t)}e.height&&(this.cuboid.z=e.height),this.updated.emit(e)}}a.registerChange("CreateCuboidChange",K);class j extends r{constructor(t,o=.5,s=.02,a=new e.Color("#F9CE03")){super(t),this.lengthParam=this.addParameter(new e.NumberParameter("Length",o)),this.handleRadiusParam=this.addParameter(new e.NumberParameter("Handle Radius",s)),this.barRadiusParam=this.addParameter(new e.NumberParameter("Bar Radius",.25*s)),this.colorParam=this.addParameter(new e.ColorParameter("Color",a)),this.hilghlightColorParam=this.addParameter(new e.ColorParameter("Highlight Color",new e.Color(1,1,1))),this.handleMat=new e.Material("handle","FlatSurfaceShader"),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue());const i=new e.Material("topBar","FlatSurfaceShader");i.getParameter("BaseColor").setValue(new e.Color(.5,.5,.5));const n=new e.Cylinder(.25*s,1,64,2,!0,!0),r=new e.Sphere(s,64);this.handle=new e.GeomItem("handle",r,this.handleMat),this.baseBar=new e.GeomItem("baseBar",n,this.handleMat),this.topBar=new e.GeomItem("topBar",n,i),this.handleXfo=new e.Xfo,this.baseBarXfo=new e.Xfo,this.topBarXfo=new e.Xfo,this.barRadiusParam.on("valueChanged",()=>{n.getParameter("radius").setValue(this.barRadiusParam.getValue())}),this.handleRadiusParam.on("valueChanged",()=>{r.getParameter("radius").setValue(this.handleRadiusParam.getValue())}),this.lengthParam.on("valueChanged",()=>{this.__updateSlider(this.value)}),this.colorParam.on("valueChanged",()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}),this.addChild(this.handle),this.addChild(this.baseBar),this.addChild(this.topBar),this.__updateSlider(0)}highlight(){this.handleMat.getParameter("BaseColor").setValue(this.hilghlightColorParam.getValue())}unhighlight(){this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}setTargetParam(e){this.param=e;const t=()=>{this.__updateSlider(e.getValue())};t(),e.on("valueChanged",t)}__updateSlider(t){this.value=t;const o=this.param&&this.param.getRange()?this.param.getRange():[0,1],s=Math.remap(t,o[0],o[1],0,1),a=this.lengthParam.getValue();this.baseBarXfo.sc.z=s*a,this.handleXfo.tr.z=s*a,this.topBarXfo.tr.z=s*a,this.topBarXfo.sc.z=(1-s)*a,this.handle.setLocalXfo(this.handleXfo,e.ValueSetMode.GENERATED_VALUE),this.baseBar.setLocalXfo(this.baseBarXfo,e.ValueSetMode.GENERATED_VALUE),this.topBar.setLocalXfo(this.topBarXfo,e.ValueSetMode.GENERATED_VALUE)}onDragStart(t){this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1.2,this.handle.setLocalXfo(this.handleXfo,e.ValueSetMode.GENERATED_VALUE),this.param&&t.undoRedoManager&&(this.change=new h(this.param),t.undoRedoManager.addChange(this.change))}onDrag(e){const t=this.lengthParam.getValue(),o=this.param&&this.param.getRange()?this.param.getRange():[0,1],s=Math.clamp(Math.remap(e.value,0,t,o[0],o[1]),o[0],o[1]);if(!this.param)return this.__updateSlider(s),void(this.value=s);this.change?this.change.update({value:s}):this.param.setValue(s)}onDragEnd(t){this.change=null,this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1,this.handle.setLocalXfo(this.handleXfo,e.ValueSetMode.GENERATED_VALUE)}toJSON(e,t=0){const o=super.toJSON(e,t|SAVE_FLAG_SKIP_CHILDREN);return this.param&&(o.targetParam=this.param.getPath()),o}fromJSON(e,t,o){super.fromJSON(e,t,o),e.targetParam&&t.resolvePath(e.targetParam).then(e=>{this.setTargetParam(e)})}}e.sgFactory.registerClass("SliderHandle",j);class Y extends d{constructor(t,o=1,s=1,a=.02,i=new e.Color(1,1,0)){super(t),this.arcRadiusParam=this.addParameter(new e.NumberParameter("Arc Radius",o)),this.arcAngleParam=this.addParameter(new e.NumberParameter("Arc Angle",s)),this.handleRadiusParam=this.addParameter(new e.NumberParameter("Handle Radius",a)),this.colorParam=this.addParameter(new e.ColorParameter("Color",i)),this.hilghlightColorParam=this.addParameter(new e.ColorParameter("Highlight Color",new e.Color(1,1,1))),this.handleMat=new e.Material("handleMat","HandleShader");const n=new e.Circle(o,s,64),r=new e.Sphere(a,64);this.handle=new e.GeomItem("handle",r,this.handleMat),this.arc=new e.GeomItem("arc",n,this.handleMat),this.handleXfo=new e.Xfo,this.handleGeomOffsetXfo=new e.Xfo,this.handleGeomOffsetXfo.tr.x=o,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.range=[0,s],this.arcAngleParam.on("valueChanged",()=>{const e=this.arcAngleParam.getValue();n.getParameter("Angle").setValue(e),this.range=[0,e]}),this.arcRadiusParam.on("valueChanged",()=>{const e=this.arcRadiusParam.getValue();n.getParameter("Radius").setValue(e),this.handleGeomOffsetXfo.tr.x=e,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo)}),this.handleRadiusParam.on("valueChanged",()=>{r.getParameter("radius").setValue(this.handleRadiusParam.getValue())}),this.colorParam.on("valueChanged",()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}),this.addChild(this.handle),this.addChild(this.arc),this.setTargetParam(this.handle.getParameter("GlobalXfo"),!1)}onMouseEnter(e){e.intersectionData&&e.intersectionData.geomItem==this.handle&&this.highlight()}onMouseLeave(e){this.unhighlight()}onMouseDown(e){e.intersectionData&&e.intersectionData.geomItem==this.handle&&super.onMouseDown(e)}highlight(){this.handleMat.getParameter("BaseColor").setValue(this.hilghlightColorParam.getValue())}unhighlight(){this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}getBaseXfo(){return this.handle.getParameter("GlobalXfo").getValue()}onDragStart(t){this.baseXfo=this.getGlobalXfo().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new e.Xfo,this.vec0=this.getGlobalXfo().ori.getXaxis(),this.vec0.normalizeInPlace(),t.undoRedoManager&&(this.change=new h(this.param),t.undoRedoManager.addChange(this.change)),this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1.2,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.emit("dragStart")}onDrag(e){const t=e.holdPos.subtract(this.baseXfo.tr);t.normalizeInPlace();let o=this.vec0.angleTo(t);if(this.vec0.cross(t).dot(this.baseXfo.ori.getZaxis())<0&&(o=-o),this.range&&(o=Math.clamp(o,this.range[0],this.range[1])),e.shiftKey){const e=Math.degToRad(22.5);o=Math.floor(o/e)*e}this.deltaXfo.ori.setFromAxisAndAngle(new Vec3(0,0,1),o);const s=this.baseXfo.multiply(this.deltaXfo);if(this.change)this.change.update({value:s});else{(this.param?this.param:this.getParameter("GlobalXfo")).setValue(s)}}onDragEnd(e){this.change=null,this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.emit("dragEnd")}toJSON(e,t=0){const o=super.toJSON(e,t|SAVE_FLAG_SKIP_CHILDREN);return this.param&&(o.targetParam=this.param.getPath()),o}fromJSON(e,t,o){super.fromJSON(e,t,o),e.targetParam&&t.resolvePath(e.targetParam).then(e=>{this.setTargetParam(e)})}}e.sgFactory.registerClass("ArcSlider",Y);exports.ArcSlider=Y,exports.AxialRotationHandle=u,exports.Change=i,exports.CreateCircleTool=class extends H{constructor(e){super(e)}createStart(e,t){this.change=new z(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.stage=1,this.radius=0}createMove(e){this.radius=e.distanceTo(this.xfo.tr),this.change.update({radius:this.radius})}createRelease(e){0==this.radius&&this.appData.undoRedoManager.undo(!1),this.change=null,this.stage=0,this.emit("actionFinished")}},exports.CreateCuboidTool=class extends H{constructor(e){super(e)}createStart(e,t){this.change=new K(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.invxfo=e.inverse(),this.stage=1,this._height=0}createMove(e){if(1==this.stage){const t=this.invxfo.transformVec3(e);this.change.update({baseSize:[Math.abs(t.x),Math.abs(t.y)],tr:this.xfo.tr.add(t.scale(.5))})}else{const t=this.invxfo.transformVec3(e);this.change.update({height:t.y})}}createRelease(t,o){if(1==this.stage){this.stage=2,this.pt1=t;const o=new e.Quat;o.setFromAxisAndAngle(new e.Vec3(1,0,0),.5*Math.PI),this.constructionPlane.ori=this.constructionPlane.ori.multiply(o),this.constructionPlane.tr=t,this.invxfo=this.constructionPlane.inverse()}else 2==this.stage&&(this.stage=0,this.emit("actionFinished"))}},exports.CreateFreehandLineTool=class extends F{constructor(t){super(t),this.mp=this.addParameter(new e.BooleanParameter("Modulate Thickness By Stroke Speed",!1))}createStart(e,t){const o=this.cp.getValue(),s=this.tp.getValue();this.change=new Z(t,e,o,s),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.invxfo=e.inverse(),this.stage=1,this.prevP=e.tr,this.length=0}createMove(e){const t=this.invxfo.transformVec3(e),o=t.subtract(this.prevP).length();o>.001&&this.change.update({point:t}),this.length+=o,this.prevP=t}createRelease(e){0==this.length&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.emit("actionFinished")}},exports.CreateLineTool=F,exports.CreateRectTool=class extends H{constructor(e){super(e)}createStart(e,t){this.change=new J(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.invxfo=e.inverse(),this.stage=1,this._size=0}createMove(e){if(1==this.stage){const t=this.invxfo.transformVec3(e);this._size=Math.abs(t.x),Math.abs(t.y),this.change.update({baseSize:[Math.abs(t.x),Math.abs(t.y)],tr:this.xfo.tr.add(t.scale(.5))})}else{const t=this.invxfo.transformVec3(e);this.change.update({height:t.y})}}createRelease(e,t){0==this._size&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.emit("actionFinished")}},exports.CreateSphereTool=class extends H{constructor(e){super(e)}createStart(e,t){this.change=new W(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.stage=1,this.radius=0}createMove(e){this.radius=e.distanceTo(this.xfo.tr),this.change.update({radius:this.radius})}createRelease(e){0==this.radius&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.emit("actionFinished")}},exports.HandleTool=class extends D{constructor(e){super(e),this.activeHandle=void 0,this.capturedItems=[],this.mouseOverItems=[]}activateTool(){super.activateTool(),console.log("activateTool.HandleTool"),this.appData.renderer.getDiv().style.cursor="crosshair";const t=t=>{if(!this.__activated)return;const o=new e.Sphere(.015),s=new e.Material("Cross","FlatSurfaceShader");s.getParameter("BaseColor").setValue(new e.Color("#03E3AC")),s.visibleInGeomDataBuffer=!1;const a=new e.GeomItem("HandleToolTip",o,s);t.getTipItem().removeAllChildren(),t.getTipItem().addChild(a,!1)},o=e=>{for(const o of e.getControllers())t(o);this.addIconToControllerId=e.on("controllerAdded",t)};this.appData.renderer.getXRViewport().then(e=>{o(e)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(e=>{e.removeListenerById("controllerAdded",this.addIconToControllerId)})}onMouseDown(e){if(!this.activeHandle){const t=e.viewport.getGeomDataAtPos(e.mousePos);if(null==t)return;if(t.geomItem.getOwner()instanceof n)return this.activeHandle=t.geomItem.getOwner(),this.activeHandle.handleMouseDown(Object.assign(e,{intersectionData:t})),!0}}onMouseMove(e){if(this.activeHandle)return this.activeHandle.handleMouseMove(e),!0;{if(0==e.button&&1==e.buttons)return!1;const t=e.viewport.getGeomDataAtPos(e.mousePos);if(null!=t&&t.geomItem.getOwner()instanceof n){const e=t.geomItem.getOwner();return this.__highlightedHandle&&this.__highlightedHandle.unhighlight(),this.__highlightedHandle=e,this.__highlightedHandle.highlight(),!0}this.__highlightedHandle&&(this.__highlightedHandle.unhighlight(),this.__highlightedHandle=void 0)}}onMouseUp(e){if(this.activeHandle)return this.activeHandle.handleMouseUp(e),this.activeHandle=void 0,!0}onWheel(e){this.activeHandle&&this.activeHandle.onWheel(e)}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onTouchCancel(e){}__prepareVREvent(e){const t=e.controller.getId();e.setCapture=e=>{this.capturedItems[t]=e},e.getCapture=()=>this.capturedItems[t],e.releaseCapture=()=>{this.capturedItems[t]=null}}onVRControllerButtonDown(e){const t=e.controller.getId();if(this.capturedItems[t])this.__prepareVREvent(e),this.capturedItems[t].onMouseDown(e);else{const t=e.controller.getGeomItemAtTip();null!=t&&(e.intersectionData=t,e.geomItem=t.geomItem,this.__prepareVREvent(e),t.geomItem.onMouseDown(e))}}onVRPoseChanged(e){for(const t of e.controllers){const o=t.getId();if(this.capturedItems[o])this.capturedItems[o].onMouseMove(e);else{const s=t.getGeomItemAtTip();null!=s?(e.intersectionData=s,e.geomItem=s.geomItem,s.geomItem!=this.mouseOverItems[o]&&(this.mouseOverItems[o]&&this.mouseOverItems[o].onMouseLeave(e),this.mouseOverItems[o]=s.geomItem,this.mouseOverItems[o].onMouseEnter(e)),s.geomItem.onMouseMove(e)):this.mouseOverItems[o]&&(this.mouseOverItems[o].onMouseLeave(e),this.mouseOverItems[o]=null)}}}onVRControllerButtonUp(e){this.__prepareVREvent(e);const t=e.controller.getId();if(this.capturedItems[t])this.capturedItems[t].onMouseUp(e);else{const t=e.controller.getGeomItemAtTip();null!=t&&(e.intersectionData=t,e.geomItem=t.geomItem,t.geomItem.onMouseUp(e))}}},exports.LinearMovementHandle=l,exports.OpenVRUITool=class extends D{constructor(e,t){super(e),this.vrUITool=t,this.uiToolIndex=-1,this.__stayClosed=!1}uninstall(){super.uninstall(),this.uiToolIndex>0&&this.appData.toolManager.removeToolByHandle(this.vrUITool)}onVRControllerButtonDown(e){}onVRControllerButtonUp(e){}stayClosed(){this.__stayClosed=!0}onVRPoseChanged(e){if(this.vrUITool.installed())return;const t=e.viewXfo,o=(e,o)=>{if(!e)return!1;const s=e.getTreeItem().getGlobalXfo(),a=s.tr.subtract(t.tr);return a.normalizeInPlace(),a.angleTo(s.ori.getYaxis())<.25*Math.PI?(this.__stayClosed||(this.vrUITool.setUIControllers(this,e,o,t),this.uiToolIndex=this.appData.toolManager.pushTool(this.vrUITool)),!0):void 0};if(e.controllers.length>0){if(o(e.controllers[0],e.controllers[1]))return!0;if(o(e.controllers[1],e.controllers[0]))return!0}this.uiToolIndex=-1,this.__stayClosed=!1}},exports.ParameterValueChange=h,exports.PlanarMovementHandle=c,exports.ScreenSpaceMovementHandle=class extends n{constructor(e){super(e)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}handleMouseDown(t){this.gizmoRay=new e.Ray,this.gizmoRay.dir=t.mouseRay.dir.negate();const o=this.getTargetParam().getValue();this.gizmoRay.pos=o.tr;const s=t.mouseRay.intersectRayPlane(this.gizmoRay);return t.grabPos=t.mouseRay.pointAtDist(s),this.onDragStart(t),!0}handleMouseMove(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.holdPos=e.mouseRay.pointAtDist(t),this.onDrag(e),!0}handleMouseUp(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.releasePos=e.mouseRay.pointAtDist(t),this.onDragEnd(e),!0}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new h(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.grabPos),o=this.baseXfo.clone();if(o.tr.addInPlace(t),this.change)this.change.update({value:o});else{this.getTargetParam().setValue(o)}}onDragEnd(e){this.change=null}},exports.SelectionManager=I,exports.SelectionTool=S,exports.SliderHandle=j,exports.ToolManager=class{constructor(e){this.__toolStack=[],this.appData=e,this.avatarPointerVisible=!1,this.avatarPointerHighlighted=!1}insertTool(e,t){this.__toolStack.splice(t,0,e),e.install(t)}insertToolBefore(e,t){const o=this.__toolStack.indexOf(t)+1;return this.__toolStack.splice(o-1,0,e),e.install(o),o}insertToolAfter(e,t){const o=this.__toolStack.indexOf(t)+1;return this.__toolStack.splice(o,0,e),e.install(o),o==this.__toolStack.length&&e.activateTool(),o}getToolIndex(e){return this.__toolStack.indexOf(e)}removeTool(e){const t=this.__toolStack[e];if(this.__toolStack.splice(e,1),t.uninstall(),e==this.__toolStack.length){t.deactivateTool();const e=this.currTool();e?e.activateTool():this.appData.renderer.getDiv().style.cursor="pointer"}}removeToolByHandle(e){this.removeTool(this.getToolIndex(e))}pushTool(e){const t=this.currTool();if(t){if(e==t)return void console.warn("Tool Already Pushed on the stack:",e.constructor.name);t.deactivateTool()}return this.__toolStack.push(e),e.install(this.__toolStack.length-1),e.activateTool(),console.log("ToolManager.pushTool:",e.constructor.name),this.__toolStack.length-1}__removeCurrTool(){if(this.__toolStack.length>0){const e=this.__toolStack.pop();e.deactivateTool(),e.uninstall()}}popTool(){this.__removeCurrTool();const e=this.currTool();e&&e.activateTool()}replaceCurrentTool(e){this.__removeCurrTool(),this.__toolStack.push(e),e.install(this.__toolStack.length-1),e.activateTool()}currTool(){return this.__toolStack[this.__toolStack.length-1]}currToolName(){return this.__toolStack[this.__toolStack.length-1].getName()}bind(e){const t=e.getViewport();this.mouseDownId=t.on("mouseDown",this.onMouseDown.bind(this)),this.mouseMoveId=t.on("mouseMove",this.onMouseMove.bind(this)),this.mouseUpId=t.on("mouseUp",this.onMouseUp.bind(this)),this.mouseLeaveId=t.on("mouseLeave",this.onMouseLeave.bind(this)),this.mouseDoubleClickedId=t.on("mouseDoubleClicked",this.onDoubleClick.bind(this)),this.mouseWheelId=t.on("mouseWheel",this.onWheel.bind(this)),this.keyDownId=t.on("keyDown",this.onKeyDown.bind(this)),this.keyUpId=t.on("keyUp",this.onKeyUp.bind(this)),this.keyPressedId=t.on("keyPressed",this.onKeyPressed.bind(this)),this.touchStartId=t.on("touchStart",this.onTouchStart.bind(this)),this.touchMoveId=t.on("touchMove",this.onTouchMove.bind(this)),this.touchEndId=t.on("touchEnd",this.onTouchEnd.bind(this)),this.touchCancelId=t.on("touchCancel",this.onTouchCancel.bind(this)),this.doubleTappedId=t.on("doubleTapped",this.onDoubleTap.bind(this)),this.appData.renderer.getXRViewport().then(e=>{this.controllerDownId=e.on("controllerButtonDown",this.onVRControllerButtonDown.bind(this)),this.controllerUpId=e.on("controllerButtonUp",this.onVRControllerButtonUp.bind(this)),this.controllerDoubleClickId=e.on("controllerDoubleClicked",this.onVRControllerDoubleClicked.bind(this)),this.onVRPoseChangedId=e.on("viewChanged",this.onVRPoseChanged.bind(this))})}onMouseDown(e){e.undoRedoManager=this.appData.undoRedoManager,e.showPointerOnAvatar=!0;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onMouseDown(e))break}1==e.showPointerOnAvatar?(this.avatarPointerVisible||(this.emit("movePointer",e),this.avatarPointerVisible=!0),this.avatarPointerHighlighted||(this.emit("hilightPointer",e),this.avatarPointerHighlighted=!0)):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.emit("hidePointer"))}onMouseMove(e){e.undoRedoManager=this.appData.undoRedoManager,e.showPointerOnAvatar=!0;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onMouseMove(e))break}1==e.showPointerOnAvatar?(this.emit("movePointer",e),this.avatarPointerVisible=!0):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.emit("hidePointer"))}onMouseUp(e){e.undoRedoManager=this.appData.undoRedoManager,e.showPointerOnAvatar=!0;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onMouseUp(e))break}1==e.showPointerOnAvatar?this.avatarPointerHighlighted&&(this.emit("unhilightPointer",e),this.avatarPointerHighlighted=!1):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.emit("hidePointer"))}onMouseLeave(e){let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&o.onMouseLeave&&1==o.onMouseLeave(e))break}this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.emit("hidePointer"))}onDoubleClick(e){let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onDoubleClick(e))break}}onWheel(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onWheel(e))break}}onKeyPressed(e,t){t.undoRedoManager=this.appData.undoRedoManager;let o=this.__toolStack.length;for(;o--;){const e=this.__toolStack[o];if(e&&1==e.onKeyPressed(t,t,viewport))break}}onKeyDown(e,t){t.undoRedoManager=this.appData.undoRedoManager;let o=this.__toolStack.length;for(;o--;){const s=this.__toolStack[o];if(s&&1==s.onKeyDown(e,t))break}}onKeyUp(e,t){t.undoRedoManager=this.appData.undoRedoManager;let o=this.__toolStack.length;for(;o--;){const s=this.__toolStack[o];if(s&&1==s.onKeyUp(e,t))break}}onTouchStart(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onTouchStart(e))break}}onTouchMove(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onTouchMove(e))break}}onTouchEnd(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onTouchEnd(e))break}}onTouchCancel(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onTouchCancel(e))break}}onDoubleTap(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onDoubleTap(e))break}}__prepareEvent(e){e.undoRedoManager=this.appData.undoRedoManager,e.propagating=!0,e.stopPropagation=()=>{e.propagating=!1}}onVRControllerButtonDown(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onVRControllerButtonDown(e))break;if(!e.propagating)break}}onVRControllerButtonUp(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onVRControllerButtonUp(e))break;if(!e.propagating)break}}onVRControllerDoubleClicked(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onVRControllerDoubleClicked(e))break;if(!e.propagating)break}}onVRPoseChanged(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onVRPoseChanged(e))break;if(!e.propagating)break}}destroy(){const e=this.appData.renderer.getViewport();e.removeListenerById("mouseDown",this.mouseDownId),e.removeListenerById("mouseMove",this.mouseMoveId),e.removeListenerById("mouseUp",this.mouseUpId),e.removeListenerById("mouseLeave",this.mouseUpId),e.removeListenerById("mouseWheel",this.mouseWheelId),e.removeListenerById("keyDown",this.keyDownId),e.removeListenerById("keyUp",this.keyUpId),e.removeListenerById("keyPressed",this.keyPressedId),e.removeListenerById("touchStart",this.touchStartId),e.removeListenerById("touchMove",this.touchMoveId),e.removeListenerById("touchEnd",this.touchEndId),e.removeListenerById("touchCancel",this.touchCancelId),this.appData.renderer.getXRViewport().then(t=>{e.removeListenerById("controllerDown",this.controllerDownId),e.removeListenerById("controllerUp",this.controllerUpId),e.removeListenerById("viewChanged",this.onVRPoseChangedId)})}},exports.TreeItemAddChange=P,exports.TreeItemMoveChange=b,exports.TreeItemsRemoveChange=w,exports.UndoRedoManager=a,exports.VIEW_TOOL_MODELS=M,exports.VRHoldObjectsTool=class extends D{constructor(e){super(e),this.__pressedButtonCount=0,this.__freeIndices=[],this.__vrControllers=[],this.__heldObjectCount=0,this.__heldGeomItems=[],this.__heldGeomItemIds=[],this.__heldGeomItemRefs=[],this.__heldGeomItemOffsets=[]}activateTool(){super.activateTool(),console.log("activateTool.VRHoldObjectsTool"),this.appData.renderer.getDiv().style.cursor="crosshair";const t=t=>{if(!this.__activated)return;const o=new e.Cross(.03),s=new e.Material("Cross","FlatSurfaceShader");s.getParameter("BaseColor").setValue(new e.Color("#03E3AC")),s.visibleInGeomDataBuffer=!1;const a=new e.GeomItem("HandleToolTip",o,s);t.getTipItem().removeAllChildren(),t.getTipItem().addChild(a,!1)};this.appData.renderer.getXRViewport().then(e=>{for(const o of e.getControllers())t(o);this.addIconToControllerId=e.on("controllerAdded",t)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(e=>{e.removeListenerById("controllerAdded",this.addIconToControllerId)})}computeGrabXfo(t){let o;if(1==t.length)o=this.__vrControllers[t[0]].getTipXfo();else if(2==t.length){const s=this.__vrControllers[t[0]].getTipXfo(),a=this.__vrControllers[t[1]].getTipXfo();s.ori.alignWith(a.ori),o=new e.Xfo,o.tr=s.tr.lerp(a.tr,.5),o.ori=s.ori.lerp(a.ori,.5);let i=a.tr.subtract(s.tr);i.normalizeInPlace();const n=o.ori.getXaxis();i.dot(n)<0&&(i=i.negate());const r=i.angleTo(n);if(r>0){const t=n.cross(i);t.normalizeInPlace();const s=new e.Quat;s.setFromAxisAndAngle(t,r),o.ori=s.multiply(o.ori)}}return o}initAction(){for(let e=0;e<this.__heldGeomItems.length;e++){const t=this.__heldGeomItems[e];if(!t)continue;const o=this.computeGrabXfo(this.__heldGeomItemRefs[e]);this.__heldGeomItemOffsets[e]=o.inverse().multiply(t.getGlobalXfo())}}onVRControllerButtonDown(e){const t=e.controller.getId();this.__vrControllers[t]=e.controller;const o=e.controller.getGeomItemAtTip();if(o){if(o.geomItem.getOwner()instanceof n)return!1;if(e.intersectionData=o,o.geomItem.onMouseDown(e,o),!e.propagating)return!1;let s=this.__heldGeomItems.indexOf(o.geomItem);if(-1==s){s=this.__heldGeomItems.length,this.__heldObjectCount++,this.__heldGeomItems.push(o.geomItem),this.__heldGeomItemRefs[s]=[t],this.__heldGeomItemIds[t]=s;const e={newItem:o.geomItem,newItemId:s};this.change?this.change.update(e):(this.change=new U(e),this.appData.undoRedoManager.addChange(this.change))}else this.__heldGeomItemIds[t]=s,this.__heldGeomItemRefs[s].push(t);return this.initAction(),!0}}onVRControllerButtonUp(e){const t=e.controller.getId();if(this.__pressedButtonCount--,void 0!==this.__heldGeomItemIds[t]){const e=this.__heldGeomItemIds[t],o=this.__heldGeomItemRefs[e];return o.splice(o.indexOf(t),1),0==o.length&&(this.__heldObjectCount--,this.__heldGeomItems[e]=void 0,this.change=void 0),this.__heldGeomItemIds[t]=void 0,this.initAction(),!0}}onVRPoseChanged(e){if(!this.change)return!1;const t=[],o=[];for(let e=0;e<this.__heldGeomItems.length;e++){if(!this.__heldGeomItems[e])continue;const s=this.computeGrabXfo(this.__heldGeomItemRefs[e]);t.push(s.multiply(this.__heldGeomItemOffsets[e])),o.push(e)}return this.change.update({changeXfos:t,changeXfoIds:o}),!0}},exports.VRUITool=class extends D{constructor(t){super(t),this.__vrUIDOMHolderElement=document.createElement("div"),this.__vrUIDOMHolderElement.className="vrUIHolder",this.__vrUIDOMElement=document.createElement("div"),this.__vrUIDOMElement.className="vrUI",document.body.appendChild(this.__vrUIDOMHolderElement),this.controllerUI=new E(t,this.__vrUIDOMHolderElement,this.__vrUIDOMElement),this.controllerUI.addRef(this),t.renderer.addTreeItem(this.controllerUI),this.__uiLocalXfo=new e.Xfo,this.__uiLocalXfo.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),-.6*Math.PI);const o=new e.Material("pointermat","LinesShader");o.visibleInGeomDataBuffer=!1,o.getParameter("Color").setValue(new e.Color(1.2,0,0));const s=new e.Lines;s.setNumVertices(2),s.setNumSegments(1),s.setSegment(0,0,1),s.getVertex(0).set(0,0,0),s.getVertex(1).set(0,0,-1),s.setBoundingBoxDirty(),this.__pointerLocalXfo=new e.Xfo,this.__pointerLocalXfo.sc.set(1,1,.1),this.__pointerLocalXfo.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),-.2*Math.PI),this.__uiPointerItem=new e.GeomItem("VRControllerPointer",s,o),this.__uiPointerItem.addRef(this),this.__triggerHeld=!1}getName(){return"VRUITool"}setUIControllers(e,t,o,s){this.openUITool=e,this.uiController=t,this.pointerController=o;const a=this.uiController.getTreeItem().getGlobalXfo();if(this.pointerController){const e=this.pointerController.getTreeItem().getGlobalXfo(),t=a.tr.subtract(s.tr),o=e.tr.subtract(s.tr);t.cross(o).dot(s.ori.getYaxis())>0?this.__uiLocalXfo.tr.set(.05,-.05,.08):this.__uiLocalXfo.tr.set(-.05,-.05,.08)}else this.__uiLocalXfo.tr.set(0,-.05,.08);this.controllerUI.setLocalXfo(this.__uiLocalXfo)}activateTool(){super.activateTool(),this.controllerUI.activate(),this.uiController&&(this.uiController.getTipItem().addChild(this.controllerUI,!1),this.pointerController&&this.pointerController.getTipItem().addChild(this.__uiPointerItem,!1),this.appData.session.pub("pose-message",{interfaceType:"VR",showUIPanel:{controllerId:this.uiController.getId(),localXfo:this.__uiLocalXfo.toJSON(),size:this.controllerUI.getGeomOffsetXfo().sc.toJSON()}}))}deactivateTool(){super.deactivateTool(),this.controllerUI.deactivate(),this.uiController&&(this.uiController.getTipItem().removeChildByHandle(this.controllerUI),this.pointerController&&this.pointerController.getTipItem().removeChildByHandle(this.__uiPointerItem),this.appData.session.pub("pose-message",{interfaceType:"VR",hideUIPanel:{controllerId:this.uiController.getId()}}))}setPointerLength(e){this.__pointerLocalXfo.sc.set(1,1,e),this.__uiPointerItem.setLocalXfo(this.__pointerLocalXfo)}calcUIIntersection(){const t=this.__uiPointerItem.getGlobalXfo(),o=t.ori.getZaxis().negate(),s=new e.Ray(t.tr,o),a=this.controllerUI.getGlobalXfo(),i=this.controllerUI.getGeomOffsetXfo().sc,n=new e.Ray(a.tr,a.ori.getZaxis().negate()),r=s.intersectRayPlane(n);if(r<=0)return void this.setPointerLength(.5);const h=t.tr.add(o.scale(r)).subtract(n.start),l=h.dot(a.ori.getXaxis())/i.x,c=h.dot(a.ori.getYaxis())/i.y;if(Math.abs(l)>.5||Math.abs(c)>.5)return void this.setPointerLength(.5);this.setPointerLength(r);const d=this.__vrUIDOMElement.getBoundingClientRect();return{clientX:Math.round(l*d.width+d.width/2),clientY:Math.round(c*-d.height+d.height/2)}}sendEventToUI(e,t){const o=this.calcUIIntersection();if(o){o.offsetX=o.pageX=o.pageX=o.screenX=o.clientX,o.offsetY=o.pageY=o.pageY=o.screenY=o.clientY;const s=document.elementFromPoint(o.clientX,o.clientY);return s!=this._element&&(this._element&&this.controllerUI.sendMouseEvent("mouseleave",Object.assign(t,o),this._element),this._element=s,this.controllerUI.sendMouseEvent("mouseenter",Object.assign(t,o),this._element)),this.controllerUI.sendMouseEvent(e,Object.assign(t,o),this._element),this._element}this._element&&(this.controllerUI.sendMouseEvent("mouseleave",Object.assign(t,o),this._element),this._element=null)}onVRControllerButtonDown(e){if(e.controller==this.pointerController){this.__triggerHeld=!0;const t=this.sendEventToUI("mousedown",{button:e.button-1});this.__triggerDownElem=t||null}return!0}onVRControllerButtonUp(e){if(e.controller==this.pointerController){this.__triggerHeld=!1;const t=this.sendEventToUI("mouseup",{button:e.button-1});t&&this.__triggerDownElem==t&&this.sendEventToUI("click",{button:e.button-1}),this.__triggerDownElem=null}return!0}onVRPoseChanged(e){const t=e.viewXfo;return(()=>{const e=this.uiController.getTreeItem().getGlobalXfo(),o=e.tr.subtract(t.tr);return o.normalizeInPlace(),!(o.angleTo(e.ori.getYaxis())>.5*Math.PI)||(this.appData.toolManager.removeToolByHandle(this),!1)})()&&this.sendEventToUI("mousemove",{}),!0}},exports.ViewTool=class extends D{constructor(t,o=M.VIEWER){super(t),console.log("ViewTool:",o),this.__maipulationModel=o,this.__defaultMode="orbit",this.__mode=this.__defaultMode,this.__mouseDragDelta=new e.Vec2,this.__keyboardMovement=!1,this.__keysPressed=[],this.__maxVel=.002,this.__velocity=new e.Vec3,this.__ongoingTouches={},this.__orbitRateParam=this.addParameter(new e.NumberParameter("orbitRate",1)),this.__dollySpeedParam=this.addParameter(new e.NumberParameter("dollySpeed",.02)),this.__mouseWheelDollySpeedParam=this.addParameter(new e.NumberParameter("mouseWheelDollySpeed",.002)),this.__controllerTriggersHeld=[]}activateTool(){super.activateTool(),console.log("activateTool.ViewTool"),this.appData.renderer.getDiv().style.cursor="default",this.appData.renderer.getXRViewport().then(t=>{this.vrControllerToolTip||(this.vrControllerToolTip=new e.Sphere(.015),this.vrControllerToolTipMat=new e.Material("Cross","FlatSurfaceShader"),this.vrControllerToolTipMat.getParameter("BaseColor").setValue(new e.Color("#03E3AC")),this.vrControllerToolTipMat.visibleInGeomDataBuffer=!1);const o=t=>{const o=new e.GeomItem("HandleToolTip",this.vrControllerToolTip,this.vrControllerToolTipMat);t.getTipItem().removeAllChildren(),t.getTipItem().addChild(o,!1)};for(const e of t.getControllers())o(e);this.addIconToControllerId=t.on("controllerAdded",o)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(e=>{e.removeListenerById("controllerAdded",this.addIconToControllerId)})}setDefaultMode(e){this.__defaultMode=e}look(t,o){const s=o.getCamera().getFocalDistance(),a=this.__orbitRateParam.getValue()*e.SystemDesc.isMobileDevice?-1:1;if(this.__keyboardMovement){const e=o.getCamera().getGlobalXfo();this.__mouseDownCameraXfo=e.clone(),this.__mouseDownZaxis=e.ori.getZaxis();const t=this.__mouseDownZaxis.scale(-s);this.__mouseDownCameraTarget=e.tr.add(t)}const i=this.__mouseDownCameraXfo.clone(),n=new e.Quat;n.rotateZ(t.x/o.getWidth()*Math.PI*a),i.ori=n.multiply(i.ori);const r=new e.Quat;r.rotateX(t.y/o.getHeight()*Math.PI*a),i.ori.multiplyInPlace(r),this.__keyboardMovement,o.getCamera().setGlobalXfo(i)}orbit(t,o){const s=o.getCamera().getFocalDistance(),a=this.__orbitRateParam.getValue()*e.SystemDesc.isMobileDevice?-1:1;if(this.__keyboardMovement){const e=o.getCamera().getGlobalXfo();this.__mouseDownCameraXfo=e.clone(),this.__mouseDownZaxis=e.ori.getZaxis();const t=this.__mouseDownZaxis.scale(-s);this.__mouseDownCameraTarget=e.tr.add(t)}const i=this.__mouseDownCameraXfo.clone(),n=new e.Quat;n.rotateZ(t.x/o.getWidth()*2*Math.PI*-a),i.ori=n.multiply(i.ori);const r=new e.Quat;r.rotateX(t.y/o.getHeight()*Math.PI*-a),i.ori.multiplyInPlace(r),i.tr=this.__mouseDownCameraTarget.add(i.ori.getZaxis().scale(s)),this.__keyboardMovement,o.getCamera().setGlobalXfo(i)}pan(t,o){const s=o.getCamera().getFocalDistance(),a=o.getCamera().getFov(),i=new e.Vec3(1,0,0),n=new e.Vec3(0,1,0),r=2*s*Math.tan(.5*a),h=r*(o.getWidth()/o.getHeight()),l=new e.Xfo;l.tr=i.scale(-t.x/o.getWidth()*h),l.tr.addInPlace(n.scale(t.y/o.getHeight()*r)),o.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(l))}dolly(t,o){const s=t.x*this.__dollySpeedParam.getValue(),a=new e.Xfo;a.tr.set(0,0,s),o.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(a))}panAndZoom(t,o,s){const a=s.getCamera().getFocalDistance(),i=s.getCamera().getFov(),n=new e.Vec3(1,0,0),r=new e.Vec3(0,1,0),h=2*a*Math.tan(.5*i),l=h*(s.getWidth()/s.getHeight()),c=new e.Xfo;c.tr=n.scale(-t.x/s.getWidth()*l),c.tr.addInPlace(r.scale(t.y/s.getHeight()*h));const d=o*a;s.getCamera().setFocalDistance(this.__mouseDownFocalDist+d),c.tr.z+=d,s.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(c))}initDrag(e){const t=e.getCamera().getFocalDistance();this.__mouseDragDelta.set(0,0),this.__mouseDownCameraXfo=e.getCamera().getGlobalXfo().clone(),this.__mouseDownZaxis=e.getCamera().getGlobalXfo().ori.getZaxis();const o=this.__mouseDownZaxis.scale(-t);this.__mouseDownCameraTarget=e.getCamera().getGlobalXfo().tr.add(o),this.__mouseDownFocalDist=t}aimFocus(t,o){this.__focusIntervalId&&clearInterval(this.__focusIntervalId);let s=0;const a=()=>{const i=t.getGlobalXfo(),n=t.getFocalDistance(),r=o.subtract(i.tr),h=r.normalizeInPlace(),l=new e.Quat,c=new e.Quat;{const e=i.ori.getZaxis().clone();e.z=0;const t=r.negate();t.z=0,l.setFrom2Vectors(e,t)}{const e=i.ori.getZaxis().clone(),t=r.negate();e.x=t.x,e.y=t.y,e.normalizeInPlace(),e.cross(t).dot(i.ori.getXaxis())>0?c.rotateX(e.angleTo(t)):c.rotateX(-e.angleTo(t))}const d=i.clone();d.ori=l.multiply(d.ori),d.ori.multiplyInPlace(c);const u=Math.pow(s/20,2),g=i.clone();g.ori=i.ori.lerp(d.ori,u),t.setFocalDistance(n+(h-n)*u),t.setGlobalXfo(g),s++,s<=20?this.__focusIntervalId=setTimeout(a,20):(this.__focusIntervalId=void 0,this.emit("movementFinished"))};a(),this.__manipulationState="focussing"}onMouseMove(e){}onDragStart(e){this.__mouseDownPos=e.mousePos,this.initDrag(e.viewport),2==e.button?this.__mode="pan":e.ctrlKey&&2==e.button?this.__mode="dolly":e.shiftKey||2==e.button?this.__mode="look":this.__mode=this.__defaultMode}onDrag(e){switch(this.__keyboardMovement?this.__mouseDragDelta=e.mousePos:this.__mouseDragDelta=e.mousePos.subtract(this.__mouseDownPos),this.__mode){case"orbit":this.orbit(this.__mouseDragDelta,e.viewport);break;case"look":this.look(this.__mouseDragDelta,e.viewport);break;case"pan":this.pan(this.__mouseDragDelta,e.viewport);break;case"dolly":this.dolly(this.__mouseDragDelta,e.viewport)}}onDragEnd(e){return this.emit("movementFinished"),!1}onMouseDown(e){return!(this.__maipulationModel==M.DCC&&!e.altKey)&&(this.dragging=!0,this.__mouseDownPos=e.mousePos,this.onDragStart(e),!0)}onMouseUp(e){if(this.dragging)return this.onDragEnd(e),this.dragging=!1,!0}onMouseMove(e){if(this.dragging)return this.onDrag(e),e.showPointerOnAvatar=!1,!0}onDoubleClick(e){if(e.intersectionData){const t=e.viewport.getCamera(),o=t.getGlobalXfo().tr.add(e.intersectionData.mouseRay.dir.scale(e.intersectionData.dist));this.aimFocus(t,o)}}onWheel(e){if(this.__maipulationModel==M.DCC&&!e.altKey)return!1;const t=e.viewport,o=t.getCamera().getGlobalXfo(),s=o.ori.getZaxis();this.__mouseWheelZoomIntervalId&&clearInterval(this.__mouseWheelZoomIntervalId);let a=0;const i=()=>{const n=t.getCamera().getFocalDistance(),r=this.__mouseWheelDollySpeedParam.getValue(),h=e.deltaY*r*n*.2;o.tr.addInPlace(s.scale(h)),"orbit"==this.__defaultMode&&t.getCamera().setFocalDistance(n+h),t.getCamera().setGlobalXfo(o),a++,a<5?this.__mouseWheelZoomIntervalId=setTimeout(i,20):(this.__mouseWheelZoomIntervalId=void 0,this.emit("movementFinished"),e.viewport.renderGeomDataFbo())};i()}__integrateVelocityChange(t,o){const s=new e.Xfo;s.tr=this.__velocity.normalize().scale(this.__maxVel),o.getCamera().setGlobalXfo(o.getCamera().getGlobalXfo().multiply(s))}onKeyPressed(e,t){return!1}onKeyDown(e,t){}onKeyUp(e,t){return!0}__startTouch(t,o){this.__ongoingTouches[t.identifier]={identifier:t.identifier,pos:new e.Vec2(t.pageX,t.pageY)}}__endTouch(e,t){delete this.__ongoingTouches[e.identifier]}onTouchStart(e){e.preventDefault(),e.stopPropagation(),0==Object.keys(this.__ongoingTouches).length&&(this.__manipMode=void 0);const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__startTouch(t[e]);return this.initDrag(e.viewport),!0}onTouchMove(t){t.preventDefault(),t.stopPropagation();const o=t.changedTouches;if(1==o.length&&"panAndZoom"!=this.__manipMode){const s=o[0],a=new e.Vec2(s.pageX,s.pageY),i=this.__ongoingTouches[s.identifier].pos.subtract(a);return"look"==this.__defaultMode?(i.scaleInPlace(6),this.look(i,t.viewport)):this.orbit(i,t.viewport),this.__manipMode="orbit",!0}if(2==o.length){const s=o[0],a=this.__ongoingTouches[s.identifier],i=o[1],n=this.__ongoingTouches[i.identifier],r=new e.Vec2(s.pageX,s.pageY),h=new e.Vec2(i.pageX,i.pageY),l=n.pos.subtract(a.pos).length()-h.subtract(r).length(),c=r.subtract(a.pos),d=h.subtract(n.pos),u=c.add(d);return u.scaleInPlace(.5),this.panAndZoom(u,.002*l,t.viewport),this.__manipMode="panAndZoom",!0}}onTouchEnd(e){e.preventDefault(),e.stopPropagation();const t=e.changedTouches;switch(this.__manipMode){case"orbit":case"panAndZoom":this.emit("movementFinished")}for(let e=0;e<t.length;e++)this.__endTouch(t[e]);return 0==Object.keys(this.__ongoingTouches).length&&(this.__manipMode=void 0),!0}onTouchCancel(e){console.log("touchcancel.");const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__endTouch(t[e]);return!0}onDoubleTap(e){const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__startTouch(t[e]);if(e.intersectionData){const t=e.viewport.getCamera(),o=t.getGlobalXfo().tr.add(e.intersectionData.mouseRay.dir.scale(e.intersectionData.dist));this.aimFocus(t,o)}}__initMoveStage(e){if(1==this.__controllerTriggersHeld.length)this.__grabPos=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr.clone(),this.stageXfo__GrabStart=e.getXfo().clone(),this.__invOri=this.stageXfo__GrabStart.ori.inverse();else if(2==this.__controllerTriggersHeld.length){const t=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,o=this.__controllerTriggersHeld[1].getControllerTipStageLocalXfo().tr;this.__grabDir=o.subtract(t),this.__grabPos=t.lerp(o,.5),this.__grabDir.y=0,this.__grabDist=this.__grabDir.length(),this.__grabDir.scaleInPlace(1/this.__grabDist),this.stageXfo__GrabStart=e.getXfo().clone(),this.__grab_to_stage=this.__grabPos.subtract(this.stageXfo__GrabStart.tr)}}onVRControllerButtonDown(e){if(1==e.button)return this.__controllerTriggersHeld.push(e.controller),this.__initMoveStage(e.vrviewport),!0}onVRControllerButtonUp(e){if(1!=e.button)return;const t=this.__controllerTriggersHeld.indexOf(e.controller);return this.__controllerTriggersHeld.splice(t,1),this.__initMoveStage(e.vrviewport),!0}onVRControllerDoubleClicked(e){console.log("onVRControllerDoubleClicked:",this.__controllerTriggersHeld.length);const t=e.vrviewport.getXfo().clone();t.sc.set(1,1,1),e.vrviewport.setXfo(t)}onVRPoseChanged(t){if(1==this.__controllerTriggersHeld.length){const o=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,s=new e.Xfo;s.tr=this.__grabPos.subtract(o);const a=this.stageXfo__GrabStart.multiply(s);return t.vrviewport.setXfo(a),!0}if(2==this.__controllerTriggersHeld.length){const o=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,s=this.__controllerTriggersHeld[1].getControllerTipStageLocalXfo().tr,a=o.lerp(s,.5),i=s.subtract(o);i.y=0;const n=i.length();i.scaleInPlace(1/n);const r=new e.Xfo,h=Math.max(Math.min(this.__grabDist/n,10),.1);r.sc.set(h,h,h);let l=this.__grabDir.angleTo(i);this.__grabDir.cross(i).y>0&&(l=-l),r.ori.rotateY(l);const c=r.ori.rotateVec3(this.__grabPos);r.tr.addInPlace(this.__grabPos.subtract(c));const d=this.__grabPos.scale(1-h);r.tr.addInPlace(r.ori.rotateVec3(d));const u=this.__grabPos.subtract(a).scale(h);r.tr.addInPlace(r.ori.rotateVec3(u));const g=this.stageXfo__GrabStart.multiply(r);return t.vrviewport.setXfo(g),!0}}};
