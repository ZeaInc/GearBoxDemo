"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@zeainc/zea-engine");const t={},o={},s=[];class i{constructor(){this.__undoStack=[],this.__redoStack=[],this.changeAdded=new e.Signal,this.changeUpdated=new e.Signal,this.changeUndone=new e.Signal,this.changeRedone=new e.Signal,this.__currChangeUpdated=this.__currChangeUpdated.bind(this)}flush(){for(const e of this.__undoStack)e.destroy();this.__undoStack=[];for(const e of this.__redoStack)e.destroy();this.__redoStack=[]}addChange(e){this.getCurrentChange()&&this.getCurrentChange().updated.disconnect(this.__currChangeUpdated),this.__undoStack.push(e),e.updated.connect(this.__currChangeUpdated);for(const e of this.__redoStack)e.destroy();this.__redoStack=[],this.changeAdded.emit(e)}getCurrentChange(){return this.__undoStack[this.__undoStack.length-1]}__currChangeUpdated(e){this.changeUpdated.emit(e)}undo(e=!0){if(this.__undoStack.length>0){const t=this.__undoStack.pop();t.undo(),e&&(this.__redoStack.push(t),this.changeUndone.emit())}}redo(){if(this.__redoStack.length>0){const e=this.__redoStack.pop();e.redo(),this.__undoStack.push(e),this.changeRedone.emit()}}constructChange(e){return new t[e]}static getChangeClassName(e){const t=s.indexOf(e.constructor);return o[t]?o[t]:(console.warn("Change not registered:",e.constructor.name),e.constructor.name)}static registerChange(e,i){-1!=s.indexOf(i)&&console.warn("Class already registered:",e);const n=s.length;s.push(i),t[e]=i,o[n]=e}}class n{constructor(t){this.name=t||i.getChangeClassName(this),this.updated=new e.Signal}undo(){throw new Error("Implement me")}redo(){throw new Error("Implement me")}update(e){throw new Error("Implement me")}toJSON(e){return{}}fromJSON(e,t){}changeFromJSON(e){this.update(e)}destroy(){}}class a extends e.TreeItem{constructor(e){super(e),this.captured=!1}highlight(){}unhighlight(){}getManipulationPlane(){const t=this.getGlobalXfo();return new e.Ray(t.tr,t.ori.getZaxis())}onMouseEnter(e){this.highlight()}onMouseLeave(e){this.unhighlight()}onMouseDown(e){e.setCapture(this),e.stopPropagation(),this.captured=!0,e.viewport?this.handleMouseDown(e):e.vrviewport&&this.onVRControllerButtonDown(e)}onMouseMove(e){this.captured&&(e.stopPropagation(),e.viewport?this.handleMouseMove(e):e.vrviewport&&this.onVRPoseChanged(e))}onMouseUp(e){this.captured&&(e.releaseCapture(),e.stopPropagation(),this.captured=!1,e.viewport?this.handleMouseUp(e):e.vrviewport&&this.onVRControllerButtonUp(e))}onWheel(e){}handleMouseDown(e){this.gizmoRay=this.getManipulationPlane();const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.grabPos=e.mouseRay.pointAtDist(t),this.onDragStart(e),!0}handleMouseMove(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.holdPos=e.mouseRay.pointAtDist(t),this.onDrag(e),!0}handleMouseUp(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.releasePos=e.mouseRay.pointAtDist(t),this.onDragEnd(e),!0}onVRControllerButtonDown(e){this.activeController=e.controller;const t=this.activeController.getTipXfo().clone(),o=this.getManipulationPlane(),s=t.tr.subtract(o.start),i=t.tr.subtract(o.dir.scale(s.dot(o.dir)));return e.grabPos=i,this.onDragStart(e),!0}onVRPoseChanged(e){if(this.activeController){const t=this.activeController.getTipXfo(),o=this.getManipulationPlane(),s=t.tr.subtract(o.start),i=t.tr.subtract(o.dir.scale(s.dot(o.dir)));return e.holdPos=i,this.onDrag(e),!0}}onVRControllerButtonUp(e){if(this.activeController==e.controller){const t=this.activeController.getTipXfo();return this.onDragEnd(e,t.tr),this.activeController=void 0,!0}}onDragStart(e){console.log("onDragStart",e)}onDrag(e){console.log("onDrag",e)}onDragEnd(e){console.log("onDragEnd",e)}}class r extends a{constructor(e){super(e)}handleMouseDown(e){this.gizmoRay=this.getManipulationPlane(),this.grabDist=e.mouseRay.intersectRayVector(this.gizmoRay)[1];const t=this.gizmoRay.pointAtDist(this.grabDist);return e.grabDist=this.grabDist,e.grabPos=t,this.onDragStart(e),!0}handleMouseMove(e){const t=e.mouseRay.intersectRayVector(this.gizmoRay)[1],o=this.gizmoRay.pointAtDist(t);e.holdDist=t,e.holdPos=o,e.value=t,e.delta=t-this.grabDist,this.onDrag(e)}handleMouseUp(e){const t=e.mouseRay.intersectRayVector(this.gizmoRay)[1],o=this.gizmoRay.pointAtDist(t);return e.releasePos=o,this.onDragEnd(e),!0}onVRControllerButtonDown(e){this.gizmoRay=this.getManipulationPlane(),this.activeController=e.controller;const t=this.activeController.getTipXfo();this.grabDist=t.tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir);const o=this.gizmoRay.start.add(this.gizmoRay.dir.scale(this.grabDist));return e.grabPos=o,this.onDragStart(e),!0}onVRPoseChanged(e){const t=this.activeController.getTipXfo().tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir),o=this.gizmoRay.start.add(this.gizmoRay.dir.scale(t));return e.value=t,e.holdPos=o,e.delta=t-this.grabDist,this.onDrag(e),!0}onVRControllerButtonUp(e){if(this.activeController==e.controller)return this.onDragEnd(),this.activeController=void 0,!0}}class l extends n{constructor(t,o,s=e.ValueSetMode.USER_SETVALUE){t?(super(t?t.getName()+" Changed":"ParameterValueChange"),this.__prevValue=t.getValue(),this.__param=t,this.__mode=s,null!=o&&(this.__nextValue=o,this.__param.setValue(this.__nextValue,s))):super()}undo(){this.__param&&this.__param.setValue(this.__prevValue,this.__mode)}redo(){this.__param&&this.__param.setValue(this.__nextValue,this.__mode)}update(e){if(!this.__param)return;this.__nextValue=e.value;const t=e.mode?e.mode:this.__mode;this.__param.setValue(this.__nextValue,t),this.updated.emit(e)}toJSON(e){const t={name:this.name,paramPath:this.__param.getPath()};return null!=this.__nextValue&&(this.__nextValue.toJSON?t.value=this.__nextValue.toJSON():t.value=this.__nextValue),t}fromJSON(t,o){const s=o.appData.scene.getRoot().resolvePath(t.paramPath,1);s&&s instanceof e.Parameter?(this.__param=s,this.__prevValue=this.__param.getValue(),this.__prevValue.clone?this.__nextValue=this.__prevValue.clone():this.__nextValue=this.__prevValue,this.name=t.name,null!=t.value&&this.changeFromJSON(t)):console.warn("resolvePath is unable to resolve",t.paramPath)}changeFromJSON(t){this.__param&&(this.__nextValue.fromJSON?this.__nextValue.fromJSON(t.value):this.__nextValue=t.value,this.__param.setValue(this.__nextValue,e.ValueSetMode.REMOTEUSER_SETVALUE))}}i.registerChange("ParameterValueChange",l);class h extends r{constructor(t,o,s,i){super(t),this.__color=i,this.__hilightedColor=new e.Color(1,1,1),this.colorParam=this.addParameter(new e.ColorParameter("BaseColor",i));const n=new e.Material("handle","HandleShader");n.getParameter("maintainScreenSize").setValue(1),n.replaceParameter(this.colorParam);const a=new e.Cylinder(s,o,64);a.getParameter("baseZAtZero").setValue(!0);const r=new e.Cone(4*s,10*s,64,!0),l=new e.GeomItem("handle",a,n),h=new e.GeomItem("tip",r,n),c=new e.Xfo;c.tr.set(0,0,o),r.transformVertices(c),this.addChild(l),this.addChild(h)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.valueChanged.connect(t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new l(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.grabPos),o=this.baseXfo.clone();o.tr.addInPlace(t),this.change?this.change.update({value:o}):this.param.setValue(o)}onDragEnd(e){this.change=null}}class c extends a{constructor(e){super(e),this.fullXfoManipulationInVR=!0}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.valueChanged.connect(t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new l(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.grabPos),o=this.baseXfo.clone();if(o.tr.addInPlace(t),this.change)this.change.update({value:o});else{this.getTargetParam().setValue(o)}}onDragEnd(e){this.change=null}onVRControllerButtonDown(e){if(this.fullXfoManipulationInVR){this.activeController=e.controller;const t=this.activeController.getTipXfo(),o=this.getGlobalXfo();this.grabOffset=t.inverse().multiply(o)}else super.onVRControllerButtonDown(e);return!0}onVRPoseChanged(e){if(this.fullXfoManipulationInVR){const e=this.activeController.getTipXfo().multiply(this.grabOffset);if(this.change)this.change.update({value:e});else{this.getTargetParam().setValue(e)}}else super.onVRPoseChanged(e)}onVRControllerButtonUp(e){this.fullXfoManipulationInVR?this.change=null:super.onVRControllerButtonUp(e)}}class d extends a{constructor(e){super(e)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.valueChanged.connect(t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(t){this.baseXfo=this.getGlobalXfo().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new e.Xfo;const o=this.getTargetParam(),s=o.getValue();this.offsetXfo=this.baseXfo.inverse().multiply(s),this.vec0=t.grabPos.subtract(this.baseXfo.tr),this.grabCircleRadius=this.vec0.length(),this.vec0.normalizeInPlace(),t.undoRedoManager&&(this.change=new l(o),t.undoRedoManager.addChange(this.change))}onDrag(t){const o=t.holdPos.subtract(this.baseXfo.tr),s=o.length();o.normalizeInPlace();const i=s/this.grabCircleRadius;let n=this.vec0.angleTo(o)*i;if(this.vec0.cross(o).dot(this.baseXfo.ori.getZaxis())<0&&(n=-n),this.range&&(n=Math.clamp(n,this.range[0],this.range[1])),t.shiftKey){const e=Math.degToRad(22.5);n=Math.floor(n/e)*e}this.deltaXfo.ori.setFromAxisAndAngle(new e.Vec3(0,0,1),n);const a=this.baseXfo.multiply(this.deltaXfo).multiply(this.offsetXfo);if(this.change)this.change.update({value:a});else{this.getTargetParam().setValue(a)}}onDragEnd(e){this.change=null}}class g extends d{constructor(t,o,s,i){super(t),this.__color=i,this.__hilightedColor=new e.Color(1,1,1),this.radiusParam=this.addParameter(new e.NumberParameter("radius",o)),this.colorParam=this.addParameter(new e.ColorParameter("BaseColor",i));const n=new e.Material("handle","HandleShader");n.getParameter("maintainScreenSize").setValue(1),n.replaceParameter(this.colorParam);const a=new e.Torus(s,o,64);this.handle=new e.GeomItem("handle",a,n),this.handleXfo=new e.Xfo,this.radiusParam.valueChanged.connect(()=>{o=this.radiusParam.getValue(),a.getParameter("radius").setValue(o),a.getParameter("height").setValue(.02*o)}),this.addChild(this.handle)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}getBaseXfo(){return this.getParameter("GlobalXfo").getValue()}onDragStart(t){super.onDragStart(t),this.colorParam.setValue(new e.Color(1,1,1))}onDrag(e){super.onDrag(e)}onDragEnd(e){super.onDragEnd(e),this.colorParam.setValue(this.__color)}}class u extends r{constructor(t,o,s,i){super(t),this.__color=i,this.__hilightedColor=new e.Color(1,1,1),this.colorParam=this.addParameter(new e.ColorParameter("BaseColor",i));const n=new e.Material("handle","HandleShader");n.getParameter("maintainScreenSize").setValue(1),n.replaceParameter(this.colorParam);const a=new e.Cylinder(s,o-10*s,64);a.getParameter("baseZAtZero").setValue(!0);const r=new e.Cuboid(10*s,10*s,10*s),l=new e.GeomItem("handle",a,n),h=new e.GeomItem("tip",r,n),c=new e.Xfo;c.tr.set(0,0,o-10*s),r.transformVertices(c),this.addChild(l),this.addChild(h)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.valueChanged.connect(t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabDist=e.grabDist,this.oriXfo=this.getGlobalXfo(),this.tmplocalXfo=this.getLocalXfo();const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new l(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=this.baseXfo.clone(),o=e.holdDist/this.grabDist;o<1e-4||(t.sc.set(this.baseXfo.sc.x*o,this.baseXfo.sc.y*o,this.baseXfo.sc.z*o),this.tmplocalXfo.sc.set(1,1,o),this.setLocalXfo(this.tmplocalXfo),this.change?this.change.update({value:t}):this.param.setValue(t))}onDragEnd(e){this.change=null,this.tmplocalXfo.sc.set(1,1,1),this.setLocalXfo(this.tmplocalXfo);const t=this.getChildByName("tip"),o=t.getLocalXfo();o.sc.set(1,1,1),t.setLocalXfo(o)}}class m extends a{constructor(t,o,s){super(t),this.radius=o;const i=new e.Material("mask","HandleShader");i.getParameter("maintainScreenSize").setValue(1),i.getParameter("BaseColor").setValue(s);const n=new e.Sphere(o,64),a=new e.GeomItem("mask",n,i);this.addChild(a)}highlight(){}unhighlight(){}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.valueChanged.connect(t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}handleMouseDown(e){return!0}handleMouseMove(e){return!0}handleMouseUp(e){return!0}onDragStart(t){this.baseXfo=this.getGlobalXfo(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new e.Xfo;const o=this.getTargetParam();this.offsetXfo=this.baseXfo.inverse().multiply(o.getValue()),this.vec0=t.grabPos.subtract(this.baseXfo.tr),this.vec0.normalizeInPlace(),this.colorParam.setValue(new e.Color(1,1,1)),t.undoRedoManager&&(this.change=new ParameterValueChange(o),t.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.baseXfo.tr);t.normalizeInPlace();const o=this.vec0.angleTo(t)*modulator,s=this.vec0.cross(t).normalize();this.deltaXfo.ori.setFromAxisAndAngle(s,o);const i=this.baseXfo.multiply(this.deltaXfo),n=i.multiply(this.offsetXfo);if(this.change)this.change.update({value:n});else{this.getTargetParam().setValue(i)}}onDragEnd(e){this.change=null,this.colorParam.setValue(this.__color)}}class p extends c{constructor(t,o,s,i){super(t),this.__color=s,this.__hilightedColor=new e.Color(1,1,1),this.sizeParam=this.addParameter(new e.NumberParameter("size",o)),this.colorParam=this.addParameter(new e.ColorParameter("BaseColor",s));const n=new e.Material("handle","HandleShader");n.getParameter("maintainScreenSize").setValue(1),n.replaceParameter(this.colorParam);const a=new e.Cuboid(o,o,.02*o),r=new e.Xfo;r.tr=i,a.transformVertices(r),this.handle=new e.GeomItem("handle",a,n),this.sizeParam.valueChanged.connect(()=>{o=this.sizeParam.getValue(),a.getParameter("size").setValue(o),a.getParameter("height").setValue(.02*o)}),this.addChild(this.handle)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}}class f extends e.TreeItem{constructor(t,o){super("XfoHandle");const s=new e.TreeItem("Translate");s.setVisible(!1),this.addChild(s);const i=new e.Color(1,.1,.1),n=new e.Color("#32CD32"),a=new e.Color("#1E90FF");i.a=.8,n.a=.8,a.a=.8;{const n=new h("linearX",t,o,i),a=new e.Xfo;a.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),.5*Math.PI),n.getParameter("LocalXfo").setValue(a),s.addChild(n)}{const i=new h("linearY",t,o,n),a=new e.Xfo;a.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),-.5*Math.PI),i.getParameter("LocalXfo").setValue(a),s.addChild(i)}{const e=new h("linearZ",t,o,a);s.addChild(e)}const r=.35*t;{const t=new p("planarXY",r,n,new e.Vec3(.5*r,.5*r,0)),o=new e.Xfo;t.getParameter("LocalXfo").setValue(o),s.addChild(t)}{const t=new p("planarYZ",r,i,new e.Vec3(-.5*r,.5*r,0)),o=new e.Xfo;o.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(o),s.addChild(t)}{const t=new p("planarXZ",r,a,new e.Vec3(.5*r,.5*r,0)),o=new e.Xfo;o.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(o),s.addChild(t)}const l=new e.TreeItem("Rotate");l.setVisible(!1),this.addChild(l);{const s=new m("rotation",t-o,new e.Color(1,1,1,.4));l.addChild(s)}{const s=new g("rotationX",t,o,i),n=new e.Xfo;n.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),.5*Math.PI),s.getParameter("LocalXfo").setValue(n),l.addChild(s)}{const s=new g("rotationY",t,o,n),i=new e.Xfo;i.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),.5*Math.PI),s.getParameter("LocalXfo").setValue(i),l.addChild(s)}{const e=new g("rotationZ",t,o,a);l.addChild(e)}const c=new e.TreeItem("Scale");c.setVisible(!1),this.addChild(c);const d=.95*t;{const t=new u("scaleX",d,o,i),s=new e.Xfo;s.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(s),c.addChild(t)}{const t=new u("scaleY",d,o,n),s=new e.Xfo;s.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),-.5*Math.PI),t.getParameter("LocalXfo").setValue(s),c.addChild(t)}{const e=new u("scaleZ",d,o,a);c.addChild(e)}}_cleanGlobalXfo(e){const t=this.getParentItem();if(void 0!==t){const e=t.getGlobalXfo().clone();return e.sc.set(1,1,1),e.multiply(this.__localXfoParam.getValue())}return this.__localXfoParam.getValue()}showHandles(e){this.traverse(e=>{if(e!=this)return e.setVisible(!1),!1});const t=this.getChildByName(e);t&&t.setVisible(!0)}setTargetParam(e){this.param=e,this.traverse(t=>{t instanceof a&&t.setTargetParam(e,!1)})}}class _ extends e.Group{constructor(t){let o,s;super(),t.selectionOutlineColor?o=t.selectionOutlineColor:(o=new e.Color("#03E3AC"),o.a=.1),t.branchSelectionOutlineColor?s=t.branchSelectionOutlineColor:(s=o.lerp(new e.Color("white"),.5),s.a=.1),this.getParameter("HighlightColor").setValue(o),this.addParameter(new e.ColorParameter("SubtreeHighlightColor",s)),this.propagatingSelectionToItems=0!=t.setItemsSelected,this.getParameter("InitialXfoMode").setValue(e.Group.INITIAL_XFO_MODES.average),this.__itemsParam.setFilterFn(t=>t instanceof e.BaseItem)}clone(e){const t=new _;return t.copyFrom(this,e),t}rebindInitialXfos(){Array.from(this.__itemsParam.getValue()).forEach((t,o)=>{t instanceof e.TreeItem&&(this.__initialXfos[o]=t.getGlobalXfo())})}__bindItem(t,o){this.propagatingSelectionToItems&&t.setSelected(this);const s={};if(t instanceof e.TreeItem){const i=this.getParameter("HighlightColor").getValue();i.a=this.getParameter("HighlightFill").getValue();const n=this.getParameter("SubtreeHighlightColor").getValue();t.addHighlight("selected"+this.getId(),i,!1),t.getChildren().forEach(t=>{t instanceof e.TreeItem&&t.addHighlight("branchselected"+this.getId(),n,!0)}),s.globalXfoChangedIndex=t.globalXfoChanged.connect(e=>{this.calculatingGroupXfo||this.propagatingXfoToItems||(this.__initialXfos[o]=t.getGlobalXfo(),this.groupXfoDirty=!0,this._setGlobalXfoDirty())}),this.__initialXfos[o]=t.getGlobalXfo(),this.groupXfoDirty=!0}this.__signalIndices[o]=s}__unbindItem(t,o){this.propagatingSelectionToItems&&t.setSelected(!1),t instanceof e.TreeItem&&(t.removeHighlight("selected"+this.getId()),t.getChildren().forEach(t=>{t instanceof e.TreeItem&&t.removeHighlight("branchselected"+this.getId(),!0)}),t.globalXfoChanged.disconnectId(this.__signalIndices[o].globalXfoChangedIndex),this.__initialXfos.splice(o,1),this.groupXfoDirty=!0),this.__signalIndices.splice(o,1)}_propagateDirtyXfoToItems(){if(this.groupXfoDirty||this.calculatingGroupXfo)return;const t=Array.from(this.__itemsParam.getValue());if(!this.calculatingGroupXfo&&t.length>0&&this.invGroupXfo&&!this.dirty){const o=this.__globalXfoParam.getValue().multiply(this.invGroupXfo);this.propagatingXfoToItems=!0;const s=(e,t)=>{const s=e.getParameter("GlobalXfo"),i=o.multiply(t);s.setValue(i)};t.forEach((t,o)=>{t instanceof e.TreeItem&&s(t,this.__initialXfos[o])}),this.propagatingXfoToItems=!1}}}class I extends n{constructor(e,t,o){super("SelectionChange"),this.__selectionManager=e,this.__prevSelection=t,this.__newSelection=o}undo(){this.__selectionManager.setSelection(this.__prevSelection,!1)}redo(){this.__selectionManager.setSelection(this.__newSelection,!1)}toJSON(e){const t=super.toJSON(e),o=[];for(const e of this.__newSelection)o.push(e.getPath());return t.itemPaths=o,t}fromJSON(e,t){super.fromJSON(e,t),this.__selectionManager=t.appData.selectionManager,this.__prevSelection=new Set(this.__selectionManager.getSelection());const o=t.appData.scene.getRoot(),s=new Set;for(const t of e.itemPaths)s.add(o.resolvePath(t,1));this.__newSelection=s,this.__selectionManager.setSelection(this.__newSelection,!1)}}i.registerChange("SelectionChange",I);class C extends n{constructor(e,t){super("Selection Visibility Change"),this.selection=e,this.state=t,this.do(this.state)}undo(){this.do(!this.state)}redo(){this.do(this.state)}do(e){for(const t of this.selection)t.getParameter("Visible").setValue(e)}}i.registerChange("ToggleSelectionVisibility",C);class w extends n{constructor(e,t,o){e?(super(e.getName()+" Added"),this.treeItem=e,this.owner=t,this.selectionManager=o,this.prevSelection=new Set(this.selectionManager.getSelection()),this.treeItemIndex=this.owner.addChild(this.treeItem),this.selectionManager.setSelection(new Set([this.treeItem]),!1),this.treeItem.addRef(this)):super()}undo(){if(this.treeItem instanceof e.Operator){this.treeItem.detach()}else this.treeItem instanceof e.TreeItem&&this.treeItem.traverse(t=>{if(t instanceof e.Operator){t.detach()}},!1);this.owner.removeChild(this.treeItemIndex),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1)}redo(){if(this.treeItem instanceof e.Operator){this.treeItem.reattach()}else subTreeItem instanceof e.TreeItem&&this.treeItem.traverse(t=>{if(t instanceof e.Operator){t.reattach()}},!1);this.owner.addChild(this.treeItem),this.selectionManager&&this.selectionManager.setSelection(new Set([this.treeItem]),!1)}toJSON(e){return{name:this.name,treeItem:this.treeItem.toJSON(e),treeItemPath:this.treeItem.getPath(),treeItemIndex:this.treeItemIndex}}fromJSON(t,o){const s=e.sgFactory.constructClass(t.treeItem.type);s?(this.name=t.name,this.treeItem=s,this.treeItem.addRef(this),this.treeItem.fromJSON(t.treeItem,o),this.treeItemIndex=this.owner.addChild(this.treeItem,!1,!1)):console.warn("resolvePath is unable to conostruct",t.treeItem)}destroy(){this.treeItem.removeRef(this)}}i.registerChange("TreeItemAddChange",w);class v extends n{constructor(t,o){if(super(),this.items=[],this.itemOwners=[],this.itemPaths=[],this.itemIndices=[],t){this.selectionManager=o.selectionManager,this.prevSelection=new Set(this.selectionManager.getSelection()),this.items=t,this.newSelection=new Set(this.prevSelection);const s=[];this.items.forEach(t=>{const o=t.getOwner(),i=o.getChildIndex(t);if(s.push(t.getName()),t.addRef(this),this.itemOwners.push(o),this.itemPaths.push(t.getPath()),this.itemIndices.push(i),this.selectionManager&&this.newSelection.has(t)&&this.newSelection.delete(t),t instanceof e.Operator){t.detach()}else t instanceof e.TreeItem&&t.traverse(t=>{if(t instanceof e.Operator){t.detach()}this.selectionManager&&this.newSelection.has(t)&&this.newSelection.delete(t)},!1);o.removeChild(i)}),this.selectionManager.setSelection(this.newSelection,!1),this.name=s+" Deleted"}}undo(){this.items.forEach((t,o)=>{if(this.itemOwners[o].insertChild(t,this.itemIndices[o],!1,!1),t instanceof e.Operator){t.reattach()}else subTreeItem instanceof e.TreeItem&&t.traverse(t=>{if(t instanceof e.Operator){t.reattach()}},!1)}),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1)}redo(){this.selectionManager&&this.selectionManager.setSelection(this.newSelection,!1),this.items.forEach((t,o)=>{if(this.itemOwners[o].removeChild(this.itemIndices[o]),t instanceof e.Operator){t.detach()}else subTreeItem instanceof e.TreeItem&&t.traverse(t=>{if(t instanceof e.Operator){t.detach()}},!1)})}toJSON(e){const t={name:this.name,items:[],itemPaths:this.itemPaths,itemIndices:this.itemIndices};return this.items.forEach(e=>{t.items.push(e.toJSON())}),t}fromJSON(e,t){this.name=e.name,e.itemPaths.forEach(e=>{const o=t.scene.getRoot().resolvePath(e,1);if(!o)return void console.warn("resolvePath is unable to resolve",e);const s=o.getOwner();this.itemOwners.push(s),this.itemPaths.push(o.getPath()),this.itemIndices.push(s.getChildIndex(o))})}destroy(){this.items.forEach(e=>e.removeRef(this))}}i.registerChange("TreeItemsRemoveChange",v);class P extends n{constructor(e,t){e?(console.log("TreeItemMoveChange"),super(e.getName()+" Added"),this.treeItem=e,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner=t,this.newOwner.addChild(this.treeItem,!0)):super()}undo(){this.oldOwner.insertChild(this.treeItem,this.oldOwnerIndex,!0)}redo(){this.newOwner.addChild(this.treeItem,!0)}toJSON(e){return{name:this.name,treeItemPath:this.treeItem.getPath(),newOwnerPath:this.newOwner.getPath()}}fromJSON(e,t){const o=appData.scene.getRoot().resolvePath(e.treeItemPath,1);if(!o)return void console.warn("resolvePath is unable to resolve",e.treeItemPath);const s=appData.scene.getRoot().resolvePath(e.newOwnerPath,1);s?(this.name=e.name,this.treeItem=o,this.newOwner=s,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner.addChild(this.treeItem,!0)):console.warn("resolvePath is unable to resolve",e.newOwnerPath)}}i.registerChange("TreeItemMoveChange",P);class b extends e.ParameterOwner{constructor(t){super(),t||console.error("App data not provided to tool"),this.appData=t,this.installChanged=new e.Signal,this.activatedChanged=new e.Signal,this.actionFinished=new e.Signal,this.__params=[],this.__installed=!1,this.__activated=!1}getName(){return this.constructor.name}isPrimaryTool(){return!1}installed(){return this.__installed}install(e){if(this.__installed)throw new Error("Tool already installed");this.index=e,this.__installed=!0,this.installChanged.emit(!0)}uninstall(){this.__installed=!1,this.installChanged.emit(!1)}activateTool(){if(this.__activated)throw new Error("Tool already activate");this.__activated=!0,this.activatedChanged.emit(!0)}deactivateTool(){this.__activated=!1,this.activatedChanged.emit(!1)}onMouseDown(e){}onMouseMove(e){}onMouseUp(e){}onDoubleClick(e){}onWheel(e){}onKeyPressed(e,t){}onKeyDown(e,t){}onKeyUp(e,t){}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onTouchCancel(e){}onDoubleTap(e){}onVRControllerButtonDown(e){}onVRControllerButtonUp(e){}onVRControllerDoubleClicked(e){}onVRPoseChanged(e){}}const T={VIEWER:0,DCC:1};class S extends b{constructor(t){super(t),this.dragging=!1,this.selectionRect=new e.Rect(1,1),this.selectionRectMat=new e.Material("marker","ScreenSpaceShader"),this.selectionRectMat.getParameter("BaseColor").setValue(new e.Color("#03E3AC")),this.selectionRectXfo=new e.Xfo,this.selectionRectXfo.tr.set(.5,.5,0),this.selectionRectXfo.sc.set(0,0,0)}activateTool(){super.activateTool(),this.rectItem||(this.rectItem=new e.GeomItem("selectionRect",this.selectionRect,this.selectionRectMat),this.rectItem.getParameter("Visible").setValue(!1),this.appData.renderer.addTreeItem(this.rectItem))}deactivateTool(){super.deactivateTool(),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.setGlobalXfo(this.selectionRectXfo)}onMouseDown(e){return 0==e.button&&!e.altKey&&(console.log("onMouseDown"),this.mouseDownPos=e.mousePos,this.dragging=!1,!0)}__resizeRect(t,o){const s=new e.Vec2(1/t.getWidth()*2,1/t.getHeight()*2),i=o.multiply(s);this.selectionRectXfo.sc.set(Math.abs(i.x),Math.abs(i.y),1);const n=this.mouseDownPos.subtract(o.scale(.5)).multiply(s).subtract(new e.Vec2(1,1));this.selectionRectXfo.tr.x=n.x,this.selectionRectXfo.tr.y=-n.y,this.rectItem.setGlobalXfo(this.selectionRectXfo)}onMouseMove(e){if(this.mouseDownPos){const t=this.mouseDownPos.subtract(e.mousePos);this.dragging&&this.__resizeRect(e.viewport,t),t.length()>4&&(this.dragging=!0,this.rectItem.getParameter("Visible").setValue(!0),this.__resizeRect(e.viewport,t))}return!0}onMouseUp(t){if(this.mouseDownPos){if(this.dragging){this.rectItem.getParameter("Visible").setValue(!1);const o=t.mousePos,s=new e.Vec2(Math.min(this.mouseDownPos.x,o.x),Math.min(this.mouseDownPos.y,o.y)),i=new e.Vec2(Math.max(this.mouseDownPos.x,o.x),Math.max(this.mouseDownPos.y,o.y)),n=t.viewport.getGeomItemsInRect(s,i);if(this.appData.selectionManager.pickingModeActive())this.appData.selectionManager.pick(n);else{const e=new Set([...n].filter(e=>!(e.getOwner()instanceof a)));t.shiftKey?this.appData.selectionManager.deselectItems(e):this.appData.selectionManager.selectItems(e,!t.ctrlKey),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.setGlobalXfo(this.selectionRectXfo)}}else{const e=t.viewport.getGeomDataAtPos(t.mousePos);if(null==e||e.geomItem.getOwner()instanceof a)this.appData.selectionManager.clearSelection();else if(this.appData.selectionManager.pickingModeActive())this.appData.selectionManager.pick(e.geomItem);else if(t.shiftKey){const t=new Set;t.add(e.geomItem),this.appData.selectionManager.deselectItems(t)}else this.appData.selectionManager.toggleItemSelection(e.geomItem,!t.ctrlKey)}return this.mouseDownPos=void 0,!0}}onVRControllerButtonDown(e){if(1==e.button){const t=e.controller.getGeomItemAtTip();if(null!=t&&!(t.geomItem.getOwner()instanceof a))return this.appData.selectionManager.toggleItemSelection(t.geomItem),!0}}}i.registerChange("SelectionTool",S);const M=function(){return{escape:function(e){return e.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")},parseExtension:e,mimeType:function(t){const o=e(t).toLowerCase();return function(){const e="application/font-woff";return{woff:e,woff2:e,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}()[o]||""},dataAsUrl:function(e,t){return"data:"+t+";base64,"+e},isDataUrl:function(e){return-1!==e.search(/^(data:)/)},canvasToBlob:function(e){return e.toBlob?new Promise((function(t){e.toBlob(t)})):function(e){return new Promise((function(t){const o=window.atob(e.toDataURL().split(",")[1]),s=o.length,i=new Uint8Array(s);for(let e=0;e<s;e++)i[e]=o.charCodeAt(e);t(new Blob([i],{type:"image/png"}))}))}(e)},resolveUrl:function(e,t){const o=document.implementation.createHTMLDocument(),s=o.createElement("base");o.head.appendChild(s);const i=o.createElement("a");return o.body.appendChild(i),s.href=t,i.href=e,i.href},getAndEncode:function(e){R.impl.options.cacheBust&&(e+=(/\?/.test(e)?"&":"?")+(new Date).getTime());return new Promise((function(t){const o=new XMLHttpRequest;let s;if(o.onreadystatechange=function(){if(4!==o.readyState)return;if(200!==o.status)return void(s?t(s):i("cannot fetch resource: "+e+", status: "+o.status));const n=new FileReader;n.onloadend=function(){const e=n.result.split(/,/)[1];t(e)},n.readAsDataURL(o.response)},o.ontimeout=function(){s?t(s):i("timeout of 30000ms occured while fetching resource: "+e)},o.responseType="blob",o.timeout=3e4,o.open("GET",e,!0),o.send(),R.impl.options.imagePlaceholder){const e=R.impl.options.imagePlaceholder.split(/,/);e&&e[1]&&(s=e[1])}function i(e){console.error(e),t("")}}))},uid:function(){let e=0;return function(){return"u"+("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)+e++}}(),delay:function(e){return function(t){return new Promise((function(o){setTimeout((function(){o(t)}),e)}))}},asArray:function(e){const t=[],o=e.length;for(let s=0;s<o;s++)t.push(e[s]);return t},escapeXhtml:function(e){return e.replace(/#/g,"%23").replace(/\n/g,"%0A")},makeImage:function(e){return new Promise((function(t,o){const s=new Image;s.onload=function(){t(s)},s.onerror=o,s.src=e}))},width:function(e){const o=t(e,"border-left-width"),s=t(e,"border-right-width");return e.scrollWidth+o+s},height:function(e){const o=t(e,"border-top-width"),s=t(e,"border-bottom-width");return e.scrollHeight+o+s}};function e(e){const t=/\.([^\.\/]*?)$/g.exec(e);return t?t[1]:""}function t(e,t){const o=window.getComputedStyle(e).getPropertyValue(t);return parseFloat(o.replace("px",""))}}(),D=function(){const e=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:function(e,i,n){return function(){return!t(e)}()?Promise.resolve(e):Promise.resolve(e).then(o).then((function(t){let o=Promise.resolve(e);return t.forEach((function(e){o=o.then((function(t){return s(t,e,i,n)}))})),o}))},shouldProcess:t,impl:{readUrls:o,inline:s}};function t(t){return-1!==t.search(e)}function o(t){const o=[];let s;for(;null!==(s=e.exec(t));)o.push(s[1]);return o.filter((function(e){return!M.isDataUrl(e)}))}function s(e,t,o,s){return Promise.resolve(t).then((function(e){return o?M.resolveUrl(e,o):e})).then(s||M.getAndEncode).then((function(e){return M.dataAsUrl(e,M.mimeType(t))})).then((function(o){return e.replace(function(e){return new RegExp("(url\\(['\"]?)("+M.escape(e)+")(['\"]?\\))","g")}(t),"$1"+o+"$3")}))}}(),V=function(){return{resolveAll:function(){return e().then((function(e){return Promise.all(e.map((function(e){return e.resolve()})))})).then((function(e){return e.join("\n")}))},impl:{readAll:e}};function e(){return Promise.resolve(M.asArray(document.styleSheets)).then((function(e){const t=[];return e.forEach((function(e){try{M.asArray(e.cssRules||[]).forEach(t.push.bind(t))}catch(t){console.log("Error while reading CSS rules from "+e.href,t.toString())}})),t})).then((function(e){return e.filter((function(e){return e.type===CSSRule.FONT_FACE_RULE})).filter((function(e){return D.shouldProcess(e.style.getPropertyValue("src"))}))})).then((function(t){return t.map(e)}));function e(e){return{resolve:function(){const t=(e.parentStyleSheet||{}).href;return D.inlineAll(e.cssText,t)},src:function(){return e.style.getPropertyValue("src")}}}}}(),y=function(){return{inlineAll:function t(o){return o instanceof Element?function(e){const t=e.style.getPropertyValue("background");return t?D.inlineAll(t).then((function(t){e.style.setProperty("background",t,e.style.getPropertyPriority("background"))})).then((function(){return e})):Promise.resolve(e)}(o).then((function(){return o instanceof HTMLImageElement?e(o).inline():Promise.all(M.asArray(o.childNodes).map((function(e){return t(e)})))})):Promise.resolve(o)},impl:{newImage:e}};function e(e){return{inline:function(t){return M.isDataUrl(e.src)?Promise.resolve():Promise.resolve(e.src).then(t||M.getAndEncode).then((function(t){return M.dataAsUrl(t,M.mimeType(e.src))})).then((function(t){return new Promise((function(o,s){e.onload=o,e.onerror=s,e.src=t}))}))}}}}(),X={imagePlaceholder:void 0,cacheBust:!1},R={toSvg:x,toPng:function(e,t){return k(e,t||{}).then((function(e){return e.toDataURL()}))},toJpeg:function(e,t){return k(e,t=t||{}).then((function(e){return e.toDataURL("image/jpeg",t.quality||1)}))},toBlob:function(e,t){return k(e,t||{}).then(M.canvasToBlob)},toPixelData:function(e,t){return k(e,t||{}).then((function(t){return t.getContext("2d").getImageData(0,0,M.width(e),M.height(e)).data}))},toCanvas:function(e,t){return k(e,t||{}).then((function(e){return e}))},impl:{fontFaces:V,images:y,util:M,inliner:D,options:{}}};function x(e,t){return function(e){void 0===e.imagePlaceholder?R.impl.options.imagePlaceholder=X.imagePlaceholder:R.impl.options.imagePlaceholder=e.imagePlaceholder;void 0===e.cacheBust?R.impl.options.cacheBust=X.cacheBust:R.impl.options.cacheBust=e.cacheBust}(t=t||{}),Promise.resolve(e).then((function(e){return function e(t,o,s){return s||!o||o(t)?Promise.resolve(t).then((function(e){return e instanceof HTMLCanvasElement?M.makeImage(e.toDataURL()):e.cloneNode(!1)})).then((function(e){return i(t,e,o)})).then((function(e){return function(e,t){return t instanceof Element?Promise.resolve().then(o).then(s).then(i).then(n).then((function(){return t})):t;function o(){var o,s;o=window.getComputedStyle(e),s=t.style,o.cssText?s.cssText=o.cssText:function(e,t){M.asArray(e).forEach((function(o){t.setProperty(o,e.getPropertyValue(o),e.getPropertyPriority(o))}))}(o,s)}function s(){[":before",":after"].forEach((function(o){!function(o){const s=window.getComputedStyle(e,o),i=s.getPropertyValue("content");if(""===i||"none"===i)return;const n=M.uid();t.className=t.className+" "+n;const a=document.createElement("style");a.appendChild(function(e,t,o){const s="."+e+":"+t,i=o.cssText?function(e){const t=e.getPropertyValue("content");return e.cssText+" content: "+t+";"}(o):function(e){return M.asArray(e).map((function(t){return t+": "+e.getPropertyValue(t)+(e.getPropertyPriority(t)?" !important":"")})).join("; ")+";"}(o);return document.createTextNode(s+"{"+i+"}")}(n,o,s)),t.appendChild(a)}(o)}))}function i(){e instanceof HTMLTextAreaElement&&(t.innerHTML=e.value),e instanceof HTMLInputElement&&t.setAttribute("value",e.value)}function n(){t instanceof SVGElement&&(t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t instanceof SVGRectElement&&["width","height"].forEach((function(e){const o=t.getAttribute(e);o&&t.style.setProperty(e,o)})))}}(t,e)})):Promise.resolve();function i(t,o,s){const i=t.childNodes;return 0===i.length?Promise.resolve(o):n(o,M.asArray(i),s).then((function(){return o}));function n(t,o,s){let i=Promise.resolve();return o.forEach((function(o){i=i.then((function(){return e(o,s)})).then((function(e){e&&t.appendChild(e)}))})),i}}}(e,t.filter,!0)})).then(G).then(O).then((function(e){t.bgcolor&&(e.style.backgroundColor=t.bgcolor);t.width&&(e.style.width=t.width+"px");t.height&&(e.style.height=t.height+"px");t.style&&Object.keys(t.style).forEach((function(o){e.style[o]=t.style[o]}));return e})).then((function(o){return function(e,t,o){return Promise.resolve(e).then((function(e){return e.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),(new XMLSerializer).serializeToString(e)})).then(M.escapeXhtml).then((function(e){return'<foreignObject x="0" y="0" width="100%" height="100%">'+e+"</foreignObject>"})).then((function(e){return'<svg xmlns="http://www.w3.org/2000/svg" width="'+t+'" height="'+o+'">'+e+"</svg>"})).then((function(e){return"data:image/svg+xml;charset=utf-8,"+e}))}(o,t.width||M.width(e),t.height||M.height(e))}))}function k(e,t){return x(e,t).then(M.makeImage).then(M.delay(100)).then((function(o){const s=function(e){const o=document.createElement("canvas");if(o.width=t.width||M.width(e),o.height=t.height||M.height(e),t.bgcolor){const e=o.getContext("2d");e.fillStyle=t.bgcolor,e.fillRect(0,0,o.width,o.height)}return o}(e);return s.getContext("2d").drawImage(o,0,0),s}))}function G(e){return V.resolveAll().then((function(t){const o=document.createElement("style");return e.appendChild(o),o.appendChild(document.createTextNode(t)),e}))}function O(e){return y.inlineAll(e).then((function(){return e}))}class E extends e.GeomItem{constructor(t,o,s){const i=new e.Material("uimat","FlatSurfaceShader");let n;i.visibleInGeomDataBuffer=!1,super("VRControllerUI",new e.Plane(1,1),i),this.appData=t,this.__vrUIDOMHolderElement=o,this.__vrUIDOMElement=s,this.__uiimage=new e.DataImage,i.getParameter("BaseColor").setValue(this.__uiimage),this.__uiGeomOffsetXfo=new e.Xfo,this.__uiGeomOffsetXfo.sc.set(0,0,1),this.__rect={width:0,height:0},this.__uiGeomOffsetXfo.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),Math.PI),this.setGeomOffsetXfo(this.__uiGeomOffsetXfo);let a=[];const r=()=>{n=null;const e=a.map(e=>this.updateElemInAtlas(e));Promise.all(e).then(()=>{this.updateUIImage(),a=[]})};this.__mutationObserver=new MutationObserver(e=>{this.mainCtx?(e.some(e=>{let t=e.target;for(;t.parentNode;){if(t==this.__vrUIDOMElement)return this.renderUIToImage(),a=[],!1;if(t.classList.contains("VRUIElement")||t==this.__vrUIDOMElement){-1==a.indexOf(t)&&a.push(t);break}t=t.parentNode}return!0}),n&&clearTimeout(n),n=setTimeout(r,50)):this.renderUIToImage()}),this.__active=!1,this.__renderRequested=!1}activate(){this.__vrUIDOMHolderElement.style.display="block",this.__active=!0,this.__mutationObserver.observe(this.__vrUIDOMElement,{attributes:!0,characterData:!0,childList:!0,subtree:!0}),this.renderUIToImage()}deactivate(){this.__vrUIDOMHolderElement.style.display="none",this.__active=!0,this.__mutationObserver.disconnect()}updateElemInAtlas(e){return new Promise((t,o)=>{R.toCanvas(e).then(o=>{const s=e.getBoundingClientRect();s.width*s.height!=0?(this.mainCtx.fillRect(s.x,s.y,s.width,s.height),this.mainCtx.drawImage(o,s.x,s.y),t()):t()})})}updateUIImage(){const e=this.mainCtx.getImageData(0,0,this.__rect.width,this.__rect.height);this.__uiimage.setData(this.__rect.width,this.__rect.height,new Uint8Array(e.data.buffer))}renderUIToImage(){R.toCanvas(this.__vrUIDOMElement).then(e=>{this.mainCtx=e.getContext("2d"),this.mainCtx.fillStyle="#FFFFFF";const t=this.__vrUIDOMElement.getBoundingClientRect();if(t.width*t.height!=0){if(t.width!=this.__rect.width||t.height!=this.__rect.height){this.__rect=t;const e=7e-4;this.__uiGeomOffsetXfo.sc.set(this.__rect.width*e,this.__rect.height*e,1),this.setGeomOffsetXfo(this.__uiGeomOffsetXfo),this.appData.session.pub("pose-message",{interfaceType:"VR",updateUIPanel:{size:this.__uiGeomOffsetXfo.sc.toJSON()}})}this.updateUIImage()}})}sendMouseEvent(e,t,o){const s=new MouseEvent(e,Object.assign({target:o,view:window,bubbles:!0,cancelable:!0},t));return o.dispatchEvent(s),s}}class A extends n{constructor(e){super("HoldObjectsChange"),this.__selection=[],this.__prevXfos=[],this.__newXfos=[],e&&this.update(e)}undo(){for(let e=0;e<this.__selection.length;e++)this.__selection[e]&&this.__selection[e].setGlobalXfo(this.__prevXfos[e])}redo(){for(let e=0;e<this.__selection.length;e++)this.__selection[e]&&this.__selection[e].setGlobalXfo(this.__newXfos[e])}update(e){if(e.newItem)this.__selection[e.newItemId]=e.newItem,this.__prevXfos[e.newItemId]=e.newItem.getGlobalXfo();else if(e.changeXfos)for(let t=0;t<e.changeXfoIds.length;t++){const o=e.changeXfoIds[t];this.__selection[o]&&(this.__selection[o].setGlobalXfo(e.changeXfos[t]),this.__newXfos[o]=e.changeXfos[t])}this.updated.emit(e)}toJSON(e){const t=super.toJSON(e),o=[];for(let e=0;e<this.__selection.length;e++)this.__selection[e]?o[e]=this.__selection[e].getPath():o.push(null);return t.itemPaths=o,t}fromJSON(e,t){super.fromJSON(e,t);const o=t.appData.scene.getRoot(),s=[];for(let t=0;t<e.itemPaths.length;t++){const i=e.itemPaths[t];i&&(s[t]=o.resolvePath(i,1))}this.__selection=s}}i.registerChange("HoldObjectsChange",A);class L extends b{constructor(e){super(e)}isPrimaryTool(){return!0}}class N extends n{constructor(e){super(e)}setParentAndXfo(e,t){this.parentItem=e;const o=this.parentItem.generateUniqueName(this.geomItem.getName());this.geomItem.setName(o),this.geomItem.setGlobalXfo(t),this.childIndex=this.parentItem.addChild(this.geomItem,!0),this.geomItem.addRef(this)}undo(){this.parentItem.removeChild(this.childIndex)}redo(){this.parentItem.addChild(this.geomItem,!1,!1)}toJSON(e){const t=super.toJSON(e);return t.parentItemPath=this.parentItem.getPath(),t.geomItemName=this.geomItem.getName(),t.geomItemXfo=this.geomItem.getParameter("LocalXfo").getValue(),t}fromJSON(t,o){const s=o.appData.scene.getRoot();this.parentItem=s.resolvePath(t.parentItemPath,1),this.geomItem.setName(this.parentItem.generateUniqueName(t.geomItemName));const i=new e.Xfo;i.fromJSON(t.geomItemXfo),this.geomItem.setLocalXfo(i),this.childIndex=this.parentItem.addChild(this.geomItem,!1)}destroy(){this.geomItem.removeRef(this)}}class H extends L{constructor(t){super(t),this.stage=0,this.removeToolOnRightClick=!0,this.cp=this.addParameter(new e.ColorParameter("Line Color",new e.Color(.7,.2,.2)))}activateTool(){super.activateTool(),this.appData.renderer.getDiv().style.cursor="crosshair",this.appData.renderer.getXRViewport().then(t=>{this.vrControllerToolTip||(this.vrControllerToolTip=new e.Cross(.05),this.vrControllerToolTipMat=new e.Material("VRController Cross","LinesShader"),this.vrControllerToolTipMat.getParameter("Color").setValue(this.cp.getValue()),this.vrControllerToolTipMat.visibleInGeomDataBuffer=!1);const o=t=>{const o=new e.GeomItem("CreateGeomToolTip",this.vrControllerToolTip,this.vrControllerToolTipMat);t.getTipItem().removeAllChildren(),t.getTipItem().addChild(o,!1)};for(const e of t.getControllers())o(e);this.addIconToControllerId=t.controllerAdded.connect(o)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getDiv().style.cursor="pointer",this.appData.renderer.getXRViewport().then(e=>{e.controllerAdded.disconnectId(this.addIconToControllerId)})}screenPosToXfo(t,o){const s=o.calcRayFromScreenPos(t),i=new e.Ray(this.constructionPlane.tr,this.constructionPlane.ori.getZaxis()),n=s.intersectRayPlane(i);if(n>0){const e=this.constructionPlane.clone();return e.tr=s.pointAtDist(n),e}const a=o.getCamera(),r=a.getGlobalXfo().clone();return r.tr=s.pointAtDist(a.getFocalDistance()),r}createStart(e,t){this.stage=1}createPoint(e){}createMove(e){}createRelease(e){}onMouseDown(t){if(0==this.stage){if(0==t.button){this.constructionPlane=new e.Xfo;const o=this.screenPosToXfo(t.mousePos,t.viewport);this.createStart(o,this.appData.scene.getRoot())}else 2==t.button&&this.removeToolOnRightClick&&this.appData.toolManager.removeTool(this.index);return!0}return 2!=t.button||(this.appData.undoRedoManager.undo(!1),this.stage=0,!0)}onMouseMove(e){if(this.stage>0){const t=this.screenPosToXfo(e.mousePos,e.viewport);return this.createMove(t.tr),!0}}onMouseUp(e){if(this.stage>0){const t=this.screenPosToXfo(e.mousePos,e.viewport);return this.createRelease(t.tr),!0}}onWheel(e){}onKeyPressed(e,t){}onKeyDown(e,t){}onKeyUp(e,t){}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onTouchCancel(e){}onVRControllerButtonDown(t){if(!this.__activeController){this.__activeController=t.controller,this.constructionPlane=new e.Xfo;const o=this.constructionPlane.clone();o.tr=this.__activeController.getTipXfo().tr,this.createStart(o,this.appData.scene.getRoot())}return!0}onVRPoseChanged(e){if(this.__activeController&&this.stage>0){const e=this.__activeController.getTipXfo();return this.createMove(e.tr),!0}}onVRControllerButtonUp(e){if(this.stage>0&&this.__activeController==e.controller){const e=this.__activeController.getTipXfo();return this.createRelease(e.tr),0==this.stage&&(this.__activeController=void 0),!0}}}class U extends N{constructor(t,o,s,i){super("Create Line"),this.line=new e.Lines(0),this.line.setNumVertices(2),this.line.setNumSegments(1),this.line.setSegment(0,0,1);const n=new e.Material("Line","LinesShader");n.getParameter("Color").setValue(new e.Color(.7,.2,.2)),this.geomItem=new e.GeomItem("Line"),this.geomItem.setGeometry(this.line),this.geomItem.setMaterial(n),s&&n.getParameter("Color").setValue(s),i&&(this.line.lineThickness=i),t&&o&&this.setParentAndXfo(t,o)}update(e){e.p1&&(this.line.getVertex(1).setFromOther(e.p1),this.line.geomDataChanged.emit()),this.updated.emit(e)}fromJSON(t,o){if(super.fromJSON(t,o),t.color){const o=new e.Color;o.fromJSON(t.color),material.getParameter("Color").setValue(o)}t.thickness&&(this.line.lineThickness=t.thickness)}}i.registerChange("CreateLineChange",U);class B extends H{constructor(t){super(t),this.tp=this.addParameter(new e.NumberParameter("Line Thickness",.06,[0,.1]))}createStart(e,t){this.change=new U(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e.inverse(),this.stage=1,this.length=0}createMove(e){const t=this.xfo.transformVec3(e);this.length=t.length(),this.change.update({p1:t})}createRelease(e){0==this.length&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.actionFinished.emit()}}class z extends N{constructor(t,o){super("Create Circle",t),this.circle=new e.Circle(0,64),this.circle.lineThickness=.05;const s=new e.Material("circle","FatLinesShader");s.getParameter("Color").setValue(new e.Color(.7,.2,.2)),this.geomItem=new e.GeomItem("Circle"),this.geomItem.setGeometry(this.circle),this.geomItem.setMaterial(s),t&&o&&this.setParentAndXfo(t,o)}update(e){this.circle.getParameter("Radius").setValue(e.radius),this.updated.emit(e)}toJSON(){const e=super.toJSON();return e.radius=this.circle.getParameter("Radius").getValue(),e}changeFromJSON(e){console.log("CreateCircleChange:",e),e.radius&&this.circle.getParameter("Radius").setValue(e.radius)}}i.registerChange("CreateCircleChange",z);class F extends N{constructor(t,o){super("Create Rect"),this.rect=new e.Rect(0,0),this.rect.lineThickness=.05;const s=new e.Material("circle","FatLinesShader");s.getParameter("Color").setValue(new e.Color(.7,.2,.2)),this.geomItem=new e.GeomItem("Rect"),this.geomItem.setGeometry(this.rect),this.geomItem.setMaterial(s),t&&o&&this.setParentAndXfo(t,o)}update(e){if(e.baseSize&&this.rect.setSize(e.baseSize[0],e.baseSize[1]),e.tr){const t=this.geomItem.getParameter("LocalXfo").getValue();t.tr.fromJSON(e.tr),this.geomItem.getParameter("LocalXfo").setValue(t)}this.updated.emit(e)}}i.registerChange("CreateRectChange",F);class J extends N{constructor(t,o,s,i){super("Create Freehand Line"),this.used=0,this.vertexCount=100,this.line=new e.Lines,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),this.line.vertices.setValue(0,new e.Vec3);const n=new e.Material("freeHandLine","FatLinesShader");this.geomItem=new e.GeomItem("freeHandLine"),this.geomItem.setGeometry(this.line),this.geomItem.setMaterial(n),s&&n.getParameter("Color").setValue(s),i&&(this.line.lineThickness=i),t&&o&&this.setParentAndXfo(t,o)}update(e){this.used++;let t=!1;this.used>=this.line.getNumSegments()&&(this.vertexCount=this.vertexCount+100,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),t=!0),this.line.vertices.setValue(this.used,e.point),this.line.setSegment(this.used-1,this.used-1,this.used),t?this.line.geomDataTopologyChanged.emit({indicesChanged:!0}):this.line.geomDataChanged.emit({indicesChanged:!0}),this.updated.emit(e)}toJSON(e){const t=super.toJSON(e);return t.lineThickness=this.line.lineThickness,t.color=this.geomItem.getMaterial().getParameter("Color").getValue(),t}fromJSON(t,o){t.lineThickness&&(this.line.lineThickness=t.lineThickness);const s=new e.Color(.7,.2,.2);t.color&&s.fromJSON(t.color),this.geomItem.getMaterial().getParameter("Color").setValue(s),super.fromJSON(t,o)}}i.registerChange("CreateFreehandLineChange",J);class Z extends N{constructor(t,o){super("Create Sphere",t),this.sphere=new e.Sphere(0,64,32);const s=new e.Material("Sphere","SimpleSurfaceShader");this.geomItem=new e.GeomItem("Sphere"),this.geomItem.setGeometry(this.sphere),this.geomItem.setMaterial(s),t&&o&&this.setParentAndXfo(t,o)}update(e){this.sphere.radius=e.radius,this.updated.emit(e)}toJSON(){const e=super.toJSON();return e.radius=this.geomItem.getGeometry().radius,e}changeFromJSON(e){e.radius&&(this.geomItem.getGeometry().radius=e.radius)}}i.registerChange("CreateSphereChange",Z);class K extends N{constructor(t,o){super("Create Cuboid"),this.cuboid=new e.Cuboid(0,0,0,!0);const s=new e.Material("Cuboid","SimpleSurfaceShader");this.geomItem=new e.GeomItem("Cuboid"),this.geomItem.setGeometry(this.cuboid),this.geomItem.setMaterial(s),t&&o&&this.setParentAndXfo(t,o)}update(e){if(e.baseSize&&this.cuboid.setBaseSize(e.baseSize[0],e.baseSize[1]),e.tr){const t=this.geomItem.getParameter("LocalXfo").getValue();t.tr.fromJSON(e.tr),this.geomItem.getParameter("LocalXfo").setValue(t)}e.height&&(this.cuboid.z=e.height),this.updated.emit(e)}}i.registerChange("CreateCuboidChange",K);class W extends r{constructor(t,o=.5,s=.02,i=new e.Color(1,1,0)){super(t),this.lengthParam=this.addParameter(new e.NumberParameter("Length",o)),this.handleRadiusParam=this.addParameter(new e.NumberParameter("Handle Radius",s)),this.barRadiusParam=this.addParameter(new e.NumberParameter("Bar Radius",.25*s)),this.colorParam=this.addParameter(new e.ColorParameter("Color",i)),this.hilghlightColorParam=this.addParameter(new e.ColorParameter("Highlight Color",new e.Color(1,1,1))),this.handleMat=new e.Material("handle","FlatSurfaceShader"),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue());const n=new e.Material("topBar","FlatSurfaceShader");n.getParameter("BaseColor").setValue(new e.Color(.5,.5,.5));const a=new e.Cylinder(.25*s,1,64,2,!0,!0),r=new e.Sphere(s,64);this.handle=new e.GeomItem("handle",r,this.handleMat),this.baseBar=new e.GeomItem("baseBar",a,this.handleMat),this.topBar=new e.GeomItem("topBar",a,n),this.handleXfo=new e.Xfo,this.baseBarXfo=new e.Xfo,this.topBarXfo=new e.Xfo,this.barRadiusParam.valueChanged.connect(()=>{a.getParameter("radius").setValue(this.barRadiusParam.getValue())}),this.handleRadiusParam.valueChanged.connect(()=>{r.getParameter("radius").setValue(this.handleRadiusParam.getValue())}),this.lengthParam.valueChanged.connect(()=>{this.__updateSlider(this.value)}),this.colorParam.valueChanged.connect(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}),this.addChild(this.handle),this.addChild(this.baseBar),this.addChild(this.topBar),this.__updateSlider(0)}highlight(){this.handleMat.getParameter("BaseColor").setValue(this.hilghlightColorParam.getValue())}unhighlight(){this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}setTargetParam(e){this.param=e;const t=()=>{this.__updateSlider(e.getValue())};t(),e.valueChanged.connect(t)}__updateSlider(t){this.value=t;const o=this.param&&this.param.getRange()?this.param.getRange():[0,1],s=Math.remap(t,o[0],o[1],0,1),i=this.lengthParam.getValue();this.baseBarXfo.sc.z=s*i,this.handleXfo.tr.z=s*i,this.topBarXfo.tr.z=s*i,this.topBarXfo.sc.z=(1-s)*i,this.handle.setLocalXfo(this.handleXfo,e.ValueSetMode.GENERATED_VALUE),this.baseBar.setLocalXfo(this.baseBarXfo,e.ValueSetMode.GENERATED_VALUE),this.topBar.setLocalXfo(this.topBarXfo,e.ValueSetMode.GENERATED_VALUE)}onDragStart(t){this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1.2,this.handle.setLocalXfo(this.handleXfo,e.ValueSetMode.GENERATED_VALUE),this.param&&t.undoRedoManager&&(this.change=new l(this.param),t.undoRedoManager.addChange(this.change))}onDrag(e){const t=this.lengthParam.getValue(),o=this.param&&this.param.getRange()?this.param.getRange():[0,1],s=Math.clamp(Math.remap(e.value,0,t,o[0],o[1]),o[0],o[1]);if(!this.param)return this.__updateSlider(s),void(this.value=s);this.change?this.change.update({value:s}):this.param.setValue(s)}onDragEnd(t){this.change=null,this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1,this.handle.setLocalXfo(this.handleXfo,e.ValueSetMode.GENERATED_VALUE)}toJSON(e,t=0){const o=super.toJSON(e,t|SAVE_FLAG_SKIP_CHILDREN);return this.param&&(o.targetParam=this.param.getPath()),o}fromJSON(e,t,o){super.fromJSON(e,t,o),e.targetParam&&t.resolvePath(e.targetParam).then(e=>{this.setTargetParam(e)})}}e.sgFactory.registerClass("SliderHandle",W);class j extends d{constructor(t,o=1,s=1,i=.02,n=new e.Color(1,1,0)){super(t),this.arcRadiusParam=this.addParameter(new e.NumberParameter("Arc Radius",o)),this.arcAngleParam=this.addParameter(new e.NumberParameter("Arc Angle",s)),this.handleRadiusParam=this.addParameter(new e.NumberParameter("Handle Radius",i)),this.colorParam=this.addParameter(new e.ColorParameter("Color",n)),this.hilghlightColorParam=this.addParameter(new e.ColorParameter("Highlight Color",new e.Color(1,1,1))),this.handleMat=new e.Material("handleMat","HandleShader");const a=new e.Circle(o,s,64),r=new e.Sphere(i,64);this.handle=new e.GeomItem("handle",r,this.handleMat),this.arc=new e.GeomItem("arc",a,this.handleMat),this.handleXfo=new e.Xfo,this.handleGeomOffsetXfo=new e.Xfo,this.handleGeomOffsetXfo.tr.x=o,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.range=[0,s],this.arcAngleParam.valueChanged.connect(()=>{const e=this.arcAngleParam.getValue();a.getParameter("Angle").setValue(e),this.range=[0,e]}),this.arcRadiusParam.valueChanged.connect(()=>{const e=this.arcRadiusParam.getValue();a.getParameter("Radius").setValue(e),this.handleGeomOffsetXfo.tr.x=e,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo)}),this.handleRadiusParam.valueChanged.connect(()=>{r.getParameter("radius").setValue(this.handleRadiusParam.getValue())}),this.colorParam.valueChanged.connect(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}),this.addChild(this.handle),this.addChild(this.arc),this.setTargetParam(this.handle.getParameter("GlobalXfo"),!1),this.dragStart=new e.Signal,this.dragEnd=new e.Signal}onMouseEnter(e){e.intersectionData&&e.intersectionData.geomItem==this.handle&&this.highlight()}onMouseLeave(e){this.unhighlight()}onMouseDown(e){e.intersectionData&&e.intersectionData.geomItem==this.handle&&super.onMouseDown(e)}highlight(){this.handleMat.getParameter("BaseColor").setValue(this.hilghlightColorParam.getValue())}unhighlight(){this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}getBaseXfo(){return this.handle.getParameter("GlobalXfo").getValue()}onDragStart(t){this.baseXfo=this.getGlobalXfo().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new e.Xfo,this.vec0=this.getGlobalXfo().ori.getXaxis(),this.vec0.normalizeInPlace(),t.undoRedoManager&&(this.change=new l(this.param),t.undoRedoManager.addChange(this.change)),this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1.2,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.dragStart.emit()}onDrag(e){const t=e.holdPos.subtract(this.baseXfo.tr);t.normalizeInPlace();let o=this.vec0.angleTo(t);if(this.vec0.cross(t).dot(this.baseXfo.ori.getZaxis())<0&&(o=-o),this.range&&(o=Math.clamp(o,this.range[0],this.range[1])),e.shiftKey){const e=Math.degToRad(22.5);o=Math.floor(o/e)*e}this.deltaXfo.ori.setFromAxisAndAngle(new Vec3(0,0,1),o);const s=this.baseXfo.multiply(this.deltaXfo);if(this.change)this.change.update({value:s});else{(this.param?this.param:this.getParameter("GlobalXfo")).setValue(s)}}onDragEnd(e){this.change=null,this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.dragEnd.emit()}toJSON(e,t=0){const o=super.toJSON(e,t|SAVE_FLAG_SKIP_CHILDREN);return this.param&&(o.targetParam=this.param.getPath()),o}fromJSON(e,t,o){super.fromJSON(e,t,o),e.targetParam&&t.resolvePath(e.targetParam).then(e=>{this.setTargetParam(e)})}}e.sgFactory.registerClass("ArcSlider",j);class Y extends HTMLElement{constructor(){super();const e=this.attachShadow({mode:"open"}),t=document.createElement("style");t.appendChild(document.createTextNode(Y.css)),e.appendChild(t),this.itemContainer=document.createElement("div"),this.itemHeader=document.createElement("div"),this.itemHeader.className="TreeNodeHeader",this.itemContainer.appendChild(this.itemHeader),this.itemChildren=document.createElement("div"),this.itemChildren.className="TreeNodesList",this.itemContainer.appendChild(this.itemChildren),this.expandBtn=document.createElement("button"),this.expandBtn.className="TreeNodesListItem__ToggleExpanded",this.itemHeader.appendChild(this.expandBtn),this.expanded=!1,this.childrenAlreadyCreated=!1,this.expandBtn.addEventListener("click",()=>{this.treeItem.getNumChildren()>0&&(this.expanded?this.collapse():this.expand())}),this.titleElement=document.createElement("span"),this.titleElement.className="TreeNodesListItem__Title",this.titleElement.addEventListener("click",e=>{this.appData&&this.appData.selectionManager?this.appData.selectionManager.pickingModeActive()?this.appData.selectionManager.pick(this.treeItem):this.appData.selectionManager.toggleItemSelection(this.treeItem,!e.ctrlKey):this.treeItem.setSelected(!this.treeItem.getSelected())}),this.itemHeader.appendChild(this.titleElement),e.appendChild(this.itemContainer)}setTreeItem(t,o){this.treeItem=t,this.appData=o,this.titleElement.textContent=t.getName();this.treeItem.nameChanged.connect(()=>{this.titleElement.textContent=t.getName()}),this.updateSelectedId=this.treeItem.selectedChanged.connect(this.updateSelected.bind(this)),this.updateSelected(),t instanceof e.TreeItem&&(this.toggleVisibilityBtn=document.createElement("button"),this.toggleVisibilityBtn.className="TreeNodesListItem__ToggleVisibility",this.itemHeader.insertBefore(this.toggleVisibilityBtn,this.titleElement),this.toggleVisibilityBtn.innerHTML='<i class="material-icons-outlined md-15">visibility</i>',this.toggleVisibilityBtn.addEventListener("click",()=>{const e=this.treeItem.getParameter("Visible");if(this.appData&&this.appData.undoRedoManager){const t=new ParameterValueChange(e,!e.getValue());this.appData.undoRedoManager.addChange(t)}else e.setValue(!e.getValue())}),this.updateVisibilityId=this.treeItem.visibilityChanged.connect(this.updateVisibility.bind(this)),this.updateVisibility(),this.updateHighlightId=this.treeItem.highlightChanged.connect(this.updateHighlight.bind(this)),this.updateHighlight(),this.treeItem.getChildren().length&&this.collapse(),this.childAddedId=this.treeItem.childAdded.connect(this.childAdded.bind(this)),this.childRemovedId=this.treeItem.childRemoved.connect(this.childRemoved.bind(this)))}updateVisibility(){const e=this.treeItem.getVisible();e?this.itemContainer.classList.remove("TreeNodesListItem--isHidden"):this.itemContainer.classList.add("TreeNodesListItem--isHidden"),this.toggleVisibilityBtn.innerHTML=e?'<i class="material-icons-outlined md-15">visibility</i>':'<i class="material-icons-outlined md-15">visibility_off</i>'}updateSelected(){this.treeItem.getSelected()?this.itemContainer.classList.add("TreeNodesListItem--isSelected"):this.itemContainer.classList.remove("TreeNodesListItem--isSelected")}updateHighlight(){const t=this.treeItem.isHighlighted();if(t?this.itemContainer.classList.add("TreeNodesListItem--isHighlighted"):this.itemContainer.classList.remove("TreeNodesListItem--isHighlighted"),t){const t=this.treeItem.getHighlight(),o=t.lerp(new e.Color(.75,.75,.75,0),.5);this.titleElement.style.setProperty("border-color",t.toHex()),this.titleElement.style.setProperty("background-color",o.toHex())}else this.titleElement.style.removeProperty("border-color"),this.titleElement.style.removeProperty("background-color")}expand(){if(this.expanded=!0,this.itemChildren.classList.remove("TreeNodesList--collapsed"),this.expandBtn.innerHTML='<i class="material-icons md-24">arrow_drop_down</i>',!this.childrenAlreadyCreated){this.treeItem.getChildren().forEach((e,t)=>{this.addChild(e,t)}),this.childrenAlreadyCreated=!0}}collapse(){this.itemChildren.classList.add("TreeNodesList--collapsed"),this.expandBtn.innerHTML='<i class="material-icons md-24">arrow_right</i>',this.expanded=!1}addChild(e,t){if(this.expanded){const o=document.createElement("tree-item-view");o.setTreeItem(e,this.appData),t==this.itemChildren.childElementCount?this.itemChildren.appendChild(o):this.itemChildren.insertBefore(o,this.itemChildren.children[t])}else this.collapse()}childAdded(e,t){this.addChild(e,t)}childRemoved(e,t){this.expanded&&(this.itemChildren.children[t].destroy(),this.itemChildren.removeChild(this.itemChildren.children[t]))}destroy(){this.treeItem.selectedChanged.disconnectId(this.updateSelectedId),this.treeItem instanceof e.TreeItem&&(this.treeItem.highlightChanged.disconnectId(this.updateHighlightId),this.treeItem.visibilityChanged.disconnectId(this.updateVisibilityId),this.treeItem.childAdded.disconnectId(this.childAddedId),this.treeItem.childRemoved.disconnectId(this.childRemovedId))}}Y.css="\n  /* tree-view.css */\n\n  ////\n  /// From https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined\n\n  /* fallback */\n  @font-face {\n    font-family: 'Material Icons';\n    font-style: normal;\n    font-weight: 400;\n    src: url(https://fonts.gstatic.com/s/materialicons/v48/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2) format('woff2');\n  }\n  /* fallback */\n  @font-face {\n    font-family: 'Material Icons Outlined';\n    font-style: normal;\n    font-weight: 400;\n    src: url(https://fonts.gstatic.com/s/materialiconsoutlined/v14/gok-H7zzDkdnRel8-DQ6KAXJ69wP1tGnf4ZGhUce.woff2) format('woff2');\n  }\n\n  .material-icons {\n    font-family: 'Material Icons';\n    font-weight: normal;\n    font-style: normal;\n    font-size: 24px;\n    line-height: 1;\n    letter-spacing: normal;\n    text-transform: none;\n    display: inline-block;\n    white-space: nowrap;\n    word-wrap: normal;\n    direction: ltr;\n    -webkit-font-feature-settings: 'liga';\n    -webkit-font-smoothing: antialiased;\n  }\n\n  .material-icons-outlined {\n    font-family: 'Material Icons Outlined';\n    font-weight: normal;\n    font-style: normal;\n    font-size: 24px;\n    line-height: 1;\n    letter-spacing: normal;\n    text-transform: none;\n    display: inline-block;\n    white-space: nowrap;\n    word-wrap: normal;\n    direction: ltr;\n    -webkit-font-feature-settings: 'liga';\n    -webkit-font-smoothing: antialiased;\n  }\n  .TreeNodesList {\n    border-left: 1px dotted;\n    list-style-type: none;\n    padding: 0 0 0 15px;\n    margin: 0 0 0 10px;\n  }\n\n  .TreeNodesList--collapsed {\n    display: none;\n  }\n\n  .TreeNodesList--root {\n    border: none;\n    margin: 0;\n    padding: 0;\n    width: max-content;\n  }\n\n  .TreeNodesListItem{\n    display: flex;\n  }\n\n  .TreeNodesListItem__ToggleVisibility {\n    border: none;\n    color: #333;\n    height: 24px;\n    padding: 0;\n    width: 25px;\n  }\n\n  .TreeNodesListItem__ToggleVisibility:focus {\n    outline: none;\n  }\n\n  .TreeNodesListItem__ToggleExpanded {\n    border: none;\n    height: 24px;\n    width: 24px;\n    padding: 0;\n    background-color: #0000;\n    outline: none;\n  }\n\n  .TreeNodesListItem::before {\n    border-bottom: 1px dotted;\n    content: '';\n    display: inline-block;\n    left: -15px;\n    position: relative;\n    top: -5px;\n    width: 10px;\n  }\n\n  .TreeNodesListItem__Toggle:focus {\n    outline: none;\n  }\n\n  .TreeNodeHeader{\n    display: flex;\n    margin: 0.4em auto;\n  }\n\n  .TreeNodesListItem__Title {\n    cursor: default;\n    padding: 2px 4px;\n    border-radius: 5px;\n  }\n\n  .TreeNodesListItem__Title:hover {\n    background-color: #e1f5fe;\n  }\n  .TreeNodesListItem__Hover {\n    background-color: #e1f5fe;\n  }\n\n  .TreeNodesListItem__Dragging {\n    background-color: #e1f5fe;\n  }\n\n  .TreeNodesListItem--isSelected > .TreeNodeHeader > .TreeNodesListItem__Title {\n    background-color: #76d2bb;\n    color: #3B3B3B;\n  }\n\n  .TreeNodesListItem--isHidden > .TreeNodeHeader >  .TreeNodesListItem__Title {\n    color: #9e9e9e;\n  }\n\n  .TreeNodesListItem--isHighlighted > .TreeNodeHeader >  .TreeNodesListItem__Title {\n    border-style: solid;\n    border-width: thin;\n  }\n\n  /* Rules for sizing the icon. */\n  .material-icons-outlined.md-15,\n  .material-icons.md-15 {\n    font-size: 15px;\n  }\n  .material-icons.md-18 {\n    font-size: 18px;\n  }\n  .material-icons.md-24 {\n    font-size: 24px;\n  }\n  .material-icons.md-36 {\n    font-size: 36px;\n  }\n  .material-icons.md-48 {\n    font-size: 48px;\n  }\n\n  /* Rules for using icons as black on a light background. */\n  .material-icons.md-dark {\n    color: rgba(0, 0, 0, 0.54);\n  }\n  .material-icons.md-dark.md-inactive {\n    color: rgba(0, 0, 0, 0.26);\n  }\n\n  /* Rules for using icons as white on a dark background. */\n  .material-icons.md-light {\n    color: rgba(255, 255, 255, 1);\n  }\n  .material-icons.md-light.md-inactive {\n    color: rgba(255, 255, 255, 0.3);\n  }\n\n  ";customElements.get("tree-item-view")||customElements.define("tree-item-view",Y);class Q extends HTMLElement{constructor(){super();const e=this.attachShadow({mode:"open"});this.treeContainer=document.createElement("div"),e.appendChild(this.treeContainer),this.treeItemView=document.createElement("tree-item-view");const t=new CSSStyleSheet;t.replaceSync("@font-face {\n      font-family: \"Material Icons\";\n      font-style: normal;\n      font-weight: 400;\n      src: url('https://fonts.gstatic.com/s/materialicons/v48/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2') format('woff');\n    }");const o=new CSSStyleSheet;o.replaceSync("@font-face {\n      font-family: \"Material Icons Outlined\";\n      font-style: normal;\n      font-weight: 400;\n      src: url('https://fonts.gstatic.com/s/materialiconsoutlined/v14/gok-H7zzDkdnRel8-DQ6KAXJ69wP1tGnf4ZGhUce.woff2') format('woff');\n    }"),document.adoptedStyleSheets=[...document.adoptedStyleSheets,t,o]}setTreeItem(e,t){this.treeItemView.setTreeItem(e,t),this.treeContainer.appendChild(this.treeItemView)}}customElements.get("scene-tree-view")||customElements.define("scene-tree-view",Q),exports.ActionRegistry=class{constructor(){this.actions=[],this.actionAdded=new e.Signal}registerAction(e){const{name:t}=e;t?this._addAction(e):console.warn("A action is missing its name.")}_addAction(e){this.actions.push(e),this.actionAdded.emit(e)}getActions(){return this.actions}},exports.ArcSlider=j,exports.AxialRotationHandle=g,exports.Change=n,exports.CreateCircleTool=class extends H{constructor(e){super(e)}createStart(e,t){this.change=new z(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.stage=1,this.radius=0}createMove(e){this.radius=e.distanceTo(this.xfo.tr),this.change.update({radius:this.radius})}createRelease(e){0==this.radius&&this.appData.undoRedoManager.undo(!1),this.change=null,this.stage=0,this.actionFinished.emit()}},exports.CreateCuboidTool=class extends H{constructor(e){super(e)}createStart(e,t){this.change=new K(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.invxfo=e.inverse(),this.stage=1,this._height=0}createMove(e){if(1==this.stage){const t=this.invxfo.transformVec3(e);this.change.update({baseSize:[Math.abs(t.x),Math.abs(t.y)],tr:this.xfo.tr.add(t.scale(.5))})}else{const t=this.invxfo.transformVec3(e);this.change.update({height:t.y})}}createRelease(t,o){if(1==this.stage){this.stage=2,this.pt1=t;const o=new e.Quat;o.setFromAxisAndAngle(new e.Vec3(1,0,0),.5*Math.PI),this.constructionPlane.ori=this.constructionPlane.ori.multiply(o),this.constructionPlane.tr=t,this.invxfo=this.constructionPlane.inverse()}else 2==this.stage&&(this.stage=0,this.actionFinished.emit())}},exports.CreateFreehandLineTool=class extends B{constructor(t){super(t),this.mp=this.addParameter(new e.BooleanParameter("Modulate Thickness By Stroke Speed",!1))}createStart(e,t){const o=this.cp.getValue(),s=this.tp.getValue();this.change=new J(t,e,o,s),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.invxfo=e.inverse(),this.stage=1,this.prevP=e.tr,this.length=0}createMove(e){const t=this.invxfo.transformVec3(e),o=t.subtract(this.prevP).length();o>.001&&this.change.update({point:t}),this.length+=o,this.prevP=t}createRelease(e){0==this.length&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.actionFinished.emit()}},exports.CreateLineTool=B,exports.CreateRectTool=class extends H{constructor(e){super(e)}createStart(e,t){this.change=new F(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.invxfo=e.inverse(),this.stage=1,this._size=0}createMove(e){if(1==this.stage){const t=this.invxfo.transformVec3(e);this._size=Math.abs(t.x),Math.abs(t.y),this.change.update({baseSize:[Math.abs(t.x),Math.abs(t.y)],tr:this.xfo.tr.add(t.scale(.5))})}else{const t=this.invxfo.transformVec3(e);this.change.update({height:t.y})}}createRelease(e,t){0==this._size&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.actionFinished.emit()}},exports.CreateSphereTool=class extends H{constructor(e){super(e)}createStart(e,t){this.change=new Z(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.stage=1,this.radius=0}createMove(e){this.radius=e.distanceTo(this.xfo.tr),this.change.update({radius:this.radius})}createRelease(e){0==this.radius&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.actionFinished.emit()}},exports.HandleTool=class extends b{constructor(e){super(e),this.activeHandle=void 0,this.capturedItems=[],this.mouseOverItems=[]}activateTool(){super.activateTool(),console.log("activateTool.HandleTool"),this.appData.renderer.getDiv().style.cursor="crosshair";const t=t=>{if(!this.__activated)return;const o=new e.Sphere(.015),s=new e.Material("Cross","FlatSurfaceShader");s.getParameter("BaseColor").setValue(new e.Color("#03E3AC")),s.visibleInGeomDataBuffer=!1;const i=new e.GeomItem("HandleToolTip",o,s);t.getTipItem().removeAllChildren(),t.getTipItem().addChild(i,!1)},o=e=>{for(const o of e.getControllers())t(o);this.addIconToControllerId=e.controllerAdded.connect(t)};this.appData.renderer.getXRViewport().then(e=>{o(e)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(e=>{e.controllerAdded.disconnectId(this.addIconToControllerId)})}onMouseDown(e){if(!this.activeHandle){const t=e.viewport.getGeomDataAtPos(e.mousePos);if(null==t)return;if(t.geomItem.getOwner()instanceof a)return this.activeHandle=t.geomItem.getOwner(),this.activeHandle.handleMouseDown(Object.assign(e,{intersectionData:t})),!0}}onMouseMove(e){if(this.activeHandle)return this.activeHandle.handleMouseMove(e),!0;{if(0==e.button&&1==e.buttons)return!1;const t=e.viewport.getGeomDataAtPos(e.mousePos);if(null!=t&&t.geomItem.getOwner()instanceof a){const e=t.geomItem.getOwner();return this.__highlightedHandle&&this.__highlightedHandle.unhighlight(),this.__highlightedHandle=e,this.__highlightedHandle.highlight(),!0}this.__highlightedHandle&&(this.__highlightedHandle.unhighlight(),this.__highlightedHandle=void 0)}}onMouseUp(e){if(this.activeHandle)return this.activeHandle.handleMouseUp(e),this.activeHandle=void 0,!0}onWheel(e){this.activeHandle&&this.activeHandle.onWheel(e)}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onTouchCancel(e){}__prepareVREvent(e){const t=e.controller.getId();e.setCapture=e=>{this.capturedItems[t]=e},e.getCapture=()=>this.capturedItems[t],e.releaseCapture=()=>{this.capturedItems[t]=null}}onVRControllerButtonDown(e){const t=e.controller.getId();if(this.capturedItems[t])this.__prepareVREvent(e),this.capturedItems[t].onMouseDown(e);else{const t=e.controller.getGeomItemAtTip();null!=t&&(e.intersectionData=t,e.geomItem=t.geomItem,this.__prepareVREvent(e),t.geomItem.onMouseDown(e))}}onVRPoseChanged(e){for(const t of e.controllers){const o=t.getId();if(this.capturedItems[o])this.capturedItems[o].onMouseMove(e);else{const s=t.getGeomItemAtTip();null!=s?(e.intersectionData=s,e.geomItem=s.geomItem,s.geomItem!=this.mouseOverItems[o]&&(this.mouseOverItems[o]&&this.mouseOverItems[o].onMouseLeave(e),this.mouseOverItems[o]=s.geomItem,this.mouseOverItems[o].onMouseEnter(e)),s.geomItem.onMouseMove(e)):this.mouseOverItems[o]&&(this.mouseOverItems[o].onMouseLeave(e),this.mouseOverItems[o]=null)}}}onVRControllerButtonUp(e){this.__prepareVREvent(e);const t=e.controller.getId();if(this.capturedItems[t])this.capturedItems[t].onMouseUp(e);else{const t=e.controller.getGeomItemAtTip();null!=t&&(e.intersectionData=t,e.geomItem=t.geomItem,t.geomItem.onMouseUp(e))}}},exports.LinearMovementHandle=h,exports.OpenVRUITool=class extends b{constructor(e,t){super(e),this.vrUITool=t,this.uiToolIndex=-1,this.__stayClosed=!1}uninstall(){super.uninstall(),this.uiToolIndex>0&&this.appData.toolManager.removeToolByHandle(this.vrUITool)}onVRControllerButtonDown(e){}onVRControllerButtonUp(e){}stayClosed(){this.__stayClosed=!0}onVRPoseChanged(e){if(this.vrUITool.installed())return;const t=e.viewXfo,o=(e,o)=>{if(!e)return!1;const s=e.getTreeItem().getGlobalXfo(),i=s.tr.subtract(t.tr);return i.normalizeInPlace(),i.angleTo(s.ori.getYaxis())<.25*Math.PI?(this.__stayClosed||(this.vrUITool.setUIControllers(this,e,o,t),this.uiToolIndex=this.appData.toolManager.pushTool(this.vrUITool)),!0):void 0};if(e.controllers.length>0){if(o(e.controllers[0],e.controllers[1]))return!0;if(o(e.controllers[1],e.controllers[0]))return!0}this.uiToolIndex=-1,this.__stayClosed=!1}},exports.ParameterValueChange=l,exports.PlanarMovementHandle=c,exports.SceneTreeView=Q,exports.ScreenSpaceMovementHandle=class extends a{constructor(e){super(e)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.valueChanged.connect(t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}handleMouseDown(t){this.gizmoRay=new e.Ray,this.gizmoRay.dir=t.mouseRay.dir.negate();const o=this.getTargetParam().getValue();this.gizmoRay.pos=o.tr;const s=t.mouseRay.intersectRayPlane(this.gizmoRay);return t.grabPos=t.mouseRay.pointAtDist(s),this.onDragStart(t),!0}handleMouseMove(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.holdPos=e.mouseRay.pointAtDist(t),this.onDrag(e),!0}handleMouseUp(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.releasePos=e.mouseRay.pointAtDist(t),this.onDragEnd(e),!0}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new l(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.grabPos),o=this.baseXfo.clone();if(o.tr.addInPlace(t),this.change)this.change.update({value:o});else{this.getTargetParam().setValue(o)}}onDragEnd(e){this.change=null}},exports.SelectionManager=class{constructor(t,o={}){if(this.appData=t,this.leadSelection=void 0,this.selectionChanged=new e.Signal,this.leadSelectionChanged=new e.Signal,this.selectionGroup=new _(o),!0===o.enableXfoHandles){const o=.1,s=.02*o;this.xfoHandle=new f(o,s),this.xfoHandle.setTargetParam(this.selectionGroup.getParameter("GlobalXfo"),!1),this.xfoHandle.setVisible(!1),this.selectionGroup.addChild(this.xfoHandle),this.handleGroup={Translate:new e.Signal,Rotate:new e.Signal,Scale:new e.Signal},this.currMode="",t.actionRegistry.registerAction({name:"Translate",path:["Edit"],callback:()=>{this.showHandles("Translate")},key:"w",activatedChanged:this.handleGroup.Translate}),t.actionRegistry.registerAction({name:"Rotate",path:["Edit"],callback:()=>{this.showHandles("Rotate")},key:"e",activatedChanged:this.handleGroup.Rotate}),t.actionRegistry.registerAction({name:"Scale",path:["Edit"],callback:()=>{this.showHandles("Scale")},key:"r",activatedChanged:this.handleGroup.Scale}),t.actionRegistry.registerAction({name:"Local",path:["Edit","Coords"],callback:()=>{this.setXfoMode(ZeaEngine.Group.INITIAL_XFO_MODES.average)},key:"k",activatedChanged:this.handleGroup.Translate}),t.actionRegistry.registerAction({name:"Global",path:["Edit","Coords"],callback:()=>{this.setXfoMode(ZeaEngine.Group.INITIAL_XFO_MODES.globalOri)},key:"l",activatedChanged:this.handleGroup.Rotate})}this.appData.renderer&&this.setRenderer(this.appData.renderer)}setRenderer(e){this.__renderer=e,this.__renderer.addTreeItem(this.selectionGroup)}setXfoMode(e){this.xfoHandle&&(this.selectionGroup.rebindInitialXfos(),this.selectionGroup.getParameter("InitialXfoMode").setValue(e))}showHandles(e){if(this.xfoHandle&&this.currMode!=e){this.currMode=e;for(const t in this.handleGroup)this.handleGroup[t].emit(e==t);this.xfoHandle.showHandles(e)}}updateHandleVisiblity(){if(!this.xfoHandle)return;const e=this.selectionGroup.getItems(),t=Array.from(e).length>0;this.xfoHandle.setVisible(t),this.__renderer.requestRedraw()}getSelection(){return this.selectionGroup.getItems()}setSelection(e,t=!0){const o=new Set(this.selectionGroup.getItems()),s=new Set(o);for(const t of e)o.has(t)||o.add(t);for(const t of o)e.has(t)||o.delete(t);if(this.selectionGroup.setItems(o),o.size>0?this.__setLeadSelection(o.values().next().value):this.__setLeadSelection(),this.updateHandleVisiblity(),t){const e=new I(this,s,o);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(e)}}__setLeadSelection(e){this.leadSelection!=e&&(this.leadSelection=e,this.leadSelectionChanged.emit(e))}toggleItemSelection(e,t=!0){const o=new Set(this.selectionGroup.getItems()),s=new Set(o);if(t&&(1!=o.size||!o.has(e))){let t=!0;if(o.has(e)){let s=1;e.traverse(e=>{o.has(e)&&s++}),t=s!=o.size}t&&o.clear()}let i;o.has(e)?(o.delete(e),i=!1):(o.add(e),i=!0),this.selectionGroup.setItems(o),i&&1===o.size?this.__setLeadSelection(e):i||(1===o.size?this.__setLeadSelection(o.values().next().value):0===o.size&&this.__setLeadSelection());const n=new I(this,s,o);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(n),this.updateHandleVisiblity(),this.selectionChanged.emit(s)}clearSelection(e=!0){const t=new Set(this.selectionGroup.getItems());if(0==t.size)return!1;let o;if(e&&(o=new Set(t)),t.clear(),this.selectionGroup.setItems(t),this.updateHandleVisiblity(),e){const e=new I(this,o,t);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(e),this.selectionChanged.emit(t)}return!0}selectItems(e,t=!0){const o=new Set(this.selectionGroup.getItems()),s=new Set(o);t&&o.clear();for(const t of e)t.getSelected()||o.add(t);const i=new I(this,s,o);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(i),this.selectionGroup.setItems(o),1===o.size?this.__setLeadSelection(o.values().next().value):0===o.size&&this.__setLeadSelection(),this.updateHandleVisiblity(),this.selectionChanged.emit(o)}deselectItems(e){const t=this.selectionGroup.getItems(),o=new Set(t);for(const o of e)o.getSelected()&&t.delete(selectedParam);this.selectionGroup.setItems(t);const s=new I(this,o,t);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(s),1===t.size?this.__setLeadSelection(t.values().next().value):0===t.size&&this.__setLeadSelection(),this.updateHandleVisiblity(),this.selectionChanged.emit(t)}toggleSelectionVisiblity(){if(this.leadSelection){const e=this.selectionGroup.getItems(),t=!this.leadSelection.getVisible(),o=new C(e,t);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(o)}}startPickingMode(e,t,o,s){console.log(e),this.__pickCB=t,this.__pickFilter=o,this.__pickCount=s,this.__picked=[]}pickingFilter(e){return this.__pickFilter(e)}pickingModeActive(){return null!=this.__pickCB}cancelPickingMode(){this.__pickCB=void 0}pick(e){if(this.__pickCB){if(Array.isArray(e))this.__pickFilter?this.__picked=this.__picked.concat(e.filter(this.__pickFilter)):this.__picked=this.__picked.concat(e);else{if(this.__pickFilter&&!this.__pickFilter(e))return;this.__picked.push(e)}this.__picked.length==this.__pickCount&&(this.__pickCB(this.__picked),this.__pickCB=void 0)}}},exports.SelectionTool=S,exports.SliderHandle=W,exports.ToolAction=class extends class{constructor(e,t,o=!1){this.name=e,this.path=t,this.availableInVR=o,this.callback=this.callback.bind(this)}callback(){}}{constructor(t,o,s,i,n){super(t,o,s),this.toolManager=i,this.tool=n,this.state=!1,this.activatedChanged=new e.Signal,n.installChanged.connect(e=>{this.activatedChanged.emit(e)})}callback(){if(this.tool.installed())this.toolManager.removeToolByHandle(this.tool);else{const e=this.toolManager.currTool();"VRUITool"==e.getName()?this.toolManager.insertToolBefore(this.tool,e):e.isPrimaryTool()?this.toolManager.replaceCurrentTool(this.tool):this.toolManager.pushTool(this.tool)}}},exports.ToolManager=class{constructor(t){this.__toolStack=[],this.appData=t,this.movePointer=new e.Signal,this.hilightPointer=new e.Signal,this.unhilightPointer=new e.Signal,this.hidePointer=new e.Signal,this.avatarPointerVisible=!1,this.avatarPointerHighlighted=!1}insertTool(e,t){this.__toolStack.splice(t,0,e),e.install(t)}insertToolBefore(e,t){const o=this.__toolStack.indexOf(t)+1;return this.__toolStack.splice(o-1,0,e),e.install(o),o}insertToolAfter(e,t){const o=this.__toolStack.indexOf(t)+1;return this.__toolStack.splice(o,0,e),e.install(o),o==this.__toolStack.length&&e.activateTool(),o}getToolIndex(e){return this.__toolStack.indexOf(e)}removeTool(e){const t=this.__toolStack[e];if(this.__toolStack.splice(e,1),t.uninstall(),e==this.__toolStack.length){t.deactivateTool();const e=this.currTool();e?e.activateTool():this.appData.renderer.getDiv().style.cursor="pointer"}}removeToolByHandle(e){this.removeTool(this.getToolIndex(e))}pushTool(e){const t=this.currTool();if(t){if(e==t)return void console.warn("Tool Already Pushed on the stack:",e.constructor.name);t.deactivateTool()}return this.__toolStack.push(e),e.install(this.__toolStack.length-1),e.activateTool(),console.log("ToolManager.pushTool:",e.constructor.name),this.__toolStack.length-1}__removeCurrTool(){if(this.__toolStack.length>0){const e=this.__toolStack.pop();e.deactivateTool(),e.uninstall()}}popTool(){this.__removeCurrTool();const e=this.currTool();e&&e.activateTool()}replaceCurrentTool(e){this.__removeCurrTool(),this.__toolStack.push(e),e.install(this.__toolStack.length-1),e.activateTool()}currTool(){return this.__toolStack[this.__toolStack.length-1]}currToolName(){return this.__toolStack[this.__toolStack.length-1].getName()}bind(e){const t=e.getViewport();this.mouseDownId=t.mouseDown.connect(this.onMouseDown.bind(this)),this.mouseMoveId=t.mouseMove.connect(this.onMouseMove.bind(this)),this.mouseUpId=t.mouseUp.connect(this.onMouseUp.bind(this)),this.mouseLeaveId=t.mouseLeave.connect(this.onMouseLeave.bind(this)),this.mouseDoubleClickedId=t.mouseDoubleClicked.connect(this.onDoubleClick.bind(this)),this.mouseWheelId=t.mouseWheel.connect(this.onWheel.bind(this)),this.keyDownId=t.keyDown.connect(this.onKeyDown.bind(this)),this.keyUpId=t.keyUp.connect(this.onKeyUp.bind(this)),this.keyPressedId=t.keyPressed.connect(this.onKeyPressed.bind(this)),this.touchStartId=t.touchStart.connect(this.onTouchStart.bind(this)),this.touchMoveId=t.touchMove.connect(this.onTouchMove.bind(this)),this.touchEndId=t.touchEnd.connect(this.onTouchEnd.bind(this)),this.touchCancelId=t.touchCancel.connect(this.onTouchCancel.bind(this)),this.doubleTappedId=t.doubleTapped.connect(this.onDoubleTap.bind(this)),this.appData.renderer.getXRViewport().then(e=>{this.controllerDownId=e.controllerButtonDown.connect(this.onVRControllerButtonDown.bind(this)),this.controllerUpId=e.controllerButtonUp.connect(this.onVRControllerButtonUp.bind(this)),this.controllerDoubleClickId=e.controllerDoubleClicked.connect(this.onVRControllerDoubleClicked.bind(this)),this.onVRPoseChangedId=e.viewChanged.connect(this.onVRPoseChanged.bind(this))})}onMouseDown(e){e.undoRedoManager=this.appData.undoRedoManager,e.showPointerOnAvatar=!0;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onMouseDown(e))break}1==e.showPointerOnAvatar?(this.avatarPointerVisible||(this.movePointer.emit(e),this.avatarPointerVisible=!0),this.avatarPointerHighlighted||(this.hilightPointer.emit(e),this.avatarPointerHighlighted=!0)):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.hidePointer.emit())}onMouseMove(e){e.undoRedoManager=this.appData.undoRedoManager,e.showPointerOnAvatar=!0;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onMouseMove(e))break}1==e.showPointerOnAvatar?(this.movePointer.emit(e),this.avatarPointerVisible=!0):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.hidePointer.emit())}onMouseUp(e){e.undoRedoManager=this.appData.undoRedoManager,e.showPointerOnAvatar=!0;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onMouseUp(e))break}1==e.showPointerOnAvatar?this.avatarPointerHighlighted&&(this.unhilightPointer.emit(e),this.avatarPointerHighlighted=!1):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.hidePointer.emit())}onMouseLeave(e){let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&o.onMouseLeave&&1==o.onMouseLeave(e))break}this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.hidePointer.emit())}onDoubleClick(e){let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onDoubleClick(e))break}}onWheel(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onWheel(e))break}}onKeyPressed(e,t){t.undoRedoManager=this.appData.undoRedoManager;let o=this.__toolStack.length;for(;o--;){const e=this.__toolStack[o];if(e&&1==e.onKeyPressed(t,t,viewport))break}}onKeyDown(e,t){t.undoRedoManager=this.appData.undoRedoManager;let o=this.__toolStack.length;for(;o--;){const s=this.__toolStack[o];if(s&&1==s.onKeyDown(e,t))break}}onKeyUp(e,t){t.undoRedoManager=this.appData.undoRedoManager;let o=this.__toolStack.length;for(;o--;){const s=this.__toolStack[o];if(s&&1==s.onKeyUp(e,t))break}}onTouchStart(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onTouchStart(e))break}}onTouchMove(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onTouchMove(e))break}}onTouchEnd(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onTouchEnd(e))break}}onTouchCancel(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onTouchCancel(e))break}}onDoubleTap(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onDoubleTap(e))break}}__prepareEvent(e){e.undoRedoManager=this.appData.undoRedoManager,e.propagating=!0,e.stopPropagation=()=>{e.propagating=!1}}onVRControllerButtonDown(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onVRControllerButtonDown(e))break;if(!e.propagating)break}}onVRControllerButtonUp(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onVRControllerButtonUp(e))break;if(!e.propagating)break}}onVRControllerDoubleClicked(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onVRControllerDoubleClicked(e))break;if(!e.propagating)break}}onVRPoseChanged(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onVRPoseChanged(e))break;if(!e.propagating)break}}destroy(){const e=this.appData.renderer.getViewport();e.mouseDown.disconnectId(this.mouseDownId),e.mouseMove.disconnectId(this.mouseMoveId),e.mouseUp.disconnectId(this.mouseUpId),e.mouseLeave.disconnectId(this.mouseUpId),e.mouseWheel.disconnectId(this.mouseWheelId),e.keyDown.disconnectId(this.keyDownId),e.keyUp.disconnectId(this.keyUpId),e.keyPressed.disconnectId(this.keyPressedId),e.touchStart.disconnectId(this.touchStartId),e.touchMove.disconnectId(this.touchMoveId),e.touchEnd.disconnectId(this.touchEndId),e.touchCancel.disconnectId(this.touchCancelId),this.appData.renderer.getXRViewport().then(t=>{e.controllerDown.disconnectId(this.controllerDownId),e.controllerUp.disconnectId(this.controllerUpId),e.viewChanged.disconnectId(this.onVRPoseChangedId)})}},exports.TreeItemAddChange=w,exports.TreeItemMoveChange=P,exports.TreeItemView=Y,exports.TreeItemsRemoveChange=v,exports.UndoRedoManager=i,exports.VIEW_TOOL_MODELS=T,exports.VRHoldObjectsTool=class extends b{constructor(e){super(e),this.__pressedButtonCount=0,this.__freeIndices=[],this.__vrControllers=[],this.__heldObjectCount=0,this.__heldGeomItems=[],this.__heldGeomItemIds=[],this.__heldGeomItemRefs=[],this.__heldGeomItemOffsets=[]}activateTool(){super.activateTool(),console.log("activateTool.VRHoldObjectsTool"),this.appData.renderer.getDiv().style.cursor="crosshair";const t=t=>{if(!this.__activated)return;const o=new e.Cross(.03),s=new e.Material("Cross","FlatSurfaceShader");s.getParameter("BaseColor").setValue(new e.Color("#03E3AC")),s.visibleInGeomDataBuffer=!1;const i=new e.GeomItem("HandleToolTip",o,s);t.getTipItem().removeAllChildren(),t.getTipItem().addChild(i,!1)};this.appData.renderer.getXRViewport().then(e=>{for(const o of e.getControllers())t(o);this.addIconToControllerId=e.controllerAdded.connect(t)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(e=>{e.controllerAdded.disconnectId(this.addIconToControllerId)})}computeGrabXfo(t){let o;if(1==t.length)o=this.__vrControllers[t[0]].getTipXfo();else if(2==t.length){const s=this.__vrControllers[t[0]].getTipXfo(),i=this.__vrControllers[t[1]].getTipXfo();s.ori.alignWith(i.ori),o=new e.Xfo,o.tr=s.tr.lerp(i.tr,.5),o.ori=s.ori.lerp(i.ori,.5);let n=i.tr.subtract(s.tr);n.normalizeInPlace();const a=o.ori.getXaxis();n.dot(a)<0&&(n=n.negate());const r=n.angleTo(a);if(r>0){const t=a.cross(n);t.normalizeInPlace();const s=new e.Quat;s.setFromAxisAndAngle(t,r),o.ori=s.multiply(o.ori)}}return o}initAction(){for(let e=0;e<this.__heldGeomItems.length;e++){const t=this.__heldGeomItems[e];if(!t)continue;const o=this.computeGrabXfo(this.__heldGeomItemRefs[e]);this.__heldGeomItemOffsets[e]=o.inverse().multiply(t.getGlobalXfo())}}onVRControllerButtonDown(e){const t=e.controller.getId();this.__vrControllers[t]=e.controller;const o=e.controller.getGeomItemAtTip();if(o){if(o.geomItem.getOwner()instanceof a)return!1;if(e.intersectionData=o,o.geomItem.onMouseDown(e,o),!e.propagating)return!1;let s=this.__heldGeomItems.indexOf(o.geomItem);if(-1==s){s=this.__heldGeomItems.length,this.__heldObjectCount++,this.__heldGeomItems.push(o.geomItem),this.__heldGeomItemRefs[s]=[t],this.__heldGeomItemIds[t]=s;const e={newItem:o.geomItem,newItemId:s};this.change?this.change.update(e):(this.change=new A(e),this.appData.undoRedoManager.addChange(this.change))}else this.__heldGeomItemIds[t]=s,this.__heldGeomItemRefs[s].push(t);return this.initAction(),!0}}onVRControllerButtonUp(e){const t=e.controller.getId();if(this.__pressedButtonCount--,void 0!==this.__heldGeomItemIds[t]){const e=this.__heldGeomItemIds[t],o=this.__heldGeomItemRefs[e];return o.splice(o.indexOf(t),1),0==o.length&&(this.__heldObjectCount--,this.__heldGeomItems[e]=void 0,this.change=void 0),this.__heldGeomItemIds[t]=void 0,this.initAction(),!0}}onVRPoseChanged(e){if(!this.change)return!1;const t=[],o=[];for(let e=0;e<this.__heldGeomItems.length;e++){if(!this.__heldGeomItems[e])continue;const s=this.computeGrabXfo(this.__heldGeomItemRefs[e]);t.push(s.multiply(this.__heldGeomItemOffsets[e])),o.push(e)}return this.change.update({changeXfos:t,changeXfoIds:o}),!0}},exports.VRUITool=class extends b{constructor(t){super(t),this.__vrUIDOMHolderElement=document.createElement("div"),this.__vrUIDOMHolderElement.className="vrUIHolder",this.__vrUIDOMElement=document.createElement("div"),this.__vrUIDOMElement.className="vrUI",document.body.appendChild(this.__vrUIDOMHolderElement),this.controllerUI=new E(t,this.__vrUIDOMHolderElement,this.__vrUIDOMElement),this.controllerUI.addRef(this),t.renderer.addTreeItem(this.controllerUI),this.__uiLocalXfo=new e.Xfo,this.__uiLocalXfo.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),-.6*Math.PI);const o=new e.Material("pointermat","LinesShader");o.visibleInGeomDataBuffer=!1,o.getParameter("Color").setValue(new e.Color(1.2,0,0));const s=new e.Lines;s.setNumVertices(2),s.setNumSegments(1),s.setSegment(0,0,1),s.getVertex(0).set(0,0,0),s.getVertex(1).set(0,0,-1),s.setBoundingBoxDirty(),this.__pointerLocalXfo=new e.Xfo,this.__pointerLocalXfo.sc.set(1,1,.1),this.__pointerLocalXfo.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),-.2*Math.PI),this.__uiPointerItem=new e.GeomItem("VRControllerPointer",s,o),this.__uiPointerItem.addRef(this),this.__triggerHeld=!1}getName(){return"VRUITool"}setUIControllers(e,t,o,s){this.openUITool=e,this.uiController=t,this.pointerController=o;const i=this.uiController.getTreeItem().getGlobalXfo();if(this.pointerController){const e=this.pointerController.getTreeItem().getGlobalXfo(),t=i.tr.subtract(s.tr),o=e.tr.subtract(s.tr);t.cross(o).dot(s.ori.getYaxis())>0?this.__uiLocalXfo.tr.set(.05,-.05,.08):this.__uiLocalXfo.tr.set(-.05,-.05,.08)}else this.__uiLocalXfo.tr.set(0,-.05,.08);this.controllerUI.setLocalXfo(this.__uiLocalXfo)}activateTool(){super.activateTool(),this.controllerUI.activate(),this.uiController&&(this.uiController.getTipItem().addChild(this.controllerUI,!1),this.pointerController&&this.pointerController.getTipItem().addChild(this.__uiPointerItem,!1),this.appData.session.pub("pose-message",{interfaceType:"VR",showUIPanel:{controllerId:this.uiController.getId(),localXfo:this.__uiLocalXfo.toJSON(),size:this.controllerUI.getGeomOffsetXfo().sc.toJSON()}}))}deactivateTool(){super.deactivateTool(),this.controllerUI.deactivate(),this.uiController&&(this.uiController.getTipItem().removeChildByHandle(this.controllerUI),this.pointerController&&this.pointerController.getTipItem().removeChildByHandle(this.__uiPointerItem),this.appData.session.pub("pose-message",{interfaceType:"VR",hideUIPanel:{controllerId:this.uiController.getId()}}))}setPointerLength(e){this.__pointerLocalXfo.sc.set(1,1,e),this.__uiPointerItem.setLocalXfo(this.__pointerLocalXfo)}calcUIIntersection(){const t=this.__uiPointerItem.getGlobalXfo(),o=t.ori.getZaxis().negate(),s=new e.Ray(t.tr,o),i=this.controllerUI.getGlobalXfo(),n=this.controllerUI.getGeomOffsetXfo().sc,a=new e.Ray(i.tr,i.ori.getZaxis().negate()),r=s.intersectRayPlane(a);if(r<=0)return void this.setPointerLength(.5);const l=t.tr.add(o.scale(r)).subtract(a.start),h=l.dot(i.ori.getXaxis())/n.x,c=l.dot(i.ori.getYaxis())/n.y;if(Math.abs(h)>.5||Math.abs(c)>.5)return void this.setPointerLength(.5);this.setPointerLength(r);const d=this.__vrUIDOMElement.getBoundingClientRect();return{clientX:Math.round(h*d.width+d.width/2),clientY:Math.round(c*-d.height+d.height/2)}}sendEventToUI(e,t){const o=this.calcUIIntersection();if(o){o.offsetX=o.pageX=o.pageX=o.screenX=o.clientX,o.offsetY=o.pageY=o.pageY=o.screenY=o.clientY;const s=document.elementFromPoint(o.clientX,o.clientY);return s!=this._element&&(this._element&&this.controllerUI.sendMouseEvent("mouseleave",Object.assign(t,o),this._element),this._element=s,this.controllerUI.sendMouseEvent("mouseenter",Object.assign(t,o),this._element)),this.controllerUI.sendMouseEvent(e,Object.assign(t,o),this._element),this._element}this._element&&(this.controllerUI.sendMouseEvent("mouseleave",Object.assign(t,o),this._element),this._element=null)}onVRControllerButtonDown(e){if(e.controller==this.pointerController){this.__triggerHeld=!0;const t=this.sendEventToUI("mousedown",{button:e.button-1});this.__triggerDownElem=t||null}return!0}onVRControllerButtonUp(e){if(e.controller==this.pointerController){this.__triggerHeld=!1;const t=this.sendEventToUI("mouseup",{button:e.button-1});t&&this.__triggerDownElem==t&&this.sendEventToUI("click",{button:e.button-1}),this.__triggerDownElem=null}return!0}onVRPoseChanged(e){const t=e.viewXfo;return(()=>{const e=this.uiController.getTreeItem().getGlobalXfo(),o=e.tr.subtract(t.tr);return o.normalizeInPlace(),!(o.angleTo(e.ori.getYaxis())>.5*Math.PI)||(this.appData.toolManager.removeToolByHandle(this),!1)})()&&this.sendEventToUI("mousemove",{}),!0}},exports.ViewTool=class extends b{constructor(t,o=T.VIEWER){super(t),console.log("ViewTool:",o),this.__maipulationModel=o,this.__defaultMode="orbit",this.__mode=this.__defaultMode,this.__mouseDragDelta=new e.Vec2,this.__keyboardMovement=!1,this.__keysPressed=[],this.__maxVel=.002,this.__velocity=new e.Vec3,this.__ongoingTouches={},this.__orbitRateParam=this.addParameter(new e.NumberParameter("orbitRate",1)),this.__dollySpeedParam=this.addParameter(new e.NumberParameter("dollySpeed",.02)),this.__mouseWheelDollySpeedParam=this.addParameter(new e.NumberParameter("mouseWheelDollySpeed",.002)),this.__controllerTriggersHeld=[],this.movementFinished=new e.Signal}activateTool(){super.activateTool(),console.log("activateTool.ViewTool"),this.appData.renderer.getDiv().style.cursor="default",this.appData.renderer.getXRViewport().then(t=>{this.vrControllerToolTip||(this.vrControllerToolTip=new e.Sphere(.015),this.vrControllerToolTipMat=new e.Material("Cross","FlatSurfaceShader"),this.vrControllerToolTipMat.getParameter("BaseColor").setValue(new e.Color("#03E3AC")),this.vrControllerToolTipMat.visibleInGeomDataBuffer=!1);const o=t=>{const o=new e.GeomItem("HandleToolTip",this.vrControllerToolTip,this.vrControllerToolTipMat);t.getTipItem().removeAllChildren(),t.getTipItem().addChild(o,!1)};for(const e of t.getControllers())o(e);this.addIconToControllerId=t.controllerAdded.connect(o)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(e=>{e.controllerAdded.disconnectId(this.addIconToControllerId)})}setDefaultMode(e){this.__defaultMode=e}look(t,o){const s=o.getCamera().getFocalDistance(),i=this.__orbitRateParam.getValue()*e.SystemDesc.isMobileDevice?-1:1;if(this.__keyboardMovement){const e=o.getCamera().getGlobalXfo();this.__mouseDownCameraXfo=e.clone(),this.__mouseDownZaxis=e.ori.getZaxis();const t=this.__mouseDownZaxis.scale(-s);this.__mouseDownCameraTarget=e.tr.add(t)}const n=this.__mouseDownCameraXfo.clone(),a=new e.Quat;a.rotateZ(t.x/o.getWidth()*Math.PI*i),n.ori=a.multiply(n.ori);const r=new e.Quat;r.rotateX(t.y/o.getHeight()*Math.PI*i),n.ori.multiplyInPlace(r),this.__keyboardMovement,o.getCamera().setGlobalXfo(n)}orbit(t,o){const s=o.getCamera().getFocalDistance(),i=this.__orbitRateParam.getValue()*e.SystemDesc.isMobileDevice?-1:1;if(this.__keyboardMovement){const e=o.getCamera().getGlobalXfo();this.__mouseDownCameraXfo=e.clone(),this.__mouseDownZaxis=e.ori.getZaxis();const t=this.__mouseDownZaxis.scale(-s);this.__mouseDownCameraTarget=e.tr.add(t)}const n=this.__mouseDownCameraXfo.clone(),a=new e.Quat;a.rotateZ(t.x/o.getWidth()*2*Math.PI*-i),n.ori=a.multiply(n.ori);const r=new e.Quat;r.rotateX(t.y/o.getHeight()*Math.PI*-i),n.ori.multiplyInPlace(r),n.tr=this.__mouseDownCameraTarget.add(n.ori.getZaxis().scale(s)),this.__keyboardMovement,o.getCamera().setGlobalXfo(n)}pan(t,o){const s=o.getCamera().getFocalDistance(),i=o.getCamera().getFov(),n=new e.Vec3(1,0,0),a=new e.Vec3(0,1,0),r=2*s*Math.tan(.5*i),l=r*(o.getWidth()/o.getHeight()),h=new e.Xfo;h.tr=n.scale(-t.x/o.getWidth()*l),h.tr.addInPlace(a.scale(t.y/o.getHeight()*r)),o.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(h))}dolly(t,o){const s=t.x*this.__dollySpeedParam.getValue(),i=new e.Xfo;i.tr.set(0,0,s),o.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(i))}panAndZoom(t,o,s){const i=s.getCamera().getFocalDistance(),n=s.getCamera().getFov(),a=new e.Vec3(1,0,0),r=new e.Vec3(0,1,0),l=2*i*Math.tan(.5*n),h=l*(s.getWidth()/s.getHeight()),c=new e.Xfo;c.tr=a.scale(-t.x/s.getWidth()*h),c.tr.addInPlace(r.scale(t.y/s.getHeight()*l));const d=o*i;s.getCamera().setFocalDistance(this.__mouseDownFocalDist+d),c.tr.z+=d,s.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(c))}initDrag(e){const t=e.getCamera().getFocalDistance();this.__mouseDragDelta.set(0,0),this.__mouseDownCameraXfo=e.getCamera().getGlobalXfo().clone(),this.__mouseDownZaxis=e.getCamera().getGlobalXfo().ori.getZaxis();const o=this.__mouseDownZaxis.scale(-t);this.__mouseDownCameraTarget=e.getCamera().getGlobalXfo().tr.add(o),this.__mouseDownFocalDist=t}aimFocus(t,o){this.__focusIntervalId&&clearInterval(this.__focusIntervalId);let s=0;const i=()=>{const n=t.getGlobalXfo(),a=t.getFocalDistance(),r=o.subtract(n.tr),l=r.normalizeInPlace(),h=new e.Quat,c=new e.Quat;{const e=n.ori.getZaxis().clone();e.z=0;const t=r.negate();t.z=0,h.setFrom2Vectors(e,t)}{const e=n.ori.getZaxis().clone(),t=r.negate();e.x=t.x,e.y=t.y,e.normalizeInPlace(),e.cross(t).dot(n.ori.getXaxis())>0?c.rotateX(e.angleTo(t)):c.rotateX(-e.angleTo(t))}const d=n.clone();d.ori=h.multiply(d.ori),d.ori.multiplyInPlace(c);const g=Math.pow(s/20,2),u=n.clone();u.ori=n.ori.lerp(d.ori,g),t.setFocalDistance(a+(l-a)*g),t.setGlobalXfo(u),s++,s<=20?this.__focusIntervalId=setTimeout(i,20):(this.__focusIntervalId=void 0,this.movementFinished.emit())};i(),this.__manipulationState="focussing"}onMouseMove(e){}onDragStart(e){this.__mouseDownPos=e.mousePos,this.initDrag(e.viewport),2==e.button?this.__mode="pan":e.ctrlKey&&2==e.button?this.__mode="dolly":e.shiftKey||2==e.button?this.__mode="look":this.__mode=this.__defaultMode}onDrag(e){switch(this.__keyboardMovement?this.__mouseDragDelta=e.mousePos:this.__mouseDragDelta=e.mousePos.subtract(this.__mouseDownPos),this.__mode){case"orbit":this.orbit(this.__mouseDragDelta,e.viewport);break;case"look":this.look(this.__mouseDragDelta,e.viewport);break;case"pan":this.pan(this.__mouseDragDelta,e.viewport);break;case"dolly":this.dolly(this.__mouseDragDelta,e.viewport)}}onDragEnd(e){return this.movementFinished.emit(),!1}onMouseDown(e){return!(this.__maipulationModel==T.DCC&&!e.altKey)&&(this.dragging=!0,this.__mouseDownPos=e.mousePos,this.onDragStart(e),!0)}onMouseUp(e){if(this.dragging)return this.onDragEnd(e),this.dragging=!1,!0}onMouseMove(e){if(this.dragging)return this.onDrag(e),e.showPointerOnAvatar=!1,!0}onDoubleClick(e){if(e.intersectionData){const t=e.viewport.getCamera(),o=t.getGlobalXfo().tr.add(e.intersectionData.mouseRay.dir.scale(e.intersectionData.dist));this.aimFocus(t,o)}}onWheel(e){if(this.__maipulationModel==T.DCC&&!e.altKey)return!1;const t=e.viewport,o=t.getCamera().getGlobalXfo(),s=o.ori.getZaxis();this.__mouseWheelZoomIntervalId&&clearInterval(this.__mouseWheelZoomIntervalId);let i=0;const n=()=>{const a=t.getCamera().getFocalDistance(),r=this.__mouseWheelDollySpeedParam.getValue(),l=e.deltaY*r*a*.2;o.tr.addInPlace(s.scale(l)),"orbit"==this.__defaultMode&&t.getCamera().setFocalDistance(a+l),t.getCamera().setGlobalXfo(o),i++,i<5?this.__mouseWheelZoomIntervalId=setTimeout(n,20):(this.__mouseWheelZoomIntervalId=void 0,this.movementFinished.emit(),e.viewport.renderGeomDataFbo())};n()}__integrateVelocityChange(t,o){const s=new e.Xfo;s.tr=this.__velocity.normalize().scale(this.__maxVel),o.getCamera().setGlobalXfo(o.getCamera().getGlobalXfo().multiply(s))}onKeyPressed(e,t){return!1}onKeyDown(e,t){}onKeyUp(e,t){return!0}__startTouch(t,o){this.__ongoingTouches[t.identifier]={identifier:t.identifier,pos:new e.Vec2(t.pageX,t.pageY)}}__endTouch(e,t){delete this.__ongoingTouches[e.identifier]}onTouchStart(e){e.preventDefault(),e.stopPropagation(),0==Object.keys(this.__ongoingTouches).length&&(this.__manipMode=void 0);const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__startTouch(t[e]);return this.initDrag(e.viewport),!0}onTouchMove(t){t.preventDefault(),t.stopPropagation();const o=t.changedTouches;if(1==o.length&&"panAndZoom"!=this.__manipMode){const s=o[0],i=new e.Vec2(s.pageX,s.pageY),n=this.__ongoingTouches[s.identifier].pos.subtract(i);return"look"==this.__defaultMode?(n.scaleInPlace(6),this.look(n,t.viewport)):this.orbit(n,t.viewport),this.__manipMode="orbit",!0}if(2==o.length){const s=o[0],i=this.__ongoingTouches[s.identifier],n=o[1],a=this.__ongoingTouches[n.identifier],r=new e.Vec2(s.pageX,s.pageY),l=new e.Vec2(n.pageX,n.pageY),h=a.pos.subtract(i.pos).length()-l.subtract(r).length(),c=r.subtract(i.pos),d=l.subtract(a.pos),g=c.add(d);return g.scaleInPlace(.5),this.panAndZoom(g,.002*h,t.viewport),this.__manipMode="panAndZoom",!0}}onTouchEnd(e){e.preventDefault(),e.stopPropagation();const t=e.changedTouches;switch(this.__manipMode){case"orbit":case"panAndZoom":this.movementFinished.emit()}for(let e=0;e<t.length;e++)this.__endTouch(t[e]);return 0==Object.keys(this.__ongoingTouches).length&&(this.__manipMode=void 0),!0}onTouchCancel(e){console.log("touchcancel.");const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__endTouch(t[e]);return!0}onDoubleTap(e){const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__startTouch(t[e]);if(e.intersectionData){const t=e.viewport.getCamera(),o=t.getGlobalXfo().tr.add(e.intersectionData.mouseRay.dir.scale(e.intersectionData.dist));this.aimFocus(t,o)}}__initMoveStage(e){if(1==this.__controllerTriggersHeld.length)this.__grabPos=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr.clone(),this.stageXfo__GrabStart=e.getXfo().clone(),this.__invOri=this.stageXfo__GrabStart.ori.inverse();else if(2==this.__controllerTriggersHeld.length){const t=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,o=this.__controllerTriggersHeld[1].getControllerTipStageLocalXfo().tr;this.__grabDir=o.subtract(t),this.__grabPos=t.lerp(o,.5),this.__grabDir.y=0,this.__grabDist=this.__grabDir.length(),this.__grabDir.scaleInPlace(1/this.__grabDist),this.stageXfo__GrabStart=e.getXfo().clone(),this.__grab_to_stage=this.__grabPos.subtract(this.stageXfo__GrabStart.tr)}}onVRControllerButtonDown(e){if(1==e.button)return this.__controllerTriggersHeld.push(e.controller),this.__initMoveStage(e.vrviewport),!0}onVRControllerButtonUp(e){if(1!=e.button)return;const t=this.__controllerTriggersHeld.indexOf(e.controller);return this.__controllerTriggersHeld.splice(t,1),this.__initMoveStage(e.vrviewport),!0}onVRControllerDoubleClicked(e){console.log("onVRControllerDoubleClicked:",this.__controllerTriggersHeld.length);const t=e.vrviewport.getXfo().clone();t.sc.set(1,1,1),e.vrviewport.setXfo(t)}onVRPoseChanged(t){if(1==this.__controllerTriggersHeld.length){const o=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,s=new e.Xfo;s.tr=this.__grabPos.subtract(o);const i=this.stageXfo__GrabStart.multiply(s);return t.vrviewport.setXfo(i),!0}if(2==this.__controllerTriggersHeld.length){const o=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,s=this.__controllerTriggersHeld[1].getControllerTipStageLocalXfo().tr,i=o.lerp(s,.5),n=s.subtract(o);n.y=0;const a=n.length();n.scaleInPlace(1/a);const r=new e.Xfo,l=Math.max(Math.min(this.__grabDist/a,10),.1);r.sc.set(l,l,l);let h=this.__grabDir.angleTo(n);this.__grabDir.cross(n).y>0&&(h=-h),r.ori.rotateY(h);const c=r.ori.rotateVec3(this.__grabPos);r.tr.addInPlace(this.__grabPos.subtract(c));const d=this.__grabPos.scale(1-l);r.tr.addInPlace(r.ori.rotateVec3(d));const g=this.__grabPos.subtract(i).scale(l);r.tr.addInPlace(r.ori.rotateVec3(g));const u=this.stageXfo__GrabStart.multiply(r);return t.vrviewport.setXfo(u),!0}}};
