import{EventEmitter as e,TreeItem as t,Ray as o,ValueSetMode as s,Parameter as i,Color as a,ColorParameter as n,Material as r,Cylinder as h,Cone as l,GeomItem as c,Xfo as d,Vec3 as u,NumberParameter as g,Torus as m,Cuboid as p,Sphere as _,Group as f,BaseItem as v,Operator as w,sgFactory as P,ParameterOwner as I,Vec2 as C,SystemDesc as b,Quat as D,Rect as S,Plane as M,DataImage as T,Lines as X,Cross as V,Circle as y,BooleanParameter as R}from"@zeainc/zea-engine";const x={},k={},O=[];class G{constructor(){this.__undoStack=[],this.__redoStack=[],this.__currChangeUpdated=this.__currChangeUpdated.bind(this)}flush(){for(const e of this.__undoStack)e.destroy();this.__undoStack=[];for(const e of this.__redoStack)e.destroy();this.__redoStack=[]}addChange(e){this.getCurrentChange()&&this.getCurrentChange().updated.disconnect(this.__currChangeUpdated),this.__undoStack.push(e),e.updated.connect(this.__currChangeUpdated);for(const e of this.__redoStack)e.destroy();this.__redoStack=[],this.emit("changeAdded",{change:e})}getCurrentChange(){return this.__undoStack[this.__undoStack.length-1]}__currChangeUpdated(e){this.emit("changeUpdated",e)}undo(e=!0){if(this.__undoStack.length>0){const t=this.__undoStack.pop();t.undo(),e&&(this.__redoStack.push(t),this.emit("changeUndone"))}}redo(){if(this.__redoStack.length>0){const e=this.__redoStack.pop();e.redo(),this.__undoStack.push(e),this.emit("changeRedone")}}constructChange(e){return new x[e]}static isChangeClassRegistered(e){return-1!=O.indexOf(e.constructor)}static getChangeClassName(e){const t=O.indexOf(e.constructor);return k[t]?k[t]:(console.warn("Change not registered:",e.constructor.name),"")}static registerChange(e,t){-1!=O.indexOf(t)&&console.warn("Class already registered:",e);const o=O.length;O.push(t),x[e]=t,k[o]=e}}class A extends e{constructor(e){super(),this.name=e||G.getChangeClassName(this)}undo(){throw new Error("Implement me")}redo(){throw new Error("Implement me")}update(e){throw new Error("Implement me")}toJSON(e){return{}}fromJSON(e,t){}changeFromJSON(e){this.update(e)}destroy(){}}class E extends t{constructor(e){super(e),this.captured=!1}highlight(){}unhighlight(){}getManipulationPlane(){const e=this.getGlobalXfo();return new o(e.tr,e.ori.getZaxis())}onMouseEnter(e){this.highlight()}onMouseLeave(e){this.unhighlight()}onMouseDown(e){e.setCapture(this),e.stopPropagation(),this.captured=!0,e.viewport?this.handleMouseDown(e):e.vrviewport&&this.onVRControllerButtonDown(e)}onMouseMove(e){this.captured&&(e.stopPropagation(),e.viewport?this.handleMouseMove(e):e.vrviewport&&this.onVRPoseChanged(e))}onMouseUp(e){this.captured&&(e.releaseCapture(),e.stopPropagation(),this.captured=!1,e.viewport?this.handleMouseUp(e):e.vrviewport&&this.onVRControllerButtonUp(e))}onWheel(e){}handleMouseDown(e){this.gizmoRay=this.getManipulationPlane();const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.grabPos=e.mouseRay.pointAtDist(t),this.onDragStart(e),!0}handleMouseMove(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.holdPos=e.mouseRay.pointAtDist(t),this.onDrag(e),!0}handleMouseUp(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.releasePos=e.mouseRay.pointAtDist(t),this.onDragEnd(e),!0}onVRControllerButtonDown(e){this.activeController=e.controller;const t=this.activeController.getTipXfo().clone(),o=this.getManipulationPlane(),s=t.tr.subtract(o.start),i=t.tr.subtract(o.dir.scale(s.dot(o.dir)));return e.grabPos=i,this.onDragStart(e),!0}onVRPoseChanged(e){if(this.activeController){const t=this.activeController.getTipXfo(),o=this.getManipulationPlane(),s=t.tr.subtract(o.start),i=t.tr.subtract(o.dir.scale(s.dot(o.dir)));return e.holdPos=i,this.onDrag(e),!0}}onVRControllerButtonUp(e){if(this.activeController==e.controller){const t=this.activeController.getTipXfo();return this.onDragEnd(e,t.tr),this.activeController=void 0,!0}}onDragStart(e){console.log("onDragStart",e)}onDrag(e){console.log("onDrag",e)}onDragEnd(e){console.log("onDragEnd",e)}}class U extends E{constructor(e){super(e)}handleMouseDown(e){this.gizmoRay=this.getManipulationPlane(),this.grabDist=e.mouseRay.intersectRayVector(this.gizmoRay)[1];const t=this.gizmoRay.pointAtDist(this.grabDist);return e.grabDist=this.grabDist,e.grabPos=t,this.onDragStart(e),!0}handleMouseMove(e){const t=e.mouseRay.intersectRayVector(this.gizmoRay)[1],o=this.gizmoRay.pointAtDist(t);e.holdDist=t,e.holdPos=o,e.value=t,e.delta=t-this.grabDist,this.onDrag(e)}handleMouseUp(e){const t=e.mouseRay.intersectRayVector(this.gizmoRay)[1],o=this.gizmoRay.pointAtDist(t);return e.releasePos=o,this.onDragEnd(e),!0}onVRControllerButtonDown(e){this.gizmoRay=this.getManipulationPlane(),this.activeController=e.controller;const t=this.activeController.getTipXfo();this.grabDist=t.tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir);const o=this.gizmoRay.start.add(this.gizmoRay.dir.scale(this.grabDist));return e.grabPos=o,this.onDragStart(e),!0}onVRPoseChanged(e){const t=this.activeController.getTipXfo().tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir),o=this.gizmoRay.start.add(this.gizmoRay.dir.scale(t));return e.value=t,e.holdPos=o,e.delta=t-this.grabDist,this.onDrag(e),!0}onVRControllerButtonUp(e){if(this.activeController==e.controller)return this.onDragEnd(),this.activeController=void 0,!0}}class L extends A{constructor(e,t,o=s.USER_SETVALUE){e?(super(e?e.getName()+" Changed":"ParameterValueChange"),this.__prevValue=e.getValue(),this.__param=e,this.__mode=o,null!=t&&(this.__nextValue=t,this.__param.setValue(this.__nextValue,o))):super()}undo(){this.__param&&this.__param.setValue(this.__prevValue,this.__mode)}redo(){this.__param&&this.__param.setValue(this.__nextValue,this.__mode)}update(e){if(!this.__param)return;this.__nextValue=e.value;const t=e.mode?e.mode:this.__mode;this.__param.setValue(this.__nextValue,t),this.updated.emit(e)}toJSON(e){const t={name:this.name,paramPath:this.__param.getPath()};return null!=this.__nextValue&&(this.__nextValue.toJSON?t.value=this.__nextValue.toJSON():t.value=this.__nextValue),t}fromJSON(e,t){const o=t.appData.scene.getRoot().resolvePath(e.paramPath,1);o&&o instanceof i?(this.__param=o,this.__prevValue=this.__param.getValue(),this.__prevValue.clone?this.__nextValue=this.__prevValue.clone():this.__nextValue=this.__prevValue,this.name=e.name,null!=e.value&&this.changeFromJSON(e)):console.warn("resolvePath is unable to resolve",e.paramPath)}changeFromJSON(e){this.__param&&(this.__nextValue.fromJSON?this.__nextValue.fromJSON(e.value):this.__nextValue=e.value,this.__param.setValue(this.__nextValue,s.REMOTEUSER_SETVALUE))}}G.registerChange("ParameterValueChange",L);class B extends U{constructor(e,t,o,s){super(e),this.__color=s,this.__hilightedColor=new a(1,1,1),this.colorParam=this.addParameter(new n("BaseColor",s));const i=new r("handle","HandleShader");i.getParameter("maintainScreenSize").setValue(1),i.replaceParameter(this.colorParam);const u=new h(o,t,64);u.getParameter("baseZAtZero").setValue(!0);const g=new l(4*o,10*o,64,!0),m=new c("handle",u,i),p=new c("tip",g,i),_=new d;_.tr.set(0,0,t),g.transformVertices(_),this.addChild(m),this.addChild(p)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new L(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.grabPos),o=this.baseXfo.clone();o.tr.addInPlace(t),this.change?this.change.update({value:o}):this.param.setValue(o)}onDragEnd(e){this.change=null}}class H extends E{constructor(e){super(e),this.fullXfoManipulationInVR=!0}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new L(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.grabPos),o=this.baseXfo.clone();if(o.tr.addInPlace(t),this.change)this.change.update({value:o});else{this.getTargetParam().setValue(o)}}onDragEnd(e){this.change=null}onVRControllerButtonDown(e){if(this.fullXfoManipulationInVR){this.activeController=e.controller;const t=this.activeController.getTipXfo(),o=this.getGlobalXfo();this.grabOffset=t.inverse().multiply(o)}else super.onVRControllerButtonDown(e);return!0}onVRPoseChanged(e){if(this.fullXfoManipulationInVR){const e=this.activeController.getTipXfo().multiply(this.grabOffset);if(this.change)this.change.update({value:e});else{this.getTargetParam().setValue(e)}}else super.onVRPoseChanged(e)}onVRControllerButtonUp(e){this.fullXfoManipulationInVR?this.change=null:super.onVRControllerButtonUp(e)}}class N extends E{constructor(e){super(e)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.baseXfo=this.getGlobalXfo().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new d;const t=this.getTargetParam(),o=t.getValue();this.offsetXfo=this.baseXfo.inverse().multiply(o),this.vec0=e.grabPos.subtract(this.baseXfo.tr),this.grabCircleRadius=this.vec0.length(),this.vec0.normalizeInPlace(),e.undoRedoManager&&(this.change=new L(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.baseXfo.tr),o=t.length();t.normalizeInPlace();const s=o/this.grabCircleRadius;let i=this.vec0.angleTo(t)*s;if(this.vec0.cross(t).dot(this.baseXfo.ori.getZaxis())<0&&(i=-i),this.range&&(i=Math.clamp(i,this.range[0],this.range[1])),e.shiftKey){const e=Math.degToRad(22.5);i=Math.floor(i/e)*e}this.deltaXfo.ori.setFromAxisAndAngle(new u(0,0,1),i);const a=this.baseXfo.multiply(this.deltaXfo).multiply(this.offsetXfo);if(this.change)this.change.update({value:a});else{this.getTargetParam().setValue(a)}}onDragEnd(e){this.change=null}}class z extends N{constructor(e,t,o,s){super(e),this.__color=s,this.__hilightedColor=new a(1,1,1),this.radiusParam=this.addParameter(new g("radius",t)),this.colorParam=this.addParameter(new n("BaseColor",s));const i=new r("handle","HandleShader");i.getParameter("maintainScreenSize").setValue(1),i.replaceParameter(this.colorParam);const h=new m(o,t,64);this.handle=new c("handle",h,i),this.handleXfo=new d,this.radiusParam.on("valueChanged",()=>{t=this.radiusParam.getValue(),h.getParameter("radius").setValue(t),h.getParameter("height").setValue(.02*t)}),this.addChild(this.handle)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}getBaseXfo(){return this.getParameter("GlobalXfo").getValue()}onDragStart(e){super.onDragStart(e),this.colorParam.setValue(new a(1,1,1))}onDrag(e){super.onDrag(e)}onDragEnd(e){super.onDragEnd(e),this.colorParam.setValue(this.__color)}}class F extends U{constructor(e,t,o,s){super(e),this.__color=s,this.__hilightedColor=new a(1,1,1),this.colorParam=this.addParameter(new n("BaseColor",s));const i=new r("handle","HandleShader");i.getParameter("maintainScreenSize").setValue(1),i.replaceParameter(this.colorParam);const l=new h(o,t-10*o,64);l.getParameter("baseZAtZero").setValue(!0);const u=new p(10*o,10*o,10*o),g=new c("handle",l,i),m=new c("tip",u,i),_=new d;_.tr.set(0,0,t-10*o),u.transformVertices(_),this.addChild(g),this.addChild(m)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabDist=e.grabDist,this.oriXfo=this.getGlobalXfo(),this.tmplocalXfo=this.getLocalXfo();const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new L(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=this.baseXfo.clone(),o=e.holdDist/this.grabDist;o<1e-4||(t.sc.set(this.baseXfo.sc.x*o,this.baseXfo.sc.y*o,this.baseXfo.sc.z*o),this.tmplocalXfo.sc.set(1,1,o),this.setLocalXfo(this.tmplocalXfo),this.change?this.change.update({value:t}):this.param.setValue(t))}onDragEnd(e){this.change=null,this.tmplocalXfo.sc.set(1,1,1),this.setLocalXfo(this.tmplocalXfo);const t=this.getChildByName("tip"),o=t.getLocalXfo();o.sc.set(1,1,1),t.setLocalXfo(o)}}class J extends E{constructor(e,t,o){super(e),this.radius=t;const s=new r("mask","HandleShader");s.getParameter("maintainScreenSize").setValue(1),s.getParameter("BaseColor").setValue(o);const i=new _(t,64),a=new c("mask",i,s);this.addChild(a)}highlight(){}unhighlight(){}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}handleMouseDown(e){return!0}handleMouseMove(e){return!0}handleMouseUp(e){return!0}onDragStart(e){this.baseXfo=this.getGlobalXfo(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new d;const t=this.getTargetParam();this.offsetXfo=this.baseXfo.inverse().multiply(t.getValue()),this.vec0=e.grabPos.subtract(this.baseXfo.tr),this.vec0.normalizeInPlace(),this.colorParam.setValue(new a(1,1,1)),e.undoRedoManager&&(this.change=new ParameterValueChange(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.baseXfo.tr);t.normalizeInPlace();const o=this.vec0.angleTo(t)*modulator,s=this.vec0.cross(t).normalize();this.deltaXfo.ori.setFromAxisAndAngle(s,o);const i=this.baseXfo.multiply(this.deltaXfo),a=i.multiply(this.offsetXfo);if(this.change)this.change.update({value:a});else{this.getTargetParam().setValue(i)}}onDragEnd(e){this.change=null,this.colorParam.setValue(this.__color)}}class Z extends H{constructor(e,t,o,s){super(e),this.__color=o,this.__hilightedColor=new a(1,1,1),this.sizeParam=this.addParameter(new g("size",t)),this.colorParam=this.addParameter(new n("BaseColor",o));const i=new r("handle","HandleShader");i.getParameter("maintainScreenSize").setValue(1),i.replaceParameter(this.colorParam);const h=new p(t,t,.02*t),l=new d;l.tr=s,h.transformVertices(l),this.handle=new c("handle",h,i),this.sizeParam.on("valueChanged",()=>{t=this.sizeParam.getValue(),h.getParameter("size").setValue(t),h.getParameter("height").setValue(.02*t)}),this.addChild(this.handle)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}}class K extends t{constructor(e,o){super("XfoHandle");const s=new t("Translate");s.setVisible(!1),this.addChild(s);const i=new a(1,.1,.1),n=new a("#32CD32"),r=new a("#1E90FF");i.a=.8,n.a=.8,r.a=.8;{const t=new B("linearX",e,o,i),a=new d;a.ori.setFromAxisAndAngle(new u(0,1,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(a),s.addChild(t)}{const t=new B("linearY",e,o,n),i=new d;i.ori.setFromAxisAndAngle(new u(1,0,0),-.5*Math.PI),t.getParameter("LocalXfo").setValue(i),s.addChild(t)}{const t=new B("linearZ",e,o,r);s.addChild(t)}const h=.35*e;{const e=new Z("planarXY",h,n,new u(.5*h,.5*h,0)),t=new d;e.getParameter("LocalXfo").setValue(t),s.addChild(e)}{const e=new Z("planarYZ",h,i,new u(-.5*h,.5*h,0)),t=new d;t.ori.setFromAxisAndAngle(new u(0,1,0),.5*Math.PI),e.getParameter("LocalXfo").setValue(t),s.addChild(e)}{const e=new Z("planarXZ",h,r,new u(.5*h,.5*h,0)),t=new d;t.ori.setFromAxisAndAngle(new u(1,0,0),.5*Math.PI),e.getParameter("LocalXfo").setValue(t),s.addChild(e)}const l=new t("Rotate");l.setVisible(!1),this.addChild(l);{const t=new J("rotation",e-o,new a(1,1,1,.4));l.addChild(t)}{const t=new z("rotationX",e,o,i),s=new d;s.ori.setFromAxisAndAngle(new u(0,1,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(s),l.addChild(t)}{const t=new z("rotationY",e,o,n),s=new d;s.ori.setFromAxisAndAngle(new u(1,0,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(s),l.addChild(t)}{const t=new z("rotationZ",e,o,r);l.addChild(t)}const c=new t("Scale");c.setVisible(!1),this.addChild(c);const g=.95*e;{const e=new F("scaleX",g,o,i),t=new d;t.ori.setFromAxisAndAngle(new u(0,1,0),.5*Math.PI),e.getParameter("LocalXfo").setValue(t),c.addChild(e)}{const e=new F("scaleY",g,o,n),t=new d;t.ori.setFromAxisAndAngle(new u(1,0,0),-.5*Math.PI),e.getParameter("LocalXfo").setValue(t),c.addChild(e)}{const e=new F("scaleZ",g,o,r);c.addChild(e)}}_cleanGlobalXfo(e){const t=this.getParentItem();if(void 0!==t){const e=t.getGlobalXfo().clone();return e.sc.set(1,1,1),e.multiply(this.__localXfoParam.getValue())}return this.__localXfoParam.getValue()}showHandles(e){this.traverse(e=>{if(e!=this)return e.setVisible(!1),!1});const t=this.getChildByName(e);t&&t.setVisible(!0)}setTargetParam(e){this.param=e,this.traverse(t=>{t instanceof E&&t.setTargetParam(e,!1)})}}class W extends f{constructor(e){let t,o;super(),e.selectionOutlineColor?t=e.selectionOutlineColor:(t=new a("#03E3AC"),t.a=.1),e.branchSelectionOutlineColor?o=e.branchSelectionOutlineColor:(o=t.lerp(new a("white"),.5),o.a=.1),this.getParameter("HighlightColor").setValue(t),this.addParameter(new n("SubtreeHighlightColor",o)),this.propagatingSelectionToItems=0!=e.setItemsSelected,this.getParameter("InitialXfoMode").setValue(f.INITIAL_XFO_MODES.average),this.__itemsParam.setFilterFn(e=>e instanceof v)}clone(e){const t=new W;return t.copyFrom(this,e),t}rebindInitialXfos(){Array.from(this.__itemsParam.getValue()).forEach((e,o)=>{e instanceof t&&(this.__initialXfos[o]=e.getGlobalXfo())})}__bindItem(e,o){this.propagatingSelectionToItems&&e.setSelected(this);const s={};if(e instanceof t){const i=this.getParameter("HighlightColor").getValue();i.a=this.getParameter("HighlightFill").getValue();const a=this.getParameter("SubtreeHighlightColor").getValue();e.addHighlight("selected"+this.getId(),i,!1),e.getChildren().forEach(e=>{e instanceof t&&e.addHighlight("branchselected"+this.getId(),a,!0)}),s.globalXfoChangedIndex=e.on("globalXfoChanged",t=>{this.calculatingGroupXfo||this.propagatingXfoToItems||(this.__initialXfos[o]=e.getGlobalXfo(),this.groupXfoDirty=!0,this._setGlobalXfoDirty())}),this.__initialXfos[o]=e.getGlobalXfo(),this.groupXfoDirty=!0}this.__signalIndices[o]=s}__unbindItem(e,o){this.propagatingSelectionToItems&&e.setSelected(!1),e instanceof t&&(e.removeHighlight("selected"+this.getId()),e.getChildren().forEach(e=>{e instanceof t&&e.removeHighlight("branchselected"+this.getId(),!0)}),e.removeListenerById("globalXfoChanged",this.__signalIndices[o].globalXfoChangedIndex),this.__initialXfos.splice(o,1),this.groupXfoDirty=!0),this.__signalIndices.splice(o,1)}_propagateDirtyXfoToItems(){if(this.groupXfoDirty||this.calculatingGroupXfo)return;const e=Array.from(this.__itemsParam.getValue());if(!this.calculatingGroupXfo&&e.length>0&&this.invGroupXfo&&!this.dirty){const o=this.__globalXfoParam.getValue().multiply(this.invGroupXfo);this.propagatingXfoToItems=!0;const s=(e,t)=>{const s=e.getParameter("GlobalXfo"),i=o.multiply(t);s.setValue(i)};e.forEach((e,o)=>{e instanceof t&&s(e,this.__initialXfos[o])}),this.propagatingXfoToItems=!1}}}class j extends A{constructor(e,t,o){super("SelectionChange"),this.__selectionManager=e,this.__prevSelection=t,this.__newSelection=o}undo(){this.__selectionManager.setSelection(this.__prevSelection,!1)}redo(){this.__selectionManager.setSelection(this.__newSelection,!1)}toJSON(e){const t=super.toJSON(e),o=[];for(const e of this.__newSelection)o.push(e.getPath());return t.itemPaths=o,t}fromJSON(e,t){super.fromJSON(e,t),this.__selectionManager=t.appData.selectionManager,this.__prevSelection=new Set(this.__selectionManager.getSelection());const o=t.appData.scene.getRoot(),s=new Set;for(const t of e.itemPaths)s.add(o.resolvePath(t,1));this.__newSelection=s,this.__selectionManager.setSelection(this.__newSelection,!1)}}G.registerChange("SelectionChange",j);class Y extends A{constructor(e,t){super("Selection Visibility Change"),this.selection=e,this.state=t,this.do(this.state)}undo(){this.do(!this.state)}redo(){this.do(this.state)}do(e){for(const t of this.selection)t.getParameter("Visible").setValue(e)}}G.registerChange("ToggleSelectionVisibility",Y);class q extends e{constructor(e,t={}){if(super(),this.appData=e,this.leadSelection=void 0,this.selectionGroup=new W(t),!0===t.enableXfoHandles){const e=.1,t=.02*e;this.xfoHandle=new K(e,t),this.xfoHandle.setTargetParam(this.selectionGroup.getParameter("GlobalXfo"),!1),this.xfoHandle.setVisible(!1),this.selectionGroup.addChild(this.xfoHandle)}this.appData.renderer&&this.setRenderer(this.appData.renderer)}setRenderer(e){this.__renderer=e,this.__renderer.addTreeItem(this.selectionGroup)}setXfoMode(e){this.xfoHandle&&(this.selectionGroup.rebindInitialXfos(),this.selectionGroup.getParameter("InitialXfoMode").setValue(e))}showHandles(e){if(this.xfoHandle&&this.currMode!=e){this.currMode=e;for(const t in this.handleGroup)this.handleGroup[t].emit(e==t);this.xfoHandle.showHandles(e)}}updateHandleVisiblity(){if(!this.xfoHandle)return;const e=this.selectionGroup.getItems(),t=Array.from(e).length>0;this.xfoHandle.setVisible(t),this.__renderer.requestRedraw()}getSelection(){return this.selectionGroup.getItems()}setSelection(e,t=!0){const o=new Set(this.selectionGroup.getItems()),s=new Set(o);for(const t of e)o.has(t)||o.add(t);for(const t of o)e.has(t)||o.delete(t);if(this.selectionGroup.setItems(o),o.size>0?this.__setLeadSelection(o.values().next().value):this.__setLeadSelection(),this.updateHandleVisiblity(),t){const e=new j(this,s,o);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(e)}}__setLeadSelection(e){this.leadSelection!=e&&(this.leadSelection=e,this.emit("leadSelectionChanged",{treeItem:e}))}toggleItemSelection(e,t=!0){const o=new Set(this.selectionGroup.getItems()),s=new Set(o);if(t&&(1!=o.size||!o.has(e))){let t=!0;if(o.has(e)){let s=1;e.traverse(e=>{o.has(e)&&s++}),t=s!=o.size}t&&o.clear()}let i;o.has(e)?(o.delete(e),i=!1):(o.add(e),i=!0),this.selectionGroup.setItems(o),i&&1===o.size?this.__setLeadSelection(e):i||(1===o.size?this.__setLeadSelection(o.values().next().value):0===o.size&&this.__setLeadSelection());const a=new j(this,s,o);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(a),this.updateHandleVisiblity(),this.emit("selectionChanged",{prevSelection:s,selection:o})}clearSelection(e=!0){const t=new Set(this.selectionGroup.getItems());if(0==t.size)return!1;let o;if(e&&(o=new Set(t)),t.clear(),this.selectionGroup.setItems(t),this.updateHandleVisiblity(),e){const e=new j(this,o,t);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(e),this.emit("selectionChanged",{selection:t,prevSelection:o})}return!0}selectItems(e,t=!0){const o=new Set(this.selectionGroup.getItems()),s=new Set(o);t&&o.clear();for(const t of e)t.getSelected()||o.add(t);const i=new j(this,s,o);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(i),this.selectionGroup.setItems(o),1===o.size?this.__setLeadSelection(o.values().next().value):0===o.size&&this.__setLeadSelection(),this.updateHandleVisiblity(),this.emit("selectionChanged",{prevSelection:s,selection:o})}deselectItems(e){const t=this.selectionGroup.getItems(),o=new Set(t);for(const o of e)o.getSelected()&&t.delete(selectedParam);this.selectionGroup.setItems(t);const s=new j(this,o,t);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(s),1===t.size?this.__setLeadSelection(t.values().next().value):0===t.size&&this.__setLeadSelection(),this.updateHandleVisiblity(),this.emit("selectionChanged",{prevSelection:o,selection:t})}toggleSelectionVisiblity(){if(this.leadSelection){const e=this.selectionGroup.getItems(),t=!this.leadSelection.getVisible(),o=new Y(e,t);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(o)}}startPickingMode(e,t,o,s){console.log(e),this.__pickCB=t,this.__pickFilter=o,this.__pickCount=s,this.__picked=[]}pickingFilter(e){return this.__pickFilter(e)}pickingModeActive(){return null!=this.__pickCB}cancelPickingMode(){this.__pickCB=void 0}pick(e){if(this.__pickCB){if(Array.isArray(e))this.__pickFilter?this.__picked=this.__picked.concat(e.filter(this.__pickFilter)):this.__picked=this.__picked.concat(e);else{if(this.__pickFilter&&!this.__pickFilter(e))return;this.__picked.push(e)}this.__picked.length==this.__pickCount&&(this.__pickCB(this.__picked),this.__pickCB=void 0)}}}class $ extends A{constructor(e,t,o){e?(super(e.getName()+" Added"),this.treeItem=e,this.owner=t,this.selectionManager=o,this.prevSelection=new Set(this.selectionManager.getSelection()),this.treeItemIndex=this.owner.addChild(this.treeItem),this.selectionManager.setSelection(new Set([this.treeItem]),!1),this.treeItem.addRef(this)):super()}undo(){if(this.treeItem instanceof w){this.treeItem.detach()}else this.treeItem instanceof t&&this.treeItem.traverse(e=>{if(e instanceof w){e.detach()}},!1);this.owner.removeChild(this.treeItemIndex),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1)}redo(){if(this.treeItem instanceof w){this.treeItem.reattach()}else subTreeItem instanceof t&&this.treeItem.traverse(e=>{if(e instanceof w){e.reattach()}},!1);this.owner.addChild(this.treeItem),this.selectionManager&&this.selectionManager.setSelection(new Set([this.treeItem]),!1)}toJSON(e){return{name:this.name,treeItem:this.treeItem.toJSON(e),treeItemPath:this.treeItem.getPath(),treeItemIndex:this.treeItemIndex}}fromJSON(e,t){const o=P.constructClass(e.treeItem.type);o?(this.name=e.name,this.treeItem=o,this.treeItem.addRef(this),this.treeItem.fromJSON(e.treeItem,t),this.treeItemIndex=this.owner.addChild(this.treeItem,!1,!1)):console.warn("resolvePath is unable to conostruct",e.treeItem)}destroy(){this.treeItem.removeRef(this)}}G.registerChange("TreeItemAddChange",$);class Q extends A{constructor(e,o){if(super(),this.items=[],this.itemOwners=[],this.itemPaths=[],this.itemIndices=[],e){this.selectionManager=o.selectionManager,this.prevSelection=new Set(this.selectionManager.getSelection()),this.items=e,this.newSelection=new Set(this.prevSelection);const s=[];this.items.forEach(e=>{const o=e.getOwner(),i=o.getChildIndex(e);if(s.push(e.getName()),e.addRef(this),this.itemOwners.push(o),this.itemPaths.push(e.getPath()),this.itemIndices.push(i),this.selectionManager&&this.newSelection.has(e)&&this.newSelection.delete(e),e instanceof w){e.detach()}else e instanceof t&&e.traverse(e=>{if(e instanceof w){e.detach()}this.selectionManager&&this.newSelection.has(e)&&this.newSelection.delete(e)},!1);o.removeChild(i)}),this.selectionManager.setSelection(this.newSelection,!1),this.name=s+" Deleted"}}undo(){this.items.forEach((e,o)=>{if(this.itemOwners[o].insertChild(e,this.itemIndices[o],!1,!1),e instanceof w){e.reattach()}else subTreeItem instanceof t&&e.traverse(e=>{if(e instanceof w){e.reattach()}},!1)}),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1)}redo(){this.selectionManager&&this.selectionManager.setSelection(this.newSelection,!1),this.items.forEach((e,o)=>{if(this.itemOwners[o].removeChild(this.itemIndices[o]),e instanceof w){e.detach()}else subTreeItem instanceof t&&e.traverse(e=>{if(e instanceof w){e.detach()}},!1)})}toJSON(e){const t={name:this.name,items:[],itemPaths:this.itemPaths,itemIndices:this.itemIndices};return this.items.forEach(e=>{t.items.push(e.toJSON())}),t}fromJSON(e,t){this.name=e.name,e.itemPaths.forEach(e=>{const o=t.scene.getRoot().resolvePath(e,1);if(!o)return void console.warn("resolvePath is unable to resolve",e);const s=o.getOwner();this.itemOwners.push(s),this.itemPaths.push(o.getPath()),this.itemIndices.push(s.getChildIndex(o))})}destroy(){this.items.forEach(e=>e.removeRef(this))}}G.registerChange("TreeItemsRemoveChange",Q);class ee extends A{constructor(e,t){e?(console.log("TreeItemMoveChange"),super(e.getName()+" Added"),this.treeItem=e,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner=t,this.newOwner.addChild(this.treeItem,!0)):super()}undo(){this.oldOwner.insertChild(this.treeItem,this.oldOwnerIndex,!0)}redo(){this.newOwner.addChild(this.treeItem,!0)}toJSON(e){return{name:this.name,treeItemPath:this.treeItem.getPath(),newOwnerPath:this.newOwner.getPath()}}fromJSON(e,t){const o=appData.scene.getRoot().resolvePath(e.treeItemPath,1);if(!o)return void console.warn("resolvePath is unable to resolve",e.treeItemPath);const s=appData.scene.getRoot().resolvePath(e.newOwnerPath,1);s?(this.name=e.name,this.treeItem=o,this.newOwner=s,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner.addChild(this.treeItem,!0)):console.warn("resolvePath is unable to resolve",e.newOwnerPath)}}G.registerChange("TreeItemMoveChange",ee);class te{constructor(e){this.__toolStack=[],this.appData=e,this.avatarPointerVisible=!1,this.avatarPointerHighlighted=!1}insertTool(e,t){this.__toolStack.splice(t,0,e),e.install(t)}insertToolBefore(e,t){const o=this.__toolStack.indexOf(t)+1;return this.__toolStack.splice(o-1,0,e),e.install(o),o}insertToolAfter(e,t){const o=this.__toolStack.indexOf(t)+1;return this.__toolStack.splice(o,0,e),e.install(o),o==this.__toolStack.length&&e.activateTool(),o}getToolIndex(e){return this.__toolStack.indexOf(e)}removeTool(e){const t=this.__toolStack[e];if(this.__toolStack.splice(e,1),t.uninstall(),e==this.__toolStack.length){t.deactivateTool();const e=this.currTool();e?e.activateTool():this.appData.renderer.getDiv().style.cursor="pointer"}}removeToolByHandle(e){this.removeTool(this.getToolIndex(e))}pushTool(e){const t=this.currTool();if(t){if(e==t)return void console.warn("Tool Already Pushed on the stack:",e.constructor.name);t.deactivateTool()}return this.__toolStack.push(e),e.install(this.__toolStack.length-1),e.activateTool(),console.log("ToolManager.pushTool:",e.constructor.name),this.__toolStack.length-1}__removeCurrTool(){if(this.__toolStack.length>0){const e=this.__toolStack.pop();e.deactivateTool(),e.uninstall()}}popTool(){this.__removeCurrTool();const e=this.currTool();e&&e.activateTool()}replaceCurrentTool(e){this.__removeCurrTool(),this.__toolStack.push(e),e.install(this.__toolStack.length-1),e.activateTool()}currTool(){return this.__toolStack[this.__toolStack.length-1]}currToolName(){return this.__toolStack[this.__toolStack.length-1].getName()}bind(e){const t=e.getViewport();this.mouseDownId=t.on("mouseDown",this.onMouseDown.bind(this)),this.mouseMoveId=t.on("mouseMove",this.onMouseMove.bind(this)),this.mouseUpId=t.on("mouseUp",this.onMouseUp.bind(this)),this.mouseLeaveId=t.on("mouseLeave",this.onMouseLeave.bind(this)),this.mouseDoubleClickedId=t.on("mouseDoubleClicked",this.onDoubleClick.bind(this)),this.mouseWheelId=t.on("mouseWheel",this.onWheel.bind(this)),this.keyDownId=t.on("keyDown",this.onKeyDown.bind(this)),this.keyUpId=t.on("keyUp",this.onKeyUp.bind(this)),this.keyPressedId=t.on("keyPressed",this.onKeyPressed.bind(this)),this.touchStartId=t.on("touchStart",this.onTouchStart.bind(this)),this.touchMoveId=t.on("touchMove",this.onTouchMove.bind(this)),this.touchEndId=t.on("touchEnd",this.onTouchEnd.bind(this)),this.touchCancelId=t.on("touchCancel",this.onTouchCancel.bind(this)),this.doubleTappedId=t.on("doubleTapped",this.onDoubleTap.bind(this)),this.appData.renderer.getXRViewport().then(e=>{this.controllerDownId=e.on("controllerButtonDown",this.onVRControllerButtonDown.bind(this)),this.controllerUpId=e.on("controllerButtonUp",this.onVRControllerButtonUp.bind(this)),this.controllerDoubleClickId=e.on("controllerDoubleClicked",this.onVRControllerDoubleClicked.bind(this)),this.onVRPoseChangedId=e.on("viewChanged",this.onVRPoseChanged.bind(this))})}onMouseDown(e){e.undoRedoManager=this.appData.undoRedoManager,e.showPointerOnAvatar=!0;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onMouseDown(e))break}1==e.showPointerOnAvatar?(this.avatarPointerVisible||(this.emit("movePointer",e),this.avatarPointerVisible=!0),this.avatarPointerHighlighted||(this.emit("hilightPointer",e),this.avatarPointerHighlighted=!0)):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.emit("hidePointer"))}onMouseMove(e){e.undoRedoManager=this.appData.undoRedoManager,e.showPointerOnAvatar=!0;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onMouseMove(e))break}1==e.showPointerOnAvatar?(this.emit("movePointer",e),this.avatarPointerVisible=!0):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.emit("hidePointer"))}onMouseUp(e){e.undoRedoManager=this.appData.undoRedoManager,e.showPointerOnAvatar=!0;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onMouseUp(e))break}1==e.showPointerOnAvatar?this.avatarPointerHighlighted&&(this.emit("unhilightPointer",e),this.avatarPointerHighlighted=!1):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.emit("hidePointer"))}onMouseLeave(e){let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&o.onMouseLeave&&1==o.onMouseLeave(e))break}this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.emit("hidePointer"))}onDoubleClick(e){let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onDoubleClick(e))break}}onWheel(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onWheel(e))break}}onKeyPressed(e,t){t.undoRedoManager=this.appData.undoRedoManager;let o=this.__toolStack.length;for(;o--;){const e=this.__toolStack[o];if(e&&1==e.onKeyPressed(t,t,viewport))break}}onKeyDown(e,t){t.undoRedoManager=this.appData.undoRedoManager;let o=this.__toolStack.length;for(;o--;){const s=this.__toolStack[o];if(s&&1==s.onKeyDown(e,t))break}}onKeyUp(e,t){t.undoRedoManager=this.appData.undoRedoManager;let o=this.__toolStack.length;for(;o--;){const s=this.__toolStack[o];if(s&&1==s.onKeyUp(e,t))break}}onTouchStart(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onTouchStart(e))break}}onTouchMove(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onTouchMove(e))break}}onTouchEnd(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onTouchEnd(e))break}}onTouchCancel(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onTouchCancel(e))break}}onDoubleTap(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onDoubleTap(e))break}}__prepareEvent(e){e.undoRedoManager=this.appData.undoRedoManager,e.propagating=!0,e.stopPropagation=()=>{e.propagating=!1}}onVRControllerButtonDown(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onVRControllerButtonDown(e))break;if(!e.propagating)break}}onVRControllerButtonUp(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onVRControllerButtonUp(e))break;if(!e.propagating)break}}onVRControllerDoubleClicked(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onVRControllerDoubleClicked(e))break;if(!e.propagating)break}}onVRPoseChanged(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onVRPoseChanged(e))break;if(!e.propagating)break}}destroy(){const e=this.appData.renderer.getViewport();e.removeListenerById("mouseDown",this.mouseDownId),e.removeListenerById("mouseMove",this.mouseMoveId),e.removeListenerById("mouseUp",this.mouseUpId),e.removeListenerById("mouseLeave",this.mouseUpId),e.removeListenerById("mouseWheel",this.mouseWheelId),e.removeListenerById("keyDown",this.keyDownId),e.removeListenerById("keyUp",this.keyUpId),e.removeListenerById("keyPressed",this.keyPressedId),e.removeListenerById("touchStart",this.touchStartId),e.removeListenerById("touchMove",this.touchMoveId),e.removeListenerById("touchEnd",this.touchEndId),e.removeListenerById("touchCancel",this.touchCancelId),this.appData.renderer.getXRViewport().then(t=>{e.removeListenerById("controllerDown",this.controllerDownId),e.removeListenerById("controllerUp",this.controllerUpId),e.removeListenerById("viewChanged",this.onVRPoseChangedId)})}}class oe extends I{constructor(e){super(),e||console.error("App data not provided to tool"),this.appData=e,this.__params=[],this.__installed=!1,this.__activated=!1}getName(){return this.constructor.name}isPrimaryTool(){return!1}installed(){return this.__installed}install(e){if(this.__installed)throw new Error("Tool already installed");this.index=e,this.__installed=!0,this.emit("installChanged",{installed:this.__installed})}uninstall(){this.__installed=!1,this.emit("installChanged",{installed:this.__installed})}activateTool(){if(this.__activated)throw new Error("Tool already activate");this.__activated=!0,this.emit("activatedChanged",{activated:this.__activated})}deactivateTool(){this.__activated=!1,this.emit("activatedChanged",{activated:this.__activated})}onMouseDown(e){}onMouseMove(e){}onMouseUp(e){}onDoubleClick(e){}onWheel(e){}onKeyPressed(e,t){}onKeyDown(e,t){}onKeyUp(e,t){}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onTouchCancel(e){}onDoubleTap(e){}onVRControllerButtonDown(e){}onVRControllerButtonUp(e){}onVRControllerDoubleClicked(e){}onVRPoseChanged(e){}}const se={VIEWER:0,DCC:1};class ie extends oe{constructor(e,t=se.VIEWER){super(e),console.log("ViewTool:",t),this.__maipulationModel=t,this.__defaultMode="orbit",this.__mode=this.__defaultMode,this.__mouseDragDelta=new C,this.__keyboardMovement=!1,this.__keysPressed=[],this.__maxVel=.002,this.__velocity=new u,this.__ongoingTouches={},this.__orbitRateParam=this.addParameter(new g("orbitRate",1)),this.__dollySpeedParam=this.addParameter(new g("dollySpeed",.02)),this.__mouseWheelDollySpeedParam=this.addParameter(new g("mouseWheelDollySpeed",.002)),this.__controllerTriggersHeld=[]}activateTool(){super.activateTool(),console.log("activateTool.ViewTool"),this.appData.renderer.getDiv().style.cursor="default",this.appData.renderer.getXRViewport().then(e=>{this.vrControllerToolTip||(this.vrControllerToolTip=new _(.015),this.vrControllerToolTipMat=new r("Cross","FlatSurfaceShader"),this.vrControllerToolTipMat.getParameter("BaseColor").setValue(new a("#03E3AC")),this.vrControllerToolTipMat.visibleInGeomDataBuffer=!1);const t=e=>{const t=new c("HandleToolTip",this.vrControllerToolTip,this.vrControllerToolTipMat);e.getTipItem().removeAllChildren(),e.getTipItem().addChild(t,!1)};for(const o of e.getControllers())t(o);this.addIconToControllerId=e.on("controllerAdded",t)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(e=>{e.removeListenerById("controllerAdded",this.addIconToControllerId)})}setDefaultMode(e){this.__defaultMode=e}look(e,t){const o=t.getCamera().getFocalDistance(),s=this.__orbitRateParam.getValue()*b.isMobileDevice?-1:1;if(this.__keyboardMovement){const e=t.getCamera().getGlobalXfo();this.__mouseDownCameraXfo=e.clone(),this.__mouseDownZaxis=e.ori.getZaxis();const s=this.__mouseDownZaxis.scale(-o);this.__mouseDownCameraTarget=e.tr.add(s)}const i=this.__mouseDownCameraXfo.clone(),a=new D;a.rotateZ(e.x/t.getWidth()*Math.PI*s),i.ori=a.multiply(i.ori);const n=new D;n.rotateX(e.y/t.getHeight()*Math.PI*s),i.ori.multiplyInPlace(n),this.__keyboardMovement,t.getCamera().setGlobalXfo(i)}orbit(e,t){const o=t.getCamera().getFocalDistance(),s=this.__orbitRateParam.getValue()*b.isMobileDevice?-1:1;if(this.__keyboardMovement){const e=t.getCamera().getGlobalXfo();this.__mouseDownCameraXfo=e.clone(),this.__mouseDownZaxis=e.ori.getZaxis();const s=this.__mouseDownZaxis.scale(-o);this.__mouseDownCameraTarget=e.tr.add(s)}const i=this.__mouseDownCameraXfo.clone(),a=new D;a.rotateZ(e.x/t.getWidth()*2*Math.PI*-s),i.ori=a.multiply(i.ori);const n=new D;n.rotateX(e.y/t.getHeight()*Math.PI*-s),i.ori.multiplyInPlace(n),i.tr=this.__mouseDownCameraTarget.add(i.ori.getZaxis().scale(o)),this.__keyboardMovement,t.getCamera().setGlobalXfo(i)}pan(e,t){const o=t.getCamera().getFocalDistance(),s=t.getCamera().getFov(),i=new u(1,0,0),a=new u(0,1,0),n=2*o*Math.tan(.5*s),r=n*(t.getWidth()/t.getHeight()),h=new d;h.tr=i.scale(-e.x/t.getWidth()*r),h.tr.addInPlace(a.scale(e.y/t.getHeight()*n)),t.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(h))}dolly(e,t){const o=e.x*this.__dollySpeedParam.getValue(),s=new d;s.tr.set(0,0,o),t.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(s))}panAndZoom(e,t,o){const s=o.getCamera().getFocalDistance(),i=o.getCamera().getFov(),a=new u(1,0,0),n=new u(0,1,0),r=2*s*Math.tan(.5*i),h=r*(o.getWidth()/o.getHeight()),l=new d;l.tr=a.scale(-e.x/o.getWidth()*h),l.tr.addInPlace(n.scale(e.y/o.getHeight()*r));const c=t*s;o.getCamera().setFocalDistance(this.__mouseDownFocalDist+c),l.tr.z+=c,o.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(l))}initDrag(e){const t=e.getCamera().getFocalDistance();this.__mouseDragDelta.set(0,0),this.__mouseDownCameraXfo=e.getCamera().getGlobalXfo().clone(),this.__mouseDownZaxis=e.getCamera().getGlobalXfo().ori.getZaxis();const o=this.__mouseDownZaxis.scale(-t);this.__mouseDownCameraTarget=e.getCamera().getGlobalXfo().tr.add(o),this.__mouseDownFocalDist=t}aimFocus(e,t){this.__focusIntervalId&&clearInterval(this.__focusIntervalId);let o=0;const s=()=>{const i=e.getGlobalXfo(),a=e.getFocalDistance(),n=t.subtract(i.tr),r=n.normalizeInPlace(),h=new D,l=new D;{const e=i.ori.getZaxis().clone();e.z=0;const t=n.negate();t.z=0,h.setFrom2Vectors(e,t)}{const e=i.ori.getZaxis().clone(),t=n.negate();e.x=t.x,e.y=t.y,e.normalizeInPlace(),e.cross(t).dot(i.ori.getXaxis())>0?l.rotateX(e.angleTo(t)):l.rotateX(-e.angleTo(t))}const c=i.clone();c.ori=h.multiply(c.ori),c.ori.multiplyInPlace(l);const d=Math.pow(o/20,2),u=i.clone();u.ori=i.ori.lerp(c.ori,d),e.setFocalDistance(a+(r-a)*d),e.setGlobalXfo(u),o++,o<=20?this.__focusIntervalId=setTimeout(s,20):(this.__focusIntervalId=void 0,this.emit("movementFinished"))};s(),this.__manipulationState="focussing"}onMouseMove(e){}onDragStart(e){this.__mouseDownPos=e.mousePos,this.initDrag(e.viewport),2==e.button?this.__mode="pan":e.ctrlKey&&2==e.button?this.__mode="dolly":e.shiftKey||2==e.button?this.__mode="look":this.__mode=this.__defaultMode}onDrag(e){switch(this.__keyboardMovement?this.__mouseDragDelta=e.mousePos:this.__mouseDragDelta=e.mousePos.subtract(this.__mouseDownPos),this.__mode){case"orbit":this.orbit(this.__mouseDragDelta,e.viewport);break;case"look":this.look(this.__mouseDragDelta,e.viewport);break;case"pan":this.pan(this.__mouseDragDelta,e.viewport);break;case"dolly":this.dolly(this.__mouseDragDelta,e.viewport)}}onDragEnd(e){return this.emit("movementFinished"),!1}onMouseDown(e){return!(this.__maipulationModel==se.DCC&&!e.altKey)&&(this.dragging=!0,this.__mouseDownPos=e.mousePos,this.onDragStart(e),!0)}onMouseUp(e){if(this.dragging)return this.onDragEnd(e),this.dragging=!1,!0}onMouseMove(e){if(this.dragging)return this.onDrag(e),e.showPointerOnAvatar=!1,!0}onDoubleClick(e){if(e.intersectionData){const t=e.viewport.getCamera(),o=t.getGlobalXfo().tr.add(e.intersectionData.mouseRay.dir.scale(e.intersectionData.dist));this.aimFocus(t,o)}}onWheel(e){if(this.__maipulationModel==se.DCC&&!e.altKey)return!1;const t=e.viewport,o=t.getCamera().getGlobalXfo(),s=o.ori.getZaxis();this.__mouseWheelZoomIntervalId&&clearInterval(this.__mouseWheelZoomIntervalId);let i=0;const a=()=>{const n=t.getCamera().getFocalDistance(),r=this.__mouseWheelDollySpeedParam.getValue(),h=e.deltaY*r*n*.2;o.tr.addInPlace(s.scale(h)),"orbit"==this.__defaultMode&&t.getCamera().setFocalDistance(n+h),t.getCamera().setGlobalXfo(o),i++,i<5?this.__mouseWheelZoomIntervalId=setTimeout(a,20):(this.__mouseWheelZoomIntervalId=void 0,this.emit("movementFinished"),e.viewport.renderGeomDataFbo())};a()}__integrateVelocityChange(e,t){const o=new d;o.tr=this.__velocity.normalize().scale(this.__maxVel),t.getCamera().setGlobalXfo(t.getCamera().getGlobalXfo().multiply(o))}onKeyPressed(e,t){return!1}onKeyDown(e,t){}onKeyUp(e,t){return!0}__startTouch(e,t){this.__ongoingTouches[e.identifier]={identifier:e.identifier,pos:new C(e.pageX,e.pageY)}}__endTouch(e,t){delete this.__ongoingTouches[e.identifier]}onTouchStart(e){e.preventDefault(),e.stopPropagation(),0==Object.keys(this.__ongoingTouches).length&&(this.__manipMode=void 0);const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__startTouch(t[e]);return this.initDrag(e.viewport),!0}onTouchMove(e){e.preventDefault(),e.stopPropagation();const t=e.changedTouches;if(1==t.length&&"panAndZoom"!=this.__manipMode){const o=t[0],s=new C(o.pageX,o.pageY),i=this.__ongoingTouches[o.identifier].pos.subtract(s);return"look"==this.__defaultMode?(i.scaleInPlace(6),this.look(i,e.viewport)):this.orbit(i,e.viewport),this.__manipMode="orbit",!0}if(2==t.length){const o=t[0],s=this.__ongoingTouches[o.identifier],i=t[1],a=this.__ongoingTouches[i.identifier],n=new C(o.pageX,o.pageY),r=new C(i.pageX,i.pageY),h=a.pos.subtract(s.pos).length()-r.subtract(n).length(),l=n.subtract(s.pos),c=r.subtract(a.pos),d=l.add(c);return d.scaleInPlace(.5),this.panAndZoom(d,.002*h,e.viewport),this.__manipMode="panAndZoom",!0}}onTouchEnd(e){e.preventDefault(),e.stopPropagation();const t=e.changedTouches;switch(this.__manipMode){case"orbit":case"panAndZoom":this.emit("movementFinished")}for(let e=0;e<t.length;e++)this.__endTouch(t[e]);return 0==Object.keys(this.__ongoingTouches).length&&(this.__manipMode=void 0),!0}onTouchCancel(e){console.log("touchcancel.");const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__endTouch(t[e]);return!0}onDoubleTap(e){const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__startTouch(t[e]);if(e.intersectionData){const t=e.viewport.getCamera(),o=t.getGlobalXfo().tr.add(e.intersectionData.mouseRay.dir.scale(e.intersectionData.dist));this.aimFocus(t,o)}}__initMoveStage(e){if(1==this.__controllerTriggersHeld.length)this.__grabPos=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr.clone(),this.stageXfo__GrabStart=e.getXfo().clone(),this.__invOri=this.stageXfo__GrabStart.ori.inverse();else if(2==this.__controllerTriggersHeld.length){const t=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,o=this.__controllerTriggersHeld[1].getControllerTipStageLocalXfo().tr;this.__grabDir=o.subtract(t),this.__grabPos=t.lerp(o,.5),this.__grabDir.y=0,this.__grabDist=this.__grabDir.length(),this.__grabDir.scaleInPlace(1/this.__grabDist),this.stageXfo__GrabStart=e.getXfo().clone(),this.__grab_to_stage=this.__grabPos.subtract(this.stageXfo__GrabStart.tr)}}onVRControllerButtonDown(e){if(1==e.button)return this.__controllerTriggersHeld.push(e.controller),this.__initMoveStage(e.vrviewport),!0}onVRControllerButtonUp(e){if(1!=e.button)return;const t=this.__controllerTriggersHeld.indexOf(e.controller);return this.__controllerTriggersHeld.splice(t,1),this.__initMoveStage(e.vrviewport),!0}onVRControllerDoubleClicked(e){console.log("onVRControllerDoubleClicked:",this.__controllerTriggersHeld.length);const t=e.vrviewport.getXfo().clone();t.sc.set(1,1,1),e.vrviewport.setXfo(t)}onVRPoseChanged(e){if(1==this.__controllerTriggersHeld.length){const t=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,o=new d;o.tr=this.__grabPos.subtract(t);const s=this.stageXfo__GrabStart.multiply(o);return e.vrviewport.setXfo(s),!0}if(2==this.__controllerTriggersHeld.length){const t=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,o=this.__controllerTriggersHeld[1].getControllerTipStageLocalXfo().tr,s=t.lerp(o,.5),i=o.subtract(t);i.y=0;const a=i.length();i.scaleInPlace(1/a);const n=new d,r=Math.max(Math.min(this.__grabDist/a,10),.1);n.sc.set(r,r,r);let h=this.__grabDir.angleTo(i);this.__grabDir.cross(i).y>0&&(h=-h),n.ori.rotateY(h);const l=n.ori.rotateVec3(this.__grabPos);n.tr.addInPlace(this.__grabPos.subtract(l));const c=this.__grabPos.scale(1-r);n.tr.addInPlace(n.ori.rotateVec3(c));const u=this.__grabPos.subtract(s).scale(r);n.tr.addInPlace(n.ori.rotateVec3(u));const g=this.stageXfo__GrabStart.multiply(n);return e.vrviewport.setXfo(g),!0}}}class ae extends oe{constructor(e){super(e),this.dragging=!1,this.selectionRect=new S(1,1),this.selectionRectMat=new r("marker","ScreenSpaceShader"),this.selectionRectMat.getParameter("BaseColor").setValue(new a("#03E3AC")),this.selectionRectXfo=new d,this.selectionRectXfo.tr.set(.5,.5,0),this.selectionRectXfo.sc.set(0,0,0)}activateTool(){super.activateTool(),this.rectItem||(this.rectItem=new c("selectionRect",this.selectionRect,this.selectionRectMat),this.rectItem.getParameter("Visible").setValue(!1),this.appData.renderer.addTreeItem(this.rectItem))}deactivateTool(){super.deactivateTool(),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.setGlobalXfo(this.selectionRectXfo)}onMouseDown(e){return 0==e.button&&!e.altKey&&(console.log("onMouseDown"),this.mouseDownPos=e.mousePos,this.dragging=!1,!0)}__resizeRect(e,t){const o=new C(1/e.getWidth()*2,1/e.getHeight()*2),s=t.multiply(o);this.selectionRectXfo.sc.set(Math.abs(s.x),Math.abs(s.y),1);const i=this.mouseDownPos.subtract(t.scale(.5)).multiply(o).subtract(new C(1,1));this.selectionRectXfo.tr.x=i.x,this.selectionRectXfo.tr.y=-i.y,this.rectItem.setGlobalXfo(this.selectionRectXfo)}onMouseMove(e){if(this.mouseDownPos){const t=this.mouseDownPos.subtract(e.mousePos);this.dragging&&this.__resizeRect(e.viewport,t),t.length()>4&&(this.dragging=!0,this.rectItem.getParameter("Visible").setValue(!0),this.__resizeRect(e.viewport,t))}return!0}onMouseUp(e){if(this.mouseDownPos){if(this.dragging){this.rectItem.getParameter("Visible").setValue(!1);const t=e.mousePos,o=new C(Math.min(this.mouseDownPos.x,t.x),Math.min(this.mouseDownPos.y,t.y)),s=new C(Math.max(this.mouseDownPos.x,t.x),Math.max(this.mouseDownPos.y,t.y)),i=e.viewport.getGeomItemsInRect(o,s);if(this.appData.selectionManager.pickingModeActive())this.appData.selectionManager.pick(i);else{const t=new Set([...i].filter(e=>!(e.getOwner()instanceof E)));e.shiftKey?this.appData.selectionManager.deselectItems(t):this.appData.selectionManager.selectItems(t,!e.ctrlKey),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.setGlobalXfo(this.selectionRectXfo)}}else{const t=e.viewport.getGeomDataAtPos(e.mousePos);if(null==t||t.geomItem.getOwner()instanceof E)this.appData.selectionManager.clearSelection();else if(this.appData.selectionManager.pickingModeActive())this.appData.selectionManager.pick(t.geomItem);else if(e.shiftKey){const e=new Set;e.add(t.geomItem),this.appData.selectionManager.deselectItems(e)}else this.appData.selectionManager.toggleItemSelection(t.geomItem,!e.ctrlKey)}return this.mouseDownPos=void 0,!0}}onVRControllerButtonDown(e){if(1==e.button){const t=e.controller.getGeomItemAtTip();if(null!=t&&!(t.geomItem.getOwner()instanceof E))return this.appData.selectionManager.toggleItemSelection(t.geomItem),!0}}}G.registerChange("SelectionTool",ae);class ne extends oe{constructor(e,t){super(e),this.vrUITool=t,this.uiToolIndex=-1,this.__stayClosed=!1}uninstall(){super.uninstall(),this.uiToolIndex>0&&this.appData.toolManager.removeToolByHandle(this.vrUITool)}onVRControllerButtonDown(e){}onVRControllerButtonUp(e){}stayClosed(){this.__stayClosed=!0}onVRPoseChanged(e){if(this.vrUITool.installed())return;const t=e.viewXfo,o=(e,o)=>{if(!e)return!1;const s=e.getTreeItem().getGlobalXfo(),i=s.tr.subtract(t.tr);return i.normalizeInPlace(),i.angleTo(s.ori.getYaxis())<.25*Math.PI?(this.__stayClosed||(this.vrUITool.setUIControllers(this,e,o,t),this.uiToolIndex=this.appData.toolManager.pushTool(this.vrUITool)),!0):void 0};if(e.controllers.length>0){if(o(e.controllers[0],e.controllers[1]))return!0;if(o(e.controllers[1],e.controllers[0]))return!0}this.uiToolIndex=-1,this.__stayClosed=!1}}const re=function(){return{escape:function(e){return e.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")},parseExtension:e,mimeType:function(t){const o=e(t).toLowerCase();return function(){const e="application/font-woff";return{woff:e,woff2:e,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}()[o]||""},dataAsUrl:function(e,t){return"data:"+t+";base64,"+e},isDataUrl:function(e){return-1!==e.search(/^(data:)/)},canvasToBlob:function(e){return e.toBlob?new Promise((function(t){e.toBlob(t)})):function(e){return new Promise((function(t){const o=window.atob(e.toDataURL().split(",")[1]),s=o.length,i=new Uint8Array(s);for(let e=0;e<s;e++)i[e]=o.charCodeAt(e);t(new Blob([i],{type:"image/png"}))}))}(e)},resolveUrl:function(e,t){const o=document.implementation.createHTMLDocument(),s=o.createElement("base");o.head.appendChild(s);const i=o.createElement("a");return o.body.appendChild(i),s.href=t,i.href=e,i.href},getAndEncode:function(e){ue.impl.options.cacheBust&&(e+=(/\?/.test(e)?"&":"?")+(new Date).getTime());return new Promise((function(t){const o=new XMLHttpRequest;let s;if(o.onreadystatechange=function(){if(4!==o.readyState)return;if(200!==o.status)return void(s?t(s):i("cannot fetch resource: "+e+", status: "+o.status));const a=new FileReader;a.onloadend=function(){const e=a.result.split(/,/)[1];t(e)},a.readAsDataURL(o.response)},o.ontimeout=function(){s?t(s):i("timeout of 30000ms occured while fetching resource: "+e)},o.responseType="blob",o.timeout=3e4,o.open("GET",e,!0),o.send(),ue.impl.options.imagePlaceholder){const e=ue.impl.options.imagePlaceholder.split(/,/);e&&e[1]&&(s=e[1])}function i(e){console.error(e),t("")}}))},uid:function(){let e=0;return function(){return"u"+("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)+e++}}(),delay:function(e){return function(t){return new Promise((function(o){setTimeout((function(){o(t)}),e)}))}},asArray:function(e){const t=[],o=e.length;for(let s=0;s<o;s++)t.push(e[s]);return t},escapeXhtml:function(e){return e.replace(/#/g,"%23").replace(/\n/g,"%0A")},makeImage:function(e){return new Promise((function(t,o){const s=new Image;s.onload=function(){t(s)},s.onerror=o,s.src=e}))},width:function(e){const o=t(e,"border-left-width"),s=t(e,"border-right-width");return e.scrollWidth+o+s},height:function(e){const o=t(e,"border-top-width"),s=t(e,"border-bottom-width");return e.scrollHeight+o+s}};function e(e){const t=/\.([^\.\/]*?)$/g.exec(e);return t?t[1]:""}function t(e,t){const o=window.getComputedStyle(e).getPropertyValue(t);return parseFloat(o.replace("px",""))}}(),he=function(){const e=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:function(e,i,a){return function(){return!t(e)}()?Promise.resolve(e):Promise.resolve(e).then(o).then((function(t){let o=Promise.resolve(e);return t.forEach((function(e){o=o.then((function(t){return s(t,e,i,a)}))})),o}))},shouldProcess:t,impl:{readUrls:o,inline:s}};function t(t){return-1!==t.search(e)}function o(t){const o=[];let s;for(;null!==(s=e.exec(t));)o.push(s[1]);return o.filter((function(e){return!re.isDataUrl(e)}))}function s(e,t,o,s){return Promise.resolve(t).then((function(e){return o?re.resolveUrl(e,o):e})).then(s||re.getAndEncode).then((function(e){return re.dataAsUrl(e,re.mimeType(t))})).then((function(o){return e.replace(function(e){return new RegExp("(url\\(['\"]?)("+re.escape(e)+")(['\"]?\\))","g")}(t),"$1"+o+"$3")}))}}(),le=function(){return{resolveAll:function(){return e().then((function(e){return Promise.all(e.map((function(e){return e.resolve()})))})).then((function(e){return e.join("\n")}))},impl:{readAll:e}};function e(){return Promise.resolve(re.asArray(document.styleSheets)).then((function(e){const t=[];return e.forEach((function(e){try{re.asArray(e.cssRules||[]).forEach(t.push.bind(t))}catch(t){console.log("Error while reading CSS rules from "+e.href,t.toString())}})),t})).then((function(e){return e.filter((function(e){return e.type===CSSRule.FONT_FACE_RULE})).filter((function(e){return he.shouldProcess(e.style.getPropertyValue("src"))}))})).then((function(t){return t.map(e)}));function e(e){return{resolve:function(){const t=(e.parentStyleSheet||{}).href;return he.inlineAll(e.cssText,t)},src:function(){return e.style.getPropertyValue("src")}}}}}(),ce=function(){return{inlineAll:function t(o){return o instanceof Element?function(e){const t=e.style.getPropertyValue("background");return t?he.inlineAll(t).then((function(t){e.style.setProperty("background",t,e.style.getPropertyPriority("background"))})).then((function(){return e})):Promise.resolve(e)}(o).then((function(){return o instanceof HTMLImageElement?e(o).inline():Promise.all(re.asArray(o.childNodes).map((function(e){return t(e)})))})):Promise.resolve(o)},impl:{newImage:e}};function e(e){return{inline:function(t){return re.isDataUrl(e.src)?Promise.resolve():Promise.resolve(e.src).then(t||re.getAndEncode).then((function(t){return re.dataAsUrl(t,re.mimeType(e.src))})).then((function(t){return new Promise((function(o,s){e.onload=o,e.onerror=s,e.src=t}))}))}}}}(),de={imagePlaceholder:void 0,cacheBust:!1},ue={toSvg:ge,toPng:function(e,t){return me(e,t||{}).then((function(e){return e.toDataURL()}))},toJpeg:function(e,t){return me(e,t=t||{}).then((function(e){return e.toDataURL("image/jpeg",t.quality||1)}))},toBlob:function(e,t){return me(e,t||{}).then(re.canvasToBlob)},toPixelData:function(e,t){return me(e,t||{}).then((function(t){return t.getContext("2d").getImageData(0,0,re.width(e),re.height(e)).data}))},toCanvas:function(e,t){return me(e,t||{}).then((function(e){return e}))},impl:{fontFaces:le,images:ce,util:re,inliner:he,options:{}}};function ge(e,t){return function(e){void 0===e.imagePlaceholder?ue.impl.options.imagePlaceholder=de.imagePlaceholder:ue.impl.options.imagePlaceholder=e.imagePlaceholder;void 0===e.cacheBust?ue.impl.options.cacheBust=de.cacheBust:ue.impl.options.cacheBust=e.cacheBust}(t=t||{}),Promise.resolve(e).then((function(e){return function e(t,o,s){return s||!o||o(t)?Promise.resolve(t).then((function(e){return e instanceof HTMLCanvasElement?re.makeImage(e.toDataURL()):e.cloneNode(!1)})).then((function(e){return i(t,e,o)})).then((function(e){return function(e,t){return t instanceof Element?Promise.resolve().then(o).then(s).then(i).then(a).then((function(){return t})):t;function o(){var o,s;o=window.getComputedStyle(e),s=t.style,o.cssText?s.cssText=o.cssText:function(e,t){re.asArray(e).forEach((function(o){t.setProperty(o,e.getPropertyValue(o),e.getPropertyPriority(o))}))}(o,s)}function s(){[":before",":after"].forEach((function(o){!function(o){const s=window.getComputedStyle(e,o),i=s.getPropertyValue("content");if(""===i||"none"===i)return;const a=re.uid();t.className=t.className+" "+a;const n=document.createElement("style");n.appendChild(function(e,t,o){const s="."+e+":"+t,i=o.cssText?function(e){const t=e.getPropertyValue("content");return e.cssText+" content: "+t+";"}(o):function(e){return re.asArray(e).map((function(t){return t+": "+e.getPropertyValue(t)+(e.getPropertyPriority(t)?" !important":"")})).join("; ")+";"}(o);return document.createTextNode(s+"{"+i+"}")}(a,o,s)),t.appendChild(n)}(o)}))}function i(){e instanceof HTMLTextAreaElement&&(t.innerHTML=e.value),e instanceof HTMLInputElement&&t.setAttribute("value",e.value)}function a(){t instanceof SVGElement&&(t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t instanceof SVGRectElement&&["width","height"].forEach((function(e){const o=t.getAttribute(e);o&&t.style.setProperty(e,o)})))}}(t,e)})):Promise.resolve();function i(t,o,s){const i=t.childNodes;return 0===i.length?Promise.resolve(o):a(o,re.asArray(i),s).then((function(){return o}));function a(t,o,s){let i=Promise.resolve();return o.forEach((function(o){i=i.then((function(){return e(o,s)})).then((function(e){e&&t.appendChild(e)}))})),i}}}(e,t.filter,!0)})).then(pe).then(_e).then((function(e){t.bgcolor&&(e.style.backgroundColor=t.bgcolor);t.width&&(e.style.width=t.width+"px");t.height&&(e.style.height=t.height+"px");t.style&&Object.keys(t.style).forEach((function(o){e.style[o]=t.style[o]}));return e})).then((function(o){return function(e,t,o){return Promise.resolve(e).then((function(e){return e.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),(new XMLSerializer).serializeToString(e)})).then(re.escapeXhtml).then((function(e){return'<foreignObject x="0" y="0" width="100%" height="100%">'+e+"</foreignObject>"})).then((function(e){return'<svg xmlns="http://www.w3.org/2000/svg" width="'+t+'" height="'+o+'">'+e+"</svg>"})).then((function(e){return"data:image/svg+xml;charset=utf-8,"+e}))}(o,t.width||re.width(e),t.height||re.height(e))}))}function me(e,t){return ge(e,t).then(re.makeImage).then(re.delay(100)).then((function(o){const s=function(e){const o=document.createElement("canvas");if(o.width=t.width||re.width(e),o.height=t.height||re.height(e),t.bgcolor){const e=o.getContext("2d");e.fillStyle=t.bgcolor,e.fillRect(0,0,o.width,o.height)}return o}(e);return s.getContext("2d").drawImage(o,0,0),s}))}function pe(e){return le.resolveAll().then((function(t){const o=document.createElement("style");return e.appendChild(o),o.appendChild(document.createTextNode(t)),e}))}function _e(e){return ce.inlineAll(e).then((function(){return e}))}class fe extends c{constructor(e,t,o){const s=new r("uimat","FlatSurfaceShader");let i;s.visibleInGeomDataBuffer=!1,super("VRControllerUI",new M(1,1),s),this.appData=e,this.__vrUIDOMHolderElement=t,this.__vrUIDOMElement=o,this.__uiimage=new T,s.getParameter("BaseColor").setValue(this.__uiimage),this.__uiGeomOffsetXfo=new d,this.__uiGeomOffsetXfo.sc.set(0,0,1),this.__rect={width:0,height:0},this.__uiGeomOffsetXfo.ori.setFromAxisAndAngle(new u(0,1,0),Math.PI),this.setGeomOffsetXfo(this.__uiGeomOffsetXfo);let a=[];const n=()=>{i=null;const e=a.map(e=>this.updateElemInAtlas(e));Promise.all(e).then(()=>{this.updateUIImage(),a=[]})};this.__mutationObserver=new MutationObserver(e=>{this.mainCtx?(e.some(e=>{let t=e.target;for(;t.parentNode;){if(t==this.__vrUIDOMElement)return this.renderUIToImage(),a=[],!1;if(t.classList.contains("VRUIElement")||t==this.__vrUIDOMElement){-1==a.indexOf(t)&&a.push(t);break}t=t.parentNode}return!0}),i&&clearTimeout(i),i=setTimeout(n,50)):this.renderUIToImage()}),this.__active=!1,this.__renderRequested=!1}activate(){this.__vrUIDOMHolderElement.style.display="block",this.__active=!0,this.__mutationObserver.observe(this.__vrUIDOMElement,{attributes:!0,characterData:!0,childList:!0,subtree:!0}),this.renderUIToImage()}deactivate(){this.__vrUIDOMHolderElement.style.display="none",this.__active=!0,this.__mutationObserver.disconnect()}updateElemInAtlas(e){return new Promise((t,o)=>{ue.toCanvas(e).then(o=>{const s=e.getBoundingClientRect();s.width*s.height!=0?(this.mainCtx.fillRect(s.x,s.y,s.width,s.height),this.mainCtx.drawImage(o,s.x,s.y),t()):t()})})}updateUIImage(){const e=this.mainCtx.getImageData(0,0,this.__rect.width,this.__rect.height);this.__uiimage.setData(this.__rect.width,this.__rect.height,new Uint8Array(e.data.buffer))}renderUIToImage(){ue.toCanvas(this.__vrUIDOMElement).then(e=>{this.mainCtx=e.getContext("2d"),this.mainCtx.fillStyle="#FFFFFF";const t=this.__vrUIDOMElement.getBoundingClientRect();if(t.width*t.height!=0){if(t.width!=this.__rect.width||t.height!=this.__rect.height){this.__rect=t;const e=7e-4;this.__uiGeomOffsetXfo.sc.set(this.__rect.width*e,this.__rect.height*e,1),this.setGeomOffsetXfo(this.__uiGeomOffsetXfo),this.appData.session.pub("pose-message",{interfaceType:"VR",updateUIPanel:{size:this.__uiGeomOffsetXfo.sc.toJSON()}})}this.updateUIImage()}})}sendMouseEvent(e,t,o){const s=new MouseEvent(e,Object.assign({target:o,view:window,bubbles:!0,cancelable:!0},t));return o.dispatchEvent(s),s}}class ve extends oe{constructor(e){super(e),this.__vrUIDOMHolderElement=document.createElement("div"),this.__vrUIDOMHolderElement.className="vrUIHolder",this.__vrUIDOMElement=document.createElement("div"),this.__vrUIDOMElement.className="vrUI",document.body.appendChild(this.__vrUIDOMHolderElement),this.controllerUI=new fe(e,this.__vrUIDOMHolderElement,this.__vrUIDOMElement),this.controllerUI.addRef(this),e.renderer.addTreeItem(this.controllerUI),this.__uiLocalXfo=new d,this.__uiLocalXfo.ori.setFromAxisAndAngle(new u(1,0,0),-.6*Math.PI);const t=new r("pointermat","LinesShader");t.visibleInGeomDataBuffer=!1,t.getParameter("Color").setValue(new a(1.2,0,0));const o=new X;o.setNumVertices(2),o.setNumSegments(1),o.setSegment(0,0,1),o.getVertex(0).set(0,0,0),o.getVertex(1).set(0,0,-1),o.setBoundingBoxDirty(),this.__pointerLocalXfo=new d,this.__pointerLocalXfo.sc.set(1,1,.1),this.__pointerLocalXfo.ori.setFromAxisAndAngle(new u(1,0,0),-.2*Math.PI),this.__uiPointerItem=new c("VRControllerPointer",o,t),this.__uiPointerItem.addRef(this),this.__triggerHeld=!1}getName(){return"VRUITool"}setUIControllers(e,t,o,s){this.openUITool=e,this.uiController=t,this.pointerController=o;const i=this.uiController.getTreeItem().getGlobalXfo();if(this.pointerController){const e=this.pointerController.getTreeItem().getGlobalXfo(),t=i.tr.subtract(s.tr),o=e.tr.subtract(s.tr);t.cross(o).dot(s.ori.getYaxis())>0?this.__uiLocalXfo.tr.set(.05,-.05,.08):this.__uiLocalXfo.tr.set(-.05,-.05,.08)}else this.__uiLocalXfo.tr.set(0,-.05,.08);this.controllerUI.setLocalXfo(this.__uiLocalXfo)}activateTool(){super.activateTool(),this.controllerUI.activate(),this.uiController&&(this.uiController.getTipItem().addChild(this.controllerUI,!1),this.pointerController&&this.pointerController.getTipItem().addChild(this.__uiPointerItem,!1),this.appData.session.pub("pose-message",{interfaceType:"VR",showUIPanel:{controllerId:this.uiController.getId(),localXfo:this.__uiLocalXfo.toJSON(),size:this.controllerUI.getGeomOffsetXfo().sc.toJSON()}}))}deactivateTool(){super.deactivateTool(),this.controllerUI.deactivate(),this.uiController&&(this.uiController.getTipItem().removeChildByHandle(this.controllerUI),this.pointerController&&this.pointerController.getTipItem().removeChildByHandle(this.__uiPointerItem),this.appData.session.pub("pose-message",{interfaceType:"VR",hideUIPanel:{controllerId:this.uiController.getId()}}))}setPointerLength(e){this.__pointerLocalXfo.sc.set(1,1,e),this.__uiPointerItem.setLocalXfo(this.__pointerLocalXfo)}calcUIIntersection(){const e=this.__uiPointerItem.getGlobalXfo(),t=e.ori.getZaxis().negate(),s=new o(e.tr,t),i=this.controllerUI.getGlobalXfo(),a=this.controllerUI.getGeomOffsetXfo().sc,n=new o(i.tr,i.ori.getZaxis().negate()),r=s.intersectRayPlane(n);if(r<=0)return void this.setPointerLength(.5);const h=e.tr.add(t.scale(r)).subtract(n.start),l=h.dot(i.ori.getXaxis())/a.x,c=h.dot(i.ori.getYaxis())/a.y;if(Math.abs(l)>.5||Math.abs(c)>.5)return void this.setPointerLength(.5);this.setPointerLength(r);const d=this.__vrUIDOMElement.getBoundingClientRect();return{clientX:Math.round(l*d.width+d.width/2),clientY:Math.round(c*-d.height+d.height/2)}}sendEventToUI(e,t){const o=this.calcUIIntersection();if(o){o.offsetX=o.pageX=o.pageX=o.screenX=o.clientX,o.offsetY=o.pageY=o.pageY=o.screenY=o.clientY;const s=document.elementFromPoint(o.clientX,o.clientY);return s!=this._element&&(this._element&&this.controllerUI.sendMouseEvent("mouseleave",Object.assign(t,o),this._element),this._element=s,this.controllerUI.sendMouseEvent("mouseenter",Object.assign(t,o),this._element)),this.controllerUI.sendMouseEvent(e,Object.assign(t,o),this._element),this._element}this._element&&(this.controllerUI.sendMouseEvent("mouseleave",Object.assign(t,o),this._element),this._element=null)}onVRControllerButtonDown(e){if(e.controller==this.pointerController){this.__triggerHeld=!0;const t=this.sendEventToUI("mousedown",{button:e.button-1});this.__triggerDownElem=t||null}return!0}onVRControllerButtonUp(e){if(e.controller==this.pointerController){this.__triggerHeld=!1;const t=this.sendEventToUI("mouseup",{button:e.button-1});t&&this.__triggerDownElem==t&&this.sendEventToUI("click",{button:e.button-1}),this.__triggerDownElem=null}return!0}onVRPoseChanged(e){const t=e.viewXfo;return(()=>{const e=this.uiController.getTreeItem().getGlobalXfo(),o=e.tr.subtract(t.tr);return o.normalizeInPlace(),!(o.angleTo(e.ori.getYaxis())>.5*Math.PI)||(this.appData.toolManager.removeToolByHandle(this),!1)})()&&this.sendEventToUI("mousemove",{}),!0}}class we extends A{constructor(e){super("HoldObjectsChange"),this.__selection=[],this.__prevXfos=[],this.__newXfos=[],e&&this.update(e)}undo(){for(let e=0;e<this.__selection.length;e++)this.__selection[e]&&this.__selection[e].setGlobalXfo(this.__prevXfos[e])}redo(){for(let e=0;e<this.__selection.length;e++)this.__selection[e]&&this.__selection[e].setGlobalXfo(this.__newXfos[e])}update(e){if(e.newItem)this.__selection[e.newItemId]=e.newItem,this.__prevXfos[e.newItemId]=e.newItem.getGlobalXfo();else if(e.changeXfos)for(let t=0;t<e.changeXfoIds.length;t++){const o=e.changeXfoIds[t];this.__selection[o]&&(this.__selection[o].setGlobalXfo(e.changeXfos[t]),this.__newXfos[o]=e.changeXfos[t])}this.updated.emit(e)}toJSON(e){const t=super.toJSON(e),o=[];for(let e=0;e<this.__selection.length;e++)this.__selection[e]?o[e]=this.__selection[e].getPath():o.push(null);return t.itemPaths=o,t}fromJSON(e,t){super.fromJSON(e,t);const o=t.appData.scene.getRoot(),s=[];for(let t=0;t<e.itemPaths.length;t++){const i=e.itemPaths[t];i&&(s[t]=o.resolvePath(i,1))}this.__selection=s}}G.registerChange("HoldObjectsChange",we);class Pe extends oe{constructor(e){super(e),this.__pressedButtonCount=0,this.__freeIndices=[],this.__vrControllers=[],this.__heldObjectCount=0,this.__heldGeomItems=[],this.__heldGeomItemIds=[],this.__heldGeomItemRefs=[],this.__heldGeomItemOffsets=[]}activateTool(){super.activateTool(),console.log("activateTool.VRHoldObjectsTool"),this.appData.renderer.getDiv().style.cursor="crosshair";const e=e=>{if(!this.__activated)return;const t=new V(.03),o=new r("Cross","FlatSurfaceShader");o.getParameter("BaseColor").setValue(new a("#03E3AC")),o.visibleInGeomDataBuffer=!1;const s=new c("HandleToolTip",t,o);e.getTipItem().removeAllChildren(),e.getTipItem().addChild(s,!1)};this.appData.renderer.getXRViewport().then(t=>{for(const o of t.getControllers())e(o);this.addIconToControllerId=t.on("controllerAdded",e)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(e=>{e.removeListenerById("controllerAdded",this.addIconToControllerId)})}computeGrabXfo(e){let t;if(1==e.length)t=this.__vrControllers[e[0]].getTipXfo();else if(2==e.length){const o=this.__vrControllers[e[0]].getTipXfo(),s=this.__vrControllers[e[1]].getTipXfo();o.ori.alignWith(s.ori),t=new d,t.tr=o.tr.lerp(s.tr,.5),t.ori=o.ori.lerp(s.ori,.5);let i=s.tr.subtract(o.tr);i.normalizeInPlace();const a=t.ori.getXaxis();i.dot(a)<0&&(i=i.negate());const n=i.angleTo(a);if(n>0){const e=a.cross(i);e.normalizeInPlace();const o=new D;o.setFromAxisAndAngle(e,n),t.ori=o.multiply(t.ori)}}return t}initAction(){for(let e=0;e<this.__heldGeomItems.length;e++){const t=this.__heldGeomItems[e];if(!t)continue;const o=this.computeGrabXfo(this.__heldGeomItemRefs[e]);this.__heldGeomItemOffsets[e]=o.inverse().multiply(t.getGlobalXfo())}}onVRControllerButtonDown(e){const t=e.controller.getId();this.__vrControllers[t]=e.controller;const o=e.controller.getGeomItemAtTip();if(o){if(o.geomItem.getOwner()instanceof E)return!1;if(e.intersectionData=o,o.geomItem.onMouseDown(e,o),!e.propagating)return!1;let s=this.__heldGeomItems.indexOf(o.geomItem);if(-1==s){s=this.__heldGeomItems.length,this.__heldObjectCount++,this.__heldGeomItems.push(o.geomItem),this.__heldGeomItemRefs[s]=[t],this.__heldGeomItemIds[t]=s;const e={newItem:o.geomItem,newItemId:s};this.change?this.change.update(e):(this.change=new we(e),this.appData.undoRedoManager.addChange(this.change))}else this.__heldGeomItemIds[t]=s,this.__heldGeomItemRefs[s].push(t);return this.initAction(),!0}}onVRControllerButtonUp(e){const t=e.controller.getId();if(this.__pressedButtonCount--,void 0!==this.__heldGeomItemIds[t]){const e=this.__heldGeomItemIds[t],o=this.__heldGeomItemRefs[e];return o.splice(o.indexOf(t),1),0==o.length&&(this.__heldObjectCount--,this.__heldGeomItems[e]=void 0,this.change=void 0),this.__heldGeomItemIds[t]=void 0,this.initAction(),!0}}onVRPoseChanged(e){if(!this.change)return!1;const t=[],o=[];for(let e=0;e<this.__heldGeomItems.length;e++){if(!this.__heldGeomItems[e])continue;const s=this.computeGrabXfo(this.__heldGeomItemRefs[e]);t.push(s.multiply(this.__heldGeomItemOffsets[e])),o.push(e)}return this.change.update({changeXfos:t,changeXfoIds:o}),!0}}class Ie extends oe{constructor(e){super(e)}isPrimaryTool(){return!0}}class Ce extends A{constructor(e){super(e)}setParentAndXfo(e,t){this.parentItem=e;const o=this.parentItem.generateUniqueName(this.geomItem.getName());this.geomItem.setName(o),this.geomItem.setGlobalXfo(t),this.childIndex=this.parentItem.addChild(this.geomItem,!0),this.geomItem.addRef(this)}undo(){this.parentItem.removeChild(this.childIndex)}redo(){this.parentItem.addChild(this.geomItem,!1,!1)}toJSON(e){const t=super.toJSON(e);return t.parentItemPath=this.parentItem.getPath(),t.geomItemName=this.geomItem.getName(),t.geomItemXfo=this.geomItem.getParameter("LocalXfo").getValue(),t}fromJSON(e,t){const o=t.appData.scene.getRoot();this.parentItem=o.resolvePath(e.parentItemPath,1),this.geomItem.setName(this.parentItem.generateUniqueName(e.geomItemName));const s=new d;s.fromJSON(e.geomItemXfo),this.geomItem.setLocalXfo(s),this.childIndex=this.parentItem.addChild(this.geomItem,!1)}destroy(){this.geomItem.removeRef(this)}}class be extends Ie{constructor(e){super(e),this.stage=0,this.removeToolOnRightClick=!0,this.cp=this.addParameter(new n("Line Color",new a(.7,.2,.2)))}activateTool(){super.activateTool(),this.appData.renderer.getDiv().style.cursor="crosshair",this.appData.renderer.getXRViewport().then(e=>{this.vrControllerToolTip||(this.vrControllerToolTip=new V(.05),this.vrControllerToolTipMat=new r("VRController Cross","LinesShader"),this.vrControllerToolTipMat.getParameter("Color").setValue(this.cp.getValue()),this.vrControllerToolTipMat.visibleInGeomDataBuffer=!1);const t=e=>{const t=new c("CreateGeomToolTip",this.vrControllerToolTip,this.vrControllerToolTipMat);e.getTipItem().removeAllChildren(),e.getTipItem().addChild(t,!1)};for(const o of e.getControllers())t(o);this.addIconToControllerId=e.on("controllerAdded",t)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getDiv().style.cursor="pointer",this.appData.renderer.getXRViewport().then(e=>{e.removeListenerById("controllerAdded",this.addIconToControllerId)})}screenPosToXfo(e,t){const s=t.calcRayFromScreenPos(e),i=new o(this.constructionPlane.tr,this.constructionPlane.ori.getZaxis()),a=s.intersectRayPlane(i);if(a>0){const e=this.constructionPlane.clone();return e.tr=s.pointAtDist(a),e}const n=t.getCamera(),r=n.getGlobalXfo().clone();return r.tr=s.pointAtDist(n.getFocalDistance()),r}createStart(e,t){this.stage=1}createPoint(e){}createMove(e){}createRelease(e){}onMouseDown(e){if(0==this.stage){if(0==e.button){this.constructionPlane=new d;const t=this.screenPosToXfo(e.mousePos,e.viewport);this.createStart(t,this.appData.scene.getRoot())}else 2==e.button&&this.removeToolOnRightClick&&this.appData.toolManager.removeTool(this.index);return!0}return 2!=e.button||(this.appData.undoRedoManager.undo(!1),this.stage=0,!0)}onMouseMove(e){if(this.stage>0){const t=this.screenPosToXfo(e.mousePos,e.viewport);return this.createMove(t.tr),!0}}onMouseUp(e){if(this.stage>0){const t=this.screenPosToXfo(e.mousePos,e.viewport);return this.createRelease(t.tr),!0}}onWheel(e){}onKeyPressed(e,t){}onKeyDown(e,t){}onKeyUp(e,t){}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onTouchCancel(e){}onVRControllerButtonDown(e){if(!this.__activeController){this.__activeController=e.controller,this.constructionPlane=new d;const t=this.constructionPlane.clone();t.tr=this.__activeController.getTipXfo().tr,this.createStart(t,this.appData.scene.getRoot())}return!0}onVRPoseChanged(e){if(this.__activeController&&this.stage>0){const e=this.__activeController.getTipXfo();return this.createMove(e.tr),!0}}onVRControllerButtonUp(e){if(this.stage>0&&this.__activeController==e.controller){const e=this.__activeController.getTipXfo();return this.createRelease(e.tr),0==this.stage&&(this.__activeController=void 0),!0}}}class De extends Ce{constructor(e,t,o,s){super("Create Line"),this.line=new X(0),this.line.setNumVertices(2),this.line.setNumSegments(1),this.line.setSegment(0,0,1);const i=new r("Line","LinesShader");i.getParameter("Color").setValue(new a(.7,.2,.2)),this.geomItem=new c("Line"),this.geomItem.setGeometry(this.line),this.geomItem.setMaterial(i),o&&i.getParameter("Color").setValue(o),s&&(this.line.lineThickness=s),e&&t&&this.setParentAndXfo(e,t)}update(e){e.p1&&(this.line.getVertex(1).setFromOther(e.p1),this.line.geomDataChanged.emit()),this.updated.emit(e)}fromJSON(e,t){if(super.fromJSON(e,t),e.color){const t=new a;t.fromJSON(e.color),material.getParameter("Color").setValue(t)}e.thickness&&(this.line.lineThickness=e.thickness)}}G.registerChange("CreateLineChange",De);class Se extends be{constructor(e){super(e),this.tp=this.addParameter(new g("Line Thickness",.06,[0,.1]))}createStart(e,t){this.change=new De(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e.inverse(),this.stage=1,this.length=0}createMove(e){const t=this.xfo.transformVec3(e);this.length=t.length(),this.change.update({p1:t})}createRelease(e){0==this.length&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.emit("actionFinished")}}class Me extends Ce{constructor(e,t){super("Create Circle",e),this.circle=new y(0,64),this.circle.lineThickness=.05;const o=new r("circle","FatLinesShader");o.getParameter("Color").setValue(new a(.7,.2,.2)),this.geomItem=new c("Circle"),this.geomItem.setGeometry(this.circle),this.geomItem.setMaterial(o),e&&t&&this.setParentAndXfo(e,t)}update(e){this.circle.getParameter("Radius").setValue(e.radius),this.updated.emit(e)}toJSON(){const e=super.toJSON();return e.radius=this.circle.getParameter("Radius").getValue(),e}changeFromJSON(e){console.log("CreateCircleChange:",e),e.radius&&this.circle.getParameter("Radius").setValue(e.radius)}}G.registerChange("CreateCircleChange",Me);class Te extends be{constructor(e){super(e)}createStart(e,t){this.change=new Me(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.stage=1,this.radius=0}createMove(e){this.radius=e.distanceTo(this.xfo.tr),this.change.update({radius:this.radius})}createRelease(e){0==this.radius&&this.appData.undoRedoManager.undo(!1),this.change=null,this.stage=0,this.emit("actionFinished")}}class Xe extends Ce{constructor(e,t){super("Create Rect"),this.rect=new S(0,0),this.rect.lineThickness=.05;const o=new r("circle","FatLinesShader");o.getParameter("Color").setValue(new a(.7,.2,.2)),this.geomItem=new c("Rect"),this.geomItem.setGeometry(this.rect),this.geomItem.setMaterial(o),e&&t&&this.setParentAndXfo(e,t)}update(e){if(e.baseSize&&this.rect.setSize(e.baseSize[0],e.baseSize[1]),e.tr){const t=this.geomItem.getParameter("LocalXfo").getValue();t.tr.fromJSON(e.tr),this.geomItem.getParameter("LocalXfo").setValue(t)}this.updated.emit(e)}}G.registerChange("CreateRectChange",Xe);class Ve extends be{constructor(e){super(e)}createStart(e,t){this.change=new Xe(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.invxfo=e.inverse(),this.stage=1,this._size=0}createMove(e){if(1==this.stage){const t=this.invxfo.transformVec3(e);this._size=Math.abs(t.x),Math.abs(t.y),this.change.update({baseSize:[Math.abs(t.x),Math.abs(t.y)],tr:this.xfo.tr.add(t.scale(.5))})}else{const t=this.invxfo.transformVec3(e);this.change.update({height:t.y})}}createRelease(e,t){0==this._size&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.emit("actionFinished")}}class ye extends Ce{constructor(e,t,o,s){super("Create Freehand Line"),this.used=0,this.vertexCount=100,this.line=new X,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),this.line.vertices.setValue(0,new u);const i=new r("freeHandLine","FatLinesShader");this.geomItem=new c("freeHandLine"),this.geomItem.setGeometry(this.line),this.geomItem.setMaterial(i),o&&i.getParameter("Color").setValue(o),s&&(this.line.lineThickness=s),e&&t&&this.setParentAndXfo(e,t)}update(e){this.used++;let t=!1;this.used>=this.line.getNumSegments()&&(this.vertexCount=this.vertexCount+100,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),t=!0),this.line.vertices.setValue(this.used,e.point),this.line.setSegment(this.used-1,this.used-1,this.used),t?this.line.geomDataTopologyChanged.emit({indicesChanged:!0}):this.line.geomDataChanged.emit({indicesChanged:!0}),this.updated.emit(e)}toJSON(e){const t=super.toJSON(e);return t.lineThickness=this.line.lineThickness,t.color=this.geomItem.getMaterial().getParameter("Color").getValue(),t}fromJSON(e,t){e.lineThickness&&(this.line.lineThickness=e.lineThickness);const o=new a(.7,.2,.2);e.color&&o.fromJSON(e.color),this.geomItem.getMaterial().getParameter("Color").setValue(o),super.fromJSON(e,t)}}G.registerChange("CreateFreehandLineChange",ye);class Re extends Se{constructor(e){super(e),this.mp=this.addParameter(new R("Modulate Thickness By Stroke Speed",!1))}createStart(e,t){const o=this.cp.getValue(),s=this.tp.getValue();this.change=new ye(t,e,o,s),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.invxfo=e.inverse(),this.stage=1,this.prevP=e.tr,this.length=0}createMove(e){const t=this.invxfo.transformVec3(e),o=t.subtract(this.prevP).length();o>.001&&this.change.update({point:t}),this.length+=o,this.prevP=t}createRelease(e){0==this.length&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.emit("actionFinished")}}class xe extends Ce{constructor(e,t){super("Create Sphere",e),this.sphere=new _(0,64,32);const o=new r("Sphere","SimpleSurfaceShader");this.geomItem=new c("Sphere"),this.geomItem.setGeometry(this.sphere),this.geomItem.setMaterial(o),e&&t&&this.setParentAndXfo(e,t)}update(e){this.sphere.radius=e.radius,this.updated.emit(e)}toJSON(){const e=super.toJSON();return e.radius=this.geomItem.getGeometry().radius,e}changeFromJSON(e){e.radius&&(this.geomItem.getGeometry().radius=e.radius)}}G.registerChange("CreateSphereChange",xe);class ke extends be{constructor(e){super(e)}createStart(e,t){this.change=new xe(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.stage=1,this.radius=0}createMove(e){this.radius=e.distanceTo(this.xfo.tr),this.change.update({radius:this.radius})}createRelease(e){0==this.radius&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.emit("actionFinished")}}class Oe extends Ce{constructor(e,t){super("Create Cuboid"),this.cuboid=new p(0,0,0,!0);const o=new r("Cuboid","SimpleSurfaceShader");this.geomItem=new c("Cuboid"),this.geomItem.setGeometry(this.cuboid),this.geomItem.setMaterial(o),e&&t&&this.setParentAndXfo(e,t)}update(e){if(e.baseSize&&this.cuboid.setBaseSize(e.baseSize[0],e.baseSize[1]),e.tr){const t=this.geomItem.getParameter("LocalXfo").getValue();t.tr.fromJSON(e.tr),this.geomItem.getParameter("LocalXfo").setValue(t)}e.height&&(this.cuboid.z=e.height),this.updated.emit(e)}}G.registerChange("CreateCuboidChange",Oe);class Ge extends be{constructor(e){super(e)}createStart(e,t){this.change=new Oe(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.invxfo=e.inverse(),this.stage=1,this._height=0}createMove(e){if(1==this.stage){const t=this.invxfo.transformVec3(e);this.change.update({baseSize:[Math.abs(t.x),Math.abs(t.y)],tr:this.xfo.tr.add(t.scale(.5))})}else{const t=this.invxfo.transformVec3(e);this.change.update({height:t.y})}}createRelease(e,t){if(1==this.stage){this.stage=2,this.pt1=e;const t=new D;t.setFromAxisAndAngle(new u(1,0,0),.5*Math.PI),this.constructionPlane.ori=this.constructionPlane.ori.multiply(t),this.constructionPlane.tr=e,this.invxfo=this.constructionPlane.inverse()}else 2==this.stage&&(this.stage=0,this.emit("actionFinished"))}}class Ae extends oe{constructor(e){super(e),this.activeHandle=void 0,this.capturedItems=[],this.mouseOverItems=[]}activateTool(){super.activateTool(),console.log("activateTool.HandleTool"),this.appData.renderer.getDiv().style.cursor="crosshair";const e=e=>{if(!this.__activated)return;const t=new _(.015),o=new r("Cross","FlatSurfaceShader");o.getParameter("BaseColor").setValue(new a("#03E3AC")),o.visibleInGeomDataBuffer=!1;const s=new c("HandleToolTip",t,o);e.getTipItem().removeAllChildren(),e.getTipItem().addChild(s,!1)},t=t=>{for(const o of t.getControllers())e(o);this.addIconToControllerId=t.on("controllerAdded",e)};this.appData.renderer.getXRViewport().then(e=>{t(e)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(e=>{e.removeListenerById("controllerAdded",this.addIconToControllerId)})}onMouseDown(e){if(!this.activeHandle){const t=e.viewport.getGeomDataAtPos(e.mousePos);if(null==t)return;if(t.geomItem.getOwner()instanceof E)return this.activeHandle=t.geomItem.getOwner(),this.activeHandle.handleMouseDown(Object.assign(e,{intersectionData:t})),!0}}onMouseMove(e){if(this.activeHandle)return this.activeHandle.handleMouseMove(e),!0;{if(0==e.button&&1==e.buttons)return!1;const t=e.viewport.getGeomDataAtPos(e.mousePos);if(null!=t&&t.geomItem.getOwner()instanceof E){const e=t.geomItem.getOwner();return this.__highlightedHandle&&this.__highlightedHandle.unhighlight(),this.__highlightedHandle=e,this.__highlightedHandle.highlight(),!0}this.__highlightedHandle&&(this.__highlightedHandle.unhighlight(),this.__highlightedHandle=void 0)}}onMouseUp(e){if(this.activeHandle)return this.activeHandle.handleMouseUp(e),this.activeHandle=void 0,!0}onWheel(e){this.activeHandle&&this.activeHandle.onWheel(e)}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onTouchCancel(e){}__prepareVREvent(e){const t=e.controller.getId();e.setCapture=e=>{this.capturedItems[t]=e},e.getCapture=()=>this.capturedItems[t],e.releaseCapture=()=>{this.capturedItems[t]=null}}onVRControllerButtonDown(e){const t=e.controller.getId();if(this.capturedItems[t])this.__prepareVREvent(e),this.capturedItems[t].onMouseDown(e);else{const t=e.controller.getGeomItemAtTip();null!=t&&(e.intersectionData=t,e.geomItem=t.geomItem,this.__prepareVREvent(e),t.geomItem.onMouseDown(e))}}onVRPoseChanged(e){for(const t of e.controllers){const o=t.getId();if(this.capturedItems[o])this.capturedItems[o].onMouseMove(e);else{const s=t.getGeomItemAtTip();null!=s?(e.intersectionData=s,e.geomItem=s.geomItem,s.geomItem!=this.mouseOverItems[o]&&(this.mouseOverItems[o]&&this.mouseOverItems[o].onMouseLeave(e),this.mouseOverItems[o]=s.geomItem,this.mouseOverItems[o].onMouseEnter(e)),s.geomItem.onMouseMove(e)):this.mouseOverItems[o]&&(this.mouseOverItems[o].onMouseLeave(e),this.mouseOverItems[o]=null)}}}onVRControllerButtonUp(e){this.__prepareVREvent(e);const t=e.controller.getId();if(this.capturedItems[t])this.capturedItems[t].onMouseUp(e);else{const t=e.controller.getGeomItemAtTip();null!=t&&(e.intersectionData=t,e.geomItem=t.geomItem,t.geomItem.onMouseUp(e))}}}class Ee extends U{constructor(e,t=.5,o=.02,s=new a("#F9CE03")){super(e),this.lengthParam=this.addParameter(new g("Length",t)),this.handleRadiusParam=this.addParameter(new g("Handle Radius",o)),this.barRadiusParam=this.addParameter(new g("Bar Radius",.25*o)),this.colorParam=this.addParameter(new n("Color",s)),this.hilghlightColorParam=this.addParameter(new n("Highlight Color",new a(1,1,1))),this.handleMat=new r("handle","FlatSurfaceShader"),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue());const i=new r("topBar","FlatSurfaceShader");i.getParameter("BaseColor").setValue(new a(.5,.5,.5));const l=new h(.25*o,1,64,2,!0,!0),u=new _(o,64);this.handle=new c("handle",u,this.handleMat),this.baseBar=new c("baseBar",l,this.handleMat),this.topBar=new c("topBar",l,i),this.handleXfo=new d,this.baseBarXfo=new d,this.topBarXfo=new d,this.barRadiusParam.on("valueChanged",()=>{l.getParameter("radius").setValue(this.barRadiusParam.getValue())}),this.handleRadiusParam.on("valueChanged",()=>{u.getParameter("radius").setValue(this.handleRadiusParam.getValue())}),this.lengthParam.on("valueChanged",()=>{this.__updateSlider(this.value)}),this.colorParam.on("valueChanged",()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}),this.addChild(this.handle),this.addChild(this.baseBar),this.addChild(this.topBar),this.__updateSlider(0)}highlight(){this.handleMat.getParameter("BaseColor").setValue(this.hilghlightColorParam.getValue())}unhighlight(){this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}setTargetParam(e){this.param=e;const t=()=>{this.__updateSlider(e.getValue())};t(),e.on("valueChanged",t)}__updateSlider(e){this.value=e;const t=this.param&&this.param.getRange()?this.param.getRange():[0,1],o=Math.remap(e,t[0],t[1],0,1),i=this.lengthParam.getValue();this.baseBarXfo.sc.z=o*i,this.handleXfo.tr.z=o*i,this.topBarXfo.tr.z=o*i,this.topBarXfo.sc.z=(1-o)*i,this.handle.setLocalXfo(this.handleXfo,s.GENERATED_VALUE),this.baseBar.setLocalXfo(this.baseBarXfo,s.GENERATED_VALUE),this.topBar.setLocalXfo(this.topBarXfo,s.GENERATED_VALUE)}onDragStart(e){this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1.2,this.handle.setLocalXfo(this.handleXfo,s.GENERATED_VALUE),this.param&&e.undoRedoManager&&(this.change=new L(this.param),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=this.lengthParam.getValue(),o=this.param&&this.param.getRange()?this.param.getRange():[0,1],s=Math.clamp(Math.remap(e.value,0,t,o[0],o[1]),o[0],o[1]);if(!this.param)return this.__updateSlider(s),void(this.value=s);this.change?this.change.update({value:s}):this.param.setValue(s)}onDragEnd(e){this.change=null,this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1,this.handle.setLocalXfo(this.handleXfo,s.GENERATED_VALUE)}toJSON(e,t=0){const o=super.toJSON(e,t|SAVE_FLAG_SKIP_CHILDREN);return this.param&&(o.targetParam=this.param.getPath()),o}fromJSON(e,t,o){super.fromJSON(e,t,o),e.targetParam&&t.resolvePath(e.targetParam).then(e=>{this.setTargetParam(e)})}}P.registerClass("SliderHandle",Ee);class Ue extends N{constructor(e,t=1,o=1,s=.02,i=new a(1,1,0)){super(e),this.arcRadiusParam=this.addParameter(new g("Arc Radius",t)),this.arcAngleParam=this.addParameter(new g("Arc Angle",o)),this.handleRadiusParam=this.addParameter(new g("Handle Radius",s)),this.colorParam=this.addParameter(new n("Color",i)),this.hilghlightColorParam=this.addParameter(new n("Highlight Color",new a(1,1,1))),this.handleMat=new r("handleMat","HandleShader");const h=new y(t,o,64),l=new _(s,64);this.handle=new c("handle",l,this.handleMat),this.arc=new c("arc",h,this.handleMat),this.handleXfo=new d,this.handleGeomOffsetXfo=new d,this.handleGeomOffsetXfo.tr.x=t,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.range=[0,o],this.arcAngleParam.on("valueChanged",()=>{const e=this.arcAngleParam.getValue();h.getParameter("Angle").setValue(e),this.range=[0,e]}),this.arcRadiusParam.on("valueChanged",()=>{const e=this.arcRadiusParam.getValue();h.getParameter("Radius").setValue(e),this.handleGeomOffsetXfo.tr.x=e,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo)}),this.handleRadiusParam.on("valueChanged",()=>{l.getParameter("radius").setValue(this.handleRadiusParam.getValue())}),this.colorParam.on("valueChanged",()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}),this.addChild(this.handle),this.addChild(this.arc),this.setTargetParam(this.handle.getParameter("GlobalXfo"),!1)}onMouseEnter(e){e.intersectionData&&e.intersectionData.geomItem==this.handle&&this.highlight()}onMouseLeave(e){this.unhighlight()}onMouseDown(e){e.intersectionData&&e.intersectionData.geomItem==this.handle&&super.onMouseDown(e)}highlight(){this.handleMat.getParameter("BaseColor").setValue(this.hilghlightColorParam.getValue())}unhighlight(){this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}getBaseXfo(){return this.handle.getParameter("GlobalXfo").getValue()}onDragStart(e){this.baseXfo=this.getGlobalXfo().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new d,this.vec0=this.getGlobalXfo().ori.getXaxis(),this.vec0.normalizeInPlace(),e.undoRedoManager&&(this.change=new L(this.param),e.undoRedoManager.addChange(this.change)),this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1.2,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.emit("dragStart")}onDrag(e){const t=e.holdPos.subtract(this.baseXfo.tr);t.normalizeInPlace();let o=this.vec0.angleTo(t);if(this.vec0.cross(t).dot(this.baseXfo.ori.getZaxis())<0&&(o=-o),this.range&&(o=Math.clamp(o,this.range[0],this.range[1])),e.shiftKey){const e=Math.degToRad(22.5);o=Math.floor(o/e)*e}this.deltaXfo.ori.setFromAxisAndAngle(new Vec3(0,0,1),o);const s=this.baseXfo.multiply(this.deltaXfo);if(this.change)this.change.update({value:s});else{(this.param?this.param:this.getParameter("GlobalXfo")).setValue(s)}}onDragEnd(e){this.change=null,this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.emit("dragEnd")}toJSON(e,t=0){const o=super.toJSON(e,t|SAVE_FLAG_SKIP_CHILDREN);return this.param&&(o.targetParam=this.param.getPath()),o}fromJSON(e,t,o){super.fromJSON(e,t,o),e.targetParam&&t.resolvePath(e.targetParam).then(e=>{this.setTargetParam(e)})}}P.registerClass("ArcSlider",Ue);class Le extends E{constructor(e){super(e)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}handleMouseDown(e){this.gizmoRay=new o,this.gizmoRay.dir=e.mouseRay.dir.negate();const t=this.getTargetParam().getValue();this.gizmoRay.pos=t.tr;const s=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.grabPos=e.mouseRay.pointAtDist(s),this.onDragStart(e),!0}handleMouseMove(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.holdPos=e.mouseRay.pointAtDist(t),this.onDrag(e),!0}handleMouseUp(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.releasePos=e.mouseRay.pointAtDist(t),this.onDragEnd(e),!0}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new L(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.grabPos),o=this.baseXfo.clone();if(o.tr.addInPlace(t),this.change)this.change.update({value:o});else{this.getTargetParam().setValue(o)}}onDragEnd(e){this.change=null}}export{Ue as ArcSlider,z as AxialRotationHandle,A as Change,Te as CreateCircleTool,Ge as CreateCuboidTool,Re as CreateFreehandLineTool,Se as CreateLineTool,Ve as CreateRectTool,ke as CreateSphereTool,Ae as HandleTool,B as LinearMovementHandle,ne as OpenVRUITool,L as ParameterValueChange,H as PlanarMovementHandle,Le as ScreenSpaceMovementHandle,q as SelectionManager,ae as SelectionTool,Ee as SliderHandle,te as ToolManager,$ as TreeItemAddChange,ee as TreeItemMoveChange,Q as TreeItemsRemoveChange,G as UndoRedoManager,se as VIEW_TOOL_MODELS,Pe as VRHoldObjectsTool,ve as VRUITool,ie as ViewTool};
