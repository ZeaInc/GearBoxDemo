import{Signal as e,TreeItem as t,Ray as o,ValueSetMode as s,Parameter as i,Color as n,ColorParameter as a,Material as r,Cylinder as h,Cone as l,GeomItem as c,Xfo as d,Vec3 as g,NumberParameter as u,Torus as m,Cuboid as p,Sphere as f,Group as _,BaseItem as w,Operator as I,sgFactory as v,ParameterOwner as C,Vec2 as P,SystemDesc as b,Quat as T,Rect as D,Plane as S,DataImage as M,Lines as y,Cross as V,Circle as X,BooleanParameter as R}from"../../zea-engine/dist/index.esm.js";class x{constructor(){this.actions=[],this.actionAdded=new e}registerAction(e){const{name:t}=e;t?this._addAction(e):console.warn("A action is missing its name.")}_addAction(e){this.actions.push(e),this.actionAdded.emit(e)}getActions(){return this.actions}}const k={},E={},O=[];class A{constructor(){this.__undoStack=[],this.__redoStack=[],this.changeAdded=new e,this.changeUpdated=new e,this.changeUndone=new e,this.changeRedone=new e,this.__currChangeUpdated=this.__currChangeUpdated.bind(this)}flush(){for(const e of this.__undoStack)e.destroy();this.__undoStack=[];for(const e of this.__redoStack)e.destroy();this.__redoStack=[]}addChange(e){this.getCurrentChange()&&this.getCurrentChange().updated.disconnect(this.__currChangeUpdated),this.__undoStack.push(e),e.updated.connect(this.__currChangeUpdated);for(const e of this.__redoStack)e.destroy();this.__redoStack=[],this.changeAdded.emit(e)}getCurrentChange(){return this.__undoStack[this.__undoStack.length-1]}__currChangeUpdated(e){this.changeUpdated.emit(e)}undo(e=!0){if(this.__undoStack.length>0){const t=this.__undoStack.pop();t.undo(),e&&(this.__redoStack.push(t),this.changeUndone.emit())}}redo(){if(this.__redoStack.length>0){const e=this.__redoStack.pop();e.redo(),this.__undoStack.push(e),this.changeRedone.emit()}}constructChange(e){return new k[e]}static getChangeClassName(e){const t=O.indexOf(e.constructor);return E[t]?E[t]:(console.warn("Change not registered:",e.constructor.name),e.constructor.name)}static registerChange(e,t){-1!=O.indexOf(t)&&console.warn("Class already registered:",e);const o=O.length;O.push(t),k[e]=t,E[o]=e}}class G{constructor(t){this.name=t||A.getChangeClassName(this),this.updated=new e}undo(){throw new Error("Implement me")}redo(){throw new Error("Implement me")}update(e){throw new Error("Implement me")}toJSON(e){return{}}fromJSON(e,t){}changeFromJSON(e){this.update(e)}destroy(){}}class L extends t{constructor(e){super(e),this.captured=!1}highlight(){}unhighlight(){}getManipulationPlane(){const e=this.getGlobalXfo();return new o(e.tr,e.ori.getZaxis())}onMouseEnter(e){this.highlight()}onMouseLeave(e){this.unhighlight()}onMouseDown(e){e.setCapture(this),e.stopPropagation(),this.captured=!0,e.viewport?this.handleMouseDown(e):e.vrviewport&&this.onVRControllerButtonDown(e)}onMouseMove(e){this.captured&&(e.stopPropagation(),e.viewport?this.handleMouseMove(e):e.vrviewport&&this.onVRPoseChanged(e))}onMouseUp(e){this.captured&&(e.releaseCapture(),e.stopPropagation(),this.captured=!1,e.viewport?this.handleMouseUp(e):e.vrviewport&&this.onVRControllerButtonUp(e))}onWheel(e){}handleMouseDown(e){this.gizmoRay=this.getManipulationPlane();const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.grabPos=e.mouseRay.pointAtDist(t),this.onDragStart(e),!0}handleMouseMove(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.holdPos=e.mouseRay.pointAtDist(t),this.onDrag(e),!0}handleMouseUp(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.releasePos=e.mouseRay.pointAtDist(t),this.onDragEnd(e),!0}onVRControllerButtonDown(e){this.activeController=e.controller;const t=this.activeController.getTipXfo().clone(),o=this.getManipulationPlane(),s=t.tr.subtract(o.start),i=t.tr.subtract(o.dir.scale(s.dot(o.dir)));return e.grabPos=i,this.onDragStart(e),!0}onVRPoseChanged(e){if(this.activeController){const t=this.activeController.getTipXfo(),o=this.getManipulationPlane(),s=t.tr.subtract(o.start),i=t.tr.subtract(o.dir.scale(s.dot(o.dir)));return e.holdPos=i,this.onDrag(e),!0}}onVRControllerButtonUp(e){if(this.activeController==e.controller){const t=this.activeController.getTipXfo();return this.onDragEnd(e,t.tr),this.activeController=void 0,!0}}onDragStart(e){console.log("onDragStart",e)}onDrag(e){console.log("onDrag",e)}onDragEnd(e){console.log("onDragEnd",e)}}class H extends L{constructor(e){super(e)}handleMouseDown(e){this.gizmoRay=this.getManipulationPlane(),this.grabDist=e.mouseRay.intersectRayVector(this.gizmoRay)[1];const t=this.gizmoRay.pointAtDist(this.grabDist);return e.grabDist=this.grabDist,e.grabPos=t,this.onDragStart(e),!0}handleMouseMove(e){const t=e.mouseRay.intersectRayVector(this.gizmoRay)[1],o=this.gizmoRay.pointAtDist(t);e.holdDist=t,e.holdPos=o,e.value=t,e.delta=t-this.grabDist,this.onDrag(e)}handleMouseUp(e){const t=e.mouseRay.intersectRayVector(this.gizmoRay)[1],o=this.gizmoRay.pointAtDist(t);return e.releasePos=o,this.onDragEnd(e),!0}onVRControllerButtonDown(e){this.gizmoRay=this.getManipulationPlane(),this.activeController=e.controller;const t=this.activeController.getTipXfo();this.grabDist=t.tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir);const o=this.gizmoRay.start.add(this.gizmoRay.dir.scale(this.grabDist));return e.grabPos=o,this.onDragStart(e),!0}onVRPoseChanged(e){const t=this.activeController.getTipXfo().tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir),o=this.gizmoRay.start.add(this.gizmoRay.dir.scale(t));return e.value=t,e.holdPos=o,e.delta=t-this.grabDist,this.onDrag(e),!0}onVRControllerButtonUp(e){if(this.activeController==e.controller)return this.onDragEnd(),this.activeController=void 0,!0}}class N extends G{constructor(e,t,o=s.USER_SETVALUE){e?(super(e?e.getName()+" Changed":"ParameterValueChange"),this.__prevValue=e.getValue(),this.__param=e,this.__mode=o,null!=t&&(this.__nextValue=t,this.__param.setValue(this.__nextValue,o))):super()}undo(){this.__param&&this.__param.setValue(this.__prevValue,this.__mode)}redo(){this.__param&&this.__param.setValue(this.__nextValue,this.__mode)}update(e){if(!this.__param)return;this.__nextValue=e.value;const t=e.mode?e.mode:this.__mode;this.__param.setValue(this.__nextValue,t),this.updated.emit(e)}toJSON(e){const t={name:this.name,paramPath:this.__param.getPath()};return null!=this.__nextValue&&(this.__nextValue.toJSON?t.value=this.__nextValue.toJSON():t.value=this.__nextValue),t}fromJSON(e,t){const o=t.appData.scene.getRoot().resolvePath(e.paramPath,1);o&&o instanceof i?(this.__param=o,this.__prevValue=this.__param.getValue(),this.__prevValue.clone?this.__nextValue=this.__prevValue.clone():this.__nextValue=this.__prevValue,this.name=e.name,null!=e.value&&this.changeFromJSON(e)):console.warn("resolvePath is unable to resolve",e.paramPath)}changeFromJSON(e){this.__param&&(this.__nextValue.fromJSON?this.__nextValue.fromJSON(e.value):this.__nextValue=e.value,this.__param.setValue(this.__nextValue,s.REMOTEUSER_SETVALUE))}}A.registerChange("ParameterValueChange",N);class U extends H{constructor(e,t,o,s){super(e),this.__color=s,this.__hilightedColor=new n(1,1,1),this.colorParam=this.addParameter(new a("BaseColor",s));const i=new r("handle","HandleShader");i.getParameter("maintainScreenSize").setValue(1),i.replaceParameter(this.colorParam);const g=new h(o,t,64);g.getParameter("baseZAtZero").setValue(!0);const u=new l(4*o,10*o,64,!0),m=new c("handle",g,i),p=new c("tip",u,i),f=new d;f.tr.set(0,0,t),u.transformVertices(f),this.addChild(m),this.addChild(p)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.valueChanged.connect(t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new N(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.grabPos),o=this.baseXfo.clone();o.tr.addInPlace(t),this.change?this.change.update({value:o}):this.param.setValue(o)}onDragEnd(e){this.change=null}}class B extends L{constructor(e){super(e),this.fullXfoManipulationInVR=!0}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.valueChanged.connect(t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new N(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.grabPos),o=this.baseXfo.clone();if(o.tr.addInPlace(t),this.change)this.change.update({value:o});else{this.getTargetParam().setValue(o)}}onDragEnd(e){this.change=null}onVRControllerButtonDown(e){if(this.fullXfoManipulationInVR){this.activeController=e.controller;const t=this.activeController.getTipXfo(),o=this.getGlobalXfo();this.grabOffset=t.inverse().multiply(o)}else super.onVRControllerButtonDown(e);return!0}onVRPoseChanged(e){if(this.fullXfoManipulationInVR){const e=this.activeController.getTipXfo().multiply(this.grabOffset);if(this.change)this.change.update({value:e});else{this.getTargetParam().setValue(e)}}else super.onVRPoseChanged(e)}onVRControllerButtonUp(e){this.fullXfoManipulationInVR?this.change=null:super.onVRControllerButtonUp(e)}}class z extends L{constructor(e){super(e)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.valueChanged.connect(t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.baseXfo=this.getGlobalXfo().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new d;const t=this.getTargetParam(),o=t.getValue();this.offsetXfo=this.baseXfo.inverse().multiply(o),this.vec0=e.grabPos.subtract(this.baseXfo.tr),this.grabCircleRadius=this.vec0.length(),this.vec0.normalizeInPlace(),e.undoRedoManager&&(this.change=new N(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.baseXfo.tr),o=t.length();t.normalizeInPlace();const s=o/this.grabCircleRadius;let i=this.vec0.angleTo(t)*s;if(this.vec0.cross(t).dot(this.baseXfo.ori.getZaxis())<0&&(i=-i),this.range&&(i=Math.clamp(i,this.range[0],this.range[1])),e.shiftKey){const e=Math.degToRad(22.5);i=Math.floor(i/e)*e}this.deltaXfo.ori.setFromAxisAndAngle(new g(0,0,1),i);const n=this.baseXfo.multiply(this.deltaXfo).multiply(this.offsetXfo);if(this.change)this.change.update({value:n});else{this.getTargetParam().setValue(n)}}onDragEnd(e){this.change=null}}class F extends z{constructor(e,t,o,s){super(e),this.__color=s,this.__hilightedColor=new n(1,1,1),this.radiusParam=this.addParameter(new u("radius",t)),this.colorParam=this.addParameter(new a("BaseColor",s));const i=new r("handle","HandleShader");i.getParameter("maintainScreenSize").setValue(1),i.replaceParameter(this.colorParam);const h=new m(o,t,64);this.handle=new c("handle",h,i),this.handleXfo=new d,this.radiusParam.valueChanged.connect(()=>{t=this.radiusParam.getValue(),h.getParameter("radius").setValue(t),h.getParameter("height").setValue(.02*t)}),this.addChild(this.handle)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}getBaseXfo(){return this.getParameter("GlobalXfo").getValue()}onDragStart(e){super.onDragStart(e),this.colorParam.setValue(new n(1,1,1))}onDrag(e){super.onDrag(e)}onDragEnd(e){super.onDragEnd(e),this.colorParam.setValue(this.__color)}}class J extends H{constructor(e,t,o,s){super(e),this.__color=s,this.__hilightedColor=new n(1,1,1),this.colorParam=this.addParameter(new a("BaseColor",s));const i=new r("handle","HandleShader");i.getParameter("maintainScreenSize").setValue(1),i.replaceParameter(this.colorParam);const l=new h(o,t-10*o,64);l.getParameter("baseZAtZero").setValue(!0);const g=new p(10*o,10*o,10*o),u=new c("handle",l,i),m=new c("tip",g,i),f=new d;f.tr.set(0,0,t-10*o),g.transformVertices(f),this.addChild(u),this.addChild(m)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.valueChanged.connect(t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabDist=e.grabDist,this.oriXfo=this.getGlobalXfo(),this.tmplocalXfo=this.getLocalXfo();const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new N(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=this.baseXfo.clone(),o=e.holdDist/this.grabDist;o<1e-4||(t.sc.set(this.baseXfo.sc.x*o,this.baseXfo.sc.y*o,this.baseXfo.sc.z*o),this.tmplocalXfo.sc.set(1,1,o),this.setLocalXfo(this.tmplocalXfo),this.change?this.change.update({value:t}):this.param.setValue(t))}onDragEnd(e){this.change=null,this.tmplocalXfo.sc.set(1,1,1),this.setLocalXfo(this.tmplocalXfo);const t=this.getChildByName("tip"),o=t.getLocalXfo();o.sc.set(1,1,1),t.setLocalXfo(o)}}class Z extends L{constructor(e,t,o){super(e),this.radius=t;const s=new r("mask","HandleShader");s.getParameter("maintainScreenSize").setValue(1),s.getParameter("BaseColor").setValue(o);const i=new f(t,64),n=new c("mask",i,s);this.addChild(n)}highlight(){}unhighlight(){}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.valueChanged.connect(t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}handleMouseDown(e){return!0}handleMouseMove(e){return!0}handleMouseUp(e){return!0}onDragStart(e){this.baseXfo=this.getGlobalXfo(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new d;const t=this.getTargetParam();this.offsetXfo=this.baseXfo.inverse().multiply(t.getValue()),this.vec0=e.grabPos.subtract(this.baseXfo.tr),this.vec0.normalizeInPlace(),this.colorParam.setValue(new n(1,1,1)),e.undoRedoManager&&(this.change=new ParameterValueChange(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.baseXfo.tr);t.normalizeInPlace();const o=this.vec0.angleTo(t)*modulator,s=this.vec0.cross(t).normalize();this.deltaXfo.ori.setFromAxisAndAngle(s,o);const i=this.baseXfo.multiply(this.deltaXfo),n=i.multiply(this.offsetXfo);if(this.change)this.change.update({value:n});else{this.getTargetParam().setValue(i)}}onDragEnd(e){this.change=null,this.colorParam.setValue(this.__color)}}class K extends B{constructor(e,t,o,s){super(e),this.__color=o,this.__hilightedColor=new n(1,1,1),this.sizeParam=this.addParameter(new u("size",t)),this.colorParam=this.addParameter(new a("BaseColor",o));const i=new r("handle","HandleShader");i.getParameter("maintainScreenSize").setValue(1),i.replaceParameter(this.colorParam);const h=new p(t,t,.02*t),l=new d;l.tr=s,h.transformVertices(l),this.handle=new c("handle",h,i),this.sizeParam.valueChanged.connect(()=>{t=this.sizeParam.getValue(),h.getParameter("size").setValue(t),h.getParameter("height").setValue(.02*t)}),this.addChild(this.handle)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}}class W extends t{constructor(e,o){super("XfoHandle");const s=new t("Translate");s.setVisible(!1),this.addChild(s);const i=new n(1,.1,.1),a=new n("#32CD32"),r=new n("#1E90FF");i.a=.8,a.a=.8,r.a=.8;{const t=new U("linearX",e,o,i),n=new d;n.ori.setFromAxisAndAngle(new g(0,1,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(n),s.addChild(t)}{const t=new U("linearY",e,o,a),i=new d;i.ori.setFromAxisAndAngle(new g(1,0,0),-.5*Math.PI),t.getParameter("LocalXfo").setValue(i),s.addChild(t)}{const t=new U("linearZ",e,o,r);s.addChild(t)}const h=.35*e;{const e=new K("planarXY",h,a,new g(.5*h,.5*h,0)),t=new d;e.getParameter("LocalXfo").setValue(t),s.addChild(e)}{const e=new K("planarYZ",h,i,new g(-.5*h,.5*h,0)),t=new d;t.ori.setFromAxisAndAngle(new g(0,1,0),.5*Math.PI),e.getParameter("LocalXfo").setValue(t),s.addChild(e)}{const e=new K("planarXZ",h,r,new g(.5*h,.5*h,0)),t=new d;t.ori.setFromAxisAndAngle(new g(1,0,0),.5*Math.PI),e.getParameter("LocalXfo").setValue(t),s.addChild(e)}const l=new t("Rotate");l.setVisible(!1),this.addChild(l);{const t=new Z("rotation",e-o,new n(1,1,1,.4));l.addChild(t)}{const t=new F("rotationX",e,o,i),s=new d;s.ori.setFromAxisAndAngle(new g(0,1,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(s),l.addChild(t)}{const t=new F("rotationY",e,o,a),s=new d;s.ori.setFromAxisAndAngle(new g(1,0,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(s),l.addChild(t)}{const t=new F("rotationZ",e,o,r);l.addChild(t)}const c=new t("Scale");c.setVisible(!1),this.addChild(c);const u=.95*e;{const e=new J("scaleX",u,o,i),t=new d;t.ori.setFromAxisAndAngle(new g(0,1,0),.5*Math.PI),e.getParameter("LocalXfo").setValue(t),c.addChild(e)}{const e=new J("scaleY",u,o,a),t=new d;t.ori.setFromAxisAndAngle(new g(1,0,0),-.5*Math.PI),e.getParameter("LocalXfo").setValue(t),c.addChild(e)}{const e=new J("scaleZ",u,o,r);c.addChild(e)}}_cleanGlobalXfo(e){const t=this.getParentItem();if(void 0!==t){const e=t.getGlobalXfo().clone();return e.sc.set(1,1,1),e.multiply(this.__localXfoParam.getValue())}return this.__localXfoParam.getValue()}showHandles(e){this.traverse(e=>{if(e!=this)return e.setVisible(!1),!1});const t=this.getChildByName(e);t&&t.setVisible(!0)}setTargetParam(e){this.param=e,this.traverse(t=>{t instanceof L&&t.setTargetParam(e,!1)})}}class j extends _{constructor(e){let t,o;super(),e.selectionOutlineColor?t=e.selectionOutlineColor:(t=new n("#03E3AC"),t.a=.1),e.branchSelectionOutlineColor?o=e.branchSelectionOutlineColor:(o=t.lerp(new n("white"),.5),o.a=.1),this.getParameter("HighlightColor").setValue(t),this.addParameter(new a("SubtreeHighlightColor",o)),this.propagatingSelectionToItems=0!=e.setItemsSelected,this.getParameter("InitialXfoMode").setValue(_.INITIAL_XFO_MODES.average),this.__itemsParam.setFilterFn(e=>e instanceof w)}clone(e){const t=new j;return t.copyFrom(this,e),t}rebindInitialXfos(){Array.from(this.__itemsParam.getValue()).forEach((e,o)=>{e instanceof t&&(this.__initialXfos[o]=e.getGlobalXfo())})}__bindItem(e,o){this.propagatingSelectionToItems&&e.setSelected(this);const s={};if(e instanceof t){const i=this.getParameter("HighlightColor").getValue();i.a=this.getParameter("HighlightFill").getValue();const n=this.getParameter("SubtreeHighlightColor").getValue();e.addHighlight("selected"+this.getId(),i,!1),e.getChildren().forEach(e=>{e instanceof t&&e.addHighlight("branchselected"+this.getId(),n,!0)}),s.globalXfoChangedIndex=e.globalXfoChanged.connect(t=>{this.calculatingGroupXfo||this.propagatingXfoToItems||(this.__initialXfos[o]=e.getGlobalXfo(),this.groupXfoDirty=!0,this._setGlobalXfoDirty())}),this.__initialXfos[o]=e.getGlobalXfo(),this.groupXfoDirty=!0}this.__signalIndices[o]=s}__unbindItem(e,o){this.propagatingSelectionToItems&&e.setSelected(!1),e instanceof t&&(e.removeHighlight("selected"+this.getId()),e.getChildren().forEach(e=>{e instanceof t&&e.removeHighlight("branchselected"+this.getId(),!0)}),e.globalXfoChanged.disconnectId(this.__signalIndices[o].globalXfoChangedIndex),this.__initialXfos.splice(o,1),this.groupXfoDirty=!0),this.__signalIndices.splice(o,1)}_propagateDirtyXfoToItems(){if(this.groupXfoDirty||this.calculatingGroupXfo)return;const e=Array.from(this.__itemsParam.getValue());if(!this.calculatingGroupXfo&&e.length>0&&this.invGroupXfo&&!this.dirty){const o=this.__globalXfoParam.getValue().multiply(this.invGroupXfo);this.propagatingXfoToItems=!0;const s=(e,t)=>{const s=e.getParameter("GlobalXfo"),i=o.multiply(t);s.setValue(i)};e.forEach((e,o)=>{e instanceof t&&s(e,this.__initialXfos[o])}),this.propagatingXfoToItems=!1}}}class Y extends G{constructor(e,t,o){super("SelectionChange"),this.__selectionManager=e,this.__prevSelection=t,this.__newSelection=o}undo(){this.__selectionManager.setSelection(this.__prevSelection,!1)}redo(){this.__selectionManager.setSelection(this.__newSelection,!1)}toJSON(e){const t=super.toJSON(e),o=[];for(const e of this.__newSelection)o.push(e.getPath());return t.itemPaths=o,t}fromJSON(e,t){super.fromJSON(e,t),this.__selectionManager=t.appData.selectionManager,this.__prevSelection=new Set(this.__selectionManager.getSelection());const o=t.appData.scene.getRoot(),s=new Set;for(const t of e.itemPaths)s.add(o.resolvePath(t,1));this.__newSelection=s,this.__selectionManager.setSelection(this.__newSelection,!1)}}A.registerChange("SelectionChange",Y);class q extends G{constructor(e,t){super("Selection Visibility Change"),this.selection=e,this.state=t,this.do(this.state)}undo(){this.do(!this.state)}redo(){this.do(this.state)}do(e){for(const t of this.selection)t.getParameter("Visible").setValue(e)}}A.registerChange("ToggleSelectionVisibility",q);class ${constructor(t,o={}){if(this.appData=t,this.leadSelection=void 0,this.selectionChanged=new e,this.leadSelectionChanged=new e,this.selectionGroup=new j(o),!0===o.enableXfoHandles){const o=.1,s=.02*o;this.xfoHandle=new W(o,s),this.xfoHandle.setTargetParam(this.selectionGroup.getParameter("GlobalXfo"),!1),this.xfoHandle.setVisible(!1),this.selectionGroup.addChild(this.xfoHandle),this.handleGroup={Translate:new e,Rotate:new e,Scale:new e},this.currMode="",t.actionRegistry.registerAction({name:"Translate",path:["Edit"],callback:()=>{this.showHandles("Translate")},key:"w",activatedChanged:this.handleGroup.Translate}),t.actionRegistry.registerAction({name:"Rotate",path:["Edit"],callback:()=>{this.showHandles("Rotate")},key:"e",activatedChanged:this.handleGroup.Rotate}),t.actionRegistry.registerAction({name:"Scale",path:["Edit"],callback:()=>{this.showHandles("Scale")},key:"r",activatedChanged:this.handleGroup.Scale}),t.actionRegistry.registerAction({name:"Local",path:["Edit","Coords"],callback:()=>{this.setXfoMode(ZeaEngine.Group.INITIAL_XFO_MODES.average)},key:"k",activatedChanged:this.handleGroup.Translate}),t.actionRegistry.registerAction({name:"Global",path:["Edit","Coords"],callback:()=>{this.setXfoMode(ZeaEngine.Group.INITIAL_XFO_MODES.globalOri)},key:"l",activatedChanged:this.handleGroup.Rotate})}this.appData.renderer&&this.setRenderer(this.appData.renderer)}setRenderer(e){this.__renderer=e,this.__renderer.addTreeItem(this.selectionGroup)}setXfoMode(e){this.xfoHandle&&(this.selectionGroup.rebindInitialXfos(),this.selectionGroup.getParameter("InitialXfoMode").setValue(e))}showHandles(e){if(this.xfoHandle&&this.currMode!=e){this.currMode=e;for(const t in this.handleGroup)this.handleGroup[t].emit(e==t);this.xfoHandle.showHandles(e)}}updateHandleVisiblity(){if(!this.xfoHandle)return;const e=this.selectionGroup.getItems(),t=Array.from(e).length>0;this.xfoHandle.setVisible(t),this.__renderer.requestRedraw()}getSelection(){return this.selectionGroup.getItems()}setSelection(e,t=!0){const o=new Set(this.selectionGroup.getItems()),s=new Set(o);for(const t of e)o.has(t)||o.add(t);for(const t of o)e.has(t)||o.delete(t);if(this.selectionGroup.setItems(o),o.size>0?this.__setLeadSelection(o.values().next().value):this.__setLeadSelection(),this.updateHandleVisiblity(),t){const e=new Y(this,s,o);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(e)}}__setLeadSelection(e){this.leadSelection!=e&&(this.leadSelection=e,this.leadSelectionChanged.emit(e))}toggleItemSelection(e,t=!0){const o=new Set(this.selectionGroup.getItems()),s=new Set(o);if(t&&(1!=o.size||!o.has(e))){let t=!0;if(o.has(e)){let s=1;e.traverse(e=>{o.has(e)&&s++}),t=s!=o.size}t&&o.clear()}let i;o.has(e)?(o.delete(e),i=!1):(o.add(e),i=!0),this.selectionGroup.setItems(o),i&&1===o.size?this.__setLeadSelection(e):i||(1===o.size?this.__setLeadSelection(o.values().next().value):0===o.size&&this.__setLeadSelection());const n=new Y(this,s,o);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(n),this.updateHandleVisiblity(),this.selectionChanged.emit(s)}clearSelection(e=!0){const t=new Set(this.selectionGroup.getItems());if(0==t.size)return!1;let o;if(e&&(o=new Set(t)),t.clear(),this.selectionGroup.setItems(t),this.updateHandleVisiblity(),e){const e=new Y(this,o,t);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(e),this.selectionChanged.emit(t)}return!0}selectItems(e,t=!0){const o=new Set(this.selectionGroup.getItems()),s=new Set(o);t&&o.clear();for(const t of e)t.getSelected()||o.add(t);const i=new Y(this,s,o);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(i),this.selectionGroup.setItems(o),1===o.size?this.__setLeadSelection(o.values().next().value):0===o.size&&this.__setLeadSelection(),this.updateHandleVisiblity(),this.selectionChanged.emit(o)}deselectItems(e){const t=this.selectionGroup.getItems(),o=new Set(t);for(const o of e)o.getSelected()&&t.delete(selectedParam);this.selectionGroup.setItems(t);const s=new Y(this,o,t);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(s),1===t.size?this.__setLeadSelection(t.values().next().value):0===t.size&&this.__setLeadSelection(),this.updateHandleVisiblity(),this.selectionChanged.emit(t)}toggleSelectionVisiblity(){if(this.leadSelection){const e=this.selectionGroup.getItems(),t=!this.leadSelection.getVisible(),o=new q(e,t);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(o)}}startPickingMode(e,t,o,s){console.log(e),this.__pickCB=t,this.__pickFilter=o,this.__pickCount=s,this.__picked=[]}pickingFilter(e){return this.__pickFilter(e)}pickingModeActive(){return null!=this.__pickCB}cancelPickingMode(){this.__pickCB=void 0}pick(e){if(this.__pickCB){if(Array.isArray(e))this.__pickFilter?this.__picked=this.__picked.concat(e.filter(this.__pickFilter)):this.__picked=this.__picked.concat(e);else{if(this.__pickFilter&&!this.__pickFilter(e))return;this.__picked.push(e)}this.__picked.length==this.__pickCount&&(this.__pickCB(this.__picked),this.__pickCB=void 0)}}}class Q extends class{constructor(e,t,o=!1){this.name=e,this.path=t,this.availableInVR=o,this.callback=this.callback.bind(this)}callback(){}}{constructor(t,o,s,i,n){super(t,o,s),this.toolManager=i,this.tool=n,this.state=!1,this.activatedChanged=new e,n.installChanged.connect(e=>{this.activatedChanged.emit(e)})}callback(){if(this.tool.installed())this.toolManager.removeToolByHandle(this.tool);else{const e=this.toolManager.currTool();"VRUITool"==e.getName()?this.toolManager.insertToolBefore(this.tool,e):e.isPrimaryTool()?this.toolManager.replaceCurrentTool(this.tool):this.toolManager.pushTool(this.tool)}}}class ee extends G{constructor(e,t,o){e?(super(e.getName()+" Added"),this.treeItem=e,this.owner=t,this.selectionManager=o,this.prevSelection=new Set(this.selectionManager.getSelection()),this.treeItemIndex=this.owner.addChild(this.treeItem),this.selectionManager.setSelection(new Set([this.treeItem]),!1),this.treeItem.addRef(this)):super()}undo(){if(this.treeItem instanceof I){this.treeItem.detach()}else this.treeItem instanceof t&&this.treeItem.traverse(e=>{if(e instanceof I){e.detach()}},!1);this.owner.removeChild(this.treeItemIndex),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1)}redo(){if(this.treeItem instanceof I){this.treeItem.reattach()}else subTreeItem instanceof t&&this.treeItem.traverse(e=>{if(e instanceof I){e.reattach()}},!1);this.owner.addChild(this.treeItem),this.selectionManager&&this.selectionManager.setSelection(new Set([this.treeItem]),!1)}toJSON(e){return{name:this.name,treeItem:this.treeItem.toJSON(e),treeItemPath:this.treeItem.getPath(),treeItemIndex:this.treeItemIndex}}fromJSON(e,t){const o=v.constructClass(e.treeItem.type);o?(this.name=e.name,this.treeItem=o,this.treeItem.addRef(this),this.treeItem.fromJSON(e.treeItem,t),this.treeItemIndex=this.owner.addChild(this.treeItem,!1,!1)):console.warn("resolvePath is unable to conostruct",e.treeItem)}destroy(){this.treeItem.removeRef(this)}}A.registerChange("TreeItemAddChange",ee);class te extends G{constructor(e,o){if(super(),this.items=[],this.itemOwners=[],this.itemPaths=[],this.itemIndices=[],e){this.selectionManager=o.selectionManager,this.prevSelection=new Set(this.selectionManager.getSelection()),this.items=e,this.newSelection=new Set(this.prevSelection);const s=[];this.items.forEach(e=>{const o=e.getOwner(),i=o.getChildIndex(e);if(s.push(e.getName()),e.addRef(this),this.itemOwners.push(o),this.itemPaths.push(e.getPath()),this.itemIndices.push(i),this.selectionManager&&this.newSelection.has(e)&&this.newSelection.delete(e),e instanceof I){e.detach()}else e instanceof t&&e.traverse(e=>{if(e instanceof I){e.detach()}this.selectionManager&&this.newSelection.has(e)&&this.newSelection.delete(e)},!1);o.removeChild(i)}),this.selectionManager.setSelection(this.newSelection,!1),this.name=s+" Deleted"}}undo(){this.items.forEach((e,o)=>{if(this.itemOwners[o].insertChild(e,this.itemIndices[o],!1,!1),e instanceof I){e.reattach()}else subTreeItem instanceof t&&e.traverse(e=>{if(e instanceof I){e.reattach()}},!1)}),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1)}redo(){this.selectionManager&&this.selectionManager.setSelection(this.newSelection,!1),this.items.forEach((e,o)=>{if(this.itemOwners[o].removeChild(this.itemIndices[o]),e instanceof I){e.detach()}else subTreeItem instanceof t&&e.traverse(e=>{if(e instanceof I){e.detach()}},!1)})}toJSON(e){const t={name:this.name,items:[],itemPaths:this.itemPaths,itemIndices:this.itemIndices};return this.items.forEach(e=>{t.items.push(e.toJSON())}),t}fromJSON(e,t){this.name=e.name,e.itemPaths.forEach(e=>{const o=t.scene.getRoot().resolvePath(e,1);if(!o)return void console.warn("resolvePath is unable to resolve",e);const s=o.getOwner();this.itemOwners.push(s),this.itemPaths.push(o.getPath()),this.itemIndices.push(s.getChildIndex(o))})}destroy(){this.items.forEach(e=>e.removeRef(this))}}A.registerChange("TreeItemsRemoveChange",te);class oe extends G{constructor(e,t){e?(console.log("TreeItemMoveChange"),super(e.getName()+" Added"),this.treeItem=e,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner=t,this.newOwner.addChild(this.treeItem,!0)):super()}undo(){this.oldOwner.insertChild(this.treeItem,this.oldOwnerIndex,!0)}redo(){this.newOwner.addChild(this.treeItem,!0)}toJSON(e){return{name:this.name,treeItemPath:this.treeItem.getPath(),newOwnerPath:this.newOwner.getPath()}}fromJSON(e,t){const o=appData.scene.getRoot().resolvePath(e.treeItemPath,1);if(!o)return void console.warn("resolvePath is unable to resolve",e.treeItemPath);const s=appData.scene.getRoot().resolvePath(e.newOwnerPath,1);s?(this.name=e.name,this.treeItem=o,this.newOwner=s,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner.addChild(this.treeItem,!0)):console.warn("resolvePath is unable to resolve",e.newOwnerPath)}}A.registerChange("TreeItemMoveChange",oe);class se{constructor(t){this.__toolStack=[],this.appData=t,this.movePointer=new e,this.hilightPointer=new e,this.unhilightPointer=new e,this.hidePointer=new e,this.avatarPointerVisible=!1,this.avatarPointerHighlighted=!1}insertTool(e,t){this.__toolStack.splice(t,0,e),e.install(t)}insertToolBefore(e,t){const o=this.__toolStack.indexOf(t)+1;return this.__toolStack.splice(o-1,0,e),e.install(o),o}insertToolAfter(e,t){const o=this.__toolStack.indexOf(t)+1;return this.__toolStack.splice(o,0,e),e.install(o),o==this.__toolStack.length&&e.activateTool(),o}getToolIndex(e){return this.__toolStack.indexOf(e)}removeTool(e){const t=this.__toolStack[e];if(this.__toolStack.splice(e,1),t.uninstall(),e==this.__toolStack.length){t.deactivateTool();const e=this.currTool();e?e.activateTool():this.appData.renderer.getDiv().style.cursor="pointer"}}removeToolByHandle(e){this.removeTool(this.getToolIndex(e))}pushTool(e){const t=this.currTool();if(t){if(e==t)return void console.warn("Tool Already Pushed on the stack:",e.constructor.name);t.deactivateTool()}return this.__toolStack.push(e),e.install(this.__toolStack.length-1),e.activateTool(),console.log("ToolManager.pushTool:",e.constructor.name),this.__toolStack.length-1}__removeCurrTool(){if(this.__toolStack.length>0){const e=this.__toolStack.pop();e.deactivateTool(),e.uninstall()}}popTool(){this.__removeCurrTool();const e=this.currTool();e&&e.activateTool()}replaceCurrentTool(e){this.__removeCurrTool(),this.__toolStack.push(e),e.install(this.__toolStack.length-1),e.activateTool()}currTool(){return this.__toolStack[this.__toolStack.length-1]}currToolName(){return this.__toolStack[this.__toolStack.length-1].getName()}bind(e){const t=e.getViewport();this.mouseDownId=t.mouseDown.connect(this.onMouseDown.bind(this)),this.mouseMoveId=t.mouseMove.connect(this.onMouseMove.bind(this)),this.mouseUpId=t.mouseUp.connect(this.onMouseUp.bind(this)),this.mouseLeaveId=t.mouseLeave.connect(this.onMouseLeave.bind(this)),this.mouseDoubleClickedId=t.mouseDoubleClicked.connect(this.onDoubleClick.bind(this)),this.mouseWheelId=t.mouseWheel.connect(this.onWheel.bind(this)),this.keyDownId=t.keyDown.connect(this.onKeyDown.bind(this)),this.keyUpId=t.keyUp.connect(this.onKeyUp.bind(this)),this.keyPressedId=t.keyPressed.connect(this.onKeyPressed.bind(this)),this.touchStartId=t.touchStart.connect(this.onTouchStart.bind(this)),this.touchMoveId=t.touchMove.connect(this.onTouchMove.bind(this)),this.touchEndId=t.touchEnd.connect(this.onTouchEnd.bind(this)),this.touchCancelId=t.touchCancel.connect(this.onTouchCancel.bind(this)),this.doubleTappedId=t.doubleTapped.connect(this.onDoubleTap.bind(this)),this.appData.renderer.getXRViewport().then(e=>{this.controllerDownId=e.controllerButtonDown.connect(this.onVRControllerButtonDown.bind(this)),this.controllerUpId=e.controllerButtonUp.connect(this.onVRControllerButtonUp.bind(this)),this.controllerDoubleClickId=e.controllerDoubleClicked.connect(this.onVRControllerDoubleClicked.bind(this)),this.onVRPoseChangedId=e.viewChanged.connect(this.onVRPoseChanged.bind(this))})}onMouseDown(e){e.undoRedoManager=this.appData.undoRedoManager,e.showPointerOnAvatar=!0;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onMouseDown(e))break}1==e.showPointerOnAvatar?(this.avatarPointerVisible||(this.movePointer.emit(e),this.avatarPointerVisible=!0),this.avatarPointerHighlighted||(this.hilightPointer.emit(e),this.avatarPointerHighlighted=!0)):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.hidePointer.emit())}onMouseMove(e){e.undoRedoManager=this.appData.undoRedoManager,e.showPointerOnAvatar=!0;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onMouseMove(e))break}1==e.showPointerOnAvatar?(this.movePointer.emit(e),this.avatarPointerVisible=!0):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.hidePointer.emit())}onMouseUp(e){e.undoRedoManager=this.appData.undoRedoManager,e.showPointerOnAvatar=!0;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onMouseUp(e))break}1==e.showPointerOnAvatar?this.avatarPointerHighlighted&&(this.unhilightPointer.emit(e),this.avatarPointerHighlighted=!1):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.hidePointer.emit())}onMouseLeave(e){let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&o.onMouseLeave&&1==o.onMouseLeave(e))break}this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.hidePointer.emit())}onDoubleClick(e){let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onDoubleClick(e))break}}onWheel(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onWheel(e))break}}onKeyPressed(e,t){t.undoRedoManager=this.appData.undoRedoManager;let o=this.__toolStack.length;for(;o--;){const e=this.__toolStack[o];if(e&&1==e.onKeyPressed(t,t,viewport))break}}onKeyDown(e,t){t.undoRedoManager=this.appData.undoRedoManager;let o=this.__toolStack.length;for(;o--;){const s=this.__toolStack[o];if(s&&1==s.onKeyDown(e,t))break}}onKeyUp(e,t){t.undoRedoManager=this.appData.undoRedoManager;let o=this.__toolStack.length;for(;o--;){const s=this.__toolStack[o];if(s&&1==s.onKeyUp(e,t))break}}onTouchStart(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onTouchStart(e))break}}onTouchMove(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onTouchMove(e))break}}onTouchEnd(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onTouchEnd(e))break}}onTouchCancel(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onTouchCancel(e))break}}onDoubleTap(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onDoubleTap(e))break}}__prepareEvent(e){e.undoRedoManager=this.appData.undoRedoManager,e.propagating=!0,e.stopPropagation=()=>{e.propagating=!1}}onVRControllerButtonDown(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onVRControllerButtonDown(e))break;if(!e.propagating)break}}onVRControllerButtonUp(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onVRControllerButtonUp(e))break;if(!e.propagating)break}}onVRControllerDoubleClicked(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onVRControllerDoubleClicked(e))break;if(!e.propagating)break}}onVRPoseChanged(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const o=this.__toolStack[t];if(o&&1==o.onVRPoseChanged(e))break;if(!e.propagating)break}}destroy(){const e=this.appData.renderer.getViewport();e.mouseDown.disconnectId(this.mouseDownId),e.mouseMove.disconnectId(this.mouseMoveId),e.mouseUp.disconnectId(this.mouseUpId),e.mouseLeave.disconnectId(this.mouseUpId),e.mouseWheel.disconnectId(this.mouseWheelId),e.keyDown.disconnectId(this.keyDownId),e.keyUp.disconnectId(this.keyUpId),e.keyPressed.disconnectId(this.keyPressedId),e.touchStart.disconnectId(this.touchStartId),e.touchMove.disconnectId(this.touchMoveId),e.touchEnd.disconnectId(this.touchEndId),e.touchCancel.disconnectId(this.touchCancelId),this.appData.renderer.getXRViewport().then(t=>{e.controllerDown.disconnectId(this.controllerDownId),e.controllerUp.disconnectId(this.controllerUpId),e.viewChanged.disconnectId(this.onVRPoseChangedId)})}}class ie extends C{constructor(t){super(),t||console.error("App data not provided to tool"),this.appData=t,this.installChanged=new e,this.activatedChanged=new e,this.actionFinished=new e,this.__params=[],this.__installed=!1,this.__activated=!1}getName(){return this.constructor.name}isPrimaryTool(){return!1}installed(){return this.__installed}install(e){if(this.__installed)throw new Error("Tool already installed");this.index=e,this.__installed=!0,this.installChanged.emit(!0)}uninstall(){this.__installed=!1,this.installChanged.emit(!1)}activateTool(){if(this.__activated)throw new Error("Tool already activate");this.__activated=!0,this.activatedChanged.emit(!0)}deactivateTool(){this.__activated=!1,this.activatedChanged.emit(!1)}onMouseDown(e){}onMouseMove(e){}onMouseUp(e){}onDoubleClick(e){}onWheel(e){}onKeyPressed(e,t){}onKeyDown(e,t){}onKeyUp(e,t){}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onTouchCancel(e){}onDoubleTap(e){}onVRControllerButtonDown(e){}onVRControllerButtonUp(e){}onVRControllerDoubleClicked(e){}onVRPoseChanged(e){}}const ne={VIEWER:0,DCC:1};class ae extends ie{constructor(t,o=ne.VIEWER){super(t),console.log("ViewTool:",o),this.__maipulationModel=o,this.__defaultMode="orbit",this.__mode=this.__defaultMode,this.__mouseDragDelta=new P,this.__keyboardMovement=!1,this.__keysPressed=[],this.__maxVel=.002,this.__velocity=new g,this.__ongoingTouches={},this.__orbitRateParam=this.addParameter(new u("orbitRate",1)),this.__dollySpeedParam=this.addParameter(new u("dollySpeed",.02)),this.__mouseWheelDollySpeedParam=this.addParameter(new u("mouseWheelDollySpeed",.002)),this.__controllerTriggersHeld=[],this.movementFinished=new e}activateTool(){super.activateTool(),console.log("activateTool.ViewTool"),this.appData.renderer.getDiv().style.cursor="default",this.appData.renderer.getXRViewport().then(e=>{this.vrControllerToolTip||(this.vrControllerToolTip=new f(.015),this.vrControllerToolTipMat=new r("Cross","FlatSurfaceShader"),this.vrControllerToolTipMat.getParameter("BaseColor").setValue(new n("#03E3AC")),this.vrControllerToolTipMat.visibleInGeomDataBuffer=!1);const t=e=>{const t=new c("HandleToolTip",this.vrControllerToolTip,this.vrControllerToolTipMat);e.getTipItem().removeAllChildren(),e.getTipItem().addChild(t,!1)};for(const o of e.getControllers())t(o);this.addIconToControllerId=e.controllerAdded.connect(t)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(e=>{e.controllerAdded.disconnectId(this.addIconToControllerId)})}setDefaultMode(e){this.__defaultMode=e}look(e,t){const o=t.getCamera().getFocalDistance(),s=this.__orbitRateParam.getValue()*b.isMobileDevice?-1:1;if(this.__keyboardMovement){const e=t.getCamera().getGlobalXfo();this.__mouseDownCameraXfo=e.clone(),this.__mouseDownZaxis=e.ori.getZaxis();const s=this.__mouseDownZaxis.scale(-o);this.__mouseDownCameraTarget=e.tr.add(s)}const i=this.__mouseDownCameraXfo.clone(),n=new T;n.rotateZ(e.x/t.getWidth()*Math.PI*s),i.ori=n.multiply(i.ori);const a=new T;a.rotateX(e.y/t.getHeight()*Math.PI*s),i.ori.multiplyInPlace(a),this.__keyboardMovement,t.getCamera().setGlobalXfo(i)}orbit(e,t){const o=t.getCamera().getFocalDistance(),s=this.__orbitRateParam.getValue()*b.isMobileDevice?-1:1;if(this.__keyboardMovement){const e=t.getCamera().getGlobalXfo();this.__mouseDownCameraXfo=e.clone(),this.__mouseDownZaxis=e.ori.getZaxis();const s=this.__mouseDownZaxis.scale(-o);this.__mouseDownCameraTarget=e.tr.add(s)}const i=this.__mouseDownCameraXfo.clone(),n=new T;n.rotateZ(e.x/t.getWidth()*2*Math.PI*-s),i.ori=n.multiply(i.ori);const a=new T;a.rotateX(e.y/t.getHeight()*Math.PI*-s),i.ori.multiplyInPlace(a),i.tr=this.__mouseDownCameraTarget.add(i.ori.getZaxis().scale(o)),this.__keyboardMovement,t.getCamera().setGlobalXfo(i)}pan(e,t){const o=t.getCamera().getFocalDistance(),s=t.getCamera().getFov(),i=new g(1,0,0),n=new g(0,1,0),a=2*o*Math.tan(.5*s),r=a*(t.getWidth()/t.getHeight()),h=new d;h.tr=i.scale(-e.x/t.getWidth()*r),h.tr.addInPlace(n.scale(e.y/t.getHeight()*a)),t.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(h))}dolly(e,t){const o=e.x*this.__dollySpeedParam.getValue(),s=new d;s.tr.set(0,0,o),t.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(s))}panAndZoom(e,t,o){const s=o.getCamera().getFocalDistance(),i=o.getCamera().getFov(),n=new g(1,0,0),a=new g(0,1,0),r=2*s*Math.tan(.5*i),h=r*(o.getWidth()/o.getHeight()),l=new d;l.tr=n.scale(-e.x/o.getWidth()*h),l.tr.addInPlace(a.scale(e.y/o.getHeight()*r));const c=t*s;o.getCamera().setFocalDistance(this.__mouseDownFocalDist+c),l.tr.z+=c,o.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(l))}initDrag(e){const t=e.getCamera().getFocalDistance();this.__mouseDragDelta.set(0,0),this.__mouseDownCameraXfo=e.getCamera().getGlobalXfo().clone(),this.__mouseDownZaxis=e.getCamera().getGlobalXfo().ori.getZaxis();const o=this.__mouseDownZaxis.scale(-t);this.__mouseDownCameraTarget=e.getCamera().getGlobalXfo().tr.add(o),this.__mouseDownFocalDist=t}aimFocus(e,t){this.__focusIntervalId&&clearInterval(this.__focusIntervalId);let o=0;const s=()=>{const i=e.getGlobalXfo(),n=e.getFocalDistance(),a=t.subtract(i.tr),r=a.normalizeInPlace(),h=new T,l=new T;{const e=i.ori.getZaxis().clone();e.z=0;const t=a.negate();t.z=0,h.setFrom2Vectors(e,t)}{const e=i.ori.getZaxis().clone(),t=a.negate();e.x=t.x,e.y=t.y,e.normalizeInPlace(),e.cross(t).dot(i.ori.getXaxis())>0?l.rotateX(e.angleTo(t)):l.rotateX(-e.angleTo(t))}const c=i.clone();c.ori=h.multiply(c.ori),c.ori.multiplyInPlace(l);const d=Math.pow(o/20,2),g=i.clone();g.ori=i.ori.lerp(c.ori,d),e.setFocalDistance(n+(r-n)*d),e.setGlobalXfo(g),o++,o<=20?this.__focusIntervalId=setTimeout(s,20):(this.__focusIntervalId=void 0,this.movementFinished.emit())};s(),this.__manipulationState="focussing"}onMouseMove(e){}onDragStart(e){this.__mouseDownPos=e.mousePos,this.initDrag(e.viewport),2==e.button?this.__mode="pan":e.ctrlKey&&2==e.button?this.__mode="dolly":e.shiftKey||2==e.button?this.__mode="look":this.__mode=this.__defaultMode}onDrag(e){switch(this.__keyboardMovement?this.__mouseDragDelta=e.mousePos:this.__mouseDragDelta=e.mousePos.subtract(this.__mouseDownPos),this.__mode){case"orbit":this.orbit(this.__mouseDragDelta,e.viewport);break;case"look":this.look(this.__mouseDragDelta,e.viewport);break;case"pan":this.pan(this.__mouseDragDelta,e.viewport);break;case"dolly":this.dolly(this.__mouseDragDelta,e.viewport)}}onDragEnd(e){return this.movementFinished.emit(),!1}onMouseDown(e){return!(this.__maipulationModel==ne.DCC&&!e.altKey)&&(this.dragging=!0,this.__mouseDownPos=e.mousePos,this.onDragStart(e),!0)}onMouseUp(e){if(this.dragging)return this.onDragEnd(e),this.dragging=!1,!0}onMouseMove(e){if(this.dragging)return this.onDrag(e),e.showPointerOnAvatar=!1,!0}onDoubleClick(e){if(e.intersectionData){const t=e.viewport.getCamera(),o=t.getGlobalXfo().tr.add(e.intersectionData.mouseRay.dir.scale(e.intersectionData.dist));this.aimFocus(t,o)}}onWheel(e){if(this.__maipulationModel==ne.DCC&&!e.altKey)return!1;const t=e.viewport,o=t.getCamera().getGlobalXfo(),s=o.ori.getZaxis();this.__mouseWheelZoomIntervalId&&clearInterval(this.__mouseWheelZoomIntervalId);let i=0;const n=()=>{const a=t.getCamera().getFocalDistance(),r=this.__mouseWheelDollySpeedParam.getValue(),h=e.deltaY*r*a*.2;o.tr.addInPlace(s.scale(h)),"orbit"==this.__defaultMode&&t.getCamera().setFocalDistance(a+h),t.getCamera().setGlobalXfo(o),i++,i<5?this.__mouseWheelZoomIntervalId=setTimeout(n,20):(this.__mouseWheelZoomIntervalId=void 0,this.movementFinished.emit(),e.viewport.renderGeomDataFbo())};n()}__integrateVelocityChange(e,t){const o=new d;o.tr=this.__velocity.normalize().scale(this.__maxVel),t.getCamera().setGlobalXfo(t.getCamera().getGlobalXfo().multiply(o))}onKeyPressed(e,t){return!1}onKeyDown(e,t){}onKeyUp(e,t){return!0}__startTouch(e,t){this.__ongoingTouches[e.identifier]={identifier:e.identifier,pos:new P(e.pageX,e.pageY)}}__endTouch(e,t){delete this.__ongoingTouches[e.identifier]}onTouchStart(e){e.preventDefault(),e.stopPropagation(),0==Object.keys(this.__ongoingTouches).length&&(this.__manipMode=void 0);const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__startTouch(t[e]);return this.initDrag(e.viewport),!0}onTouchMove(e){e.preventDefault(),e.stopPropagation();const t=e.changedTouches;if(1==t.length&&"panAndZoom"!=this.__manipMode){const o=t[0],s=new P(o.pageX,o.pageY),i=this.__ongoingTouches[o.identifier].pos.subtract(s);return"look"==this.__defaultMode?(i.scaleInPlace(6),this.look(i,e.viewport)):this.orbit(i,e.viewport),this.__manipMode="orbit",!0}if(2==t.length){const o=t[0],s=this.__ongoingTouches[o.identifier],i=t[1],n=this.__ongoingTouches[i.identifier],a=new P(o.pageX,o.pageY),r=new P(i.pageX,i.pageY),h=n.pos.subtract(s.pos).length()-r.subtract(a).length(),l=a.subtract(s.pos),c=r.subtract(n.pos),d=l.add(c);return d.scaleInPlace(.5),this.panAndZoom(d,.002*h,e.viewport),this.__manipMode="panAndZoom",!0}}onTouchEnd(e){e.preventDefault(),e.stopPropagation();const t=e.changedTouches;switch(this.__manipMode){case"orbit":case"panAndZoom":this.movementFinished.emit()}for(let e=0;e<t.length;e++)this.__endTouch(t[e]);return 0==Object.keys(this.__ongoingTouches).length&&(this.__manipMode=void 0),!0}onTouchCancel(e){console.log("touchcancel.");const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__endTouch(t[e]);return!0}onDoubleTap(e){const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__startTouch(t[e]);if(e.intersectionData){const t=e.viewport.getCamera(),o=t.getGlobalXfo().tr.add(e.intersectionData.mouseRay.dir.scale(e.intersectionData.dist));this.aimFocus(t,o)}}__initMoveStage(e){if(1==this.__controllerTriggersHeld.length)this.__grabPos=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr.clone(),this.stageXfo__GrabStart=e.getXfo().clone(),this.__invOri=this.stageXfo__GrabStart.ori.inverse();else if(2==this.__controllerTriggersHeld.length){const t=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,o=this.__controllerTriggersHeld[1].getControllerTipStageLocalXfo().tr;this.__grabDir=o.subtract(t),this.__grabPos=t.lerp(o,.5),this.__grabDir.y=0,this.__grabDist=this.__grabDir.length(),this.__grabDir.scaleInPlace(1/this.__grabDist),this.stageXfo__GrabStart=e.getXfo().clone(),this.__grab_to_stage=this.__grabPos.subtract(this.stageXfo__GrabStart.tr)}}onVRControllerButtonDown(e){if(1==e.button)return this.__controllerTriggersHeld.push(e.controller),this.__initMoveStage(e.vrviewport),!0}onVRControllerButtonUp(e){if(1!=e.button)return;const t=this.__controllerTriggersHeld.indexOf(e.controller);return this.__controllerTriggersHeld.splice(t,1),this.__initMoveStage(e.vrviewport),!0}onVRControllerDoubleClicked(e){console.log("onVRControllerDoubleClicked:",this.__controllerTriggersHeld.length);const t=e.vrviewport.getXfo().clone();t.sc.set(1,1,1),e.vrviewport.setXfo(t)}onVRPoseChanged(e){if(1==this.__controllerTriggersHeld.length){const t=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,o=new d;o.tr=this.__grabPos.subtract(t);const s=this.stageXfo__GrabStart.multiply(o);return e.vrviewport.setXfo(s),!0}if(2==this.__controllerTriggersHeld.length){const t=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,o=this.__controllerTriggersHeld[1].getControllerTipStageLocalXfo().tr,s=t.lerp(o,.5),i=o.subtract(t);i.y=0;const n=i.length();i.scaleInPlace(1/n);const a=new d,r=Math.max(Math.min(this.__grabDist/n,10),.1);a.sc.set(r,r,r);let h=this.__grabDir.angleTo(i);this.__grabDir.cross(i).y>0&&(h=-h),a.ori.rotateY(h);const l=a.ori.rotateVec3(this.__grabPos);a.tr.addInPlace(this.__grabPos.subtract(l));const c=this.__grabPos.scale(1-r);a.tr.addInPlace(a.ori.rotateVec3(c));const g=this.__grabPos.subtract(s).scale(r);a.tr.addInPlace(a.ori.rotateVec3(g));const u=this.stageXfo__GrabStart.multiply(a);return e.vrviewport.setXfo(u),!0}}}class re extends ie{constructor(e){super(e),this.dragging=!1,this.selectionRect=new D(1,1),this.selectionRectMat=new r("marker","ScreenSpaceShader"),this.selectionRectMat.getParameter("BaseColor").setValue(new n("#03E3AC")),this.selectionRectXfo=new d,this.selectionRectXfo.tr.set(.5,.5,0),this.selectionRectXfo.sc.set(0,0,0)}activateTool(){super.activateTool(),this.rectItem||(this.rectItem=new c("selectionRect",this.selectionRect,this.selectionRectMat),this.rectItem.getParameter("Visible").setValue(!1),this.appData.renderer.addTreeItem(this.rectItem))}deactivateTool(){super.deactivateTool(),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.setGlobalXfo(this.selectionRectXfo)}onMouseDown(e){return 0==e.button&&!e.altKey&&(console.log("onMouseDown"),this.mouseDownPos=e.mousePos,this.dragging=!1,!0)}__resizeRect(e,t){const o=new P(1/e.getWidth()*2,1/e.getHeight()*2),s=t.multiply(o);this.selectionRectXfo.sc.set(Math.abs(s.x),Math.abs(s.y),1);const i=this.mouseDownPos.subtract(t.scale(.5)).multiply(o).subtract(new P(1,1));this.selectionRectXfo.tr.x=i.x,this.selectionRectXfo.tr.y=-i.y,this.rectItem.setGlobalXfo(this.selectionRectXfo)}onMouseMove(e){if(this.mouseDownPos){const t=this.mouseDownPos.subtract(e.mousePos);this.dragging&&this.__resizeRect(e.viewport,t),t.length()>4&&(this.dragging=!0,this.rectItem.getParameter("Visible").setValue(!0),this.__resizeRect(e.viewport,t))}return!0}onMouseUp(e){if(this.mouseDownPos){if(this.dragging){this.rectItem.getParameter("Visible").setValue(!1);const t=e.mousePos,o=new P(Math.min(this.mouseDownPos.x,t.x),Math.min(this.mouseDownPos.y,t.y)),s=new P(Math.max(this.mouseDownPos.x,t.x),Math.max(this.mouseDownPos.y,t.y)),i=e.viewport.getGeomItemsInRect(o,s);if(this.appData.selectionManager.pickingModeActive())this.appData.selectionManager.pick(i);else{const t=new Set([...i].filter(e=>!(e.getOwner()instanceof L)));e.shiftKey?this.appData.selectionManager.deselectItems(t):this.appData.selectionManager.selectItems(t,!e.ctrlKey),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.setGlobalXfo(this.selectionRectXfo)}}else{const t=e.viewport.getGeomDataAtPos(e.mousePos);if(null==t||t.geomItem.getOwner()instanceof L)this.appData.selectionManager.clearSelection();else if(this.appData.selectionManager.pickingModeActive())this.appData.selectionManager.pick(t.geomItem);else if(e.shiftKey){const e=new Set;e.add(t.geomItem),this.appData.selectionManager.deselectItems(e)}else this.appData.selectionManager.toggleItemSelection(t.geomItem,!e.ctrlKey)}return this.mouseDownPos=void 0,!0}}onVRControllerButtonDown(e){if(1==e.button){const t=e.controller.getGeomItemAtTip();if(null!=t&&!(t.geomItem.getOwner()instanceof L))return this.appData.selectionManager.toggleItemSelection(t.geomItem),!0}}}A.registerChange("SelectionTool",re);class he extends ie{constructor(e,t){super(e),this.vrUITool=t,this.uiToolIndex=-1,this.__stayClosed=!1}uninstall(){super.uninstall(),this.uiToolIndex>0&&this.appData.toolManager.removeToolByHandle(this.vrUITool)}onVRControllerButtonDown(e){}onVRControllerButtonUp(e){}stayClosed(){this.__stayClosed=!0}onVRPoseChanged(e){if(this.vrUITool.installed())return;const t=e.viewXfo,o=(e,o)=>{if(!e)return!1;const s=e.getTreeItem().getGlobalXfo(),i=s.tr.subtract(t.tr);return i.normalizeInPlace(),i.angleTo(s.ori.getYaxis())<.25*Math.PI?(this.__stayClosed||(this.vrUITool.setUIControllers(this,e,o,t),this.uiToolIndex=this.appData.toolManager.pushTool(this.vrUITool)),!0):void 0};if(e.controllers.length>0){if(o(e.controllers[0],e.controllers[1]))return!0;if(o(e.controllers[1],e.controllers[0]))return!0}this.uiToolIndex=-1,this.__stayClosed=!1}}const le=function(){return{escape:function(e){return e.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")},parseExtension:e,mimeType:function(t){const o=e(t).toLowerCase();return function(){const e="application/font-woff";return{woff:e,woff2:e,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}()[o]||""},dataAsUrl:function(e,t){return"data:"+t+";base64,"+e},isDataUrl:function(e){return-1!==e.search(/^(data:)/)},canvasToBlob:function(e){return e.toBlob?new Promise((function(t){e.toBlob(t)})):function(e){return new Promise((function(t){const o=window.atob(e.toDataURL().split(",")[1]),s=o.length,i=new Uint8Array(s);for(let e=0;e<s;e++)i[e]=o.charCodeAt(e);t(new Blob([i],{type:"image/png"}))}))}(e)},resolveUrl:function(e,t){const o=document.implementation.createHTMLDocument(),s=o.createElement("base");o.head.appendChild(s);const i=o.createElement("a");return o.body.appendChild(i),s.href=t,i.href=e,i.href},getAndEncode:function(e){me.impl.options.cacheBust&&(e+=(/\?/.test(e)?"&":"?")+(new Date).getTime());return new Promise((function(t){const o=new XMLHttpRequest;let s;if(o.onreadystatechange=function(){if(4!==o.readyState)return;if(200!==o.status)return void(s?t(s):i("cannot fetch resource: "+e+", status: "+o.status));const n=new FileReader;n.onloadend=function(){const e=n.result.split(/,/)[1];t(e)},n.readAsDataURL(o.response)},o.ontimeout=function(){s?t(s):i("timeout of 30000ms occured while fetching resource: "+e)},o.responseType="blob",o.timeout=3e4,o.open("GET",e,!0),o.send(),me.impl.options.imagePlaceholder){const e=me.impl.options.imagePlaceholder.split(/,/);e&&e[1]&&(s=e[1])}function i(e){console.error(e),t("")}}))},uid:function(){let e=0;return function(){return"u"+("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)+e++}}(),delay:function(e){return function(t){return new Promise((function(o){setTimeout((function(){o(t)}),e)}))}},asArray:function(e){const t=[],o=e.length;for(let s=0;s<o;s++)t.push(e[s]);return t},escapeXhtml:function(e){return e.replace(/#/g,"%23").replace(/\n/g,"%0A")},makeImage:function(e){return new Promise((function(t,o){const s=new Image;s.onload=function(){t(s)},s.onerror=o,s.src=e}))},width:function(e){const o=t(e,"border-left-width"),s=t(e,"border-right-width");return e.scrollWidth+o+s},height:function(e){const o=t(e,"border-top-width"),s=t(e,"border-bottom-width");return e.scrollHeight+o+s}};function e(e){const t=/\.([^\.\/]*?)$/g.exec(e);return t?t[1]:""}function t(e,t){const o=window.getComputedStyle(e).getPropertyValue(t);return parseFloat(o.replace("px",""))}}(),ce=function(){const e=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:function(e,i,n){return function(){return!t(e)}()?Promise.resolve(e):Promise.resolve(e).then(o).then((function(t){let o=Promise.resolve(e);return t.forEach((function(e){o=o.then((function(t){return s(t,e,i,n)}))})),o}))},shouldProcess:t,impl:{readUrls:o,inline:s}};function t(t){return-1!==t.search(e)}function o(t){const o=[];let s;for(;null!==(s=e.exec(t));)o.push(s[1]);return o.filter((function(e){return!le.isDataUrl(e)}))}function s(e,t,o,s){return Promise.resolve(t).then((function(e){return o?le.resolveUrl(e,o):e})).then(s||le.getAndEncode).then((function(e){return le.dataAsUrl(e,le.mimeType(t))})).then((function(o){return e.replace(function(e){return new RegExp("(url\\(['\"]?)("+le.escape(e)+")(['\"]?\\))","g")}(t),"$1"+o+"$3")}))}}(),de=function(){return{resolveAll:function(){return e().then((function(e){return Promise.all(e.map((function(e){return e.resolve()})))})).then((function(e){return e.join("\n")}))},impl:{readAll:e}};function e(){return Promise.resolve(le.asArray(document.styleSheets)).then((function(e){const t=[];return e.forEach((function(e){try{le.asArray(e.cssRules||[]).forEach(t.push.bind(t))}catch(t){console.log("Error while reading CSS rules from "+e.href,t.toString())}})),t})).then((function(e){return e.filter((function(e){return e.type===CSSRule.FONT_FACE_RULE})).filter((function(e){return ce.shouldProcess(e.style.getPropertyValue("src"))}))})).then((function(t){return t.map(e)}));function e(e){return{resolve:function(){const t=(e.parentStyleSheet||{}).href;return ce.inlineAll(e.cssText,t)},src:function(){return e.style.getPropertyValue("src")}}}}}(),ge=function(){return{inlineAll:function t(o){return o instanceof Element?function(e){const t=e.style.getPropertyValue("background");return t?ce.inlineAll(t).then((function(t){e.style.setProperty("background",t,e.style.getPropertyPriority("background"))})).then((function(){return e})):Promise.resolve(e)}(o).then((function(){return o instanceof HTMLImageElement?e(o).inline():Promise.all(le.asArray(o.childNodes).map((function(e){return t(e)})))})):Promise.resolve(o)},impl:{newImage:e}};function e(e){return{inline:function(t){return le.isDataUrl(e.src)?Promise.resolve():Promise.resolve(e.src).then(t||le.getAndEncode).then((function(t){return le.dataAsUrl(t,le.mimeType(e.src))})).then((function(t){return new Promise((function(o,s){e.onload=o,e.onerror=s,e.src=t}))}))}}}}(),ue={imagePlaceholder:void 0,cacheBust:!1},me={toSvg:pe,toPng:function(e,t){return fe(e,t||{}).then((function(e){return e.toDataURL()}))},toJpeg:function(e,t){return fe(e,t=t||{}).then((function(e){return e.toDataURL("image/jpeg",t.quality||1)}))},toBlob:function(e,t){return fe(e,t||{}).then(le.canvasToBlob)},toPixelData:function(e,t){return fe(e,t||{}).then((function(t){return t.getContext("2d").getImageData(0,0,le.width(e),le.height(e)).data}))},toCanvas:function(e,t){return fe(e,t||{}).then((function(e){return e}))},impl:{fontFaces:de,images:ge,util:le,inliner:ce,options:{}}};function pe(e,t){return function(e){void 0===e.imagePlaceholder?me.impl.options.imagePlaceholder=ue.imagePlaceholder:me.impl.options.imagePlaceholder=e.imagePlaceholder;void 0===e.cacheBust?me.impl.options.cacheBust=ue.cacheBust:me.impl.options.cacheBust=e.cacheBust}(t=t||{}),Promise.resolve(e).then((function(e){return function e(t,o,s){return s||!o||o(t)?Promise.resolve(t).then((function(e){return e instanceof HTMLCanvasElement?le.makeImage(e.toDataURL()):e.cloneNode(!1)})).then((function(e){return i(t,e,o)})).then((function(e){return function(e,t){return t instanceof Element?Promise.resolve().then(o).then(s).then(i).then(n).then((function(){return t})):t;function o(){var o,s;o=window.getComputedStyle(e),s=t.style,o.cssText?s.cssText=o.cssText:function(e,t){le.asArray(e).forEach((function(o){t.setProperty(o,e.getPropertyValue(o),e.getPropertyPriority(o))}))}(o,s)}function s(){[":before",":after"].forEach((function(o){!function(o){const s=window.getComputedStyle(e,o),i=s.getPropertyValue("content");if(""===i||"none"===i)return;const n=le.uid();t.className=t.className+" "+n;const a=document.createElement("style");a.appendChild(function(e,t,o){const s="."+e+":"+t,i=o.cssText?function(e){const t=e.getPropertyValue("content");return e.cssText+" content: "+t+";"}(o):function(e){return le.asArray(e).map((function(t){return t+": "+e.getPropertyValue(t)+(e.getPropertyPriority(t)?" !important":"")})).join("; ")+";"}(o);return document.createTextNode(s+"{"+i+"}")}(n,o,s)),t.appendChild(a)}(o)}))}function i(){e instanceof HTMLTextAreaElement&&(t.innerHTML=e.value),e instanceof HTMLInputElement&&t.setAttribute("value",e.value)}function n(){t instanceof SVGElement&&(t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t instanceof SVGRectElement&&["width","height"].forEach((function(e){const o=t.getAttribute(e);o&&t.style.setProperty(e,o)})))}}(t,e)})):Promise.resolve();function i(t,o,s){const i=t.childNodes;return 0===i.length?Promise.resolve(o):n(o,le.asArray(i),s).then((function(){return o}));function n(t,o,s){let i=Promise.resolve();return o.forEach((function(o){i=i.then((function(){return e(o,s)})).then((function(e){e&&t.appendChild(e)}))})),i}}}(e,t.filter,!0)})).then(_e).then(we).then((function(e){t.bgcolor&&(e.style.backgroundColor=t.bgcolor);t.width&&(e.style.width=t.width+"px");t.height&&(e.style.height=t.height+"px");t.style&&Object.keys(t.style).forEach((function(o){e.style[o]=t.style[o]}));return e})).then((function(o){return function(e,t,o){return Promise.resolve(e).then((function(e){return e.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),(new XMLSerializer).serializeToString(e)})).then(le.escapeXhtml).then((function(e){return'<foreignObject x="0" y="0" width="100%" height="100%">'+e+"</foreignObject>"})).then((function(e){return'<svg xmlns="http://www.w3.org/2000/svg" width="'+t+'" height="'+o+'">'+e+"</svg>"})).then((function(e){return"data:image/svg+xml;charset=utf-8,"+e}))}(o,t.width||le.width(e),t.height||le.height(e))}))}function fe(e,t){return pe(e,t).then(le.makeImage).then(le.delay(100)).then((function(o){const s=function(e){const o=document.createElement("canvas");if(o.width=t.width||le.width(e),o.height=t.height||le.height(e),t.bgcolor){const e=o.getContext("2d");e.fillStyle=t.bgcolor,e.fillRect(0,0,o.width,o.height)}return o}(e);return s.getContext("2d").drawImage(o,0,0),s}))}function _e(e){return de.resolveAll().then((function(t){const o=document.createElement("style");return e.appendChild(o),o.appendChild(document.createTextNode(t)),e}))}function we(e){return ge.inlineAll(e).then((function(){return e}))}class Ie extends c{constructor(e,t,o){const s=new r("uimat","FlatSurfaceShader");let i;s.visibleInGeomDataBuffer=!1,super("VRControllerUI",new S(1,1),s),this.appData=e,this.__vrUIDOMHolderElement=t,this.__vrUIDOMElement=o,this.__uiimage=new M,s.getParameter("BaseColor").setValue(this.__uiimage),this.__uiGeomOffsetXfo=new d,this.__uiGeomOffsetXfo.sc.set(0,0,1),this.__rect={width:0,height:0},this.__uiGeomOffsetXfo.ori.setFromAxisAndAngle(new g(0,1,0),Math.PI),this.setGeomOffsetXfo(this.__uiGeomOffsetXfo);let n=[];const a=()=>{i=null;const e=n.map(e=>this.updateElemInAtlas(e));Promise.all(e).then(()=>{this.updateUIImage(),n=[]})};this.__mutationObserver=new MutationObserver(e=>{this.mainCtx?(e.some(e=>{let t=e.target;for(;t.parentNode;){if(t==this.__vrUIDOMElement)return this.renderUIToImage(),n=[],!1;if(t.classList.contains("VRUIElement")||t==this.__vrUIDOMElement){-1==n.indexOf(t)&&n.push(t);break}t=t.parentNode}return!0}),i&&clearTimeout(i),i=setTimeout(a,50)):this.renderUIToImage()}),this.__active=!1,this.__renderRequested=!1}activate(){this.__vrUIDOMHolderElement.style.display="block",this.__active=!0,this.__mutationObserver.observe(this.__vrUIDOMElement,{attributes:!0,characterData:!0,childList:!0,subtree:!0}),this.renderUIToImage()}deactivate(){this.__vrUIDOMHolderElement.style.display="none",this.__active=!0,this.__mutationObserver.disconnect()}updateElemInAtlas(e){return new Promise((t,o)=>{me.toCanvas(e).then(o=>{const s=e.getBoundingClientRect();s.width*s.height!=0?(this.mainCtx.fillRect(s.x,s.y,s.width,s.height),this.mainCtx.drawImage(o,s.x,s.y),t()):t()})})}updateUIImage(){const e=this.mainCtx.getImageData(0,0,this.__rect.width,this.__rect.height);this.__uiimage.setData(this.__rect.width,this.__rect.height,new Uint8Array(e.data.buffer))}renderUIToImage(){me.toCanvas(this.__vrUIDOMElement).then(e=>{this.mainCtx=e.getContext("2d"),this.mainCtx.fillStyle="#FFFFFF";const t=this.__vrUIDOMElement.getBoundingClientRect();if(t.width*t.height!=0){if(t.width!=this.__rect.width||t.height!=this.__rect.height){this.__rect=t;const e=7e-4;this.__uiGeomOffsetXfo.sc.set(this.__rect.width*e,this.__rect.height*e,1),this.setGeomOffsetXfo(this.__uiGeomOffsetXfo),this.appData.session.pub("pose-message",{interfaceType:"VR",updateUIPanel:{size:this.__uiGeomOffsetXfo.sc.toJSON()}})}this.updateUIImage()}})}sendMouseEvent(e,t,o){const s=new MouseEvent(e,Object.assign({target:o,view:window,bubbles:!0,cancelable:!0},t));return o.dispatchEvent(s),s}}class ve extends ie{constructor(e){super(e),this.__vrUIDOMHolderElement=document.createElement("div"),this.__vrUIDOMHolderElement.className="vrUIHolder",this.__vrUIDOMElement=document.createElement("div"),this.__vrUIDOMElement.className="vrUI",document.body.appendChild(this.__vrUIDOMHolderElement),this.controllerUI=new Ie(e,this.__vrUIDOMHolderElement,this.__vrUIDOMElement),this.controllerUI.addRef(this),e.renderer.addTreeItem(this.controllerUI),this.__uiLocalXfo=new d,this.__uiLocalXfo.ori.setFromAxisAndAngle(new g(1,0,0),-.6*Math.PI);const t=new r("pointermat","LinesShader");t.visibleInGeomDataBuffer=!1,t.getParameter("Color").setValue(new n(1.2,0,0));const o=new y;o.setNumVertices(2),o.setNumSegments(1),o.setSegment(0,0,1),o.getVertex(0).set(0,0,0),o.getVertex(1).set(0,0,-1),o.setBoundingBoxDirty(),this.__pointerLocalXfo=new d,this.__pointerLocalXfo.sc.set(1,1,.1),this.__pointerLocalXfo.ori.setFromAxisAndAngle(new g(1,0,0),-.2*Math.PI),this.__uiPointerItem=new c("VRControllerPointer",o,t),this.__uiPointerItem.addRef(this),this.__triggerHeld=!1}getName(){return"VRUITool"}setUIControllers(e,t,o,s){this.openUITool=e,this.uiController=t,this.pointerController=o;const i=this.uiController.getTreeItem().getGlobalXfo();if(this.pointerController){const e=this.pointerController.getTreeItem().getGlobalXfo(),t=i.tr.subtract(s.tr),o=e.tr.subtract(s.tr);t.cross(o).dot(s.ori.getYaxis())>0?this.__uiLocalXfo.tr.set(.05,-.05,.08):this.__uiLocalXfo.tr.set(-.05,-.05,.08)}else this.__uiLocalXfo.tr.set(0,-.05,.08);this.controllerUI.setLocalXfo(this.__uiLocalXfo)}activateTool(){super.activateTool(),this.controllerUI.activate(),this.uiController&&(this.uiController.getTipItem().addChild(this.controllerUI,!1),this.pointerController&&this.pointerController.getTipItem().addChild(this.__uiPointerItem,!1),this.appData.session.pub("pose-message",{interfaceType:"VR",showUIPanel:{controllerId:this.uiController.getId(),localXfo:this.__uiLocalXfo.toJSON(),size:this.controllerUI.getGeomOffsetXfo().sc.toJSON()}}))}deactivateTool(){super.deactivateTool(),this.controllerUI.deactivate(),this.uiController&&(this.uiController.getTipItem().removeChildByHandle(this.controllerUI),this.pointerController&&this.pointerController.getTipItem().removeChildByHandle(this.__uiPointerItem),this.appData.session.pub("pose-message",{interfaceType:"VR",hideUIPanel:{controllerId:this.uiController.getId()}}))}setPointerLength(e){this.__pointerLocalXfo.sc.set(1,1,e),this.__uiPointerItem.setLocalXfo(this.__pointerLocalXfo)}calcUIIntersection(){const e=this.__uiPointerItem.getGlobalXfo(),t=e.ori.getZaxis().negate(),s=new o(e.tr,t),i=this.controllerUI.getGlobalXfo(),n=this.controllerUI.getGeomOffsetXfo().sc,a=new o(i.tr,i.ori.getZaxis().negate()),r=s.intersectRayPlane(a);if(r<=0)return void this.setPointerLength(.5);const h=e.tr.add(t.scale(r)).subtract(a.start),l=h.dot(i.ori.getXaxis())/n.x,c=h.dot(i.ori.getYaxis())/n.y;if(Math.abs(l)>.5||Math.abs(c)>.5)return void this.setPointerLength(.5);this.setPointerLength(r);const d=this.__vrUIDOMElement.getBoundingClientRect();return{clientX:Math.round(l*d.width+d.width/2),clientY:Math.round(c*-d.height+d.height/2)}}sendEventToUI(e,t){const o=this.calcUIIntersection();if(o){o.offsetX=o.pageX=o.pageX=o.screenX=o.clientX,o.offsetY=o.pageY=o.pageY=o.screenY=o.clientY;const s=document.elementFromPoint(o.clientX,o.clientY);return s!=this._element&&(this._element&&this.controllerUI.sendMouseEvent("mouseleave",Object.assign(t,o),this._element),this._element=s,this.controllerUI.sendMouseEvent("mouseenter",Object.assign(t,o),this._element)),this.controllerUI.sendMouseEvent(e,Object.assign(t,o),this._element),this._element}this._element&&(this.controllerUI.sendMouseEvent("mouseleave",Object.assign(t,o),this._element),this._element=null)}onVRControllerButtonDown(e){if(e.controller==this.pointerController){this.__triggerHeld=!0;const t=this.sendEventToUI("mousedown",{button:e.button-1});this.__triggerDownElem=t||null}return!0}onVRControllerButtonUp(e){if(e.controller==this.pointerController){this.__triggerHeld=!1;const t=this.sendEventToUI("mouseup",{button:e.button-1});t&&this.__triggerDownElem==t&&this.sendEventToUI("click",{button:e.button-1}),this.__triggerDownElem=null}return!0}onVRPoseChanged(e){const t=e.viewXfo;return(()=>{const e=this.uiController.getTreeItem().getGlobalXfo(),o=e.tr.subtract(t.tr);return o.normalizeInPlace(),!(o.angleTo(e.ori.getYaxis())>.5*Math.PI)||(this.appData.toolManager.removeToolByHandle(this),!1)})()&&this.sendEventToUI("mousemove",{}),!0}}class Ce extends G{constructor(e){super("HoldObjectsChange"),this.__selection=[],this.__prevXfos=[],this.__newXfos=[],e&&this.update(e)}undo(){for(let e=0;e<this.__selection.length;e++)this.__selection[e]&&this.__selection[e].setGlobalXfo(this.__prevXfos[e])}redo(){for(let e=0;e<this.__selection.length;e++)this.__selection[e]&&this.__selection[e].setGlobalXfo(this.__newXfos[e])}update(e){if(e.newItem)this.__selection[e.newItemId]=e.newItem,this.__prevXfos[e.newItemId]=e.newItem.getGlobalXfo();else if(e.changeXfos)for(let t=0;t<e.changeXfoIds.length;t++){const o=e.changeXfoIds[t];this.__selection[o]&&(this.__selection[o].setGlobalXfo(e.changeXfos[t]),this.__newXfos[o]=e.changeXfos[t])}this.updated.emit(e)}toJSON(e){const t=super.toJSON(e),o=[];for(let e=0;e<this.__selection.length;e++)this.__selection[e]?o[e]=this.__selection[e].getPath():o.push(null);return t.itemPaths=o,t}fromJSON(e,t){super.fromJSON(e,t);const o=t.appData.scene.getRoot(),s=[];for(let t=0;t<e.itemPaths.length;t++){const i=e.itemPaths[t];i&&(s[t]=o.resolvePath(i,1))}this.__selection=s}}A.registerChange("HoldObjectsChange",Ce);class Pe extends ie{constructor(e){super(e),this.__pressedButtonCount=0,this.__freeIndices=[],this.__vrControllers=[],this.__heldObjectCount=0,this.__heldGeomItems=[],this.__heldGeomItemIds=[],this.__heldGeomItemRefs=[],this.__heldGeomItemOffsets=[]}activateTool(){super.activateTool(),console.log("activateTool.VRHoldObjectsTool"),this.appData.renderer.getDiv().style.cursor="crosshair";const e=e=>{if(!this.__activated)return;const t=new V(.03),o=new r("Cross","FlatSurfaceShader");o.getParameter("BaseColor").setValue(new n("#03E3AC")),o.visibleInGeomDataBuffer=!1;const s=new c("HandleToolTip",t,o);e.getTipItem().removeAllChildren(),e.getTipItem().addChild(s,!1)};this.appData.renderer.getXRViewport().then(t=>{for(const o of t.getControllers())e(o);this.addIconToControllerId=t.controllerAdded.connect(e)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(e=>{e.controllerAdded.disconnectId(this.addIconToControllerId)})}computeGrabXfo(e){let t;if(1==e.length)t=this.__vrControllers[e[0]].getTipXfo();else if(2==e.length){const o=this.__vrControllers[e[0]].getTipXfo(),s=this.__vrControllers[e[1]].getTipXfo();o.ori.alignWith(s.ori),t=new d,t.tr=o.tr.lerp(s.tr,.5),t.ori=o.ori.lerp(s.ori,.5);let i=s.tr.subtract(o.tr);i.normalizeInPlace();const n=t.ori.getXaxis();i.dot(n)<0&&(i=i.negate());const a=i.angleTo(n);if(a>0){const e=n.cross(i);e.normalizeInPlace();const o=new T;o.setFromAxisAndAngle(e,a),t.ori=o.multiply(t.ori)}}return t}initAction(){for(let e=0;e<this.__heldGeomItems.length;e++){const t=this.__heldGeomItems[e];if(!t)continue;const o=this.computeGrabXfo(this.__heldGeomItemRefs[e]);this.__heldGeomItemOffsets[e]=o.inverse().multiply(t.getGlobalXfo())}}onVRControllerButtonDown(e){const t=e.controller.getId();this.__vrControllers[t]=e.controller;const o=e.controller.getGeomItemAtTip();if(o){if(o.geomItem.getOwner()instanceof L)return!1;if(e.intersectionData=o,o.geomItem.onMouseDown(e,o),!e.propagating)return!1;let s=this.__heldGeomItems.indexOf(o.geomItem);if(-1==s){s=this.__heldGeomItems.length,this.__heldObjectCount++,this.__heldGeomItems.push(o.geomItem),this.__heldGeomItemRefs[s]=[t],this.__heldGeomItemIds[t]=s;const e={newItem:o.geomItem,newItemId:s};this.change?this.change.update(e):(this.change=new Ce(e),this.appData.undoRedoManager.addChange(this.change))}else this.__heldGeomItemIds[t]=s,this.__heldGeomItemRefs[s].push(t);return this.initAction(),!0}}onVRControllerButtonUp(e){const t=e.controller.getId();if(this.__pressedButtonCount--,void 0!==this.__heldGeomItemIds[t]){const e=this.__heldGeomItemIds[t],o=this.__heldGeomItemRefs[e];return o.splice(o.indexOf(t),1),0==o.length&&(this.__heldObjectCount--,this.__heldGeomItems[e]=void 0,this.change=void 0),this.__heldGeomItemIds[t]=void 0,this.initAction(),!0}}onVRPoseChanged(e){if(!this.change)return!1;const t=[],o=[];for(let e=0;e<this.__heldGeomItems.length;e++){if(!this.__heldGeomItems[e])continue;const s=this.computeGrabXfo(this.__heldGeomItemRefs[e]);t.push(s.multiply(this.__heldGeomItemOffsets[e])),o.push(e)}return this.change.update({changeXfos:t,changeXfoIds:o}),!0}}class be extends ie{constructor(e){super(e)}isPrimaryTool(){return!0}}class Te extends G{constructor(e){super(e)}setParentAndXfo(e,t){this.parentItem=e;const o=this.parentItem.generateUniqueName(this.geomItem.getName());this.geomItem.setName(o),this.geomItem.setGlobalXfo(t),this.childIndex=this.parentItem.addChild(this.geomItem,!0),this.geomItem.addRef(this)}undo(){this.parentItem.removeChild(this.childIndex)}redo(){this.parentItem.addChild(this.geomItem,!1,!1)}toJSON(e){const t=super.toJSON(e);return t.parentItemPath=this.parentItem.getPath(),t.geomItemName=this.geomItem.getName(),t.geomItemXfo=this.geomItem.getParameter("LocalXfo").getValue(),t}fromJSON(e,t){const o=t.appData.scene.getRoot();this.parentItem=o.resolvePath(e.parentItemPath,1),this.geomItem.setName(this.parentItem.generateUniqueName(e.geomItemName));const s=new d;s.fromJSON(e.geomItemXfo),this.geomItem.setLocalXfo(s),this.childIndex=this.parentItem.addChild(this.geomItem,!1)}destroy(){this.geomItem.removeRef(this)}}class De extends be{constructor(e){super(e),this.stage=0,this.removeToolOnRightClick=!0,this.cp=this.addParameter(new a("Line Color",new n(.7,.2,.2)))}activateTool(){super.activateTool(),this.appData.renderer.getDiv().style.cursor="crosshair",this.appData.renderer.getXRViewport().then(e=>{this.vrControllerToolTip||(this.vrControllerToolTip=new V(.05),this.vrControllerToolTipMat=new r("VRController Cross","LinesShader"),this.vrControllerToolTipMat.getParameter("Color").setValue(this.cp.getValue()),this.vrControllerToolTipMat.visibleInGeomDataBuffer=!1);const t=e=>{const t=new c("CreateGeomToolTip",this.vrControllerToolTip,this.vrControllerToolTipMat);e.getTipItem().removeAllChildren(),e.getTipItem().addChild(t,!1)};for(const o of e.getControllers())t(o);this.addIconToControllerId=e.controllerAdded.connect(t)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getDiv().style.cursor="pointer",this.appData.renderer.getXRViewport().then(e=>{e.controllerAdded.disconnectId(this.addIconToControllerId)})}screenPosToXfo(e,t){const s=t.calcRayFromScreenPos(e),i=new o(this.constructionPlane.tr,this.constructionPlane.ori.getZaxis()),n=s.intersectRayPlane(i);if(n>0){const e=this.constructionPlane.clone();return e.tr=s.pointAtDist(n),e}const a=t.getCamera(),r=a.getGlobalXfo().clone();return r.tr=s.pointAtDist(a.getFocalDistance()),r}createStart(e,t){this.stage=1}createPoint(e){}createMove(e){}createRelease(e){}onMouseDown(e){if(0==this.stage){if(0==e.button){this.constructionPlane=new d;const t=this.screenPosToXfo(e.mousePos,e.viewport);this.createStart(t,this.appData.scene.getRoot())}else 2==e.button&&this.removeToolOnRightClick&&this.appData.toolManager.removeTool(this.index);return!0}return 2!=e.button||(this.appData.undoRedoManager.undo(!1),this.stage=0,!0)}onMouseMove(e){if(this.stage>0){const t=this.screenPosToXfo(e.mousePos,e.viewport);return this.createMove(t.tr),!0}}onMouseUp(e){if(this.stage>0){const t=this.screenPosToXfo(e.mousePos,e.viewport);return this.createRelease(t.tr),!0}}onWheel(e){}onKeyPressed(e,t){}onKeyDown(e,t){}onKeyUp(e,t){}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onTouchCancel(e){}onVRControllerButtonDown(e){if(!this.__activeController){this.__activeController=e.controller,this.constructionPlane=new d;const t=this.constructionPlane.clone();t.tr=this.__activeController.getTipXfo().tr,this.createStart(t,this.appData.scene.getRoot())}return!0}onVRPoseChanged(e){if(this.__activeController&&this.stage>0){const e=this.__activeController.getTipXfo();return this.createMove(e.tr),!0}}onVRControllerButtonUp(e){if(this.stage>0&&this.__activeController==e.controller){const e=this.__activeController.getTipXfo();return this.createRelease(e.tr),0==this.stage&&(this.__activeController=void 0),!0}}}class Se extends Te{constructor(e,t,o,s){super("Create Line"),this.line=new y(0),this.line.setNumVertices(2),this.line.setNumSegments(1),this.line.setSegment(0,0,1);const i=new r("Line","LinesShader");i.getParameter("Color").setValue(new n(.7,.2,.2)),this.geomItem=new c("Line"),this.geomItem.setGeometry(this.line),this.geomItem.setMaterial(i),o&&i.getParameter("Color").setValue(o),s&&(this.line.lineThickness=s),e&&t&&this.setParentAndXfo(e,t)}update(e){e.p1&&(this.line.getVertex(1).setFromOther(e.p1),this.line.geomDataChanged.emit()),this.updated.emit(e)}fromJSON(e,t){if(super.fromJSON(e,t),e.color){const t=new n;t.fromJSON(e.color),material.getParameter("Color").setValue(t)}e.thickness&&(this.line.lineThickness=e.thickness)}}A.registerChange("CreateLineChange",Se);class Me extends De{constructor(e){super(e),this.tp=this.addParameter(new u("Line Thickness",.06,[0,.1]))}createStart(e,t){this.change=new Se(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e.inverse(),this.stage=1,this.length=0}createMove(e){const t=this.xfo.transformVec3(e);this.length=t.length(),this.change.update({p1:t})}createRelease(e){0==this.length&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.actionFinished.emit()}}class ye extends Te{constructor(e,t){super("Create Circle",e),this.circle=new X(0,64),this.circle.lineThickness=.05;const o=new r("circle","FatLinesShader");o.getParameter("Color").setValue(new n(.7,.2,.2)),this.geomItem=new c("Circle"),this.geomItem.setGeometry(this.circle),this.geomItem.setMaterial(o),e&&t&&this.setParentAndXfo(e,t)}update(e){this.circle.getParameter("Radius").setValue(e.radius),this.updated.emit(e)}toJSON(){const e=super.toJSON();return e.radius=this.circle.getParameter("Radius").getValue(),e}changeFromJSON(e){console.log("CreateCircleChange:",e),e.radius&&this.circle.getParameter("Radius").setValue(e.radius)}}A.registerChange("CreateCircleChange",ye);class Ve extends De{constructor(e){super(e)}createStart(e,t){this.change=new ye(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.stage=1,this.radius=0}createMove(e){this.radius=e.distanceTo(this.xfo.tr),this.change.update({radius:this.radius})}createRelease(e){0==this.radius&&this.appData.undoRedoManager.undo(!1),this.change=null,this.stage=0,this.actionFinished.emit()}}class Xe extends Te{constructor(e,t){super("Create Rect"),this.rect=new D(0,0),this.rect.lineThickness=.05;const o=new r("circle","FatLinesShader");o.getParameter("Color").setValue(new n(.7,.2,.2)),this.geomItem=new c("Rect"),this.geomItem.setGeometry(this.rect),this.geomItem.setMaterial(o),e&&t&&this.setParentAndXfo(e,t)}update(e){if(e.baseSize&&this.rect.setSize(e.baseSize[0],e.baseSize[1]),e.tr){const t=this.geomItem.getParameter("LocalXfo").getValue();t.tr.fromJSON(e.tr),this.geomItem.getParameter("LocalXfo").setValue(t)}this.updated.emit(e)}}A.registerChange("CreateRectChange",Xe);class Re extends De{constructor(e){super(e)}createStart(e,t){this.change=new Xe(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.invxfo=e.inverse(),this.stage=1,this._size=0}createMove(e){if(1==this.stage){const t=this.invxfo.transformVec3(e);this._size=Math.abs(t.x),Math.abs(t.y),this.change.update({baseSize:[Math.abs(t.x),Math.abs(t.y)],tr:this.xfo.tr.add(t.scale(.5))})}else{const t=this.invxfo.transformVec3(e);this.change.update({height:t.y})}}createRelease(e,t){0==this._size&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.actionFinished.emit()}}class xe extends Te{constructor(e,t,o,s){super("Create Freehand Line"),this.used=0,this.vertexCount=100,this.line=new y,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),this.line.vertices.setValue(0,new g);const i=new r("freeHandLine","FatLinesShader");this.geomItem=new c("freeHandLine"),this.geomItem.setGeometry(this.line),this.geomItem.setMaterial(i),o&&i.getParameter("Color").setValue(o),s&&(this.line.lineThickness=s),e&&t&&this.setParentAndXfo(e,t)}update(e){this.used++;let t=!1;this.used>=this.line.getNumSegments()&&(this.vertexCount=this.vertexCount+100,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),t=!0),this.line.vertices.setValue(this.used,e.point),this.line.setSegment(this.used-1,this.used-1,this.used),t?this.line.geomDataTopologyChanged.emit({indicesChanged:!0}):this.line.geomDataChanged.emit({indicesChanged:!0}),this.updated.emit(e)}toJSON(e){const t=super.toJSON(e);return t.lineThickness=this.line.lineThickness,t.color=this.geomItem.getMaterial().getParameter("Color").getValue(),t}fromJSON(e,t){e.lineThickness&&(this.line.lineThickness=e.lineThickness);const o=new n(.7,.2,.2);e.color&&o.fromJSON(e.color),this.geomItem.getMaterial().getParameter("Color").setValue(o),super.fromJSON(e,t)}}A.registerChange("CreateFreehandLineChange",xe);class ke extends Me{constructor(e){super(e),this.mp=this.addParameter(new R("Modulate Thickness By Stroke Speed",!1))}createStart(e,t){const o=this.cp.getValue(),s=this.tp.getValue();this.change=new xe(t,e,o,s),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.invxfo=e.inverse(),this.stage=1,this.prevP=e.tr,this.length=0}createMove(e){const t=this.invxfo.transformVec3(e),o=t.subtract(this.prevP).length();o>.001&&this.change.update({point:t}),this.length+=o,this.prevP=t}createRelease(e){0==this.length&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.actionFinished.emit()}}class Ee extends Te{constructor(e,t){super("Create Sphere",e),this.sphere=new f(0,64,32);const o=new r("Sphere","SimpleSurfaceShader");this.geomItem=new c("Sphere"),this.geomItem.setGeometry(this.sphere),this.geomItem.setMaterial(o),e&&t&&this.setParentAndXfo(e,t)}update(e){this.sphere.radius=e.radius,this.updated.emit(e)}toJSON(){const e=super.toJSON();return e.radius=this.geomItem.getGeometry().radius,e}changeFromJSON(e){e.radius&&(this.geomItem.getGeometry().radius=e.radius)}}A.registerChange("CreateSphereChange",Ee);class Oe extends De{constructor(e){super(e)}createStart(e,t){this.change=new Ee(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.stage=1,this.radius=0}createMove(e){this.radius=e.distanceTo(this.xfo.tr),this.change.update({radius:this.radius})}createRelease(e){0==this.radius&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.actionFinished.emit()}}class Ae extends Te{constructor(e,t){super("Create Cuboid"),this.cuboid=new p(0,0,0,!0);const o=new r("Cuboid","SimpleSurfaceShader");this.geomItem=new c("Cuboid"),this.geomItem.setGeometry(this.cuboid),this.geomItem.setMaterial(o),e&&t&&this.setParentAndXfo(e,t)}update(e){if(e.baseSize&&this.cuboid.setBaseSize(e.baseSize[0],e.baseSize[1]),e.tr){const t=this.geomItem.getParameter("LocalXfo").getValue();t.tr.fromJSON(e.tr),this.geomItem.getParameter("LocalXfo").setValue(t)}e.height&&(this.cuboid.z=e.height),this.updated.emit(e)}}A.registerChange("CreateCuboidChange",Ae);class Ge extends De{constructor(e){super(e)}createStart(e,t){this.change=new Ae(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.invxfo=e.inverse(),this.stage=1,this._height=0}createMove(e){if(1==this.stage){const t=this.invxfo.transformVec3(e);this.change.update({baseSize:[Math.abs(t.x),Math.abs(t.y)],tr:this.xfo.tr.add(t.scale(.5))})}else{const t=this.invxfo.transformVec3(e);this.change.update({height:t.y})}}createRelease(e,t){if(1==this.stage){this.stage=2,this.pt1=e;const t=new T;t.setFromAxisAndAngle(new g(1,0,0),.5*Math.PI),this.constructionPlane.ori=this.constructionPlane.ori.multiply(t),this.constructionPlane.tr=e,this.invxfo=this.constructionPlane.inverse()}else 2==this.stage&&(this.stage=0,this.actionFinished.emit())}}class Le extends ie{constructor(e){super(e),this.activeHandle=void 0,this.capturedItems=[],this.mouseOverItems=[]}activateTool(){super.activateTool(),console.log("activateTool.HandleTool"),this.appData.renderer.getDiv().style.cursor="crosshair";const e=e=>{if(!this.__activated)return;const t=new f(.015),o=new r("Cross","FlatSurfaceShader");o.getParameter("BaseColor").setValue(new n("#03E3AC")),o.visibleInGeomDataBuffer=!1;const s=new c("HandleToolTip",t,o);e.getTipItem().removeAllChildren(),e.getTipItem().addChild(s,!1)},t=t=>{for(const o of t.getControllers())e(o);this.addIconToControllerId=t.controllerAdded.connect(e)};this.appData.renderer.getXRViewport().then(e=>{t(e)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(e=>{e.controllerAdded.disconnectId(this.addIconToControllerId)})}onMouseDown(e){if(!this.activeHandle){const t=e.viewport.getGeomDataAtPos(e.mousePos);if(null==t)return;if(t.geomItem.getOwner()instanceof L)return this.activeHandle=t.geomItem.getOwner(),this.activeHandle.handleMouseDown(Object.assign(e,{intersectionData:t})),!0}}onMouseMove(e){if(this.activeHandle)return this.activeHandle.handleMouseMove(e),!0;{if(0==e.button&&1==e.buttons)return!1;const t=e.viewport.getGeomDataAtPos(e.mousePos);if(null!=t&&t.geomItem.getOwner()instanceof L){const e=t.geomItem.getOwner();return this.__highlightedHandle&&this.__highlightedHandle.unhighlight(),this.__highlightedHandle=e,this.__highlightedHandle.highlight(),!0}this.__highlightedHandle&&(this.__highlightedHandle.unhighlight(),this.__highlightedHandle=void 0)}}onMouseUp(e){if(this.activeHandle)return this.activeHandle.handleMouseUp(e),this.activeHandle=void 0,!0}onWheel(e){this.activeHandle&&this.activeHandle.onWheel(e)}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onTouchCancel(e){}__prepareVREvent(e){const t=e.controller.getId();e.setCapture=e=>{this.capturedItems[t]=e},e.getCapture=()=>this.capturedItems[t],e.releaseCapture=()=>{this.capturedItems[t]=null}}onVRControllerButtonDown(e){const t=e.controller.getId();if(this.capturedItems[t])this.__prepareVREvent(e),this.capturedItems[t].onMouseDown(e);else{const t=e.controller.getGeomItemAtTip();null!=t&&(e.intersectionData=t,e.geomItem=t.geomItem,this.__prepareVREvent(e),t.geomItem.onMouseDown(e))}}onVRPoseChanged(e){for(const t of e.controllers){const o=t.getId();if(this.capturedItems[o])this.capturedItems[o].onMouseMove(e);else{const s=t.getGeomItemAtTip();null!=s?(e.intersectionData=s,e.geomItem=s.geomItem,s.geomItem!=this.mouseOverItems[o]&&(this.mouseOverItems[o]&&this.mouseOverItems[o].onMouseLeave(e),this.mouseOverItems[o]=s.geomItem,this.mouseOverItems[o].onMouseEnter(e)),s.geomItem.onMouseMove(e)):this.mouseOverItems[o]&&(this.mouseOverItems[o].onMouseLeave(e),this.mouseOverItems[o]=null)}}}onVRControllerButtonUp(e){this.__prepareVREvent(e);const t=e.controller.getId();if(this.capturedItems[t])this.capturedItems[t].onMouseUp(e);else{const t=e.controller.getGeomItemAtTip();null!=t&&(e.intersectionData=t,e.geomItem=t.geomItem,t.geomItem.onMouseUp(e))}}}class He extends H{constructor(e,t=.5,o=.02,s=new n(1,1,0)){super(e),this.lengthParam=this.addParameter(new u("Length",t)),this.handleRadiusParam=this.addParameter(new u("Handle Radius",o)),this.barRadiusParam=this.addParameter(new u("Bar Radius",.25*o)),this.colorParam=this.addParameter(new a("Color",s)),this.hilghlightColorParam=this.addParameter(new a("Highlight Color",new n(1,1,1))),this.handleMat=new r("handle","FlatSurfaceShader"),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue());const i=new r("topBar","FlatSurfaceShader");i.getParameter("BaseColor").setValue(new n(.5,.5,.5));const l=new h(.25*o,1,64,2,!0,!0),g=new f(o,64);this.handle=new c("handle",g,this.handleMat),this.baseBar=new c("baseBar",l,this.handleMat),this.topBar=new c("topBar",l,i),this.handleXfo=new d,this.baseBarXfo=new d,this.topBarXfo=new d,this.barRadiusParam.valueChanged.connect(()=>{l.getParameter("radius").setValue(this.barRadiusParam.getValue())}),this.handleRadiusParam.valueChanged.connect(()=>{g.getParameter("radius").setValue(this.handleRadiusParam.getValue())}),this.lengthParam.valueChanged.connect(()=>{this.__updateSlider(this.value)}),this.colorParam.valueChanged.connect(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}),this.addChild(this.handle),this.addChild(this.baseBar),this.addChild(this.topBar),this.__updateSlider(0)}highlight(){this.handleMat.getParameter("BaseColor").setValue(this.hilghlightColorParam.getValue())}unhighlight(){this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}setTargetParam(e){this.param=e;const t=()=>{this.__updateSlider(e.getValue())};t(),e.valueChanged.connect(t)}__updateSlider(e){this.value=e;const t=this.param&&this.param.getRange()?this.param.getRange():[0,1],o=Math.remap(e,t[0],t[1],0,1),i=this.lengthParam.getValue();this.baseBarXfo.sc.z=o*i,this.handleXfo.tr.z=o*i,this.topBarXfo.tr.z=o*i,this.topBarXfo.sc.z=(1-o)*i,this.handle.setLocalXfo(this.handleXfo,s.GENERATED_VALUE),this.baseBar.setLocalXfo(this.baseBarXfo,s.GENERATED_VALUE),this.topBar.setLocalXfo(this.topBarXfo,s.GENERATED_VALUE)}onDragStart(e){this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1.2,this.handle.setLocalXfo(this.handleXfo,s.GENERATED_VALUE),this.param&&e.undoRedoManager&&(this.change=new N(this.param),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=this.lengthParam.getValue(),o=this.param&&this.param.getRange()?this.param.getRange():[0,1],s=Math.clamp(Math.remap(e.value,0,t,o[0],o[1]),o[0],o[1]);if(!this.param)return this.__updateSlider(s),void(this.value=s);this.change?this.change.update({value:s}):this.param.setValue(s)}onDragEnd(e){this.change=null,this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1,this.handle.setLocalXfo(this.handleXfo,s.GENERATED_VALUE)}toJSON(e,t=0){const o=super.toJSON(e,t|SAVE_FLAG_SKIP_CHILDREN);return this.param&&(o.targetParam=this.param.getPath()),o}fromJSON(e,t,o){super.fromJSON(e,t,o),e.targetParam&&t.resolvePath(e.targetParam).then(e=>{this.setTargetParam(e)})}}v.registerClass("SliderHandle",He);class Ne extends z{constructor(t,o=1,s=1,i=.02,h=new n(1,1,0)){super(t),this.arcRadiusParam=this.addParameter(new u("Arc Radius",o)),this.arcAngleParam=this.addParameter(new u("Arc Angle",s)),this.handleRadiusParam=this.addParameter(new u("Handle Radius",i)),this.colorParam=this.addParameter(new a("Color",h)),this.hilghlightColorParam=this.addParameter(new a("Highlight Color",new n(1,1,1))),this.handleMat=new r("handleMat","HandleShader");const l=new X(o,s,64),g=new f(i,64);this.handle=new c("handle",g,this.handleMat),this.arc=new c("arc",l,this.handleMat),this.handleXfo=new d,this.handleGeomOffsetXfo=new d,this.handleGeomOffsetXfo.tr.x=o,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.range=[0,s],this.arcAngleParam.valueChanged.connect(()=>{const e=this.arcAngleParam.getValue();l.getParameter("Angle").setValue(e),this.range=[0,e]}),this.arcRadiusParam.valueChanged.connect(()=>{const e=this.arcRadiusParam.getValue();l.getParameter("Radius").setValue(e),this.handleGeomOffsetXfo.tr.x=e,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo)}),this.handleRadiusParam.valueChanged.connect(()=>{g.getParameter("radius").setValue(this.handleRadiusParam.getValue())}),this.colorParam.valueChanged.connect(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}),this.addChild(this.handle),this.addChild(this.arc),this.setTargetParam(this.handle.getParameter("GlobalXfo"),!1),this.dragStart=new e,this.dragEnd=new e}onMouseEnter(e){e.intersectionData&&e.intersectionData.geomItem==this.handle&&this.highlight()}onMouseLeave(e){this.unhighlight()}onMouseDown(e){e.intersectionData&&e.intersectionData.geomItem==this.handle&&super.onMouseDown(e)}highlight(){this.handleMat.getParameter("BaseColor").setValue(this.hilghlightColorParam.getValue())}unhighlight(){this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}getBaseXfo(){return this.handle.getParameter("GlobalXfo").getValue()}onDragStart(e){this.baseXfo=this.getGlobalXfo().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new d,this.vec0=this.getGlobalXfo().ori.getXaxis(),this.vec0.normalizeInPlace(),e.undoRedoManager&&(this.change=new N(this.param),e.undoRedoManager.addChange(this.change)),this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1.2,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.dragStart.emit()}onDrag(e){const t=e.holdPos.subtract(this.baseXfo.tr);t.normalizeInPlace();let o=this.vec0.angleTo(t);if(this.vec0.cross(t).dot(this.baseXfo.ori.getZaxis())<0&&(o=-o),this.range&&(o=Math.clamp(o,this.range[0],this.range[1])),e.shiftKey){const e=Math.degToRad(22.5);o=Math.floor(o/e)*e}this.deltaXfo.ori.setFromAxisAndAngle(new Vec3(0,0,1),o);const s=this.baseXfo.multiply(this.deltaXfo);if(this.change)this.change.update({value:s});else{(this.param?this.param:this.getParameter("GlobalXfo")).setValue(s)}}onDragEnd(e){this.change=null,this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.dragEnd.emit()}toJSON(e,t=0){const o=super.toJSON(e,t|SAVE_FLAG_SKIP_CHILDREN);return this.param&&(o.targetParam=this.param.getPath()),o}fromJSON(e,t,o){super.fromJSON(e,t,o),e.targetParam&&t.resolvePath(e.targetParam).then(e=>{this.setTargetParam(e)})}}v.registerClass("ArcSlider",Ne);class Ue extends L{constructor(e){super(e)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.valueChanged.connect(t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}handleMouseDown(e){this.gizmoRay=new o,this.gizmoRay.dir=e.mouseRay.dir.negate();const t=this.getTargetParam().getValue();this.gizmoRay.pos=t.tr;const s=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.grabPos=e.mouseRay.pointAtDist(s),this.onDragStart(e),!0}handleMouseMove(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.holdPos=e.mouseRay.pointAtDist(t),this.onDrag(e),!0}handleMouseUp(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.releasePos=e.mouseRay.pointAtDist(t),this.onDragEnd(e),!0}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new N(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.grabPos),o=this.baseXfo.clone();if(o.tr.addInPlace(t),this.change)this.change.update({value:o});else{this.getTargetParam().setValue(o)}}onDragEnd(e){this.change=null}}class Be extends HTMLElement{constructor(){super();const e=this.attachShadow({mode:"open"}),t=document.createElement("style");t.appendChild(document.createTextNode(Be.css)),e.appendChild(t),this.itemContainer=document.createElement("div"),this.itemHeader=document.createElement("div"),this.itemHeader.className="TreeNodeHeader",this.itemContainer.appendChild(this.itemHeader),this.itemChildren=document.createElement("div"),this.itemChildren.className="TreeNodesList",this.itemContainer.appendChild(this.itemChildren),this.expandBtn=document.createElement("button"),this.expandBtn.className="TreeNodesListItem__ToggleExpanded",this.itemHeader.appendChild(this.expandBtn),this.expanded=!1,this.childrenAlreadyCreated=!1,this.expandBtn.addEventListener("click",()=>{this.treeItem.getNumChildren()>0&&(this.expanded?this.collapse():this.expand())}),this.titleElement=document.createElement("span"),this.titleElement.className="TreeNodesListItem__Title",this.titleElement.addEventListener("click",e=>{this.appData&&this.appData.selectionManager?this.appData.selectionManager.pickingModeActive()?this.appData.selectionManager.pick(this.treeItem):this.appData.selectionManager.toggleItemSelection(this.treeItem,!e.ctrlKey):this.treeItem.setSelected(!this.treeItem.getSelected())}),this.itemHeader.appendChild(this.titleElement),e.appendChild(this.itemContainer)}setTreeItem(e,o){this.treeItem=e,this.appData=o,this.titleElement.textContent=e.getName();this.treeItem.nameChanged.connect(()=>{this.titleElement.textContent=e.getName()}),this.updateSelectedId=this.treeItem.selectedChanged.connect(this.updateSelected.bind(this)),this.updateSelected(),e instanceof t&&(this.toggleVisibilityBtn=document.createElement("button"),this.toggleVisibilityBtn.className="TreeNodesListItem__ToggleVisibility",this.itemHeader.insertBefore(this.toggleVisibilityBtn,this.titleElement),this.toggleVisibilityBtn.innerHTML='<i class="material-icons-outlined md-15">visibility</i>',this.toggleVisibilityBtn.addEventListener("click",()=>{const e=this.treeItem.getParameter("Visible");if(this.appData&&this.appData.undoRedoManager){const t=new ParameterValueChange(e,!e.getValue());this.appData.undoRedoManager.addChange(t)}else e.setValue(!e.getValue())}),this.updateVisibilityId=this.treeItem.visibilityChanged.connect(this.updateVisibility.bind(this)),this.updateVisibility(),this.updateHighlightId=this.treeItem.highlightChanged.connect(this.updateHighlight.bind(this)),this.updateHighlight(),this.treeItem.getChildren().length&&this.collapse(),this.childAddedId=this.treeItem.childAdded.connect(this.childAdded.bind(this)),this.childRemovedId=this.treeItem.childRemoved.connect(this.childRemoved.bind(this)))}updateVisibility(){const e=this.treeItem.getVisible();e?this.itemContainer.classList.remove("TreeNodesListItem--isHidden"):this.itemContainer.classList.add("TreeNodesListItem--isHidden"),this.toggleVisibilityBtn.innerHTML=e?'<i class="material-icons-outlined md-15">visibility</i>':'<i class="material-icons-outlined md-15">visibility_off</i>'}updateSelected(){this.treeItem.getSelected()?this.itemContainer.classList.add("TreeNodesListItem--isSelected"):this.itemContainer.classList.remove("TreeNodesListItem--isSelected")}updateHighlight(){const e=this.treeItem.isHighlighted();if(e?this.itemContainer.classList.add("TreeNodesListItem--isHighlighted"):this.itemContainer.classList.remove("TreeNodesListItem--isHighlighted"),e){const e=this.treeItem.getHighlight(),t=e.lerp(new n(.75,.75,.75,0),.5);this.titleElement.style.setProperty("border-color",e.toHex()),this.titleElement.style.setProperty("background-color",t.toHex())}else this.titleElement.style.removeProperty("border-color"),this.titleElement.style.removeProperty("background-color")}expand(){if(this.expanded=!0,this.itemChildren.classList.remove("TreeNodesList--collapsed"),this.expandBtn.innerHTML='<i class="material-icons md-24">arrow_drop_down</i>',!this.childrenAlreadyCreated){this.treeItem.getChildren().forEach((e,t)=>{this.addChild(e,t)}),this.childrenAlreadyCreated=!0}}collapse(){this.itemChildren.classList.add("TreeNodesList--collapsed"),this.expandBtn.innerHTML='<i class="material-icons md-24">arrow_right</i>',this.expanded=!1}addChild(e,t){if(this.expanded){const o=document.createElement("tree-item-view");o.setTreeItem(e,this.appData),t==this.itemChildren.childElementCount?this.itemChildren.appendChild(o):this.itemChildren.insertBefore(o,this.itemChildren.children[t])}else this.collapse()}childAdded(e,t){this.addChild(e,t)}childRemoved(e,t){this.expanded&&(this.itemChildren.children[t].destroy(),this.itemChildren.removeChild(this.itemChildren.children[t]))}destroy(){this.treeItem.selectedChanged.disconnectId(this.updateSelectedId),this.treeItem instanceof t&&(this.treeItem.highlightChanged.disconnectId(this.updateHighlightId),this.treeItem.visibilityChanged.disconnectId(this.updateVisibilityId),this.treeItem.childAdded.disconnectId(this.childAddedId),this.treeItem.childRemoved.disconnectId(this.childRemovedId))}}Be.css="\n  /* tree-view.css */\n\n  ////\n  /// From https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined\n\n  /* fallback */\n  @font-face {\n    font-family: 'Material Icons';\n    font-style: normal;\n    font-weight: 400;\n    src: url(https://fonts.gstatic.com/s/materialicons/v48/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2) format('woff2');\n  }\n  /* fallback */\n  @font-face {\n    font-family: 'Material Icons Outlined';\n    font-style: normal;\n    font-weight: 400;\n    src: url(https://fonts.gstatic.com/s/materialiconsoutlined/v14/gok-H7zzDkdnRel8-DQ6KAXJ69wP1tGnf4ZGhUce.woff2) format('woff2');\n  }\n\n  .material-icons {\n    font-family: 'Material Icons';\n    font-weight: normal;\n    font-style: normal;\n    font-size: 24px;\n    line-height: 1;\n    letter-spacing: normal;\n    text-transform: none;\n    display: inline-block;\n    white-space: nowrap;\n    word-wrap: normal;\n    direction: ltr;\n    -webkit-font-feature-settings: 'liga';\n    -webkit-font-smoothing: antialiased;\n  }\n\n  .material-icons-outlined {\n    font-family: 'Material Icons Outlined';\n    font-weight: normal;\n    font-style: normal;\n    font-size: 24px;\n    line-height: 1;\n    letter-spacing: normal;\n    text-transform: none;\n    display: inline-block;\n    white-space: nowrap;\n    word-wrap: normal;\n    direction: ltr;\n    -webkit-font-feature-settings: 'liga';\n    -webkit-font-smoothing: antialiased;\n  }\n  .TreeNodesList {\n    border-left: 1px dotted;\n    list-style-type: none;\n    padding: 0 0 0 15px;\n    margin: 0 0 0 10px;\n  }\n\n  .TreeNodesList--collapsed {\n    display: none;\n  }\n\n  .TreeNodesList--root {\n    border: none;\n    margin: 0;\n    padding: 0;\n    width: max-content;\n  }\n\n  .TreeNodesListItem{\n    display: flex;\n  }\n\n  .TreeNodesListItem__ToggleVisibility {\n    border: none;\n    color: #333;\n    height: 24px;\n    padding: 0;\n    width: 25px;\n  }\n\n  .TreeNodesListItem__ToggleVisibility:focus {\n    outline: none;\n  }\n\n  .TreeNodesListItem__ToggleExpanded {\n    border: none;\n    height: 24px;\n    width: 24px;\n    padding: 0;\n    background-color: #0000;\n    outline: none;\n  }\n\n  .TreeNodesListItem::before {\n    border-bottom: 1px dotted;\n    content: '';\n    display: inline-block;\n    left: -15px;\n    position: relative;\n    top: -5px;\n    width: 10px;\n  }\n\n  .TreeNodesListItem__Toggle:focus {\n    outline: none;\n  }\n\n  .TreeNodeHeader{\n    display: flex;\n    margin: 0.4em auto;\n  }\n\n  .TreeNodesListItem__Title {\n    cursor: default;\n    padding: 2px 4px;\n    border-radius: 5px;\n  }\n\n  .TreeNodesListItem__Title:hover {\n    background-color: #e1f5fe;\n  }\n  .TreeNodesListItem__Hover {\n    background-color: #e1f5fe;\n  }\n\n  .TreeNodesListItem__Dragging {\n    background-color: #e1f5fe;\n  }\n\n  .TreeNodesListItem--isSelected > .TreeNodeHeader > .TreeNodesListItem__Title {\n    background-color: #76d2bb;\n    color: #3B3B3B;\n  }\n\n  .TreeNodesListItem--isHidden > .TreeNodeHeader >  .TreeNodesListItem__Title {\n    color: #9e9e9e;\n  }\n\n  .TreeNodesListItem--isHighlighted > .TreeNodeHeader >  .TreeNodesListItem__Title {\n    border-style: solid;\n    border-width: thin;\n  }\n\n  /* Rules for sizing the icon. */\n  .material-icons-outlined.md-15,\n  .material-icons.md-15 {\n    font-size: 15px;\n  }\n  .material-icons.md-18 {\n    font-size: 18px;\n  }\n  .material-icons.md-24 {\n    font-size: 24px;\n  }\n  .material-icons.md-36 {\n    font-size: 36px;\n  }\n  .material-icons.md-48 {\n    font-size: 48px;\n  }\n\n  /* Rules for using icons as black on a light background. */\n  .material-icons.md-dark {\n    color: rgba(0, 0, 0, 0.54);\n  }\n  .material-icons.md-dark.md-inactive {\n    color: rgba(0, 0, 0, 0.26);\n  }\n\n  /* Rules for using icons as white on a dark background. */\n  .material-icons.md-light {\n    color: rgba(255, 255, 255, 1);\n  }\n  .material-icons.md-light.md-inactive {\n    color: rgba(255, 255, 255, 0.3);\n  }\n\n  ";customElements.get("tree-item-view")||customElements.define("tree-item-view",Be);class ze extends HTMLElement{constructor(){super();const e=this.attachShadow({mode:"open"});this.treeContainer=document.createElement("div"),e.appendChild(this.treeContainer),this.treeItemView=document.createElement("tree-item-view");const t=new CSSStyleSheet;t.replaceSync("@font-face {\n      font-family: \"Material Icons\";\n      font-style: normal;\n      font-weight: 400;\n      src: url('https://fonts.gstatic.com/s/materialicons/v48/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2') format('woff');\n    }");const o=new CSSStyleSheet;o.replaceSync("@font-face {\n      font-family: \"Material Icons Outlined\";\n      font-style: normal;\n      font-weight: 400;\n      src: url('https://fonts.gstatic.com/s/materialiconsoutlined/v14/gok-H7zzDkdnRel8-DQ6KAXJ69wP1tGnf4ZGhUce.woff2') format('woff');\n    }"),document.adoptedStyleSheets=[...document.adoptedStyleSheets,t,o]}setTreeItem(e,t){this.treeItemView.setTreeItem(e,t),this.treeContainer.appendChild(this.treeItemView)}}customElements.get("scene-tree-view")||customElements.define("scene-tree-view",ze);export{x as ActionRegistry,Ne as ArcSlider,F as AxialRotationHandle,G as Change,Ve as CreateCircleTool,Ge as CreateCuboidTool,ke as CreateFreehandLineTool,Me as CreateLineTool,Re as CreateRectTool,Oe as CreateSphereTool,Le as HandleTool,U as LinearMovementHandle,he as OpenVRUITool,N as ParameterValueChange,B as PlanarMovementHandle,ze as SceneTreeView,Ue as ScreenSpaceMovementHandle,$ as SelectionManager,re as SelectionTool,He as SliderHandle,Q as ToolAction,se as ToolManager,ee as TreeItemAddChange,oe as TreeItemMoveChange,Be as TreeItemView,te as TreeItemsRemoveChange,A as UndoRedoManager,ne as VIEW_TOOL_MODELS,Pe as VRHoldObjectsTool,ve as VRUITool,ae as ViewTool};
