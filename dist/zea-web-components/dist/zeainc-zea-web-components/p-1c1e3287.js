import{c as n,a as t,b as r}from"./p-f249487f.js";import{p as e}from"./p-b57dc4fe.js";import{E as i}from"./p-26586be0.js";var o,u,f=n.MutationObserver||n.WebKitMutationObserver;if(f){var c=0,a=new f(l),s=n.document.createTextNode("");a.observe(s,{characterData:!0}),o=function(){s.data=c=++c%2}}else if(n.setImmediate||void 0===n.MessageChannel)o="document"in n&&"onreadystatechange"in n.document.createElement("script")?function(){var t=n.document.createElement("script");t.onreadystatechange=function(){l(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},n.document.documentElement.appendChild(t)}:function(){setTimeout(l,0)};else{var v=new n.MessageChannel;v.port1.onmessage=l,o=function(){v.port2.postMessage(0)}}var d=[];function l(){var n,t;u=!0;for(var r=d.length;r;){for(t=d,d=[],n=-1;++n<r;)t[n]();r=d.length}u=!1}for(var h=function(n){1!==d.push(n)||u||o()},y=t((function(n){var t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(t){var r=new Uint8Array(16);n.exports=function(){return t(r),r}}else{var e=new Array(16);n.exports=function(){for(var n,t=0;t<16;t++)0==(3&t)&&(n=4294967296*Math.random()),e[t]=n>>>((3&t)<<3)&255;return e}}})),p=[],b=0;b<256;++b)p[b]=(b+256).toString(16).substr(1);var w,m,_=function(n,t){var r=t||0;return[p[n[r++]],p[n[r++]],p[n[r++]],p[n[r++]],"-",p[n[r++]],p[n[r++]],"-",p[n[r++]],p[n[r++]],"-",p[n[r++]],p[n[r++]],"-",p[n[r++]],p[n[r++]],p[n[r++]],p[n[r++]],p[n[r++]],p[n[r++]]].join("")},g=0,k=0,j=function(n,t,r){var e=t&&r||0;"string"==typeof n&&(t="binary"===n?new Array(16):null,n=null);var i=(n=n||{}).random||(n.rng||y)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t)for(var o=0;o<16;++o)t[e+o]=i[o];return t||_(i)},O=j;O.v1=function(n,t,r){var e=t&&r||0,i=t||[],o=(n=n||{}).node||w,u=void 0!==n.clockseq?n.clockseq:m;if(null==o||null==u){var f=y();null==o&&(o=w=[1|f[0],f[1],f[2],f[3],f[4],f[5]]),null==u&&(u=m=16383&(f[6]<<8|f[7]))}var c=void 0!==n.msecs?n.msecs:(new Date).getTime(),a=void 0!==n.nsecs?n.nsecs:k+1,s=c-g+(a-k)/1e4;if(s<0&&void 0===n.clockseq&&(u=u+1&16383),(s<0||c>g)&&void 0===n.nsecs&&(a=0),a>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");g=c,k=a,m=u;var v=(1e4*(268435455&(c+=122192928e5))+a)%4294967296;i[e++]=v>>>24&255,i[e++]=v>>>16&255,i[e++]=v>>>8&255,i[e++]=255&v;var d=c/4294967296*1e4&268435455;i[e++]=d>>>8&255,i[e++]=255&d,i[e++]=d>>>24&15|16,i[e++]=d>>>16&255,i[e++]=u>>>8|128,i[e++]=255&u;for(var l=0;l<6;++l)i[e+l]=o[l];return t||_(i)},O.v4=j;var $=O,q=t((function(n){n.exports=function(){var n=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function t(n,t){var r=n[0],e=n[1],i=n[2],o=n[3];e=((e+=((i=((i+=((o=((o+=((r=((r+=(e&i|~e&o)+t[0]-680876936|0)<<7|r>>>25)+e|0)&e|~r&i)+t[1]-389564586|0)<<12|o>>>20)+r|0)&r|~o&e)+t[2]+606105819|0)<<17|i>>>15)+o|0)&o|~i&r)+t[3]-1044525330|0)<<22|e>>>10)+i|0,e=((e+=((i=((i+=((o=((o+=((r=((r+=(e&i|~e&o)+t[4]-176418897|0)<<7|r>>>25)+e|0)&e|~r&i)+t[5]+1200080426|0)<<12|o>>>20)+r|0)&r|~o&e)+t[6]-1473231341|0)<<17|i>>>15)+o|0)&o|~i&r)+t[7]-45705983|0)<<22|e>>>10)+i|0,e=((e+=((i=((i+=((o=((o+=((r=((r+=(e&i|~e&o)+t[8]+1770035416|0)<<7|r>>>25)+e|0)&e|~r&i)+t[9]-1958414417|0)<<12|o>>>20)+r|0)&r|~o&e)+t[10]-42063|0)<<17|i>>>15)+o|0)&o|~i&r)+t[11]-1990404162|0)<<22|e>>>10)+i|0,e=((e+=((i=((i+=((o=((o+=((r=((r+=(e&i|~e&o)+t[12]+1804603682|0)<<7|r>>>25)+e|0)&e|~r&i)+t[13]-40341101|0)<<12|o>>>20)+r|0)&r|~o&e)+t[14]-1502002290|0)<<17|i>>>15)+o|0)&o|~i&r)+t[15]+1236535329|0)<<22|e>>>10)+i|0,e=((e+=((i=((i+=((o=((o+=((r=((r+=(e&o|i&~o)+t[1]-165796510|0)<<5|r>>>27)+e|0)&i|e&~i)+t[6]-1069501632|0)<<9|o>>>23)+r|0)&e|r&~e)+t[11]+643717713|0)<<14|i>>>18)+o|0)&r|o&~r)+t[0]-373897302|0)<<20|e>>>12)+i|0,e=((e+=((i=((i+=((o=((o+=((r=((r+=(e&o|i&~o)+t[5]-701558691|0)<<5|r>>>27)+e|0)&i|e&~i)+t[10]+38016083|0)<<9|o>>>23)+r|0)&e|r&~e)+t[15]-660478335|0)<<14|i>>>18)+o|0)&r|o&~r)+t[4]-405537848|0)<<20|e>>>12)+i|0,e=((e+=((i=((i+=((o=((o+=((r=((r+=(e&o|i&~o)+t[9]+568446438|0)<<5|r>>>27)+e|0)&i|e&~i)+t[14]-1019803690|0)<<9|o>>>23)+r|0)&e|r&~e)+t[3]-187363961|0)<<14|i>>>18)+o|0)&r|o&~r)+t[8]+1163531501|0)<<20|e>>>12)+i|0,e=((e+=((i=((i+=((o=((o+=((r=((r+=(e&o|i&~o)+t[13]-1444681467|0)<<5|r>>>27)+e|0)&i|e&~i)+t[2]-51403784|0)<<9|o>>>23)+r|0)&e|r&~e)+t[7]+1735328473|0)<<14|i>>>18)+o|0)&r|o&~r)+t[12]-1926607734|0)<<20|e>>>12)+i|0,e=((e+=((i=((i+=((o=((o+=((r=((r+=(e^i^o)+t[5]-378558|0)<<4|r>>>28)+e|0)^e^i)+t[8]-2022574463|0)<<11|o>>>21)+r|0)^r^e)+t[11]+1839030562|0)<<16|i>>>16)+o|0)^o^r)+t[14]-35309556|0)<<23|e>>>9)+i|0,e=((e+=((i=((i+=((o=((o+=((r=((r+=(e^i^o)+t[1]-1530992060|0)<<4|r>>>28)+e|0)^e^i)+t[4]+1272893353|0)<<11|o>>>21)+r|0)^r^e)+t[7]-155497632|0)<<16|i>>>16)+o|0)^o^r)+t[10]-1094730640|0)<<23|e>>>9)+i|0,e=((e+=((i=((i+=((o=((o+=((r=((r+=(e^i^o)+t[13]+681279174|0)<<4|r>>>28)+e|0)^e^i)+t[0]-358537222|0)<<11|o>>>21)+r|0)^r^e)+t[3]-722521979|0)<<16|i>>>16)+o|0)^o^r)+t[6]+76029189|0)<<23|e>>>9)+i|0,e=((e+=((i=((i+=((o=((o+=((r=((r+=(e^i^o)+t[9]-640364487|0)<<4|r>>>28)+e|0)^e^i)+t[12]-421815835|0)<<11|o>>>21)+r|0)^r^e)+t[15]+530742520|0)<<16|i>>>16)+o|0)^o^r)+t[2]-995338651|0)<<23|e>>>9)+i|0,e=((e+=((o=((o+=(e^((r=((r+=(i^(e|~o))+t[0]-198630844|0)<<6|r>>>26)+e|0)|~i))+t[7]+1126891415|0)<<10|o>>>22)+r|0)^((i=((i+=(r^(o|~e))+t[14]-1416354905|0)<<15|i>>>17)+o|0)|~r))+t[5]-57434055|0)<<21|e>>>11)+i|0,e=((e+=((o=((o+=(e^((r=((r+=(i^(e|~o))+t[12]+1700485571|0)<<6|r>>>26)+e|0)|~i))+t[3]-1894986606|0)<<10|o>>>22)+r|0)^((i=((i+=(r^(o|~e))+t[10]-1051523|0)<<15|i>>>17)+o|0)|~r))+t[1]-2054922799|0)<<21|e>>>11)+i|0,e=((e+=((o=((o+=(e^((r=((r+=(i^(e|~o))+t[8]+1873313359|0)<<6|r>>>26)+e|0)|~i))+t[15]-30611744|0)<<10|o>>>22)+r|0)^((i=((i+=(r^(o|~e))+t[6]-1560198380|0)<<15|i>>>17)+o|0)|~r))+t[13]+1309151649|0)<<21|e>>>11)+i|0,e=((e+=((o=((o+=(e^((r=((r+=(i^(e|~o))+t[4]-145523070|0)<<6|r>>>26)+e|0)|~i))+t[11]-1120210379|0)<<10|o>>>22)+r|0)^((i=((i+=(r^(o|~e))+t[2]+718787259|0)<<15|i>>>17)+o|0)|~r))+t[9]-343485551|0)<<21|e>>>11)+i|0,n[0]=r+n[0]|0,n[1]=e+n[1]|0,n[2]=i+n[2]|0,n[3]=o+n[3]|0}function r(n){var t,r=[];for(t=0;t<64;t+=4)r[t>>2]=n.charCodeAt(t)+(n.charCodeAt(t+1)<<8)+(n.charCodeAt(t+2)<<16)+(n.charCodeAt(t+3)<<24);return r}function e(n){var t,r=[];for(t=0;t<64;t+=4)r[t>>2]=n[t]+(n[t+1]<<8)+(n[t+2]<<16)+(n[t+3]<<24);return r}function i(n){var e,i,o,u,f,c,a=n.length,s=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=a;e+=64)t(s,r(n.substring(e-64,e)));for(i=(n=n.substring(e-64)).length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<i;e+=1)o[e>>2]|=n.charCodeAt(e)<<(e%4<<3);if(o[e>>2]|=128<<(e%4<<3),e>55)for(t(s,o),e=0;e<16;e+=1)o[e]=0;return u=(u=8*a).toString(16).match(/(.*?)(.{0,8})$/),f=parseInt(u[2],16),c=parseInt(u[1],16)||0,o[14]=f,o[15]=c,t(s,o),s}function o(t){var r,e="";for(r=0;r<4;r+=1)e+=n[t>>8*r+4&15]+n[t>>8*r&15];return e}function u(n){var t;for(t=0;t<n.length;t+=1)n[t]=o(n[t]);return n.join("")}function f(n){return/[\u0080-\uFFFF]/.test(n)&&(n=unescape(encodeURIComponent(n))),n}function c(n){var t,r=[],e=n.length;for(t=0;t<e-1;t+=2)r.push(parseInt(n.substr(t,2),16));return String.fromCharCode.apply(String,r)}function a(){this.reset()}return u(i("hello")),"undefined"==typeof ArrayBuffer||ArrayBuffer.prototype.slice||function(){function n(n,t){return(n=0|n||0)<0?Math.max(n+t,0):Math.min(n,t)}ArrayBuffer.prototype.slice=function(t,r){var e,i,o,u,f=this.byteLength,c=n(t,f),a=f;return void 0!==r&&(a=n(r,f)),c>a?new ArrayBuffer(0):(e=a-c,i=new ArrayBuffer(e),o=new Uint8Array(i),u=new Uint8Array(this,c,e),o.set(u),i)}}(),a.prototype.append=function(n){return this.appendBinary(f(n)),this},a.prototype.appendBinary=function(n){this._buff+=n,this._length+=n.length;var e,i=this._buff.length;for(e=64;e<=i;e+=64)t(this._hash,r(this._buff.substring(e-64,e)));return this._buff=this._buff.substring(e-64),this},a.prototype.end=function(n){var t,r,e=this._buff,i=e.length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)o[t>>2]|=e.charCodeAt(t)<<(t%4<<3);return this._finish(o,i),r=u(this._hash),n&&(r=c(r)),this.reset(),r},a.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},a.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash}},a.prototype.setState=function(n){return this._buff=n.buff,this._length=n.length,this._hash=n.hash,this},a.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},a.prototype._finish=function(n,r){var e,i,o,u=r;if(n[u>>2]|=128<<(u%4<<3),u>55)for(t(this._hash,n),u=0;u<16;u+=1)n[u]=0;e=(e=8*this._length).toString(16).match(/(.*?)(.{0,8})$/),i=parseInt(e[2],16),o=parseInt(e[1],16)||0,n[14]=i,n[15]=o,t(this._hash,n)},a.hash=function(n,t){return a.hashBinary(f(n),t)},a.hashBinary=function(n,t){var r=u(i(n));return t?c(r):r},(a.ArrayBuffer=function(){this.reset()}).prototype.append=function(n){var r,i,o,u,f=(i=this._buff.buffer,o=n,!0,(u=new Uint8Array(i.byteLength+o.byteLength)).set(new Uint8Array(i)),u.set(new Uint8Array(o),i.byteLength),u),c=f.length;for(this._length+=n.byteLength,r=64;r<=c;r+=64)t(this._hash,e(f.subarray(r-64,r)));return this._buff=r-64<c?new Uint8Array(f.buffer.slice(r-64)):new Uint8Array(0),this},a.ArrayBuffer.prototype.end=function(n){var t,r,e=this._buff,i=e.length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)o[t>>2]|=e[t]<<(t%4<<3);return this._finish(o,i),r=u(this._hash),n&&(r=c(r)),this.reset(),r},a.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},a.ArrayBuffer.prototype.getState=function(){var n=a.prototype.getState.call(this);return n.buff=String.fromCharCode.apply(null,new Uint8Array(n.buff)),n},a.ArrayBuffer.prototype.setState=function(n){return n.buff=function(n){var t,r=n.length,e=new ArrayBuffer(r),i=new Uint8Array(e);for(t=0;t<r;t+=1)i[t]=n.charCodeAt(t);return i}(n.buff),a.prototype.setState.call(this,n)},a.ArrayBuffer.prototype.destroy=a.prototype.destroy,a.ArrayBuffer.prototype._finish=a.prototype._finish,a.ArrayBuffer.hash=function(n,r){var i=u(function(n){var r,i,o,u,f,c,a=n.length,s=[1732584193,-271733879,-1732584194,271733878];for(r=64;r<=a;r+=64)t(s,e(n.subarray(r-64,r)));for(i=(n=r-64<a?n.subarray(r-64):new Uint8Array(0)).length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],r=0;r<i;r+=1)o[r>>2]|=n[r]<<(r%4<<3);if(o[r>>2]|=128<<(r%4<<3),r>55)for(t(s,o),r=0;r<16;r+=1)o[r]=0;return u=(u=8*a).toString(16).match(/(.*?)(.{0,8})$/),f=parseInt(u[2],16),c=parseInt(u[1],16)||0,o[14]=f,o[15]=c,t(s,o),s}(new Uint8Array(n)));return r?c(i):i},a}()}));function A(n,t,r){var e=r[r.length-1];n===e.element&&(r.pop(),e=r[r.length-1]);var i=e.element,o=e.index;Array.isArray(i)?i.push(n):o===t.length-2?i[t.pop()]=n:t.push(n)}var S,P,E=function(n){return function(){var t=arguments.length;if(t){for(var r=[],e=-1;++e<t;)r[e]=arguments[e];return n.call(this,r)}return n.call(this,[])}},B=t((function(n){n.exports="function"==typeof Object.create?function(n,t){t&&(n.super_=t,n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}))}:function(n,t){if(t){n.super_=t;var r=function(){};r.prototype=t.prototype,n.prototype=new r,n.prototype.constructor=n}}}));function x(n){return"$"+n}function D(n){return n.substring(1)}function I(){this._store={}}function N(n){if(this._store=new I,n&&Array.isArray(n))for(var t=0,r=n.length;t<r;t++)this.add(n[t])}I.prototype.get=function(n){var t=x(n);return this._store[t]},I.prototype.set=function(n,t){var r=x(n);return this._store[r]=t,!0},I.prototype.has=function(n){return x(n)in this._store},I.prototype.delete=function(n){var t=x(n),r=t in this._store;return delete this._store[t],r},I.prototype.forEach=function(n){for(var t=Object.keys(this._store),r=0,e=t.length;r<e;r++){var i=t[r];n(this._store[i],i=D(i))}},Object.defineProperty(I.prototype,"size",{get:function(){return Object.keys(this._store).length}}),N.prototype.add=function(n){return this._store.set(n,!0)},N.prototype.has=function(n){return this._store.has(n)},N.prototype.forEach=function(n){this._store.forEach((function(t,r){n(r)}))},Object.defineProperty(N.prototype,"size",{get:function(){return this._store.size}}),function(){if("undefined"==typeof Symbol||"undefined"==typeof Map||"undefined"==typeof Set)return!1;var n=Object.getOwnPropertyDescriptor(Map,Symbol.species);return n&&"get"in n&&Map[Symbol.species]===Map}()?(S=Set,P=Map):(S=N,P=I);var M,T=Function.prototype.toString,C=T.call(Object);function J(n){var t,r,e;if(!n||"object"!=typeof n)return n;if(Array.isArray(n)){for(t=[],r=0,e=n.length;r<e;r++)t[r]=J(n[r]);return t}if(n instanceof Date)return n.toISOString();if(function(n){return"undefined"!=typeof ArrayBuffer&&n instanceof ArrayBuffer||"undefined"!=typeof Blob&&n instanceof Blob}(n))return function(n){if(n instanceof ArrayBuffer)return function(n){if("function"==typeof n.slice)return n.slice(0);var t=new ArrayBuffer(n.byteLength),r=new Uint8Array(t),e=new Uint8Array(n);return r.set(e),t}(n);var t=n.size,r=n.type;return"function"==typeof n.slice?n.slice(0,t,r):n.webkitSlice(0,t,r)}(n);if(!function(n){var t=Object.getPrototypeOf(n);if(null===t)return!0;var r=t.constructor;return"function"==typeof r&&r instanceof r&&T.call(r)==C}(n))return n;for(r in t={},n)if(Object.prototype.hasOwnProperty.call(n,r)){var i=J(n[r]);void 0!==i&&(t[r]=i)}return t}function R(n){var t=!1;return E((function(r){if(t)throw new Error("once called more than once");t=!0,n.apply(this,r)}))}function U(n){return E((function(t){t=J(t);var r=this,e="function"==typeof t[t.length-1]&&t.pop(),i=new Promise((function(e,i){var o;try{var u=R((function(n,t){n?i(n):e(t)}));t.push(u),(o=n.apply(r,t))&&"function"==typeof o.then&&e(o)}catch(f){i(f)}}));return e&&i.then((function(n){e(null,n)}),e),i}))}function F(n,t){return U(E((function(r){if(this._closed)return Promise.reject(new Error("database is closed"));if(this._destroyed)return Promise.reject(new Error("database is destroyed"));var e=this;return function(n,t,r){if(n.constructor.listeners("debug").length){for(var e=["api",n.name,t],i=0;i<r.length-1;i++)e.push(r[i]);n.constructor.emit("debug",e);var o=r[r.length-1];r[r.length-1]=function(r,e){var i=["api",n.name,t];i=i.concat(r?["error",r]:["success",e]),n.constructor.emit("debug",i),o(r,e)}}}(e,n,r),this.taskqueue.isReady?t.apply(this,r):new Promise((function(t,i){e.taskqueue.addTask((function(o){o?i(o):t(e[n].apply(e,r))}))}))})))}function z(n,t){for(var r={},e=0,i=t.length;e<i;e++){var o=t[e];o in n&&(r[o]=n[o])}return r}function K(n){return n}function L(n){return[{ok:n}]}function G(n,t,r){var e=t.docs,i=new P;e.forEach((function(n){i.has(n.id)?i.get(n.id).push(n):i.set(n.id,[n])}));var o=i.size,u=0,f=new Array(o);var c=[];i.forEach((function(n,t){c.push(t)}));var a=0;!function e(){if(!(a>=c.length)){var s=Math.min(a+6,c.length),v=c.slice(a,s);!function(c,a){c.forEach((function(c,s){var v=a+s,d=i.get(c),l=z(d[0],["atts_since","attachments"]);l.open_revs=d.map((function(n){return n.rev})),l.open_revs=l.open_revs.filter(K);var h=K;0===l.open_revs.length&&(delete l.open_revs,h=L),["revs","attachments","binary","ajax","latest"].forEach((function(n){n in t&&(l[n]=t[n])})),n.get(c,l,(function(n,t){var i,a;i=n?[{error:n}]:h(t),f[v]={id:c,docs:i},++u===o&&(a=[],f.forEach((function(n){n.docs.forEach((function(t){a.push({id:n.id,docs:[t]})}))})),r(null,{results:a})),e()}))}))}(v,a),a+=v.length}}()}try{localStorage.setItem("_pouch_check_localstorage",1),M=!!localStorage.getItem("_pouch_check_localstorage")}catch(Vi){M=!1}function W(){return M}function Z(){var n;i.call(this),this._listeners={},n=this,W()&&addEventListener("storage",(function(t){n.emit(t.key)}))}function Q(n){if("undefined"!=typeof console&&"function"==typeof console[n]){var t=Array.prototype.slice.call(arguments,1);console[n].apply(console,t)}}function H(n){var t=0;return n||(t=2e3),function(n,t){return n=parseInt(n,10)||0,(t=parseInt(t,10))!=t||t<=n?t=(n||1)<<1:t+=1,t>6e5&&(n=3e5,t=6e5),~~((t-n)*Math.random()+n)}(n,t)}function Y(n,t){Q("info","The above "+n+" is totally normal. "+t)}B(Z,i),Z.prototype.addListener=function(n,t,r,e){if(!this._listeners[t]){var i=this,o=!1;this._listeners[t]=u,this.on(n,u)}function u(){if(i._listeners[t])if(o)o="waiting";else{o=!0;var n=z(e,["style","include_docs","attachments","conflicts","filter","doc_ids","view","since","query_params","binary","return_docs"]);r.changes(n).on("change",(function(n){n.seq>e.since&&!e.cancelled&&(e.since=n.seq,e.onChange(n))})).on("complete",(function(){"waiting"===o&&h(u),o=!1})).on("error",(function(){o=!1}))}}},Z.prototype.removeListener=function(n,t){t in this._listeners&&(i.prototype.removeListener.call(this,n,this._listeners[t]),delete this._listeners[t])},Z.prototype.notifyLocalWindows=function(n){W()&&(localStorage[n]="a"===localStorage[n]?"b":"a")},Z.prototype.notify=function(n){this.emit(n),this.notifyLocalWindows(n)};var V="function"==typeof Object.assign?Object.assign:function(n){for(var t=Object(n),r=1;r<arguments.length;r++){var e=arguments[r];if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])}return t};function X(n,t,r){Error.call(this,r),this.status=n,this.name=t,this.message=r,this.error=!0}B(X,Error),X.prototype.toString=function(){return JSON.stringify({status:this.status,name:this.name,message:this.message,reason:this.reason})},new X(401,"unauthorized","Name or password is incorrect.");var nn=new X(400,"bad_request","Missing JSON list of 'docs'"),tn=new X(404,"not_found","missing"),rn=new X(409,"conflict","Document update conflict"),en=new X(400,"bad_request","_id field must contain a string"),on=new X(412,"missing_id","_id is required for puts"),un=new X(400,"bad_request","Only reserved document ids may start with underscore."),fn=(new X(412,"precondition_failed","Database not open"),new X(500,"unknown_error","Database encountered an unknown error")),cn=new X(500,"badarg","Some query argument is invalid"),an=(new X(400,"invalid_request","Request was invalid"),new X(400,"query_parse_error","Some query parameter is invalid")),sn=new X(500,"doc_validation","Bad special document member"),vn=new X(400,"bad_request","Something wrong with the request"),dn=new X(400,"bad_request","Document must be a JSON object"),ln=(new X(404,"not_found","Database not found"),new X(500,"indexed_db_went_bad","unknown")),hn=(new X(500,"web_sql_went_bad","unknown"),new X(500,"levelDB_went_went_bad","unknown"),new X(403,"forbidden","Forbidden by design doc validate_doc_update function"),new X(400,"bad_request","Invalid rev format")),yn=(new X(412,"file_exists","The database could not be created, the file already exists."),new X(412,"missing_stub","A pre-existing attachment stub wasn't found"));function pn(n,t){function r(t){for(var r in n)"function"!=typeof n[r]&&(this[r]=n[r]);void 0!==t&&(this.reason=t)}return r.prototype=X.prototype,new r(t)}function bn(n){if("object"!=typeof n){var t=n;(n=fn).data=t}return"error"in n&&"conflict"===n.error&&(n.name="conflict",n.status=409),"name"in n||(n.name=n.error||"unknown"),"status"in n||(n.status=500),"message"in n||(n.message=n.message||n.reason),n}function wn(n){var t={},r=n.filter&&"function"==typeof n.filter;return t.query=n.query_params,function(e){e.doc||(e.doc={});var i=r&&function(n,t,r){try{return!n(t,r)}catch(i){var e="Filter function threw: "+i.toString();return pn(vn,e)}}(n.filter,e.doc,t);if("object"==typeof i)return i;if(i)return!1;if(n.include_docs){if(!n.attachments)for(var o in e.doc._attachments)e.doc._attachments.hasOwnProperty(o)&&(e.doc._attachments[o].stub=!0)}else delete e.doc;return!0}}function mn(n){for(var t=[],r=0,e=n.length;r<e;r++)t=t.concat(n[r]);return t}function _n(n){var t;if(n?"string"!=typeof n?t=pn(en):/^_/.test(n)&&!/^_(design|local)/.test(n)&&(t=pn(un)):t=pn(on),t)throw t}function gn(n){return"boolean"==typeof n._remote?n._remote:"function"==typeof n.type&&(Q("warn","db.type() is deprecated and will be removed in a future version of PouchDB"),"http"===n.type())}function kn(n){if(!n)return null;var t=n.split("/");return 2===t.length?t:1===t.length?[n,n]:null}function jn(n){var t=kn(n);return t?t.join("/"):null}new X(413,"invalid_url","Provided URL is invalid");var On=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],$n=/(?:^|&)([^&=]*)=?([^&]*)/g,qn=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;function An(n){for(var t=qn.exec(n),r={},e=14;e--;){var i=On[e],o=t[e]||"",u=-1!==["user","password"].indexOf(i);r[i]=u?decodeURIComponent(o):o}return r.queryKey={},r[On[12]].replace($n,(function(n,t,e){t&&(r.queryKey[t]=e)})),r}function Sn(n,t){var r=[],e=[];for(var i in t)t.hasOwnProperty(i)&&(r.push(i),e.push(t[i]));return r.push(n),Function.apply(null,r).apply(null,e)}function Pn(n,t,r){return new Promise((function(e,i){n.get(t,(function(o,u){if(o){if(404!==o.status)return i(o);u={}}var f=u._rev,c=r(u);if(!c)return e({updated:!1,rev:f});c._id=t,c._rev=f,e(function(n,t,r){return n.put(t).then((function(n){return{updated:!0,rev:n.rev}}),(function(e){if(409!==e.status)throw e;return Pn(n,t._id,r)}))}(n,c,r))}))}))}var En=function(n){return atob(n)},Bn=function(n){return btoa(n)};function xn(n,t){n=n||[],t=t||{};try{return new Blob(n,t)}catch(Vi){if("TypeError"!==Vi.name)throw Vi;for(var r=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),e=0;e<n.length;e+=1)r.append(n[e]);return r.getBlob(t.type)}}function Dn(n){for(var t=n.length,r=new ArrayBuffer(t),e=new Uint8Array(r),i=0;i<t;i++)e[i]=n.charCodeAt(i);return r}function In(n,t){return xn([Dn(n)],{type:t})}function Nn(n,t){return In(En(n),t)}function Mn(n,t){var r=new FileReader,e="function"==typeof r.readAsBinaryString;r.onloadend=function(n){var r=n.target.result||"";if(e)return t(r);t(function(n){for(var t="",r=new Uint8Array(n),e=r.byteLength,i=0;i<e;i++)t+=String.fromCharCode(r[i]);return t}(r))},e?r.readAsBinaryString(n):r.readAsArrayBuffer(n)}function Tn(n,t){Mn(n,(function(n){t(n)}))}function Cn(n,t){Tn(n,(function(n){t(Bn(n))}))}var Jn=r.setImmediate||r.setTimeout;function Rn(n,t,r,e,i){(r>0||e<t.size)&&(t=function(n,t,r){return n.webkitSlice?n.webkitSlice(t,r):n.slice(t,r)}(t,r,e)),function(n,t){var r=new FileReader;r.onloadend=function(n){var r=n.target.result||new ArrayBuffer(0);t(r)},r.readAsArrayBuffer(n)}(t,(function(t){n.append(t),i()}))}function Un(n,t,r,e,i){(r>0||e<t.length)&&(t=t.substring(r,e)),n.appendBinary(t),i()}function Fn(n,t){var r="string"==typeof n,e=r?n.length:n.size,i=Math.min(32768,e),o=Math.ceil(e/i),u=0,f=r?new q:new q.ArrayBuffer,c=r?Un:Rn;function a(){Jn(v)}function s(){var n,r=(n=f.end(!0),Bn(n));t(r),f.destroy()}function v(){var t=u*i;u++,c(f,n,t,t+i,u<o?a:s)}v()}function zn(n){return q.hash(n)}function Kn(n,t){var r=J(n);return t?(delete r._rev_tree,zn(JSON.stringify(r))):$.v4().replace(/-/g,"").toLowerCase()}var Ln=$.v4;function Gn(n){for(var t,r,e,i,o=n.rev_tree.slice();i=o.pop();){var u=i.ids,f=u[2],c=i.pos;if(f.length)for(var a=0,s=f.length;a<s;a++)o.push({pos:c+1,ids:f[a]});else{var v=!!u[1].deleted,d=u[0];t&&!(e!==v?e:r!==c?r<c:t<d)||(t=d,r=c,e=v)}}return r+"-"+t}function Wn(n,t){for(var r,e=n.slice();r=e.pop();)for(var i=r.pos,o=r.ids,u=o[2],f=t(0===u.length,i,o[0],r.ctx,o[1]),c=0,a=u.length;c<a;c++)e.push({pos:i+1,ids:u[c],ctx:f})}function Zn(n,t){return n.pos-t.pos}function Qn(n){var t=[];Wn(n,(function(n,r,e,i,o){n&&t.push({rev:r+"-"+e,pos:r,opts:o})})),t.sort(Zn).reverse();for(var r=0,e=t.length;r<e;r++)delete t[r].pos;return t}function Hn(n){for(var t=Gn(n),r=Qn(n.rev_tree),e=[],i=0,o=r.length;i<o;i++){var u=r[i];u.rev===t||u.opts.deleted||e.push(u.rev)}return e}function Yn(n){for(var t,r=[],e=n.slice();t=e.pop();){var i=t.pos,o=t.ids,u=o[0],f=o[1],c=o[2],a=0===c.length,s=t.history?t.history.slice():[];s.push({id:u,opts:f}),a&&r.push({pos:i+1-s.length,ids:s});for(var v=0,d=c.length;v<d;v++)e.push({pos:i+1,ids:c[v],history:s})}return r.reverse()}function Vn(n,t){return n.pos-t.pos}function Xn(n,t,r){var e=function(n,t,r){for(var e,i=0,o=n.length;i<o;)r(n[e=i+o>>>1],t)<0?i=e+1:o=e;return i}(n,t,r);n.splice(e,0,t)}function nt(n,t){for(var r,e,i=t,o=n.length;i<o;i++){var u=n[i],f=[u.id,u.opts,[]];e?(e[2].push(f),e=f):r=e=f}return r}function tt(n,t){return n[0]<t[0]?-1:1}function rt(n,t){for(var r=[{tree1:n,tree2:t}],e=!1;r.length>0;){var i=r.pop(),o=i.tree1,u=i.tree2;(o[1].status||u[1].status)&&(o[1].status="available"===o[1].status||"available"===u[1].status?"available":"missing");for(var f=0;f<u[2].length;f++)if(o[2][0]){for(var c=!1,a=0;a<o[2].length;a++)o[2][a][0]===u[2][f][0]&&(r.push({tree1:o[2][a],tree2:u[2][f]}),c=!0);c||(e="new_branch",Xn(o[2],u[2][f],tt))}else e="new_leaf",o[2][0]=u[2][f]}return{conflicts:e,tree:n}}function et(n,t,r){var e,i=[],o=!1,u=!1;if(!n.length)return{tree:[t],conflicts:"new_leaf"};for(var f=0,c=n.length;f<c;f++){var a=n[f];if(a.pos===t.pos&&a.ids[0]===t.ids[0])e=rt(a.ids,t.ids),i.push({pos:a.pos,ids:e.tree}),o=o||e.conflicts,u=!0;else if(!0!==r){var s=a.pos<t.pos?a:t,v=a.pos<t.pos?t:a,d=[],l=[];for(l.push({ids:s.ids,diff:v.pos-s.pos,parent:null,parentIdx:null});l.length>0;){var h=l.pop();if(0!==h.diff)for(var y=h.ids[2],p=0,b=y.length;p<b;p++)l.push({ids:y[p],diff:h.diff-1,parent:h.ids,parentIdx:p});else h.ids[0]===v.ids[0]&&d.push(h)}var w=d[0];w?(e=rt(w.ids,v.ids),w.parent[2][w.parentIdx]=e.tree,i.push({pos:s.pos,ids:s.ids}),o=o||e.conflicts,u=!0):i.push(a)}else i.push(a)}return u||i.push(t),i.sort(Vn),{tree:i,conflicts:o||"internal_node"}}function it(n,t,r){var e=et(n,t),i=function(n,t){for(var r,e,i=Yn(n),o=0,u=i.length;o<u;o++){var f,c=i[o],a=c.ids;if(a.length>t){r||(r={});var s=a.length-t;f={pos:c.pos+s,ids:nt(a,s)};for(var v=0;v<s;v++)r[c.pos+v+"-"+a[v].id]=!0}else f={pos:c.pos,ids:nt(a,0)};e=e?et(e,f,!0).tree:[f]}return r&&Wn(e,(function(n,t,e){delete r[t+"-"+e]})),{tree:e,revs:r?Object.keys(r):[]}}(e.tree,r);return{tree:i.tree,stemmedRevs:i.revs,conflicts:e.conflicts}}function ot(n){return n.ids}function ut(n,t){t||(t=Gn(n));for(var r,e=t.substring(t.indexOf("-")+1),i=n.rev_tree.map(ot);r=i.pop();){if(r[0]===e)return!!r[1].deleted;i=i.concat(r[2])}}function ft(n){return/^_local/.test(n)}function ct(n,t,r){i.call(this);var e=this;this.db=n;var o=(t=t?J(t):{}).complete=R((function(t,r){var o;t?("error",("listenerCount"in(o=e)?o.listenerCount("error"):i.listenerCount(o,"error"))>0&&e.emit("error",t)):e.emit("complete",r),e.removeAllListeners(),n.removeListener("destroyed",u)}));function u(){e.cancel()}r&&(e.on("complete",(function(n){r(null,n)})),e.on("error",r)),n.once("destroyed",u),t.onChange=function(n,t,r){e.isCancelled||function(n,t,r,e){try{n.emit("change",t,r,e)}catch(Vi){Q("error",'Error in .on("change", function):',Vi)}}(e,n,t,r)};var f=new Promise((function(n,r){t.complete=function(t,e){t?r(t):n(e)}}));e.once("cancel",(function(){n.removeListener("destroyed",u),t.complete(null,{status:"cancelled"})})),this.then=f.then.bind(f),this.catch=f.catch.bind(f),this.then((function(n){o(null,n)}),o),n.taskqueue.isReady?e.validateChanges(t):n.taskqueue.addTask((function(n){n?t.complete(n):e.isCancelled?e.emit("cancel"):e.validateChanges(t)}))}function at(n,t,r){var e=[{rev:n._rev}];"all_docs"===r.style&&(e=Qn(t.rev_tree).map((function(n){return{rev:n.rev}})));var i={id:t.id,changes:e,doc:n};return ut(t,n._rev)&&(i.deleted=!0),r.conflicts&&(i.doc._conflicts=Hn(t),i.doc._conflicts.length||delete i.doc._conflicts),i}function st(n,t){return n<t?-1:n>t?1:0}function vt(n,t){return function(r,e){r||e[0]&&e[0].error?((r=r||e[0]).docId=t,n(r)):n(null,e.length?e[0]:e)}}function dt(n,t){var r=st(n._id,t._id);return 0!==r?r:st(n._revisions?n._revisions.start:0,t._revisions?t._revisions.start:0)}function lt(){for(var n in i.call(this),lt.prototype)"function"==typeof this[n]&&(this[n]=this[n].bind(this))}function ht(){this.isReady=!1,this.failed=!1,this.queue=[]}function yt(n,t){if(!(this instanceof yt))return new yt(n,t);var r=this;if(t=t||{},n&&"object"==typeof n&&(n=(t=n).name,delete t.name),void 0===t.deterministic_revs&&(t.deterministic_revs=!0),this.__opts=t=J(t),r.auto_compaction=t.auto_compaction,r.prefix=yt.prefix,"string"!=typeof n)throw new Error("Missing/invalid DB name");var e=function(n,t){var r=n.match(/([a-z-]*):\/\/(.*)/);if(r)return{name:/https?/.test(r[1])?r[1]+"://"+r[2]:r[2],adapter:r[1]};var e=yt.adapters,i=yt.preferredAdapters,o=yt.prefix,u=t.adapter;if(!u)for(var f=0;f<i.length&&"idb"===(u=i[f])&&"websql"in e&&W()&&localStorage["_pouch__websqldb_"+o+n];++f)Q("log",'PouchDB is downgrading "'+n+'" to WebSQL to avoid data loss, because it was already opened with WebSQL.');var c=e[u];return{name:c&&"use_prefix"in c&&!c.use_prefix?n:o+n,adapter:u}}((t.prefix||"")+n,t);if(t.name=e.name,t.adapter=t.adapter||e.adapter,r.name=n,r._adapter=t.adapter,yt.emit("debug",["adapter","Picked adapter: ",t.adapter]),!yt.adapters[t.adapter]||!yt.adapters[t.adapter].valid())throw new Error("Invalid Adapter: "+t.adapter);lt.call(r),r.taskqueue=new ht,r.adapter=t.adapter,yt.adapters[t.adapter].call(r,t,(function(n){if(n)return r.taskqueue.fail(n);!function(n){function t(t){n.removeListener("closed",r),t||n.constructor.emit("destroyed",n.name)}function r(){n.removeListener("destroyed",t),n.constructor.emit("unref",n)}n.once("destroyed",t),n.once("closed",r),n.constructor.emit("ref",n)}(r),r.emit("created",r),yt.emit("created",r.name),r.taskqueue.ready(r)}))}B(ct,i),ct.prototype.cancel=function(){this.isCancelled=!0,this.db.taskqueue.isReady&&this.emit("cancel")},ct.prototype.validateChanges=function(n){var t=n.complete,r=this;yt._changesFilterPlugin?yt._changesFilterPlugin.validate(n,(function(e){if(e)return t(e);r.doChanges(n)})):r.doChanges(n)},ct.prototype.doChanges=function(n){var t=this,r=n.complete;if("live"in(n=J(n))&&!("continuous"in n)&&(n.continuous=n.live),n.processChange=at,"latest"===n.since&&(n.since="now"),n.since||(n.since=0),"now"!==n.since){if(yt._changesFilterPlugin){if(yt._changesFilterPlugin.normalize(n),yt._changesFilterPlugin.shouldFilter(this,n))return yt._changesFilterPlugin.filter(this,n)}else["doc_ids","filter","selector","view"].forEach((function(t){t in n&&Q("warn",'The "'+t+'" option was passed in to changes/replicate, but pouchdb-changes-filter plugin is not installed, so it was ignored. Please install the plugin to enable filtering.')}));"descending"in n||(n.descending=!1),n.limit=0===n.limit?1:n.limit,n.complete=r;var e=this.db._changes(n);if(e&&"function"==typeof e.cancel){var i=t.cancel;t.cancel=E((function(n){e.cancel(),i.apply(this,n)}))}}else this.db.info().then((function(e){t.isCancelled?r(null,{status:"cancelled"}):(n.since=e.update_seq,t.doChanges(n))}),r)},B(lt,i),lt.prototype.post=F("post",(function(n,t,r){if("function"==typeof t&&(r=t,t={}),"object"!=typeof n||Array.isArray(n))return r(pn(dn));this.bulkDocs({docs:[n]},t,vt(r,n._id))})),lt.prototype.put=F("put",(function(n,t,r){if("function"==typeof t&&(r=t,t={}),"object"!=typeof n||Array.isArray(n))return r(pn(dn));if(_n(n._id),ft(n._id)&&"function"==typeof this._putLocal)return n._deleted?this._removeLocal(n,r):this._putLocal(n,r);var e,i,o,u,f=this;function c(r){"function"==typeof f._put&&!1!==t.new_edits?f._put(n,t,r):f.bulkDocs({docs:[n]},t,vt(r,n._id))}t.force&&n._rev?(i=(e=n._rev.split("-"))[1],o=parseInt(e[0],10)+1,u=Kn(),n._revisions={start:o,ids:[u,i]},n._rev=o+"-"+u,t.new_edits=!1,c((function(t){r(t,t?null:{ok:!0,id:n._id,rev:n._rev})}))):c(r)})),lt.prototype.putAttachment=F("putAttachment",(function(n,t,r,e,i){var o=this;function u(n){var r="_rev"in n?parseInt(n._rev,10):0;return n._attachments=n._attachments||{},n._attachments[t]={content_type:i,data:e,revpos:++r},o.put(n)}return"function"==typeof i&&(i=e,e=r,r=null),void 0===i&&(i=e,e=r,r=null),i||Q("warn","Attachment",t,"on document",n,"is missing content_type"),o.get(n).then((function(n){if(n._rev!==r)throw pn(rn);return u(n)}),(function(t){if(t.reason===tn.message)return u({_id:n});throw t}))})),lt.prototype.removeAttachment=F("removeAttachment",(function(n,t,r,e){var i=this;i.get(n,(function(n,o){if(n)e(n);else if(o._rev===r){if(!o._attachments)return e();delete o._attachments[t],0===Object.keys(o._attachments).length&&delete o._attachments,i.put(o,e)}else e(pn(rn))}))})),lt.prototype.remove=F("remove",(function(n,t,r,e){var i;"string"==typeof t?(i={_id:n,_rev:t},"function"==typeof r&&(e=r,r={})):(i=n,"function"==typeof t?(e=t,r={}):(e=r,r=t)),(r=r||{}).was_delete=!0;var o={_id:i._id,_rev:i._rev||r.rev,_deleted:!0};if(ft(o._id)&&"function"==typeof this._removeLocal)return this._removeLocal(i,e);this.bulkDocs({docs:[o]},r,vt(e,o._id))})),lt.prototype.revsDiff=F("revsDiff",(function(n,t,r){"function"==typeof t&&(r=t,t={});var e=Object.keys(n);if(!e.length)return r(null,{});var i=0,o=new P;function u(n,t){o.has(n)||o.set(n,{missing:[]}),o.get(n).missing.push(t)}e.map((function(t){this._getRevisionTree(t,(function(f,c){if(f&&404===f.status&&"missing"===f.message)o.set(t,{missing:n[t]});else{if(f)return r(f);!function(t,r){var e=n[t].slice(0);Wn(r,(function(n,r,i,o,f){var c=r+"-"+i,a=e.indexOf(c);-1!==a&&(e.splice(a,1),"available"!==f.status&&u(t,c))})),e.forEach((function(n){u(t,n)}))}(t,c)}if(++i===e.length){var a={};return o.forEach((function(n,t){a[t]=n})),r(null,a)}}))}),this)})),lt.prototype.bulkGet=F("bulkGet",(function(n,t){G(this,n,t)})),lt.prototype.compactDocument=F("compactDocument",(function(n,t,r){var e=this;this._getRevisionTree(n,(function(i,o){if(i)return r(i);var u=function(n){var t={},r=[];return Wn(n,(function(n,e,i,o){var u=e+"-"+i;return n&&(t[u]=0),void 0!==o&&r.push({from:o,to:u}),u})),r.reverse(),r.forEach((function(n){t[n.from]=void 0===t[n.from]?1+t[n.to]:Math.min(t[n.from],1+t[n.to])})),t}(o),f=[],c=[];Object.keys(u).forEach((function(n){u[n]>t&&f.push(n)})),Wn(o,(function(n,t,r,e,i){var o=t+"-"+r;"available"===i.status&&-1!==f.indexOf(o)&&c.push(o)})),e._doCompaction(n,c,r)}))})),lt.prototype.compact=F("compact",(function(n,t){"function"==typeof n&&(t=n,n={}),n=n||{},this._compactionQueue=this._compactionQueue||[],this._compactionQueue.push({opts:n,callback:t}),1===this._compactionQueue.length&&function n(t){var r=t._compactionQueue[0],e=r.opts,i=r.callback;t.get("_local/compaction").catch((function(){return!1})).then((function(r){r&&r.last_seq&&(e.last_seq=r.last_seq),t._compact(e,(function(r,e){r?i(r):i(null,e),h((function(){t._compactionQueue.shift(),t._compactionQueue.length&&n(t)}))}))}))}(this)})),lt.prototype._compact=function(n,t){var r=this,e=[];r.changes({return_docs:!1,last_seq:n.last_seq||0}).on("change",(function(n){e.push(r.compactDocument(n.id,0))})).on("complete",(function(n){var i=n.last_seq;Promise.all(e).then((function(){return Pn(r,"_local/compaction",(function(n){return(!n.last_seq||n.last_seq<i)&&(n.last_seq=i,n)}))})).then((function(){t(null,{ok:!0})})).catch(t)})).on("error",t)},lt.prototype.get=F("get",(function(n,t,r){if("function"==typeof t&&(r=t,t={}),"string"!=typeof n)return r(pn(en));if(ft(n)&&"function"==typeof this._getLocal)return this._getLocal(n,r);var e=[],i=this;function o(){var o=[],u=e.length;if(!u)return r(null,o);e.forEach((function(e){i.get(n,{rev:e,revs:t.revs,latest:t.latest,attachments:t.attachments,binary:t.binary},(function(n,t){if(n)o.push({missing:e});else{for(var i,f=0,c=o.length;f<c;f++)if(o[f].ok&&o[f].ok._rev===t._rev){i=!0;break}i||o.push({ok:t})}--u||r(null,o)}))}))}if(!t.open_revs)return this._get(n,t,(function(e,o){if(e)return e.docId=n,r(e);var u=o.doc,f=o.metadata,c=o.ctx;if(t.conflicts){var a=Hn(f);a.length&&(u._conflicts=a)}if(ut(f,u._rev)&&(u._deleted=!0),t.revs||t.revs_info){for(var s=u._rev.split("-"),v=parseInt(s[0],10),d=s[1],l=Yn(f.rev_tree),h=null,y=0;y<l.length;y++){var p=l[y],b=p.ids.map((function(n){return n.id})).indexOf(d);(b===v-1||!h&&-1!==b)&&(h=p)}if(!h)return(e=new Error("invalid rev tree")).docId=n,r(e);var w=h.ids.map((function(n){return n.id})).indexOf(u._rev.split("-")[1])+1;if(h.ids.splice(w,h.ids.length-w),h.ids.reverse(),t.revs&&(u._revisions={start:h.pos+h.ids.length-1,ids:h.ids.map((function(n){return n.id}))}),t.revs_info){var m=h.pos+h.ids.length;u._revs_info=h.ids.map((function(n){return{rev:--m+"-"+n.id,status:n.opts.status}}))}}if(t.attachments&&u._attachments){var _=u._attachments,g=Object.keys(_).length;if(0===g)return r(null,u);Object.keys(_).forEach((function(n){this._getAttachment(u._id,n,_[n],{rev:u._rev,binary:t.binary,ctx:c},(function(t,e){var i=u._attachments[n];i.data=e,delete i.stub,delete i.length,--g||r(null,u)}))}),i)}else{if(u._attachments)for(var k in u._attachments)u._attachments.hasOwnProperty(k)&&(u._attachments[k].stub=!0);r(null,u)}}));if("all"===t.open_revs)this._getRevisionTree(n,(function(n,t){if(n)return r(n);e=Qn(t).map((function(n){return n.rev})),o()}));else{if(!Array.isArray(t.open_revs))return r(pn(fn,"function_clause"));e=t.open_revs;for(var u=0;u<e.length;u++){var f=e[u];if("string"!=typeof f||!/^\d+-/.test(f))return r(pn(hn))}o()}})),lt.prototype.getAttachment=F("getAttachment",(function(n,t,r,e){var i=this;r instanceof Function&&(e=r,r={}),this._get(n,r,(function(o,u){return o?e(o):u.doc._attachments&&u.doc._attachments[t]?(r.ctx=u.ctx,r.binary=!0,void i._getAttachment(n,t,u.doc._attachments[t],r,e)):e(pn(tn))}))})),lt.prototype.allDocs=F("allDocs",(function(n,t){if("function"==typeof n&&(t=n,n={}),n.skip=void 0!==n.skip?n.skip:0,n.start_key&&(n.startkey=n.start_key),n.end_key&&(n.endkey=n.end_key),"keys"in n){if(!Array.isArray(n.keys))return t(new TypeError("options.keys must be an array"));var r=["startkey","endkey","key"].filter((function(t){return t in n}))[0];if(r)return void t(pn(an,"Query parameter `"+r+"` is not compatible with multi-get"));if(!gn(this)&&(function(n){var t="limit"in n?n.keys.slice(n.skip,n.limit+n.skip):n.skip>0?n.keys.slice(n.skip):n.keys;n.keys=t,n.skip=0,delete n.limit,n.descending&&(t.reverse(),n.descending=!1)}(n),0===n.keys.length))return this._allDocs({limit:0},t)}return this._allDocs(n,t)})),lt.prototype.changes=function(n,t){return"function"==typeof n&&(t=n,n={}),(n=n||{}).return_docs="return_docs"in n?n.return_docs:!n.live,new ct(this,n,t)},lt.prototype.close=F("close",(function(n){return this._closed=!0,this.emit("closed"),this._close(n)})),lt.prototype.info=F("info",(function(n){var t=this;this._info((function(r,e){if(r)return n(r);e.db_name=e.db_name||t.name,e.auto_compaction=!(!t.auto_compaction||gn(t)),e.adapter=t.adapter,n(null,e)}))})),lt.prototype.id=F("id",(function(n){return this._id(n)})),lt.prototype.type=function(){return"function"==typeof this._type?this._type():this.adapter},lt.prototype.bulkDocs=F("bulkDocs",(function(n,t,r){if("function"==typeof t&&(r=t,t={}),t=t||{},Array.isArray(n)&&(n={docs:n}),!n||!n.docs||!Array.isArray(n.docs))return r(pn(nn));for(var e=0;e<n.docs.length;++e)if("object"!=typeof n.docs[e]||Array.isArray(n.docs[e]))return r(pn(dn));var i;if(n.docs.forEach((function(n){n._attachments&&Object.keys(n._attachments).forEach((function(t){i=i||function(n){return"_"===n.charAt(0)&&n+" is not a valid attachment name, attachment names cannot start with '_'"}(t),n._attachments[t].content_type||Q("warn","Attachment",t,"on document",n._id,"is missing content_type")}))})),i)return r(pn(vn,i));"new_edits"in t||(t.new_edits=!("new_edits"in n)||n.new_edits);var o=this;t.new_edits||gn(o)||n.docs.sort(dt),function(n){for(var t=0;t<n.length;t++){var r=n[t];if(r._deleted)delete r._attachments;else if(r._attachments)for(var e=Object.keys(r._attachments),i=0;i<e.length;i++){var o=e[i];r._attachments[o]=z(r._attachments[o],["data","digest","content_type","length","revpos","stub"])}}}(n.docs);var u=n.docs.map((function(n){return n._id}));return this._bulkDocs(n,t,(function(n,e){if(n)return r(n);if(t.new_edits||(e=e.filter((function(n){return n.error}))),!gn(o))for(var i=0,f=e.length;i<f;i++)e[i].id=e[i].id||u[i];r(null,e)}))})),lt.prototype.registerDependentDatabase=F("registerDependentDatabase",(function(n,t){var r=new this.constructor(n,this.__opts);Pn(this,"_local/_pouch_dependentDbs",(function(t){return t.dependentDbs=t.dependentDbs||{},!t.dependentDbs[n]&&(t.dependentDbs[n]=!0,t)})).then((function(){t(null,{db:r})})).catch(t)})),lt.prototype.destroy=F("destroy",(function(n,t){"function"==typeof n&&(t=n,n={});var r=this,e=!("use_prefix"in r)||r.use_prefix;function i(){r._destroy(n,(function(n,e){if(n)return t(n);r._destroyed=!0,r.emit("destroyed"),t(null,e||{ok:!0})}))}if(gn(r))return i();r.get("_local/_pouch_dependentDbs",(function(n,o){if(n)return 404!==n.status?t(n):i();var u=r.constructor,f=Object.keys(o.dependentDbs).map((function(n){var t=e?n.replace(new RegExp("^"+u.prefix),""):n;return new u(t,r.__opts).destroy()}));Promise.all(f).then(i,t)}))})),ht.prototype.execute=function(){var n;if(this.failed)for(;n=this.queue.shift();)n(this.failed);else for(;n=this.queue.shift();)n()},ht.prototype.fail=function(n){this.failed=n,this.execute()},ht.prototype.ready=function(n){this.isReady=!0,this.db=n,this.execute()},ht.prototype.addTask=function(n){this.queue.push(n),this.failed&&this.execute()},B(yt,lt);var pt="undefined"!=typeof AbortController?AbortController:function(){return{abort:function(){}}},bt=fetch,wt=Headers;yt.adapters={},yt.preferredAdapters=[],yt.prefix="_pouch_";var mt=new i;function _t(n,t){for(var r=n,e=0,i=t.length;e<i&&(r=r[t[e]]);e++);return r}function gt(n){for(var t=[],r="",e=0,i=n.length;e<i;e++){var o=n[e];"."===o?e>0&&"\\"===n[e-1]?r=r.substring(0,r.length-1)+".":(t.push(r),r=""):r+=o}return t.push(r),t}!function(n){Object.keys(i.prototype).forEach((function(t){"function"==typeof i.prototype[t]&&(n[t]=mt[t].bind(mt))}));var t=n._destructionListeners=new P;n.on("ref",(function(n){t.has(n.name)||t.set(n.name,[]),t.get(n.name).push(n)})),n.on("unref",(function(n){if(t.has(n.name)){var r=t.get(n.name),e=r.indexOf(n);e<0||(r.splice(e,1),r.length>1?t.set(n.name,r):t.delete(n.name))}})),n.on("destroyed",(function(n){if(t.has(n)){var r=t.get(n);t.delete(n),r.forEach((function(n){n.emit("destroyed",!0)}))}}))}(yt),yt.adapter=function(n,t,r){t.valid()&&(yt.adapters[n]=t,r&&yt.preferredAdapters.push(n))},yt.plugin=function(n){if("function"==typeof n)n(yt);else{if("object"!=typeof n||0===Object.keys(n).length)throw new Error('Invalid plugin: got "'+n+'", expected an object or a function');Object.keys(n).forEach((function(t){yt.prototype[t]=n[t]}))}return this.__defaults&&(yt.__defaults=V({},this.__defaults)),yt},yt.defaults=function(n){function t(n,r){if(!(this instanceof t))return new t(n,r);r=r||{},n&&"object"==typeof n&&(n=(r=n).name,delete r.name),r=V({},t.__defaults,r),yt.call(this,n,r)}return B(t,yt),t.preferredAdapters=yt.preferredAdapters.slice(),Object.keys(yt).forEach((function(n){n in t||(t[n]=yt[n])})),t.__defaults=V({},this.__defaults,n),t},yt.fetch=function(n,t){return bt(n,t)};var kt=["$or","$nor","$not"];function jt(n){return kt.indexOf(n)>-1}function Ot(n){return Object.keys(n)[0]}function $t(n){var t={};return n.forEach((function(n){Object.keys(n).forEach((function(r){var e=n[r];if("object"!=typeof e&&(e={$eq:e}),jt(r))t[r]=e instanceof Array?e.map((function(n){return $t([n])})):$t([e]);else{var i=t[r]=t[r]||{};Object.keys(e).forEach((function(n){var t=e[n];return"$gt"===n||"$gte"===n?function(n,t,r){void 0===r.$eq&&(void 0!==r.$gte?"$gte"===n?t>r.$gte&&(r.$gte=t):t>=r.$gte&&(delete r.$gte,r.$gt=t):void 0!==r.$gt?"$gte"===n?t>r.$gt&&(delete r.$gt,r.$gte=t):t>r.$gt&&(r.$gt=t):r[n]=t)}(n,t,i):"$lt"===n||"$lte"===n?function(n,t,r){void 0===r.$eq&&(void 0!==r.$lte?"$lte"===n?t<r.$lte&&(r.$lte=t):t<=r.$lte&&(delete r.$lte,r.$lt=t):void 0!==r.$lt?"$lte"===n?t<r.$lt&&(delete r.$lt,r.$lte=t):t<r.$lt&&(r.$lt=t):r[n]=t)}(n,t,i):"$ne"===n?function(n,t){"$ne"in t?t.$ne.push(n):t.$ne=[n]}(t,i):"$eq"===n?function(n,t){delete t.$gt,delete t.$gte,delete t.$lt,delete t.$lte,delete t.$ne,t.$eq=n}(t,i):void(i[n]=t)}))}}))})),t}function qt(n){var t=J(n),r=!1;(function n(t,r){for(var e in t){"$and"===e&&(r=!0);var i=t[e];"object"==typeof i&&(r=n(i,r))}return r})(t,!1)&&("$and"in(t=function n(t){for(var r in t){if(Array.isArray(t))for(var e in t)t[e].$and&&(t[e]=$t(t[e].$and));var i=t[r];"object"==typeof i&&n(i)}return t}(t))&&(t=$t(t.$and)),r=!0),["$or","$nor"].forEach((function(n){n in t&&t[n].forEach((function(n){for(var t=Object.keys(n),r=0;r<t.length;r++){var e=t[r],i=n[e];"object"==typeof i&&null!==i||(n[e]={$eq:i})}}))})),"$not"in t&&(t.$not=$t([t.$not]));for(var e=Object.keys(t),i=0;i<e.length;i++){var o=e[i],u=t[o];"object"!=typeof u||null===u?u={$eq:u}:"$ne"in u&&!r&&(u.$ne=[u.$ne]),t[o]=u}return t}function At(n,t){if(n===t)return 0;n=St(n),t=St(t);var r=xt(n),e=xt(t);if(r-e!=0)return r-e;switch(typeof n){case"number":return n-t;case"boolean":return n<t?-1:1;case"string":return function(n,t){return n===t?0:n>t?1:-1}(n,t)}return Array.isArray(n)?function(n,t){for(var r=Math.min(n.length,t.length),e=0;e<r;e++){var i=At(n[e],t[e]);if(0!==i)return i}return n.length===t.length?0:n.length>t.length?1:-1}(n,t):function(n,t){for(var r=Object.keys(n),e=Object.keys(t),i=Math.min(r.length,e.length),o=0;o<i;o++){var u=At(r[o],e[o]);if(0!==u)return u;if(0!==(u=At(n[r[o]],t[e[o]])))return u}return r.length===e.length?0:r.length>e.length?1:-1}(n,t)}function St(n){switch(typeof n){case"undefined":return null;case"number":return n===1/0||n===-1/0||isNaN(n)?null:n;case"object":var t=n;if(Array.isArray(n)){var r=n.length;n=new Array(r);for(var e=0;e<r;e++)n[e]=St(t[e])}else{if(n instanceof Date)return n.toJSON();if(null!==n)for(var i in n={},t)if(t.hasOwnProperty(i)){var o=t[i];void 0!==o&&(n[i]=St(o))}}}return n}function Pt(n){return xt(n=St(n))+""+function(n){if(null!==n)switch(typeof n){case"boolean":return n?1:0;case"number":return function(n){if(0===n)return"1";var t,r=n.toExponential().split(/e\+?/),e=parseInt(r[1],10),i=n<0,o=i?"0":"2";o+=""+("0",3,function(n){for(var t="",r=3-n.length;t.length<r;)t+="0";return t}(t=((i?-e:e)- -324).toString())+t);var u=Math.abs(parseFloat(r[0]));i&&(u=10-u);var f=u.toFixed(20);return o+""+(f=f.replace(/\.?0+$/,""))}(n);case"string":return n.replace(/\u0002/g,"").replace(/\u0001/g,"").replace(/\u0000/g,"");case"object":var t=Array.isArray(n),r=t?n:Object.keys(n),e=-1,i=r.length,o="";if(t)for(;++e<i;)o+=Pt(r[e]);else for(;++e<i;){var u=r[e];o+=Pt(u)+Pt(n[u])}return o}return""}(n)+"\0"}function Et(n,t){var r,e=t;if("1"===n[t])r=0,t++;else{var i="0"===n[t];t++;var o="",u=n.substring(t,t+3),f=parseInt(u,10)+-324;for(i&&(f=-f),t+=3;;){var c=n[t];if("\0"===c)break;o+=c,t++}r=1===(o=o.split(".")).length?parseInt(o,10):parseFloat(o[0]+"."+o[1]),i&&(r-=10),0!==f&&(r=parseFloat(r+"e"+f))}return{num:r,length:t-e}}function Bt(n,t){var r=n.pop();if(t.length){var e=t[t.length-1];r===e.element&&(t.pop(),e=t[t.length-1]);var i=e.element,o=e.index;Array.isArray(i)?i.push(r):o===n.length-2?i[n.pop()]=r:n.push(r)}}function xt(n){var t=["boolean","number","string","object"].indexOf(typeof n);return~t?null===n?1:Array.isArray(n)?5:t<3?t+2:t+3:Array.isArray(n)?5:void 0}function Dt(n,t,r){return r.every((function(r){var e=t[r],i=gt(r),o=_t(n,i);return jt(r)?function(n,t,r){return"$or"===n?t.some((function(n){return Dt(r,n,Object.keys(n))})):"$not"===n?!Dt(r,t,Object.keys(t)):!t.find((function(n){return Dt(r,n,Object.keys(n))}))}(r,e,n):It(e,n,i,o)}))}function It(n,t,r,e){return!n||("object"==typeof n?Object.keys(n).every((function(i){return function(n,t,r,e,i){if(!Ct[n])throw new Error('unknown operator "'+n+'" - should be one of $eq, $lte, $lt, $gt, $gte, $exists, $ne, $in, $nin, $size, $mod, $regex, $elemMatch, $type, $allMatch or $all');return Ct[n](t,r,e,i)}(i,t,n[i],r,e)})):n===e)}function Nt(n){return null!=n}function Mt(n){return void 0!==n}function Tt(n,t){return t.some((function(t){return n instanceof Array?n.indexOf(t)>-1:n===t}))}var Ct={$elemMatch:function(n,t,r,e){return!!Array.isArray(e)&&0!==e.length&&e.some("object"==typeof e[0]?function(n){return Dt(n,t,Object.keys(t))}:function(e){return It(t,n,r,e)})},$allMatch:function(n,t,r,e){return!!Array.isArray(e)&&0!==e.length&&e.every("object"==typeof e[0]?function(n){return Dt(n,t,Object.keys(t))}:function(e){return It(t,n,r,e)})},$eq:function(n,t,r,e){return Mt(e)&&0===At(e,t)},$gte:function(n,t,r,e){return Mt(e)&&At(e,t)>=0},$gt:function(n,t,r,e){return Mt(e)&&At(e,t)>0},$lte:function(n,t,r,e){return Mt(e)&&At(e,t)<=0},$lt:function(n,t,r,e){return Mt(e)&&At(e,t)<0},$exists:function(n,t,r,e){return t?Mt(e):!Mt(e)},$mod:function(n,t,r,e){return Nt(e)&&function(n,t){var r=t[0],e=t[1];if(0===r)throw new Error("Bad divisor, cannot divide by zero");if(parseInt(r,10)!==r)throw new Error("Divisor is not an integer");if(parseInt(e,10)!==e)throw new Error("Modulus is not an integer");return parseInt(n,10)===n&&n%r===e}(e,t)},$ne:function(n,t,r,e){return t.every((function(n){return 0!==At(e,n)}))},$in:function(n,t,r,e){return Nt(e)&&Tt(e,t)},$nin:function(n,t,r,e){return Nt(e)&&!Tt(e,t)},$size:function(n,t,r,e){return Nt(e)&&function(n,t){return n.length===t}(e,t)},$all:function(n,t,r,e){return Array.isArray(e)&&function(n,t){return t.every((function(t){return n.indexOf(t)>-1}))}(e,t)},$regex:function(n,t,r,e){return Nt(e)&&function(n,t){return new RegExp(t).test(n)}(e,t)},$type:function(n,t,r,e){return function(n,t){switch(t){case"null":return null===n;case"boolean":return"boolean"==typeof n;case"number":return"number"==typeof n;case"string":return"string"==typeof n;case"array":return n instanceof Array;case"object":return"[object Object]"==={}.toString.call(n)}throw new Error(t+" not supported as a type.Please use one of object, string, array, number, boolean or null.")}(e,t)}};function Jt(n,t){if(n.selector&&n.filter&&"_selector"!==n.filter)return t(new Error('selector invalid for filter "'+("string"==typeof n.filter?n.filter:"function")+'"'));t()}function Rt(n){n.view&&!n.filter&&(n.filter="_view"),n.selector&&!n.filter&&(n.filter="_selector"),n.filter&&"string"==typeof n.filter&&("_view"===n.filter?n.view=jn(n.view):n.filter=jn(n.filter))}function Ut(n,t){return t.filter&&"string"==typeof t.filter&&!t.doc_ids&&!gn(n.db)}function Ft(n,t){var r=t.complete;if("_view"===t.filter){if(!t.view||"string"!=typeof t.view){var e=pn(vn,"`view` filter parameter not found or invalid.");return r(e)}var i=kn(t.view);n.db.get("_design/"+i[0],(function(e,o){if(n.isCancelled)return r(null,{status:"cancelled"});if(e)return r(bn(e));var u=o&&o.views&&o.views[i[1]]&&o.views[i[1]].map;if(!u)return r(pn(tn,o.views?"missing json key: "+i[1]:"missing json key: views"));t.filter=Sn(["return function(doc) {",'  "use strict";',"  var emitted = false;","  var emit = function (a, b) {","    emitted = true;","  };","  var view = "+u+";","  view(doc);","  if (emitted) {","    return true;","  }","};"].join("\n"),{}),n.doChanges(t)}))}else if(t.selector)t.filter=function(n){return function(n,t){if("object"!=typeof t)throw new Error("Selector error: expected a JSON object");var r=function(n,t,r){if(n=n.filter((function(n){return Dt(n.doc,t.selector,r)})),t.sort){var e=function(n){function t(t){return n.map((function(n){var r=gt(Ot(n));return _t(t,r)}))}return function(n,r){var e,i,o=At(t(n.doc),t(r.doc));return 0!==o?o:(e=n.doc._id)<(i=r.doc._id)?-1:e>i?1:0}}(t.sort);n=n.sort(e),"string"!=typeof t.sort[0]&&"desc"===(i=t.sort[0])[Ot(i)]&&(n=n.reverse())}var i;if("limit"in t||"skip"in t){var o=t.skip||0;n=n.slice(o,("limit"in t?t.limit:n.length)+o)}return n}([{doc:n}],{selector:t=qt(t)},Object.keys(t));return r&&1===r.length}(n,t.selector)},n.doChanges(t);else{var o=kn(t.filter);n.db.get("_design/"+o[0],(function(e,i){if(n.isCancelled)return r(null,{status:"cancelled"});if(e)return r(bn(e));var u=i&&i.filters&&i.filters[o[1]];if(!u)return r(pn(tn,i&&i.filters?"missing json key: "+o[1]:"missing json key: filters"));t.filter=Sn('"use strict";\nreturn '+u+";",{}),n.doChanges(t)}))}}function zt(n){return n.reduce((function(n,t){return n[t]=!0,n}),{})}yt.plugin((function(n){n._changesFilterPlugin={validate:Jt,normalize:Rt,shouldFilter:Ut,filter:Ft}})),yt.version="7.2.1";var Kt=zt(["_id","_rev","_attachments","_deleted","_revisions","_revs_info","_conflicts","_deleted_conflicts","_local_seq","_rev_tree","_replication_id","_replication_state","_replication_state_time","_replication_state_reason","_replication_stats","_removed"]),Lt=zt(["_attachments","_replication_id","_replication_state","_replication_state_time","_replication_state_reason","_replication_stats"]);function Gt(n){if(!/^\d+-/.test(n))return pn(hn);var t=n.indexOf("-"),r=n.substring(0,t),e=n.substring(t+1);return{prefix:parseInt(r,10),id:e}}function Wt(n,t,r){var e,i,o;r||(r={deterministic_revs:!0});var u={status:"available"};if(n._deleted&&(u.deleted=!0),t)if(n._id||(n._id=Ln()),i=Kn(n,r.deterministic_revs),n._rev){if((o=Gt(n._rev)).error)return o;n._rev_tree=[{pos:o.prefix,ids:[o.id,{status:"missing"},[[i,u,[]]]]}],e=o.prefix+1}else n._rev_tree=[{pos:1,ids:[i,u,[]]}],e=1;else if(n._revisions&&(n._rev_tree=function(n,t){for(var r=n.start-n.ids.length+1,e=n.ids,i=[e[0],t,[]],o=1,u=e.length;o<u;o++)i=[e[o],{status:"missing"},[i]];return[{pos:r,ids:i}]}(n._revisions,u),e=n._revisions.start,i=n._revisions.ids[0]),!n._rev_tree){if((o=Gt(n._rev)).error)return o;n._rev_tree=[{pos:e=o.prefix,ids:[i=o.id,u,[]]}]}_n(n._id),n._rev=e+"-"+i;var f={metadata:{},data:{}};for(var c in n)if(Object.prototype.hasOwnProperty.call(n,c)){var a="_"===c[0];if(a&&!Kt[c]){var s=pn(sn,c);throw s.message=sn.message+": "+c,s}a&&!Lt[c]?f.metadata[c.slice(1)]=n[c]:f.data[c]=n[c]}return f}function Zt(n,t,r){if(n.stub)return r();"string"==typeof n.data?function(n,t,r){var e=function(n){try{return En(n)}catch(Vi){return{error:pn(cn,"Attachment is not a valid base64 string")}}}(n.data);if(e.error)return r(e.error);n.length=e.length,n.data="blob"===t?In(e,n.content_type):"base64"===t?Bn(e):e,Fn(e,(function(t){n.digest="md5-"+t,r()}))}(n,t,r):function(n,t,r){Fn(n.data,(function(e){n.digest="md5-"+e,n.length=n.data.size||n.data.length||0,"binary"===t?Tn(n.data,(function(t){n.data=t,r()})):"base64"===t?Cn(n.data,(function(t){n.data=t,r()})):r()}))}(n,t,r)}function Qt(n,t,r,e,i,o,u,f,c){n=n||1e3;var a=f.new_edits,s=new P,v=0,d=t.length;function l(){++v===d&&c&&c()}t.forEach((function(n,t){if(n._id&&ft(n._id))r[n._deleted?"_removeLocal":"_putLocal"](n,{ctx:i},(function(n,r){o[t]=n||r,l()}));else{var e=n.metadata.id;s.has(e)?(d--,s.get(e).push([n,t])):s.set(e,[[n,t]])}})),s.forEach((function(t,r){var i=0;function c(){++i<t.length?s():l()}function s(){var s=t[i],v=s[0],d=s[1];if(e.has(r))!function(n,t,r,e,i,o,u,f){if(function(n,t){for(var r,e=n.slice(),i=t.split("-"),o=parseInt(i[0],10),u=i[1];r=e.pop();){if(r.pos===o&&r.ids[0]===u)return!0;for(var f=r.ids[2],c=0,a=f.length;c<a;c++)e.push({pos:r.pos+1,ids:f[c]})}return!1}(t.rev_tree,r.metadata.rev)&&!f)return e[i]=r,o();var c=t.winningRev||Gn(t),a="deleted"in t?t.deleted:ut(t,c),s="deleted"in r.metadata?r.metadata.deleted:ut(r.metadata),v=/^1-/.test(r.metadata.rev);if(a&&!s&&f&&v){var d=r.data;d._rev=c,d._id=r.metadata.id,r=Wt(d,f)}var l=it(t.rev_tree,r.metadata.rev_tree[0],n);if(f&&(a&&s&&"new_leaf"!==l.conflicts||!a&&"new_leaf"!==l.conflicts||a&&!s&&"new_branch"===l.conflicts)){var h=pn(rn);return e[i]=h,o()}var y=r.metadata.rev;r.metadata.rev_tree=l.tree,r.stemmedRevs=l.stemmedRevs||[],t.rev_map&&(r.metadata.rev_map=t.rev_map);var p=Gn(r.metadata),b=ut(r.metadata,p),w=a===b?0:a<b?-1:1;u(r,p,b,y===p?b:ut(r.metadata,y),!0,w,i,o)}(n,e.get(r),v,o,d,c,u,a);else{var l=it([],v.metadata.rev_tree[0],n);v.metadata.rev_tree=l.tree,v.stemmedRevs=l.stemmedRevs||[],function(n,t,r){var e=Gn(n.metadata),i=ut(n.metadata,e);if("was_delete"in f&&i)return o[t]=pn(tn,"deleted"),r();if(a&&function(n){return"missing"===n.metadata.rev_tree[0].ids[1].status}(n)){var c=pn(rn);return o[t]=c,r()}u(n,e,i,i,!1,i?0:1,t,r)}(v,d,c)}}s()}))}var Ht="document-store",Yt="meta-store";function Vt(n){try{return JSON.stringify(n)}catch(Vi){return function(n){var t=[];t.push({obj:n});for(var r,e,i,o,u,f,c,a,s,v="";r=t.pop();)if(e=r.obj,v+=r.prefix||"",i=r.val||"")v+=i;else if("object"!=typeof e)v+=void 0===e?null:JSON.stringify(e);else if(null===e)v+="null";else if(Array.isArray(e)){for(t.push({val:"]"}),o=e.length-1;o>=0;o--)t.push({obj:e[o],prefix:0===o?"":","});t.push({val:"["})}else{for(f in u=[],e)e.hasOwnProperty(f)&&u.push(f);for(t.push({val:"}"}),o=u.length-1;o>=0;o--)a=e[c=u[o]],s=o>0?",":"",s+=JSON.stringify(c)+":",t.push({obj:a,prefix:s});t.push({val:"{"})}return v}(n)}}function Xt(n){return function(t){var r="unknown_error";t.target&&t.target.error&&(r=t.target.error.name||t.target.error.message),n(pn(ln,r))}}function nr(n,t,r){return{data:Vt(n),winningRev:t,deletedOrLocal:r?"1":"0",seq:n.seq,id:n.id}}function tr(n){if(!n)return null;var t=function(n){try{return JSON.parse(n)}catch(Vi){return function(n){for(var t,r,e,i,o,u,f,c,a,s=[],v=[],d=0;;)if("}"!==(t=n[d++])&&"]"!==t&&void 0!==t)switch(t){case" ":case"\t":case"\n":case":":case",":break;case"n":d+=3,A(null,s,v);break;case"t":d+=3,A(!0,s,v);break;case"f":d+=4,A(!1,s,v);break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"-":for(r="",d--;;){if(e=n[d++],!/[\d\.\-e\+]/.test(e)){d--;break}r+=e}A(parseFloat(r),s,v);break;case'"':for(i="",o=void 0,u=0;'"'!==(f=n[d++])||"\\"===o&&u%2==1;)i+=f,"\\"===(o=f)?u++:u=0;A(JSON.parse('"'+i+'"'),s,v);break;case"[":s.push((c={element:[],index:s.length}).element),v.push(c);break;case"{":s.push((a={element:{},index:s.length}).element),v.push(a);break;default:throw new Error("unexpectedly reached end of input: "+t)}else{if(1===s.length)return s.pop();A(s.pop(),s,v)}}(n)}}(n.data);return t.winningRev=n.winningRev,t.deleted="1"===n.deletedOrLocal,t.seq=n.seq,t}function rr(n){if(!n)return n;var t=n._doc_id_rev.lastIndexOf(":");return n._id=n._doc_id_rev.substring(0,t-1),n._rev=n._doc_id_rev.substring(t+1),delete n._doc_id_rev,n}function er(n,t,r,e){r?e(n?"string"!=typeof n?n:Nn(n,t):xn([""],{type:t})):n?"string"!=typeof n?Mn(n,(function(n){e(Bn(n))})):e(n):e("")}function ir(n,t,r,e){var i=Object.keys(n._attachments||{});if(!i.length)return e&&e();var o=0;function u(){++o===i.length&&e&&e()}i.forEach((function(e){t.attachments&&t.include_docs?function(n,t){var e=n._attachments[t],i=e.digest;r.objectStore("attach-store").get(i).onsuccess=function(n){e.body=n.target.result.body,u()}}(n,e):(n._attachments[e].stub=!0,u())}))}function or(n,t){return Promise.all(n.map((function(n){if(n.doc&&n.doc._attachments){var r=Object.keys(n.doc._attachments);return Promise.all(r.map((function(r){var e=n.doc._attachments[r];if("body"in e){var i=e.body,o=e.content_type;return new Promise((function(u){er(i,o,t,(function(t){n.doc._attachments[r]=V(z(e,["digest","content_type"]),{data:t}),u()}))}))}})))}})))}function ur(n,t,r){var e=[],i=r.objectStore("by-sequence"),o=r.objectStore("attach-store"),u=r.objectStore("attach-seq-store"),f=n.length;function c(){--f||e.length&&e.forEach((function(n){u.index("digestSeq").count(IDBKeyRange.bound(n+"::",n+"::￿",!1,!1)).onsuccess=function(t){t.target.result||o.delete(n)}}))}n.forEach((function(n){i.index("_doc_id_rev").getKey(t+"::"+n).onsuccess=function(n){var t=n.target.result;if("number"!=typeof t)return c();i.delete(t),u.index("seq").openCursor(IDBKeyRange.only(t)).onsuccess=function(n){var t=n.target.result;if(t){var r=t.value.digestSeq.split("::")[0];e.push(r),u.delete(t.primaryKey),t.continue()}else c()}}}))}function fr(n,t,r){try{return{txn:n.transaction(t,r)}}catch(e){return{error:e}}}var cr=new Z;function ar(n,t,r,e,i){var o,u,f;function c(n){u=n.target.result,o&&i(o,u,f)}function a(n){o=n.target.result,u&&i(o,u,f)}function s(n){var t=n.target.result;if(!t)return i();i([t.key],[t.value],t)}-1===e&&(e=1e3),"function"==typeof n.getAll&&"function"==typeof n.getAllKeys&&e>1&&!r?(f={continue:function(){if(!o.length)return i();var r,f=o[o.length-1];if(t&&t.upper)try{r=IDBKeyRange.bound(f,t.upper,!0,t.upperOpen)}catch(Vi){if("DataError"===Vi.name&&0===Vi.code)return i()}else r=IDBKeyRange.lowerBound(f,!0);o=null,u=null,n.getAll(t=r,e).onsuccess=c,n.getAllKeys(t,e).onsuccess=a}},n.getAll(t,e).onsuccess=c,n.getAllKeys(t,e).onsuccess=a):r?n.openCursor(t,"prev").onsuccess=s:n.openCursor(t).onsuccess=s}var sr=!1,vr=[];function dr(){!sr&&vr.length&&(sr=!0,vr.shift()())}var lr,hr=new P,yr=new P;function pr(n,t){var r=this;!function(t,e,i){vr.push((function(){(function(n,t,r){var e=t.name,i=null;function o(n,t){var r=n.objectStore(Ht);r.createIndex("deletedOrLocal","deletedOrLocal",{unique:!1}),r.openCursor().onsuccess=function(n){var e=n.target.result;if(e){var i=e.value,o=ut(i);i.deletedOrLocal=o?"1":"0",r.put(i),e.continue()}else t()}}function u(n,t){var r=n.objectStore("local-store"),e=n.objectStore(Ht),i=n.objectStore("by-sequence");e.openCursor().onsuccess=function(n){var o=n.target.result;if(o){var u=o.value,f=u.id,c=ft(f),a=Gn(u);if(c){var s=f+"::"+a,v=f+"::",d=f+"::~",l=i.index("_doc_id_rev"),h=IDBKeyRange.bound(v,d,!1,!1),y=l.openCursor(h);y.onsuccess=function(n){if(y=n.target.result){var t=y.value;t._doc_id_rev===s&&r.put(t),i.delete(y.primaryKey),y.continue()}else e.delete(o.primaryKey),o.continue()}}else o.continue()}else t&&t()}}function f(n,t){var r=n.objectStore("by-sequence"),e=n.objectStore("attach-store"),i=n.objectStore("attach-seq-store");e.count().onsuccess=function(n){if(!n.target.result)return t();r.openCursor().onsuccess=function(n){var r=n.target.result;if(!r)return t();for(var e=r.value,o=r.primaryKey,u=Object.keys(e._attachments||{}),f={},c=0;c<u.length;c++)f[e._attachments[u[c]].digest]=!0;var a=Object.keys(f);for(c=0;c<a.length;c++)i.put({seq:o,digestSeq:a[c]+"::"+o});r.continue()}}}function c(n){var t=n.objectStore("by-sequence"),r=n.objectStore(Ht);r.openCursor().onsuccess=function(n){var e=n.target.result;if(e){var i,o=(i=e.value).data?tr(i):(i.deleted="1"===i.deletedOrLocal,i);if(o.winningRev=o.winningRev||Gn(o),o.seq)return u();!function(){var n=o.id+"::",r=o.id+"::￿",e=t.index("_doc_id_rev").openCursor(IDBKeyRange.bound(n,r)),i=0;e.onsuccess=function(n){var t=n.target.result;if(!t)return o.seq=i,u();var r=t.primaryKey;r>i&&(i=r),t.continue()}}()}function u(){var n=nr(o,o.winningRev,o.deleted);r.put(n).onsuccess=function(){e.continue()}}}}n._meta=null,n._remote=!1,n.type=function(){return"idb"},n._id=U((function(t){t(null,n._meta.instanceId)})),n._bulkDocs=function(r,e,o){!function(n,t,r,e,i,o){for(var u,f,c,a,s,v,d,l,h=t.docs,y=0,p=h.length;y<p;y++){var b=h[y];b._id&&ft(b._id)||(b=h[y]=Wt(b,r.new_edits,n)).error&&!d&&(d=b)}if(d)return o(d);var w=!1,m=0,_=new Array(h.length),g=new P,k=!1;function j(){w=!0,O()}function O(){l&&w&&(l.docCount+=m,v.put(l))}function $(){k||(cr.notify(e._meta.name),o(null,_))}function q(n,t,r,e,i,o,u,f){n.metadata.winningRev=t,n.metadata.deleted=r;var c=n.data;if(c._id=n.metadata.id,c._rev=n.metadata.rev,e&&(c._deleted=!0),c._attachments&&Object.keys(c._attachments).length)return function(n,t,r,e,i,o){var u=0,f=Object.keys(n.data._attachments);function c(){u===f.length&&A(n,t,r,e,i,o)}function s(){u++,c()}f.forEach((function(r){var e=n.data._attachments[r];if(e.stub)u++,c();else{var i=e.data;delete e.data,e.revpos=parseInt(t,10),function(n,t,r){a.count(n).onsuccess=function(e){if(e.target.result)return r();a.put({digest:n,body:t}).onsuccess=r}}(e.digest,i,s)}}))}(n,t,r,i,u,f);m+=o,O(),A(n,t,r,i,u,f)}function A(n,t,r,i,o,a){var v=n.data,d=n.metadata;function l(o){var c=n.stemmedRevs||[];i&&e.auto_compaction&&(c=c.concat(function(n){var t=[];return Wn(n.rev_tree,(function(n,r,e,i,o){"available"!==o.status||n||(t.push(r+"-"+e),o.status="missing")})),t}(n.metadata))),c&&c.length&&ur(c,n.metadata.id,u),d.seq=o.target.result;var a=nr(d,t,r);f.put(a).onsuccess=h}function h(){_[o]={ok:!0,id:d.id,rev:d.rev},g.set(n.metadata.id,n.metadata),function(n,t,r){var e=0,i=Object.keys(n.data._attachments||{});if(!i.length)return r();function o(){++e===i.length&&r()}function u(r){var e=s.put({seq:t,digestSeq:n.data._attachments[r].digest+"::"+t});e.onsuccess=o,e.onerror=function(n){n.preventDefault(),n.stopPropagation(),o()}}for(var f=0;f<i.length;f++)u(i[f])}(n,d.seq,a)}v._doc_id_rev=d.id+"::"+d.rev,delete v._id,delete v._rev;var y=c.put(v);y.onsuccess=l,y.onerror=function(n){n.preventDefault(),n.stopPropagation(),c.index("_doc_id_rev").getKey(v._doc_id_rev).onsuccess=function(n){c.put(v,n.target.result).onsuccess=l}}}!function(n,t,r){if(!n.length)return r();var e,i=0;function o(){i++,n.length===i&&(e?r(e):r())}n.forEach((function(n){var r=n.data&&n.data._attachments?Object.keys(n.data._attachments):[],i=0;if(!r.length)return o();function u(n){e=n,++i===r.length&&o()}for(var f in n.data._attachments)n.data._attachments.hasOwnProperty(f)&&Zt(n.data._attachments[f],t,u)}))}(h,e._meta.blobSupport?"blob":"base64",(function(t){if(t)return o(t);!function(){var t=fr(i,[Ht,"by-sequence","attach-store","local-store","attach-seq-store",Yt],"readwrite");if(t.error)return o(t.error);(u=t.txn).onabort=Xt(o),u.ontimeout=Xt(o),u.oncomplete=$,f=u.objectStore(Ht),c=u.objectStore("by-sequence"),a=u.objectStore("attach-store"),s=u.objectStore("attach-seq-store"),(v=u.objectStore(Yt)).get(Yt).onsuccess=function(n){l=n.target.result,O()},function(n){var t=[];if(h.forEach((function(n){n.data&&n.data._attachments&&Object.keys(n.data._attachments).forEach((function(r){var e=n.data._attachments[r];e.stub&&t.push(e.digest)}))})),!t.length)return n();var r,e=0;t.forEach((function(i){!function(n,t){a.get(n).onsuccess=function(r){if(r.target.result)t();else{var e=pn(yn,"unknown stub attachment with digest "+n);e.status=412,t(e)}}}(i,(function(i){i&&!r&&(r=i),++e===t.length&&n(r)}))}))}((function(t){if(t)return k=!0,o(t);!function(){if(h.length)for(var t=0,i=0,o=h.length;i<o;i++){var c=h[i];c._id&&ft(c._id)?a():f.get(c.metadata.id).onsuccess=s}function a(){++t===h.length&&Qt(n.revs_limit,h,e,g,u,_,q,r,j)}function s(n){var t=tr(n.target.result);t&&g.set(t.id,t),a()}}()}))}()}))}(t,r,e,n,i,o)},n._get=function(n,t,r){var e,o,u,f=t.ctx;if(!f){var c=fr(i,[Ht,"by-sequence","attach-store"],"readonly");if(c.error)return r(c.error);f=c.txn}function a(){r(u,{doc:e,metadata:o,ctx:f})}f.objectStore(Ht).get(n).onsuccess=function(n){if(!(o=tr(n.target.result)))return u=pn(tn,"missing"),a();var r;if(t.rev)r=t.latest?function(n,t){for(var r,e=t.rev_tree.slice();r=e.pop();){var i=r.pos,o=r.ids,u=o[0],f=o[1],c=o[2],a=0===c.length,s=r.history?r.history.slice():[];if(s.push({id:u,pos:i,opts:f}),a)for(var v=0,d=s.length;v<d;v++){var l=s[v];if(l.pos+"-"+l.id===n)return i+"-"+u}for(var h=0,y=c.length;h<y;h++)e.push({pos:i+1,ids:c[h],history:s})}throw new Error("Unable to resolve latest revision for id "+t.id+", rev "+n)}(t.rev,o):t.rev;else if(r=o.winningRev,ut(o))return u=pn(tn,"deleted"),a();var i=f.objectStore("by-sequence"),c=o.id+"::"+r;i.index("_doc_id_rev").get(c).onsuccess=function(n){if((e=n.target.result)&&(e=rr(e)),!e)return u=pn(tn,"missing"),a();a()}}},n._getAttachment=function(n,t,r,e,o){var u;if(e.ctx)u=e.ctx;else{var f=fr(i,[Ht,"by-sequence","attach-store"],"readonly");if(f.error)return o(f.error);u=f.txn}var c=r.digest,a=r.content_type;u.objectStore("attach-store").get(c).onsuccess=function(n){er(n.target.result.body,a,e.binary,(function(n){o(null,n)}))}},n._info=function(t){var r,e,o=fr(i,[Yt,"by-sequence"],"readonly");if(o.error)return t(o.error);var u=o.txn;u.objectStore(Yt).get(Yt).onsuccess=function(n){e=n.target.result.docCount},u.objectStore("by-sequence").openCursor(null,"prev").onsuccess=function(n){var t=n.target.result;r=t?t.key:0},u.oncomplete=function(){t(null,{doc_count:e,update_seq:r,idb_attachment_format:n._meta.blobSupport?"binary":"base64"})}},n._allDocs=function(n,t){!function(n,t,r){var e,i,o="keys"in n&&n.keys,u=n.skip||0,f="number"==typeof n.limit?n.limit:-1;if(!o&&(i=(e=function(n,t,r,e,i){try{if(n&&t)return i?IDBKeyRange.bound(t,n,!r,!1):IDBKeyRange.bound(n,t,!1,!r);if(n)return i?IDBKeyRange.upperBound(n):IDBKeyRange.lowerBound(n);if(t)return i?IDBKeyRange.lowerBound(t,!r):IDBKeyRange.upperBound(t,!r);if(e)return IDBKeyRange.only(e)}catch(Vi){return{error:Vi}}return null}("startkey"in n&&n.startkey,"endkey"in n&&n.endkey,!1!==n.inclusive_end,"key"in n&&n.key,n.descending))&&e.error)&&("DataError"!==i.name||0!==i.code))return r(pn(ln,i.name));var c=[Ht,"by-sequence",Yt];n.attachments&&c.push("attach-store");var a=fr(t,c,"readonly");if(a.error)return r(a.error);var s=a.txn;s.oncomplete=function(){n.attachments?or(w,n.binary).then(k):k()},s.onabort=Xt(r);var v,d,l,h=s.objectStore(Ht),y=s.objectStore("by-sequence"),p=s.objectStore(Yt),b=y.index("_doc_id_rev"),w=[];function m(t,r){var e={id:r.id,key:r.id,value:{rev:t}};r.deleted?o&&(w.push(e),e.value.deleted=!0,e.doc=null):u--<=0&&(w.push(e),n.include_docs&&function(t,r,e){b.get(t.id+"::"+e).onsuccess=function(e){if(r.doc=rr(e.target.result)||{},n.conflicts){var i=Hn(t);i.length&&(r.doc._conflicts=i)}ir(r.doc,n,s)}}(r,e,t))}function _(n){for(var t=0,r=n.length;t<r&&w.length!==f;t++){var e=n[t];if(e.error&&o)w.push(e);else{var i=tr(e);m(i.winningRev,i)}}}function g(n,t,r){r&&(_(t),w.length<f&&r.continue())}function k(){var t={total_rows:v,offset:n.skip,rows:w};n.update_seq&&void 0!==d&&(t.update_seq=d),r(null,t)}p.get(Yt).onsuccess=function(n){v=n.target.result.docCount},n.update_seq&&(l=function(n){n.target.result&&n.target.result.length>0&&(d=n.target.result[0])},y.openCursor(null,"prev").onsuccess=function(n){var t=n.target.result,r=void 0;return t&&t.key&&(r=t.key),l({target:{result:[r]}})}),i||0===f||(o?function(n,t,r){var e=new Array(n.length),i=0;n.forEach((function(o,u){t.get(o).onsuccess=function(t){e[u]=t.target.result?t.target.result:{key:o,error:"not_found"},++i===n.length&&r(n,e,{})}}))}(n.keys,h,g):-1===f?function(n,t,r){if("function"!=typeof n.getAll){var e=[];n.openCursor(t).onsuccess=function(n){var t=n.target.result;t?(e.push(t.value),t.continue()):r({target:{result:e}})}}else n.getAll(t).onsuccess=r}(h,e,(function(t){var r=t.target.result;n.descending&&(r=r.reverse()),_(r)})):ar(h,e,n.descending,f+u,g))}(n,i,t)},n._changes=function(t){return function(n,t,r,e){if((n=J(n)).continuous){var i=r+":"+Ln();return cr.addListener(r,i,t,n),cr.notify(r),{cancel:function(){cr.removeListener(r,i)}}}var o=n.doc_ids&&new S(n.doc_ids);n.since=n.since||0;var u=n.since,f="limit"in n?n.limit:-1;0===f&&(f=1);var c,a,s,v,d=[],l=0,h=wn(n),y=new P;function p(n,t,r,e){return r.seq!==t?e():r.winningRev===n._rev?e(r,n):void(v.get(n._id+"::"+r.winningRev).onsuccess=function(n){e(r,rr(n.target.result))})}function b(){n.complete(null,{results:d,last_seq:u})}var w=[Ht,"by-sequence"];n.attachments&&w.push("attach-store");var m=fr(e,w,"readonly");if(m.error)return n.complete(m.error);(c=m.txn).onabort=Xt(n.complete),c.oncomplete=function(){!n.continuous&&n.attachments?or(d).then(b):b()},a=c.objectStore("by-sequence"),s=c.objectStore(Ht),v=a.index("_doc_id_rev"),ar(a,n.since&&!n.descending?IDBKeyRange.lowerBound(n.since,!0):null,n.descending,f,(function(t,r,e){if(e&&t.length){var i=new Array(t.length),a=new Array(t.length),v=0;r.forEach((function(r,u){!function(n,t,r){if(o&&!o.has(n._id))return r();var e=y.get(n._id);if(e)return p(n,t,e,r);s.get(n._id).onsuccess=function(i){e=tr(i.target.result),y.set(n._id,e),p(n,t,e,r)}}(rr(r),t[u],(function(r,o){a[u]=r,i[u]=o,++v===t.length&&function(){for(var t=[],r=0,o=i.length;r<o&&l!==f;r++){var u=i[r];u&&t.push(b(a[r],u))}Promise.all(t).then((function(t){for(var r=0,e=t.length;r<e;r++)t[r]&&n.onChange(t[r])})).catch(n.complete),l!==f&&e.continue()}()}))}))}function b(t,r){var e=n.processChange(r,t,n);u=e.seq=t.seq;var i=h(e);return"object"==typeof i?Promise.reject(i):i?(l++,n.return_docs&&d.push(e),n.attachments&&n.include_docs?new Promise((function(t){ir(r,n,c,(function(){or([e],n.binary).then((function(){t(e)}))}))})):Promise.resolve(e)):Promise.resolve()}}))}(t,n,e,i)},n._close=function(n){i.close(),hr.delete(e),n()},n._getRevisionTree=function(n,t){var r=fr(i,[Ht],"readonly");if(r.error)return t(r.error);r.txn.objectStore(Ht).get(n).onsuccess=function(n){var r=tr(n.target.result);r?t(null,r.rev_tree):t(pn(tn))}},n._doCompaction=function(n,t,r){var e=fr(i,[Ht,"by-sequence","attach-store","attach-seq-store"],"readwrite");if(e.error)return r(e.error);var o=e.txn;o.objectStore(Ht).get(n).onsuccess=function(r){var e=tr(r.target.result);Wn(e.rev_tree,(function(n,r,e,i,o){-1!==t.indexOf(r+"-"+e)&&(o.status="missing")})),ur(t,n,o);var i=e.winningRev,u=e.deleted;o.objectStore(Ht).put(nr(e,i,u))},o.onabort=Xt(r),o.oncomplete=function(){r()}},n._getLocal=function(n,t){var r=fr(i,["local-store"],"readonly");if(r.error)return t(r.error);var e=r.txn.objectStore("local-store").get(n);e.onerror=Xt(t),e.onsuccess=function(n){var r=n.target.result;r?(delete r._doc_id_rev,t(null,r)):t(pn(tn))}},n._putLocal=function(n,t,r){"function"==typeof t&&(r=t,t={}),delete n._revisions;var e=n._rev,o=n._id;n._rev=e?"0-"+(parseInt(e.split("-")[1],10)+1):"0-1";var u,f=t.ctx;if(!f){var c=fr(i,["local-store"],"readwrite");if(c.error)return r(c.error);(f=c.txn).onerror=Xt(r),f.oncomplete=function(){u&&r(null,u)}}var a,s=f.objectStore("local-store");e?(a=s.get(o)).onsuccess=function(i){var o=i.target.result;o&&o._rev===e?s.put(n).onsuccess=function(){u={ok:!0,id:n._id,rev:n._rev},t.ctx&&r(null,u)}:r(pn(rn))}:((a=s.add(n)).onerror=function(n){r(pn(rn)),n.preventDefault(),n.stopPropagation()},a.onsuccess=function(){u={ok:!0,id:n._id,rev:n._rev},t.ctx&&r(null,u)})},n._removeLocal=function(n,t,r){"function"==typeof t&&(r=t,t={});var e,o=t.ctx;if(!o){var u=fr(i,["local-store"],"readwrite");if(u.error)return r(u.error);(o=u.txn).oncomplete=function(){e&&r(null,e)}}var f=n._id,c=o.objectStore("local-store"),a=c.get(f);a.onerror=Xt(r),a.onsuccess=function(i){var o=i.target.result;o&&o._rev===n._rev?(c.delete(f),e={ok:!0,id:f,rev:"0-0"},t.ctx&&r(null,e)):r(pn(tn))}},n._destroy=function(n,t){cr.removeAllListeners(e);var r=yr.get(e);r&&r.result&&(r.result.close(),hr.delete(e));var i=indexedDB.deleteDatabase(e);i.onsuccess=function(){yr.delete(e),W()&&e in localStorage&&delete localStorage[e],t(null,{ok:!0})},i.onerror=Xt(t)};var a=hr.get(e);if(a)return i=a.idb,n._meta=a.global,h((function(){r(null,n)}));var s=indexedDB.open(e,5);yr.set(e,s),s.onupgradeneeded=function(n){var t=n.target.result;if(n.oldVersion<1)return function(n){var t=n.createObjectStore(Ht,{keyPath:"id"});n.createObjectStore("by-sequence",{autoIncrement:!0}).createIndex("_doc_id_rev","_doc_id_rev",{unique:!0}),n.createObjectStore("attach-store",{keyPath:"digest"}),n.createObjectStore(Yt,{keyPath:"id",autoIncrement:!1}),n.createObjectStore("detect-blob-support"),t.createIndex("deletedOrLocal","deletedOrLocal",{unique:!1}),n.createObjectStore("local-store",{keyPath:"_id"});var r=n.createObjectStore("attach-seq-store",{autoIncrement:!0});r.createIndex("seq","seq"),r.createIndex("digestSeq","digestSeq",{unique:!0})}(t);var r=n.currentTarget.transaction;n.oldVersion<3&&function(n){n.createObjectStore("local-store",{keyPath:"_id"}).createIndex("_doc_id_rev","_doc_id_rev",{unique:!0})}(t),n.oldVersion<4&&function(n){var t=n.createObjectStore("attach-seq-store",{autoIncrement:!0});t.createIndex("seq","seq"),t.createIndex("digestSeq","digestSeq",{unique:!0})}(t);var e=[o,u,f,c],i=n.oldVersion;!function n(){var t=e[i-1];i++,t&&t(r,n)}()},s.onsuccess=function(t){(i=t.target.result).onversionchange=function(){i.close(),hr.delete(e)},i.onabort=function(n){Q("error","Database has a global failure",n.target.error),i.close(),hr.delete(e)};var o,u,f,c,a=i.transaction([Yt,"detect-blob-support",Ht],"readwrite"),s=!1;function v(){void 0!==f&&s&&(n._meta={name:e,instanceId:c,blobSupport:f},hr.set(e,{idb:i,global:n._meta}),r(null,n))}function d(){if(void 0!==u&&void 0!==o){var n=e+"_id";n in o?c=o[n]:o[n]=c=Ln(),o.docCount=u,a.objectStore(Yt).put(o)}}a.objectStore(Yt).get(Yt).onsuccess=function(n){o=n.target.result||{id:Yt},d()},function(n){n.objectStore(Ht).index("deletedOrLocal").count(IDBKeyRange.only("0")).onsuccess=function(n){u=n.target.result,d()}}(a),lr||(lr=function(n){return new Promise((function(t){var r=xn([""]),e=n.objectStore("detect-blob-support").put(r,"key");e.onsuccess=function(){var n=navigator.userAgent.match(/Chrome\/(\d+)/),r=navigator.userAgent.match(/Edge\//);t(r||!n||parseInt(n[1],10)>=43)},e.onerror=n.onabort=function(n){n.preventDefault(),n.stopPropagation(),t(!1)}})).catch((function(){return!1}))}(a)),lr.then((function(n){f=n,v()})),a.oncomplete=function(){s=!0,v()},a.onabort=Xt(r)},s.onerror=function(n){var t=n.target.error&&n.target.error.message;t?-1!==t.indexOf("stored database is a higher version")&&(t=new Error('This DB was created with the newer "indexeddb" adapter, but you are trying to open it with the older "idb" adapter')):t="Failed to open indexedDB, are you in private browsing mode?",Q("error",t),r(pn(ln,t))}})(r,n,(function(n,t){!function(n,t,r,e){try{n(t,r)}catch(t){e.emit("error",t)}}(e,n,t,i),sr=!1,h((function(){dr()}))}))})),dr()}(0,t,r.constructor)}pr.valid=function(){try{return"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(Vi){return!1}};var br={};function wr(n){var t=n.doc||n.ok,r=t&&t._attachments;r&&Object.keys(r).forEach((function(n){var t=r[n];t.data=Nn(t.data,t.content_type)}))}function mr(n){return/^_design/.test(n)?"_design/"+encodeURIComponent(n.slice(8)):/^_local/.test(n)?"_local/"+encodeURIComponent(n.slice(7)):encodeURIComponent(n)}function _r(n){return n._attachments&&Object.keys(n._attachments)?Promise.all(Object.keys(n._attachments).map((function(t){var r=n._attachments[t];if(r.data&&"string"!=typeof r.data)return new Promise((function(n){Cn(r.data,n)})).then((function(n){r.data=n}))}))):Promise.resolve()}function gr(n,t){return kr(n,n.db+"/"+t)}function kr(n,t){return n.protocol+"://"+n.host+(n.port?":"+n.port:"")+"/"+n.path+(n.path?"/":"")+t}function jr(n){return"?"+Object.keys(n).map((function(t){return t+"="+encodeURIComponent(n[t])})).join("&")}function Or(n,t){var r=this,i=function(n,t){if(function(n){if(!n.prefix)return!1;var t=An(n.prefix).protocol;return"http"===t||"https"===t}(t)){var r=t.name.substr(t.prefix.length);n=t.prefix.replace(/\/?$/,"/")+encodeURIComponent(r)}var e=An(n);(e.user||e.password)&&(e.auth={username:e.user,password:e.password});var i=e.path.replace(/(^\/|\/$)/g,"").split("/");return e.db=i.pop(),-1===e.db.indexOf("%")&&(e.db=encodeURIComponent(e.db)),e.path=i.join("/"),e}(n.name,n),o=gr(i,"");n=J(n);var u,f=function(t,r){if((r=r||{}).headers=r.headers||new wt,r.credentials="include",n.auth||i.auth){var e=n.auth||i.auth,o=Bn(unescape(encodeURIComponent(e.username+":"+e.password)));r.headers.set("Authorization","Basic "+o)}var u=n.headers||{};return Object.keys(u).forEach((function(n){r.headers.append(n,u[n])})),function(n){var t="undefined"!=typeof navigator&&navigator.userAgent?navigator.userAgent.toLowerCase():"",r=-1!==t.indexOf("msie"),e=-1!==t.indexOf("trident"),i=-1!==t.indexOf("edge");return(r||e||i)&&(!("method"in n)||"GET"===n.method)}(r)&&(t+=(-1===t.indexOf("?")?"?":"&")+"_nonce="+Date.now()),(n.fetch||bt)(t,r)};function c(n,t){return F(n,E((function(n){s().then((function(){return t.apply(this,n)})).catch((function(t){n.pop()(t)}))}))).bind(r)}function a(n,t,r){var e={};return(t=t||{}).headers=t.headers||new wt,t.headers.get("Content-Type")||t.headers.set("Content-Type","application/json"),t.headers.get("Accept")||t.headers.set("Accept","application/json"),f(n,t).then((function(n){return e.ok=n.ok,e.status=n.status,n.json()})).then((function(n){if(e.data=n,!e.ok){e.data.status=e.status;var t=bn(e.data);if(r)return r(t);throw t}if(Array.isArray(e.data)&&(e.data=e.data.map((function(n){return n.error||n.missing?bn(n):n}))),!r)return e;r(null,e.data)}))}function s(){return n.skip_setup?Promise.resolve():u||((u=a(o).catch((function(n){return n&&n.status&&404===n.status?(Y(404,"PouchDB is just detecting if the remote exists."),a(o,{method:"PUT"})):Promise.reject(n)})).catch((function(n){return!(!n||!n.status||412!==n.status)||Promise.reject(n)}))).catch((function(){u=null})),u)}function v(n){return n.split("/").map(encodeURIComponent).join("/")}h((function(){t(null,r)})),r._remote=!0,r.type=function(){return"http"},r.id=c("id",(function(n){f(kr(i,"")).then((function(n){return n.json()})).catch((function(){return{}})).then((function(t){var r=t&&t.uuid?t.uuid+i.db:gr(i,"");n(null,r)}))})),r.compact=c("compact",(function(n,t){"function"==typeof n&&(t=n,n={}),n=J(n),a(gr(i,"_compact"),{method:"POST"}).then((function(){!function e(){r.info((function(r,i){i&&!i.compact_running?t(null,{ok:!0}):setTimeout(e,n.interval||200)}))}()}))})),r.bulkGet=F("bulkGet",(function(n,t){var r=this;function e(t){var r={};n.revs&&(r.revs=!0),n.attachments&&(r.attachments=!0),n.latest&&(r.latest=!0),a(gr(i,"_bulk_get"+jr(r)),{method:"POST",body:JSON.stringify({docs:n.docs})}).then((function(r){n.attachments&&n.binary&&r.data.results.forEach((function(n){n.docs.forEach(wr)})),t(null,r.data)})).catch(t)}function o(){var e=Math.ceil(n.docs.length/50),i=0,o=new Array(e);function u(n){return function(r,u){o[n]=u.results,++i===e&&t(null,{results:mn(o)})}}for(var f=0;f<e;f++){var c=z(n,["revs","attachments","binary","latest"]);c.docs=n.docs.slice(50*f,Math.min(n.docs.length,50*(f+1))),G(r,c,u(f))}}var u=kr(i,""),f=br[u];"boolean"!=typeof f?e((function(n,r){n?(br[u]=!1,Y(n.status,"PouchDB is just detecting if the remote supports the _bulk_get API."),o()):(br[u]=!0,t(null,r))})):f?e(t):o()})),r._info=function(n){s().then((function(){return f(gr(i,""))})).then((function(n){return n.json()})).then((function(t){t.host=gr(i,""),n(null,t)})).catch(n)},r.fetch=function(n,t){return s().then((function(){var r="/"===n.substring(0,1)?kr(i,n.substring(1)):gr(i,n);return f(r,t)}))},r.get=c("get",(function(n,t,r){"function"==typeof t&&(r=t,t={});var e={};function o(n){var r,e=n._attachments,o=e&&Object.keys(e);if(e&&o.length)return r=o.map((function(r){return function(){return function(r){var o=e[r],u=mr(n._id)+"/"+v(r)+"?rev="+n._rev;return f(gr(i,u)).then((function(n){return"buffer"in n?n.buffer():n.blob()})).then((function(n){if(t.binary){var r=Object.getOwnPropertyDescriptor(n.__proto__,"type");return r&&!r.set||(n.type=o.content_type),n}return new Promise((function(t){Cn(n,t)}))})).then((function(n){delete o.stub,delete o.length,o.data=n}))}(r)}})),new Promise((function(n,t){var e,i=0,o=0,u=0,f=r.length;function c(){++u===f?e?t(e):n():v()}function a(){i--,c()}function s(n){i--,e=e||n,c()}function v(){for(;i<5&&o<f;)i++,r[o++]().then(a,s)}v()}))}(t=J(t)).revs&&(e.revs=!0),t.revs_info&&(e.revs_info=!0),t.latest&&(e.latest=!0),t.open_revs&&("all"!==t.open_revs&&(t.open_revs=JSON.stringify(t.open_revs)),e.open_revs=t.open_revs),t.rev&&(e.rev=t.rev),t.conflicts&&(e.conflicts=t.conflicts),t.update_seq&&(e.update_seq=t.update_seq),n=mr(n),a(gr(i,n+jr(e))).then((function(n){return Promise.resolve().then((function(){if(t.attachments)return r=n.data,Array.isArray(r)?Promise.all(r.map((function(n){if(n.ok)return o(n.ok)}))):o(r);var r})).then((function(){r(null,n.data)}))})).catch((function(t){t.docId=n,r(t)}))})),r.remove=c("remove",(function(n,t,r,e){var o;"string"==typeof t?(o={_id:n,_rev:t},"function"==typeof r&&(e=r,r={})):(o=n,"function"==typeof t?(e=t,r={}):(e=r,r=t));var u=o._rev||r.rev;a(gr(i,mr(o._id))+"?rev="+u,{method:"DELETE"},e).catch(e)})),r.getAttachment=c("getAttachment",(function(n,t,r,o){"function"==typeof r&&(o=r,r={});var u,c=r.rev?"?rev="+r.rev:"",a=gr(i,mr(n))+"/"+v(t)+c;f(a,{method:"GET"}).then((function(n){if(u=n.headers.get("content-type"),n.ok)return void 0===e||e.browser||"function"!=typeof n.buffer?n.blob():n.buffer();throw n})).then((function(n){void 0===e||e.browser||(n.type=u),o(null,n)})).catch((function(n){o(n)}))})),r.removeAttachment=c("removeAttachment",(function(n,t,r,e){a(gr(i,mr(n)+"/"+v(t))+"?rev="+r,{method:"DELETE"},e).catch(e)})),r.putAttachment=c("putAttachment",(function(n,t,r,e,o,u){"function"==typeof o&&(u=o,o=e,e=r,r=null);var f=mr(n)+"/"+v(t),c=gr(i,f);if(r&&(c+="?rev="+r),"string"==typeof e){var s;try{s=En(e)}catch(d){return u(pn(cn,"Attachment is not a valid base64 string"))}e=s?In(s,o):""}a(c,{headers:new wt({"Content-Type":o}),method:"PUT",body:e},u).catch(u)})),r._bulkDocs=function(n,t,r){n.new_edits=t.new_edits,s().then((function(){return Promise.all(n.docs.map(_r))})).then((function(){return a(gr(i,"_bulk_docs"),{method:"POST",body:JSON.stringify(n)},r)})).catch(r)},r._put=function(n,t,r){s().then((function(){return _r(n)})).then((function(){return a(gr(i,mr(n._id)),{method:"PUT",body:JSON.stringify(n)})})).then((function(n){r(null,n.data)})).catch((function(t){t.docId=n&&n._id,r(t)}))},r.allDocs=c("allDocs",(function(n,t){"function"==typeof n&&(t=n,n={});var r,e={},o="GET";(n=J(n)).conflicts&&(e.conflicts=!0),n.update_seq&&(e.update_seq=!0),n.descending&&(e.descending=!0),n.include_docs&&(e.include_docs=!0),n.attachments&&(e.attachments=!0),n.key&&(e.key=JSON.stringify(n.key)),n.start_key&&(n.startkey=n.start_key),n.startkey&&(e.startkey=JSON.stringify(n.startkey)),n.end_key&&(n.endkey=n.end_key),n.endkey&&(e.endkey=JSON.stringify(n.endkey)),void 0!==n.inclusive_end&&(e.inclusive_end=!!n.inclusive_end),void 0!==n.limit&&(e.limit=n.limit),void 0!==n.skip&&(e.skip=n.skip);var u=jr(e);void 0!==n.keys&&(o="POST",r={keys:n.keys}),a(gr(i,"_all_docs"+u),{method:o,body:JSON.stringify(r)}).then((function(r){n.include_docs&&n.attachments&&n.binary&&r.data.rows.forEach(wr),t(null,r.data)})).catch(t)})),r._changes=function(n){var t="batch_size"in n?n.batch_size:25;(n=J(n)).continuous&&!("heartbeat"in n)&&(n.heartbeat=1e4);var r={};"timeout"in n&&n.timeout&&(r.timeout=n.timeout);var e=void 0!==n.limit&&n.limit,o=e;if(n.style&&(r.style=n.style),(n.include_docs||n.filter&&"function"==typeof n.filter)&&(r.include_docs=!0),n.attachments&&(r.attachments=!0),n.continuous&&(r.feed="longpoll"),n.seq_interval&&(r.seq_interval=n.seq_interval),n.conflicts&&(r.conflicts=!0),n.descending&&(r.descending=!0),n.update_seq&&(r.update_seq=!0),"heartbeat"in n&&n.heartbeat&&(r.heartbeat=n.heartbeat),n.filter&&"string"==typeof n.filter&&(r.filter=n.filter),n.view&&"string"==typeof n.view&&(r.filter="_view",r.view=n.view),n.query_params&&"object"==typeof n.query_params)for(var u in n.query_params)n.query_params.hasOwnProperty(u)&&(r[u]=n.query_params[u]);var f,c="GET";n.doc_ids?(r.filter="_doc_ids",c="POST",f={doc_ids:n.doc_ids}):n.selector&&(r.filter="_selector",c="POST",f={selector:n.selector});var v,d=new pt,l=function(u,l){if(!n.aborted){r.since=u,"object"==typeof r.since&&(r.since=JSON.stringify(r.since)),n.descending?e&&(r.limit=o):r.limit=!e||o>t?t:o;var h=gr(i,"_changes"+jr(r)),y={signal:d.signal,method:c,body:JSON.stringify(f)};v=u,n.aborted||s().then((function(){return a(h,y,l)})).catch(l)}},y={results:[]},p=function(r,i){if(!n.aborted){var u=0;if(i&&i.results){u=i.results.length,y.last_seq=i.last_seq;var f=null,c=null;"number"==typeof i.pending&&(f=i.pending),"string"!=typeof y.last_seq&&"number"!=typeof y.last_seq||(c=y.last_seq),i.results=i.results.filter((function(t){o--;var r=wn(n)(t);return r&&(n.include_docs&&n.attachments&&n.binary&&wr(t),n.return_docs&&y.results.push(t),n.onChange(t,f,c)),r}))}else if(r)return n.aborted=!0,void n.complete(r);i&&i.last_seq&&(v=i.last_seq),(!n.continuous||e&&o<=0)&&(e&&o<=0||i&&u<t||n.descending)?n.complete(null,y):h((function(){l(v,p)}))}};return l(n.since||0,p),{cancel:function(){n.aborted=!0,d.abort()}}},r.revsDiff=c("revsDiff",(function(n,t,r){"function"==typeof t&&(r=t,t={}),a(gr(i,"_revs_diff"),{method:"POST",body:JSON.stringify(n)},r).catch(r)})),r._close=function(n){n()},r._destroy=function(n,t){a(gr(i,""),{method:"DELETE"}).then((function(n){t(null,n)})).catch((function(n){404===n.status?t(null,{ok:!0}):t(n)}))}}function $r(n){this.status=400,this.name="query_parse_error",this.message=n,this.error=!0;try{Error.captureStackTrace(this,$r)}catch(Vi){}}function qr(n){this.status=404,this.name="not_found",this.message=n,this.error=!0;try{Error.captureStackTrace(this,qr)}catch(Vi){}}function Ar(n){this.status=500,this.name="invalid_value",this.message=n,this.error=!0;try{Error.captureStackTrace(this,Ar)}catch(Vi){}}function Sr(n,t){return t&&n.then((function(n){h((function(){t(null,n)}))}),(function(n){h((function(){t(n)}))})),n}function Pr(n,t){return function(){var r=arguments,e=this;return n.add((function(){return t.apply(e,r)}))}}function Er(n){var t=new S(n),r=new Array(t.size),e=-1;return t.forEach((function(n){r[++e]=n})),r}function Br(n){var t=new Array(n.size),r=-1;return n.forEach((function(n,e){t[++r]=e})),t}function xr(n){return new Ar("builtin "+n+" function requires map values to be numbers or number arrays")}function Dr(n){for(var t=0,r=0,e=n.length;r<e;r++){var i=n[r];if("number"!=typeof i){if(!Array.isArray(i))throw xr("_sum");t="number"==typeof t?[t]:t;for(var o=0,u=i.length;o<u;o++){var f=i[o];if("number"!=typeof f)throw xr("_sum");void 0===t[o]?t.push(f):t[o]+=f}}else"number"==typeof t?t+=i:t[0]+=i}return t}Or.valid=function(){return!0},B($r,Error),B(qr,Error),B(Ar,Error);var Ir=Q.bind(null,"log"),Nr=Array.isArray,Mr=JSON.parse;function Tr(n,t){return Sn("return ("+n.replace(/;\s*$/,"")+");",{emit:t,sum:Dr,log:Ir,isArray:Nr,toJSON:Mr})}function Cr(){this.promise=new Promise((function(n){n()}))}function Jr(n){if(!n)return"undefined";switch(typeof n){case"function":case"string":return n.toString();default:return JSON.stringify(n)}}function Rr(n,t,r,e,i,o){var u,f=function(n,t){return Jr(n)+Jr(t)+"undefined"}(r,e);if(!i&&(u=n._cachedViews=n._cachedViews||{})[f])return u[f];var c=n.info().then((function(c){var a=c.db_name+"-mrview-"+(i?"temp":zn(f));return Pn(n,"_local/"+o,(function(n){n.views=n.views||{};var r=t;-1===r.indexOf("/")&&(r=t+"/"+t);var e=n.views[r]=n.views[r]||{};if(!e[a])return e[a]=!0,n})).then((function(){return n.registerDependentDatabase(a).then((function(t){var i=t.db;i.auto_compaction=!0;var o={name:a,db:i,sourceDB:n,adapter:n.adapter,mapFun:r,reduceFun:e};return o.db.get("_local/lastSeq").catch((function(n){if(404!==n.status)throw n})).then((function(n){return o.seq=n?n.seq:0,u&&o.db.once("destroyed",(function(){delete u[f]})),o}))}))}))}));return u&&(u[f]=c),c}Cr.prototype.add=function(n){return this.promise=this.promise.catch((function(){})).then((function(){return n()})),this.promise},Cr.prototype.finish=function(){return this.promise};var Ur={},Fr=new Cr;function zr(n){return-1===n.indexOf("/")?[n,n]:n.split("/")}function Kr(n,t){try{n.emit("error",t)}catch(r){Q("error","The user's map/reduce function threw an uncaught error.\nYou can debug this error by doing:\nmyDatabase.on('error', function (err) { debugger; });\nPlease double-check your map/reduce function."),Q("error",t)}}var Lr=function(n,t){return Dr(t)},Gr=function(n,t){return t.length},Wr=function(n,t){return{sum:Dr(t),min:Math.min.apply(null,t),max:Math.max.apply(null,t),count:t.length,sumsqr:function(n){for(var t=0,r=0,e=n.length;r<e;r++){var i=n[r];t+=i*i}return t}(t)}},Zr=function(){function n(n,t,r){try{t(r)}catch(Vi){Kr(n,Vi)}}function t(n,t,r,e,i){try{return{output:t(r,e,i)}}catch(Vi){return Kr(n,Vi),{error:Vi}}}function r(n,t){var r=At(n.key,t.key);return 0!==r?r:At(n.value,t.value)}function e(n,t,r){return r=r||0,"number"==typeof t?n.slice(r,t+r):r>0?n.slice(r):n}function i(n){var t=n.value;return t&&"object"==typeof t&&t._id||n.id}function o(n){return function(t){return n.include_docs&&n.attachments&&n.binary&&function(n){n.rows.forEach((function(n){var t=n.doc&&n.doc._attachments;t&&Object.keys(t).forEach((function(n){var r=t[n];t[n].data=Nn(r.data,r.content_type)}))}))}(t),t}}function u(n,t,r,e){var i=t[n];void 0!==i&&(e&&(i=encodeURIComponent(JSON.stringify(i))),r.push(n+"="+i))}function f(n){if(void 0!==n){var t=Number(n);return isNaN(t)||t!==parseInt(n,10)?n:t}}function c(n,t){var r=n.descending?"endkey":"startkey",e=n.descending?"startkey":"endkey";if(void 0!==n[r]&&void 0!==n[e]&&At(n[r],n[e])>0)throw new $r("No rows can match your key range, reverse your start_key and end_key or set {descending : true}");if(t.reduce&&!1!==n.reduce){if(n.include_docs)throw new $r("{include_docs:true} is invalid for reduce");if(n.keys&&n.keys.length>1&&!n.group&&!n.group_level)throw new $r("Multi-key fetches for reduce views must use {group: true}")}["group_level","limit","skip"].forEach((function(t){var r=function(n){if(n){if("number"!=typeof n)return new $r('Invalid value for integer: "'+n+'"');if(n<0)return new $r('Invalid value for positive integer: "'+n+'"')}}(n[t]);if(r)throw r}))}function a(n){return function(t){if(404===t.status)return n;throw t}}function s(n){var t="string"==typeof n?n:n.name,r=Ur[t];return r||(r=Ur[t]=new Cr),r}function v(t){return Pr(s(t),(function(){return function(t){var e,i,o=function(n,t){if("function"==typeof n&&2===n.length){var r=n;return function(n){return r(n,t)}}return Tr(n.toString(),t)}(t.mapFun,(function(n,t){var r={id:i._id,key:St(n)};null!=t&&(r.value=St(t)),e.push(r)})),u=t.seq||0;function f(n,r){return function(){return function(n,t,r){return n.db.get("_local/lastSeq").catch(a({_id:"_local/lastSeq",seq:0})).then((function(e){var i=Br(t);return Promise.all(i.map((function(r){return function(n,t,r){var e="_local/doc_"+n,i={_id:e,keys:[]},o=r.get(n),u=o[0];return(function(n){return 1===n.length&&/^1-/.test(n[0].rev)}(o[1])?Promise.resolve(i):t.db.get(e).catch(a(i))).then((function(n){return function(n){return n.keys.length?t.db.allDocs({keys:n.keys,include_docs:!0}):Promise.resolve({rows:[]})}(n).then((function(t){return function(n,t){for(var r=[],e=new S,i=0,o=t.rows.length;i<o;i++){var f=t.rows[i].doc;if(f&&(r.push(f),e.add(f._id),f._deleted=!u.has(f._id),!f._deleted)){var c=u.get(f._id);"value"in c&&(f.value=c.value)}}var a=Br(u);return a.forEach((function(n){if(!e.has(n)){var t={_id:n},i=u.get(n);"value"in i&&(t.value=i.value),r.push(t)}})),n.keys=Er(a.concat(n.keys)),r.push(n),r}(n,t)}))}))}(r,n,t)}))).then((function(t){var i=mn(t);return e.seq=r,i.push(e),n.db.bulkDocs({docs:i})}))}))}(t,n,r)}}var c=new Cr;function s(){return t.sourceDB.changes({return_docs:!0,conflicts:!0,include_docs:!0,style:"all_docs",since:u,limit:50}).then(v)}function v(a){var v=a.results;if(v.length){var l=function(f){for(var c=new P,a=0,s=f.length;a<s;a++){var v=f[a];if("_"!==v.doc._id[0]){e=[],(i=v.doc)._deleted||n(t.sourceDB,o,i),e.sort(r);var l=d(e);c.set(v.doc._id,[l,v.changes])}u=v.seq}return c}(v);if(c.add(f(l,u)),!(v.length<50))return s()}}function d(n){for(var t,r=new P,e=0,i=n.length;e<i;e++){var o=n[e],u=[o.key,o.id];e>0&&0===At(o.key,t)&&u.push(e),r.set(Pt(u),o),t=o.key}return r}return s().then((function(){return c.finish()})).then((function(){t.seq=u}))}(t)}))()}function d(n,r){return Pr(s(n),(function(){return function(n,r){var o,u=n.reduceFun&&!1!==r.reduce,f=r.skip||0;function c(t){return t.include_docs=!0,n.db.allDocs(t).then((function(n){return o=n.total_rows,n.rows.map((function(n){if("value"in n.doc&&"object"==typeof n.doc.value&&null!==n.doc.value){var t=Object.keys(n.doc.value).sort(),r=["id","key","value"];if(!(t<r||t>r))return n.doc.value}var e=function(n){for(var t=[],r=[],e=0;;){var i=n[e++];if("\0"!==i)switch(i){case"1":t.push(null);break;case"2":t.push("1"===n[e]),e++;break;case"3":var o=Et(n,e);t.push(o.num),e+=o.length;break;case"4":for(var u="";;){var f=n[e];if("\0"===f)break;u+=f,e++}u=u.replace(/\u0001\u0001/g,"\0").replace(/\u0001\u0002/g,"").replace(/\u0002\u0002/g,""),t.push(u);break;case"5":var c={element:[],index:t.length};t.push(c.element),r.push(c);break;case"6":var a={element:{},index:t.length};t.push(a.element),r.push(a);break;default:throw new Error("bad collationIndex or unexpectedly reached end of input: "+i)}else{if(1===t.length)return t.pop();Bt(t,r)}}}(n.doc._id);return{key:e[0],id:e[1],value:"value"in n.doc?n.doc.value:null}}))}))}function a(c){var a;if(a=u?function(n,r,i){0===i.group_level&&delete i.group_level;var o=i.group||i.group_level,u=function(n){var t=n.toString();return function(n){if(/^_sum/.test(n))return Lr;if(/^_count/.test(n))return Gr;if(/^_stats/.test(n))return Wr;if(/^_/.test(n))throw new Error(n+" is not a supported reduce function.")}(t)||Tr(t)}(n.reduceFun),f=[],c=isNaN(i.group_level)?Number.POSITIVE_INFINITY:i.group_level;r.forEach((function(n){var t=f[f.length-1],r=o?n.key:null;if(o&&Array.isArray(r)&&(r=r.slice(0,c)),t&&0===At(t.groupKey,r))return t.keys.push([n.key,n.id]),void t.values.push(n.value);f.push({keys:[[n.key,n.id]],values:[n.value],groupKey:r})})),r=[];for(var a=0,s=f.length;a<s;a++){var v=f[a],d=t(n.sourceDB,u,v.keys,v.values,!1);if(d.error&&d.error instanceof Ar)throw d.error;r.push({value:d.error?null:d.output,key:v.groupKey})}return{rows:e(r,i.limit,i.skip)}}(n,c,r):{total_rows:o,offset:f,rows:c},r.update_seq&&(a.update_seq=n.seq),r.include_docs){var s=Er(c.map(i));return n.sourceDB.allDocs({keys:s,include_docs:!0,conflicts:r.conflicts,attachments:r.attachments,binary:r.binary}).then((function(n){var t=new P;return n.rows.forEach((function(n){t.set(n.id,n.doc)})),c.forEach((function(n){var r=i(n),e=t.get(r);e&&(n.doc=e)})),a}))}return a}if(void 0===r.keys||r.keys.length||(r.limit=0,delete r.keys),void 0!==r.keys){var s=r.keys.map((function(n){var t={startkey:Pt([n]),endkey:Pt([n,{}])};return r.update_seq&&(t.update_seq=!0),c(t)}));return Promise.all(s).then(mn).then(a)}var v,d,l={descending:r.descending};if(r.update_seq&&(l.update_seq=!0),"start_key"in r&&(v=r.start_key),"startkey"in r&&(v=r.startkey),"end_key"in r&&(d=r.end_key),"endkey"in r&&(d=r.endkey),void 0!==v&&(l.startkey=Pt(r.descending?[v,{}]:[v])),void 0!==d){var h=!1!==r.inclusive_end;r.descending&&(h=!h),l.endkey=Pt(h?[d,{}]:[d])}if(void 0!==r.key){var y=Pt([r.key]),p=Pt([r.key,{}]);l.descending?(l.endkey=y,l.startkey=p):(l.startkey=y,l.endkey=p)}return u||("number"==typeof r.limit&&(l.limit=r.limit),l.skip=f),c(l).then(a)}(n,r)}))()}function l(n,t,r){if("function"==typeof n._query)return function(n,t,r){return new Promise((function(e,i){n._query(t,r,(function(n,t){if(n)return i(n);e(t)}))}))}(n,t,r);if(gn(n))return function(n,t,r){var e,i,f,c=[],a="GET";if(u("reduce",r,c),u("include_docs",r,c),u("attachments",r,c),u("limit",r,c),u("descending",r,c),u("group",r,c),u("group_level",r,c),u("skip",r,c),u("stale",r,c),u("conflicts",r,c),u("startkey",r,c,!0),u("start_key",r,c,!0),u("endkey",r,c,!0),u("end_key",r,c,!0),u("inclusive_end",r,c),u("key",r,c,!0),u("update_seq",r,c),c=""===(c=c.join("&"))?"":"?"+c,void 0!==r.keys){var s="keys="+encodeURIComponent(JSON.stringify(r.keys));s.length+c.length+1<=2e3?c+=("?"===c[0]?"&":"?")+s:(a="POST","string"==typeof t?e={keys:r.keys}:t.keys=r.keys)}if("string"==typeof t){var v=zr(t);return n.fetch("_design/"+v[0]+"/_view/"+v[1]+c,{headers:new wt({"Content-Type":"application/json"}),method:a,body:JSON.stringify(e)}).then((function(n){return i=n.ok,f=n.status,n.json()})).then((function(n){if(!i)throw n.status=f,bn(n);return n.rows.forEach((function(n){if(n.value&&n.value.error&&"builtin_reduce_error"===n.value.error)throw new Error(n.reason)})),n})).then(o(r))}return e=e||{},Object.keys(t).forEach((function(n){e[n]=Array.isArray(t[n])?t[n]:t[n].toString()})),n.fetch("_temp_view"+c,{headers:new wt({"Content-Type":"application/json"}),method:"POST",body:JSON.stringify(e)}).then((function(n){return i=n.ok,f=n.status,n.json()})).then((function(n){if(!i)throw n.status=f,bn(n);return n})).then(o(r))}(n,t,r);if("string"!=typeof t)return c(r,t),Fr.add((function(){return Rr(n,"temp_view/temp_view",t.map,t.reduce,!0,"mrviews").then((function(n){return t=v(n).then((function(){return d(n,r)})),e=function(){return n.db.destroy()},t.then((function(n){return e().then((function(){return n}))}),(function(n){return e().then((function(){throw n}))}));var t,e}))})),Fr.finish();var e=t,i=zr(e),f=i[1];return n.get("_design/"+i[0]).then((function(t){var i=t.views&&t.views[f];if(!i)throw new qr("ddoc "+t._id+" has no view named "+f);return function(n,t){var r=n.views&&n.views[t];if("string"!=typeof r.map)throw new qr("ddoc "+n._id+" has no string view named "+t+", instead found object of type: "+typeof r.map)}(t,f),c(r,i),Rr(n,e,i.map,i.reduce,!1,"mrviews").then((function(n){return"ok"===r.stale||"update_after"===r.stale?("update_after"===r.stale&&h((function(){v(n)})),d(n,r)):v(n).then((function(){return d(n,r)}))}))}))}var y;return{query:function(n,t,r){var e=this;"function"==typeof t&&(r=t,t={}),t=t?function(n){return n.group_level=f(n.group_level),n.limit=f(n.limit),n.skip=f(n.skip),n}(t):{},"function"==typeof n&&(n={map:n});var i=Promise.resolve().then((function(){return l(e,n,t)}));return Sr(i,r),i},viewCleanup:(y=function(){var n=this;return"function"==typeof n._viewCleanup?function(n){return new Promise((function(t,r){n._viewCleanup((function(n,e){if(n)return r(n);t(e)}))}))}(n):gn(n)?function(n){return n.fetch("_view_cleanup",{headers:new wt({"Content-Type":"application/json"}),method:"POST"}).then((function(n){return n.json()}))}(n):function(n){return n.get("_local/mrviews").then((function(t){var r=new P;Object.keys(t.views).forEach((function(n){var t=zr(n),e="_design/"+t[0],i=t[1],o=r.get(e);o||(o=new S,r.set(e,o)),o.add(i)}));var e={keys:Br(r),include_docs:!0};return n.allDocs(e).then((function(e){var i={};e.rows.forEach((function(n){var e=n.key.substring(8);r.get(n.key).forEach((function(r){var o=e+"/"+r;t.views[o]||(o=r);var u=Object.keys(t.views[o]),f=n.doc&&n.doc.views&&n.doc.views[r];u.forEach((function(n){i[n]=i[n]||f}))}))}));var o=Object.keys(i).filter((function(n){return!i[n]})).map((function(t){return Pr(s(t),(function(){return new n.constructor(t,n.__opts).destroy()}))()}));return Promise.all(o).then((function(){return{ok:!0}}))}))}),a({ok:!0}))}(n)},E((function(n){var t=n.pop(),r=y.apply(this,n);return"function"==typeof t&&Sr(r,t),r})))}}(),Qr={query:function(n,t,r){return Zr.query.call(this,n,t,r)},viewCleanup:function(n){return Zr.viewCleanup.call(this,n)}};function Hr(n){return/^1-/.test(n)}function Yr(n,t){var r=Object.keys(t._attachments);return Promise.all(r.map((function(r){return n.getAttachment(t._id,r,{rev:t._rev})})))}function Vr(n,t,r,e){r=J(r);var i=[],o=!0;return Promise.resolve().then((function(){var t=Object.keys(r).filter((function(n){var t=r[n].missing;return 1===t.length&&Hr(t[0])}));if(t.length>0)return function(t){return n.allDocs({keys:t,include_docs:!0,conflicts:!0}).then((function(n){if(e.cancelled)throw new Error("cancelled");n.rows.forEach((function(n){var t;n.deleted||!n.doc||!Hr(n.value.rev)||(t=n.doc)._attachments&&Object.keys(t._attachments).length>0||function(n){return n._conflicts&&n._conflicts.length>0}(n.doc)||(n.doc._conflicts&&delete n.doc._conflicts,i.push(n.doc),delete r[n.id])}))}))}(t)})).then((function(){var u=function(n){var t=[];return Object.keys(n).forEach((function(r){n[r].missing.forEach((function(n){t.push({id:r,rev:n})}))})),{docs:t,revs:!0,latest:!0}}(r);if(u.docs.length)return n.bulkGet(u).then((function(r){if(e.cancelled)throw new Error("cancelled");return Promise.all(r.results.map((function(r){return Promise.all(r.docs.map((function(r){var e=r.ok;return r.error&&(o=!1),e&&e._attachments?function(n,t,r){var e=gn(t)&&!gn(n),i=Object.keys(r._attachments);return e?n.get(r._id).then((function(e){return Promise.all(i.map((function(i){return function(n,t,r){return!n._attachments||!n._attachments[r]||n._attachments[r].digest!==t._attachments[r].digest}(e,r,i)?t.getAttachment(r._id,i):n.getAttachment(e._id,i)})))})).catch((function(n){if(404!==n.status)throw n;return Yr(t,r)})):Yr(t,r)}(t,n,e).then((function(n){var t=Object.keys(e._attachments);return n.forEach((function(n,r){var i=e._attachments[t[r]];delete i.stub,delete i.length,i.data=n})),e})):e})))}))).then((function(n){i=i.concat(mn(n).filter(Boolean))}))}))})).then((function(){return{ok:o,docs:i}}))}function Xr(n,t,r,e,i){return n.get(t).catch((function(r){if(404===r.status)return"http"!==n.adapter&&"https"!==n.adapter||Y(404,"PouchDB is just checking if a remote checkpoint exists."),{session_id:e,_id:t,history:[],replicator:"pouchdb",version:1};throw r})).then((function(o){if(!i.cancelled&&o.last_seq!==r)return o.history=(o.history||[]).filter((function(n){return n.session_id!==e})),o.history.unshift({last_seq:r,session_id:e}),o.history=o.history.slice(0,5),o.version=1,o.replicator="pouchdb",o.session_id=e,o.last_seq=r,n.put(o).catch((function(o){if(409===o.status)return Xr(n,t,r,e,i);throw o}))}))}function ne(n,t,r,e,i){this.src=n,this.target=t,this.id=r,this.returnValue=e,this.opts=i||{}}ne.prototype.writeCheckpoint=function(n,t){var r=this;return this.updateTarget(n,t).then((function(){return r.updateSource(n,t)}))},ne.prototype.updateTarget=function(n,t){return this.opts.writeTargetCheckpoint?Xr(this.target,this.id,n,t,this.returnValue):Promise.resolve(!0)},ne.prototype.updateSource=function(n,t){if(this.opts.writeSourceCheckpoint){var r=this;return Xr(this.src,this.id,n,t,this.returnValue).catch((function(n){if(ee(n))return r.opts.writeSourceCheckpoint=!1,!0;throw n}))}return Promise.resolve(!0)};var te={undefined:function(n,t){return 0===At(n.last_seq,t.last_seq)?t.last_seq:0},1:function(n,t){return(r=t,e=n,r.session_id===e.session_id?{last_seq:r.last_seq,history:r.history}:function n(t,r){var e=t[0],i=t.slice(1),o=r[0],u=r.slice(1);return e&&0!==r.length?re(e.session_id,r)?{last_seq:e.last_seq,history:t}:re(o.session_id,i)?{last_seq:o.last_seq,history:u}:n(i,u):{last_seq:0,history:[]}}(r.history,e.history)).last_seq;var r,e}};function re(n,t){var r=t[0],e=t.slice(1);return!(!n||0===t.length)&&(n===r.session_id||re(n,e))}function ee(n){return"number"==typeof n.status&&4===Math.floor(n.status/100)}function ie(n,t,r,e,i){var o,u,f=[],c={seq:0,changes:[],docs:[]},a=!1,s=!1,v=!1,d=0,l=r.continuous||r.live||!1,y=r.batch_size||100,p=r.batches_limit||10,b=!1,w=r.doc_ids,m=r.selector,_=[],g=Ln();i=i||{ok:!0,start_time:(new Date).toISOString(),docs_read:0,docs_written:0,doc_write_failures:0,errors:[]};var k={};function j(){return u?Promise.resolve():function(n,t,r){var e=r.doc_ids?r.doc_ids.sort(At):"",i=r.filter?r.filter.toString():"",o="",u="",f="";return r.selector&&(f=JSON.stringify(r.selector)),r.filter&&r.query_params&&(o=JSON.stringify(function(n){return Object.keys(n).sort(At).reduce((function(t,r){return t[r]=n[r],t}),{})}(r.query_params))),r.filter&&"_view"===r.filter&&(u=r.view.toString()),Promise.all([n.id(),t.id()]).then((function(n){var t=n[0]+n[1]+i+u+o+e+f;return new Promise((function(n){Fn(t,n)}))})).then((function(n){return"_local/"+n.replace(/\//g,".").replace(/\+/g,"_")}))}(n,t,r).then((function(i){u=new ne(n,t,i,e,!1===r.checkpoint?{writeSourceCheckpoint:!1,writeTargetCheckpoint:!1}:"source"===r.checkpoint?{writeSourceCheckpoint:!0,writeTargetCheckpoint:!1}:"target"===r.checkpoint?{writeSourceCheckpoint:!1,writeTargetCheckpoint:!0}:{writeSourceCheckpoint:!0,writeTargetCheckpoint:!0})}))}function O(){if(_=[],0!==o.docs.length){var n=o.docs;return t.bulkDocs({docs:n,new_edits:!1},{timeout:r.timeout}).then((function(t){if(e.cancelled)throw E(),new Error("cancelled");var r=Object.create(null);t.forEach((function(n){n.error&&(r[n.id]=n)}));var o=Object.keys(r).length;i.doc_write_failures+=o,i.docs_written+=n.length-o,n.forEach((function(n){var t=r[n._id];if(t){i.errors.push(t);var o=(t.name||"").toLowerCase();if("unauthorized"!==o&&"forbidden"!==o)throw t;e.emit("denied",J(t))}else _.push(n)}))}),(function(t){throw i.doc_write_failures+=n.length,t}))}}function $(){if(o.error)throw new Error("There was a problem getting docs.");i.last_seq=d=o.seq;var n=J(i);return _.length&&(n.docs=_,"number"==typeof o.pending&&(n.pending=o.pending,delete o.pending),e.emit("change",n)),a=!0,u.writeCheckpoint(o.seq,g).then((function(){if(a=!1,e.cancelled)throw E(),new Error("cancelled");o=void 0,I()})).catch((function(n){throw M(n),n}))}function q(){return Vr(n,t,o.diffs,e).then((function(n){o.error=!n.ok,n.docs.forEach((function(n){delete o.diffs[n._id],i.docs_read++,o.docs.push(n)}))}))}function A(){var n;e.cancelled||o||(0!==f.length?(o=f.shift(),(n={},o.changes.forEach((function(t){"_user/"!==t.id&&(n[t.id]=t.changes.map((function(n){return n.rev})))})),t.revsDiff(n).then((function(n){if(e.cancelled)throw E(),new Error("cancelled");o.diffs=n}))).then(q).then(O).then($).then(A).catch((function(n){P("batch processing terminated with error",n)}))):S(!0))}function S(n){0!==c.changes.length?(n||s||c.changes.length>=y)&&(f.push(c),c={seq:0,changes:[],docs:[]},"pending"!==e.state&&"stopped"!==e.state||(e.state="active",e.emit("active")),A()):0!==f.length||o||((l&&k.live||s)&&(e.state="pending",e.emit("paused")),s&&E())}function P(n,t){v||(t.message||(t.message=n),i.ok=!1,i.status="aborting",f=[],c={seq:0,changes:[],docs:[]},E(t))}function E(o){if(!(v||e.cancelled&&(i.status="cancelled",a)))if(i.status=i.status||"complete",i.end_time=(new Date).toISOString(),i.last_seq=d,v=!0,o){(o=pn(o)).result=i;var u=(o.name||"").toLowerCase();"unauthorized"===u||"forbidden"===u?(e.emit("error",o),e.removeAllListeners()):function(n,t,r,e){if(!1===n.retry)return t.emit("error",r),void t.removeAllListeners();if("function"!=typeof n.back_off_function&&(n.back_off_function=H),t.emit("requestError",r),"active"===t.state||"pending"===t.state){t.emit("paused",r),t.state="stopped";var i=function(){n.current_back_off=0};t.once("paused",(function(){t.removeListener("active",i)})),t.once("active",i)}n.current_back_off=n.current_back_off||0,n.current_back_off=n.back_off_function(n.current_back_off),setTimeout(e,n.current_back_off)}(r,e,o,(function(){ie(n,t,r,e)}))}else e.emit("complete",i),e.removeAllListeners()}function B(n,t,i){if(e.cancelled)return E();"number"==typeof t&&(c.pending=t),wn(r)(n)&&(c.seq=n.seq||i,c.changes.push(n),h((function(){S(0===f.length&&k.live)})))}function x(n){if(b=!1,e.cancelled)return E();if(n.results.length>0)k.since=n.results[n.results.length-1].seq,I(),S(!0);else{var t=function(){l?(k.live=!0,I()):s=!0,S(!0)};o||0!==n.results.length?t():(a=!0,u.writeCheckpoint(n.last_seq,g).then((function(){a=!1,i.last_seq=d=n.last_seq,t()})).catch(M))}}function D(n){if(b=!1,e.cancelled)return E();P("changes rejected",n)}function I(){if(!b&&!s&&f.length<p){b=!0,e._changes&&(e.removeListener("cancel",e._abortChanges),e._changes.cancel()),e.once("cancel",i);var t=n.changes(k).on("change",B);t.then(o,o),t.then(x).catch(D),r.retry&&(e._changes=t,e._abortChanges=i)}function i(){t.cancel()}function o(){e.removeListener("cancel",i)}}function N(){j().then((function(){if(!e.cancelled)return u.getCheckpoint().then((function(n){k={since:d=n,limit:y,batch_size:y,style:"all_docs",doc_ids:w,selector:m,return_docs:!0},r.filter&&("string"!=typeof r.filter?k.include_docs=!0:k.filter=r.filter),"heartbeat"in r&&(k.heartbeat=r.heartbeat),"timeout"in r&&(k.timeout=r.timeout),r.query_params&&(k.query_params=r.query_params),r.view&&(k.view=r.view),I()}));E()})).catch((function(n){P("getCheckpoint rejected with ",n)}))}function M(n){a=!1,P("writeCheckpoint completed with error",n)}e.ready(n,t),e.cancelled?E():(e._addedListeners||(e.once("cancel",E),"function"==typeof r.complete&&(e.once("error",r.complete),e.once("complete",(function(n){r.complete(null,n)}))),e._addedListeners=!0),void 0===r.since?N():j().then((function(){return a=!0,u.writeCheckpoint(r.since,g)})).then((function(){a=!1,e.cancelled?E():(d=r.since,N())})).catch(M))}function oe(){i.call(this),this.cancelled=!1,this.state="pending";var n=this,t=new Promise((function(t,r){n.once("complete",t),n.once("error",r)}));n.then=function(n,r){return t.then(n,r)},n.catch=function(n){return t.catch(n)},n.catch((function(){}))}function ue(n,t){return"string"==typeof n?new(0,t.PouchConstructor)(n,t):n}function fe(n,t,r,e){if("function"==typeof r&&(e=r,r={}),void 0===r&&(r={}),r.doc_ids&&!Array.isArray(r.doc_ids))throw pn(vn,"`doc_ids` filter parameter is not a list.");r.complete=e,(r=J(r)).continuous=r.continuous||r.live,r.retry="retry"in r&&r.retry,r.PouchConstructor=r.PouchConstructor||this;var i=new oe(r);return ie(ue(n,r),ue(t,r),r,i),i}function ce(n,t,r,e){return"function"==typeof r&&(e=r,r={}),void 0===r&&(r={}),(r=J(r)).PouchConstructor=r.PouchConstructor||this,new ae(n=ue(n,r),t=ue(t,r),r,e)}function ae(n,t,r,e){var i=this;this.canceled=!1;var o=r.push?V({},r,r.push):r,u=r.pull?V({},r,r.pull):r;function f(n){i.emit("change",{direction:"pull",change:n})}function c(n){i.emit("change",{direction:"push",change:n})}function a(n){i.emit("denied",{direction:"push",doc:n})}function s(n){i.emit("denied",{direction:"pull",doc:n})}function v(){i.pushPaused=!0,i.pullPaused&&i.emit("paused")}function d(){i.pullPaused=!0,i.pushPaused&&i.emit("paused")}function l(){i.pushPaused=!1,i.pullPaused&&i.emit("active",{direction:"push"})}function h(){i.pullPaused=!1,i.pushPaused&&i.emit("active",{direction:"pull"})}this.push=fe(n,t,o),this.pull=fe(t,n,u),this.pushPaused=!0,this.pullPaused=!0;var y={};function p(n){return function(t,r){("change"===t&&(r===f||r===c)||"denied"===t&&(r===s||r===a)||"paused"===t&&(r===d||r===v)||"active"===t&&(r===h||r===l))&&(t in y||(y[t]={}),y[t][n]=!0,2===Object.keys(y[t]).length&&i.removeAllListeners(t))}}function b(n,t,r){-1==n.listeners(t).indexOf(r)&&n.on(t,r)}r.live&&(this.push.on("complete",i.pull.cancel.bind(i.pull)),this.pull.on("complete",i.push.cancel.bind(i.push))),this.on("newListener",(function(n){"change"===n?(b(i.pull,"change",f),b(i.push,"change",c)):"denied"===n?(b(i.pull,"denied",s),b(i.push,"denied",a)):"active"===n?(b(i.pull,"active",h),b(i.push,"active",l)):"paused"===n&&(b(i.pull,"paused",d),b(i.push,"paused",v))})),this.on("removeListener",(function(n){"change"===n?(i.pull.removeListener("change",f),i.push.removeListener("change",c)):"denied"===n?(i.pull.removeListener("denied",s),i.push.removeListener("denied",a)):"active"===n?(i.pull.removeListener("active",h),i.push.removeListener("active",l)):"paused"===n&&(i.pull.removeListener("paused",d),i.push.removeListener("paused",v))})),this.pull.on("removeListener",p("pull")),this.push.on("removeListener",p("push"));var w=Promise.all([this.push,this.pull]).then((function(n){var t={push:n[0],pull:n[1]};return i.emit("complete",t),e&&e(null,t),i.removeAllListeners(),t}),(function(n){if(i.cancel(),e?e(n):i.emit("error",n),i.removeAllListeners(),e)throw n}));this.then=function(n,t){return w.then(n,t)},this.catch=function(n){return w.catch(n)}}function se(n,t,r){Error.call(this,r),this.status=n,this.name=t,this.message=r,this.error=!0}ne.prototype.getCheckpoint=function(){var n=this;return n.opts&&n.opts.writeSourceCheckpoint&&!n.opts.writeTargetCheckpoint?n.src.get(n.id).then((function(n){return n.last_seq||0})).catch((function(n){if(404!==n.status)throw n;return 0})):n.target.get(n.id).then((function(t){return n.opts&&n.opts.writeTargetCheckpoint&&!n.opts.writeSourceCheckpoint?t.last_seq||0:n.src.get(n.id).then((function(n){return t.version!==n.version?0:(r=t.version?t.version.toString():"undefined")in te?te[r](t,n):0;var r}),(function(r){if(404===r.status&&t.last_seq)return n.src.put({_id:n.id,last_seq:0}).then((function(){return 0}),(function(r){return ee(r)?(n.opts.writeSourceCheckpoint=!1,t.last_seq):0}));throw r}))})).catch((function(n){if(404!==n.status)throw n;return 0}))},B(oe,i),oe.prototype.cancel=function(){this.cancelled=!0,this.state="cancelled",this.emit("cancel")},oe.prototype.ready=function(n,t){var r=this;function e(){r.cancel()}r._readyCalled||(r._readyCalled=!0,n.once("destroyed",e),t.once("destroyed",e),r.once("complete",(function(){n.removeListener("destroyed",e),t.removeListener("destroyed",e)})))},B(ae,i),ae.prototype.cancel=function(){this.canceled||(this.canceled=!0,this.push.cancel(),this.pull.cancel())},yt.plugin((function(n){n.adapter("idb",pr,!0)})).plugin((function(n){n.adapter("http",Or,!1),n.adapter("https",Or,!1)})).plugin(Qr).plugin((function(n){n.replicate=fe,n.sync=ce,Object.defineProperty(n.prototype,"replicate",{get:function(){var n=this;return void 0===this.replicateMethods&&(this.replicateMethods={from:function(t,r,e){return n.constructor.replicate(t,n,r,e)},to:function(t,r,e){return n.constructor.replicate(n,t,r,e)}}),this.replicateMethods}}),n.prototype.sync=function(n,t,r){return this.constructor.sync(this,n,t,r)}})),B(se,Error),se.prototype.toString=function(){return JSON.stringify({status:this.status,name:this.name,message:this.message,reason:this.reason})},new se(401,"unauthorized","Name or password is incorrect."),new se(400,"bad_request","Missing JSON list of 'docs'"),new se(404,"not_found","missing"),new se(409,"conflict","Document update conflict"),new se(400,"bad_request","_id field must contain a string"),new se(412,"missing_id","_id is required for puts"),new se(400,"bad_request","Only reserved document ids may start with underscore."),new se(412,"precondition_failed","Database not open");var ve=new se(500,"unknown_error","Database encountered an unknown error");function de(n){if("object"!=typeof n){var t=n;(n=ve).data=t}return"error"in n&&"conflict"===n.error&&(n.name="conflict",n.status=409),"name"in n||(n.name=n.error||"unknown"),"status"in n||(n.status=500),"message"in n||(n.message=n.message||n.reason),n}new se(500,"badarg","Some query argument is invalid"),new se(400,"invalid_request","Request was invalid"),new se(400,"query_parse_error","Some query parameter is invalid"),new se(500,"doc_validation","Bad special document member"),new se(400,"bad_request","Something wrong with the request"),new se(400,"bad_request","Document must be a JSON object"),new se(404,"not_found","Database not found"),new se(500,"indexed_db_went_bad","unknown"),new se(500,"web_sql_went_bad","unknown"),new se(500,"levelDB_went_went_bad","unknown"),new se(403,"forbidden","Forbidden by design doc validate_doc_update function"),new se(400,"bad_request","Invalid rev format"),new se(412,"file_exists","The database could not be created, the file already exists."),new se(412,"missing_stub","A pre-existing attachment stub wasn't found"),new se(413,"invalid_url","Provided URL is invalid");var le,he,ye=Headers;function pe(n){return"$"+n}function be(n){return n.substring(1)}function we(){this._store={}}function me(n){if(this._store=new we,n&&Array.isArray(n))for(var t=0,r=n.length;t<r;t++)this.add(n[t])}function _e(n){for(var t=n.length,r=new ArrayBuffer(t),e=new Uint8Array(r),i=0;i<t;i++)e[i]=n.charCodeAt(i);return r}function ge(n,t){return function(n,t){return function(n,t){n=n||[],t=t||{};try{return new Blob(n,t)}catch(Vi){if("TypeError"!==Vi.name)throw Vi;for(var r=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),e=0;e<n.length;e+=1)r.append(n[e]);return r.getBlob(t.type)}}([_e(n)],{type:t})}(atob(n),t)}function ke(n,t){if(n===t)return 0;n=je(n),t=je(t);var r=Ae(n),e=Ae(t);if(r-e!=0)return r-e;switch(typeof n){case"number":return n-t;case"boolean":return n<t?-1:1;case"string":return function(n,t){return n===t?0:n>t?1:-1}(n,t)}return Array.isArray(n)?function(n,t){for(var r=Math.min(n.length,t.length),e=0;e<r;e++){var i=ke(n[e],t[e]);if(0!==i)return i}return n.length===t.length?0:n.length>t.length?1:-1}(n,t):function(n,t){for(var r=Object.keys(n),e=Object.keys(t),i=Math.min(r.length,e.length),o=0;o<i;o++){var u=ke(r[o],e[o]);if(0!==u)return u;if(0!==(u=ke(n[r[o]],t[e[o]])))return u}return r.length===e.length?0:r.length>e.length?1:-1}(n,t)}function je(n){switch(typeof n){case"undefined":return null;case"number":return n===1/0||n===-1/0||isNaN(n)?null:n;case"object":var t=n;if(Array.isArray(n)){var r=n.length;n=new Array(r);for(var e=0;e<r;e++)n[e]=je(t[e])}else{if(n instanceof Date)return n.toJSON();if(null!==n)for(var i in n={},t)if(t.hasOwnProperty(i)){var o=t[i];void 0!==o&&(n[i]=je(o))}}}return n}function Oe(n){return Ae(n=je(n))+""+function(n){if(null!==n)switch(typeof n){case"boolean":return n?1:0;case"number":return function(n){if(0===n)return"1";var t,r=n.toExponential().split(/e\+?/),e=parseInt(r[1],10),i=n<0,o=i?"0":"2";o+=""+("0",3,function(n){for(var t="",r=3-n.length;t.length<r;)t+="0";return t}(t=((i?-e:e)- -324).toString())+t);var u=Math.abs(parseFloat(r[0]));i&&(u=10-u);var f=u.toFixed(20);return o+""+(f=f.replace(/\.?0+$/,""))}(n);case"string":return n.replace(/\u0002/g,"").replace(/\u0001/g,"").replace(/\u0000/g,"");case"object":var t=Array.isArray(n),r=t?n:Object.keys(n),e=-1,i=r.length,o="";if(t)for(;++e<i;)o+=Oe(r[e]);else for(;++e<i;){var u=r[e];o+=Oe(u)+Oe(n[u])}return o}return""}(n)+"\0"}function $e(n,t){var r,e=t;if("1"===n[t])r=0,t++;else{var i="0"===n[t];t++;var o="",u=n.substring(t,t+3),f=parseInt(u,10)+-324;for(i&&(f=-f),t+=3;;){var c=n[t];if("\0"===c)break;o+=c,t++}r=1===(o=o.split(".")).length?parseInt(o,10):parseFloat(o[0]+"."+o[1]),i&&(r-=10),0!==f&&(r=parseFloat(r+"e"+f))}return{num:r,length:t-e}}function qe(n,t){var r=n.pop();if(t.length){var e=t[t.length-1];r===e.element&&(t.pop(),e=t[t.length-1]);var i=e.element,o=e.index;Array.isArray(i)?i.push(r):o===n.length-2?i[n.pop()]=r:n.push(r)}}function Ae(n){var t=["boolean","number","string","object"].indexOf(typeof n);return~t?null===n?1:Array.isArray(n)?5:t<3?t+2:t+3:Array.isArray(n)?5:void 0}function Se(n){return q.hash(n)}we.prototype.get=function(n){var t=pe(n);return this._store[t]},we.prototype.set=function(n,t){var r=pe(n);return this._store[r]=t,!0},we.prototype.has=function(n){return pe(n)in this._store},we.prototype.delete=function(n){var t=pe(n),r=t in this._store;return delete this._store[t],r},we.prototype.forEach=function(n){for(var t=Object.keys(this._store),r=0,e=t.length;r<e;r++){var i=t[r];n(this._store[i],i=be(i))}},Object.defineProperty(we.prototype,"size",{get:function(){return Object.keys(this._store).length}}),me.prototype.add=function(n){return this._store.set(n,!0)},me.prototype.has=function(n){return this._store.has(n)},me.prototype.forEach=function(n){this._store.forEach((function(t,r){n(r)}))},Object.defineProperty(me.prototype,"size",{get:function(){return this._store.size}}),function(){if("undefined"==typeof Symbol||"undefined"==typeof Map||"undefined"==typeof Set)return!1;var n=Object.getOwnPropertyDescriptor(Map,Symbol.species);return n&&"get"in n&&Map[Symbol.species]===Map}()?(le=Set,he=Map):(le=me,he=we);var Pe,Ee=Function.prototype.toString,Be=Ee.call(Object);function xe(n){var t,r,e;if(!n||"object"!=typeof n)return n;if(Array.isArray(n)){for(t=[],r=0,e=n.length;r<e;r++)t[r]=xe(n[r]);return t}if(n instanceof Date)return n.toISOString();if(function(n){return"undefined"!=typeof ArrayBuffer&&n instanceof ArrayBuffer||"undefined"!=typeof Blob&&n instanceof Blob}(n))return function(n){if(n instanceof ArrayBuffer)return function(n){if("function"==typeof n.slice)return n.slice(0);var t=new ArrayBuffer(n.byteLength),r=new Uint8Array(t),e=new Uint8Array(n);return r.set(e),t}(n);var t=n.size,r=n.type;return"function"==typeof n.slice?n.slice(0,t,r):n.webkitSlice(0,t,r)}(n);if(!function(n){var t=Object.getPrototypeOf(n);if(null===t)return!0;var r=t.constructor;return"function"==typeof r&&r instanceof r&&Ee.call(r)==Be}(n))return n;for(r in t={},n)if(Object.prototype.hasOwnProperty.call(n,r)){var i=xe(n[r]);void 0!==i&&(t[r]=i)}return t}function De(n){return E((function(t){t=xe(t);var r=this,e="function"==typeof t[t.length-1]&&t.pop(),i=new Promise((function(e,i){var o;try{var u=function(n){var t=!1;return E((function(r){if(t)throw new Error("once called more than once");t=!0,n.apply(this,r)}))}((function(n,t){n?i(n):e(t)}));t.push(u),(o=n.apply(r,t))&&"function"==typeof o.then&&e(o)}catch(Vi){i(Vi)}}));return e&&i.then((function(n){e(null,n)}),e),i}))}try{localStorage.setItem("_pouch_check_localstorage",1),Pe=!!localStorage.getItem("_pouch_check_localstorage")}catch(Vi){Pe=!1}function Ie(){return Pe}function Ne(){var n;i.call(this),this._listeners={},n=this,Ie()&&addEventListener("storage",(function(t){n.emit(t.key)}))}function Me(n){if("undefined"!=typeof console&&"function"==typeof console[n]){var t=Array.prototype.slice.call(arguments,1);console[n].apply(console,t)}}B(Ne,i),Ne.prototype.addListener=function(n,t,r,e){if(!this._listeners[t]){var i=this,o=!1;this._listeners[t]=u,this.on(n,u)}function u(){if(i._listeners[t])if(o)o="waiting";else{o=!0;var n=function(n,t){for(var r={},e=0,i=t.length;e<i;e++){var o=t[e];o in n&&(r[o]=n[o])}return r}(e,["style","include_docs","attachments","conflicts","filter","doc_ids","view","since","query_params","binary","return_docs"]);r.changes(n).on("change",(function(n){n.seq>e.since&&!e.cancelled&&(e.since=n.seq,e.onChange(n))})).on("complete",(function(){"waiting"===o&&h(u),o=!1})).on("error",(function(){o=!1}))}}},Ne.prototype.removeListener=function(n,t){t in this._listeners&&(i.prototype.removeListener.call(this,n,this._listeners[t]),delete this._listeners[t])},Ne.prototype.notifyLocalWindows=function(n){Ie()&&(localStorage[n]="a"===localStorage[n]?"b":"a")},Ne.prototype.notify=function(n){this.emit(n),this.notifyLocalWindows(n)};var Te="function"==typeof Object.assign?Object.assign:function(n){for(var t=Object(n),r=1;r<arguments.length;r++){var e=arguments[r];if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])}return t};function Ce(n){for(var t=[],r=0,e=n.length;r<e;r++)t=t.concat(n[r]);return t}function Je(n){return"boolean"==typeof n._remote?n._remote:"function"==typeof n.type&&(Me("warn","db.type() is deprecated and will be removed in a future version of PouchDB"),"http"===n.type())}function Re(n,t,r){return new Promise((function(e,i){n.get(t,(function(o,u){if(o){if(404!==o.status)return i(o);u={}}var f=u._rev,c=r(u);if(!c)return e({updated:!1,rev:f});c._id=t,c._rev=f,e(function(n,t,r){return n.put(t).then((function(n){return{updated:!0,rev:n.rev}}),(function(e){if(409!==e.status)throw e;return Re(n,t._id,r)}))}(n,c,r))}))}))}function Ue(n){this.status=400,this.name="query_parse_error",this.message=n,this.error=!0;try{Error.captureStackTrace(this,Ue)}catch(Vi){}}function Fe(n){this.status=404,this.name="not_found",this.message=n,this.error=!0;try{Error.captureStackTrace(this,Fe)}catch(Vi){}}function ze(n){this.status=500,this.name="invalid_value",this.message=n,this.error=!0;try{Error.captureStackTrace(this,ze)}catch(Vi){}}function Ke(n,t){return t&&n.then((function(n){h((function(){t(null,n)}))}),(function(n){h((function(){t(n)}))})),n}function Le(n,t){return function(){var r=arguments,e=this;return n.add((function(){return t.apply(e,r)}))}}function Ge(n){var t=new le(n),r=new Array(t.size),e=-1;return t.forEach((function(n){r[++e]=n})),r}function We(n){var t=new Array(n.size),r=-1;return n.forEach((function(n,e){t[++r]=e})),t}function Ze(){this.promise=new Promise((function(n){n()}))}function Qe(n){if(!n)return"undefined";switch(typeof n){case"function":case"string":return n.toString();default:return JSON.stringify(n)}}function He(n,t,r,e,i,o){var u,f=function(n,t){return Qe(n)+Qe(t)+"undefined"}(r,e);if(!i&&(u=n._cachedViews=n._cachedViews||{})[f])return u[f];var c=n.info().then((function(c){var a=c.db_name+"-mrview-"+(i?"temp":Se(f));return Re(n,"_local/"+o,(function(n){n.views=n.views||{};var r=t;-1===r.indexOf("/")&&(r=t+"/"+t);var e=n.views[r]=n.views[r]||{};if(!e[a])return e[a]=!0,n})).then((function(){return n.registerDependentDatabase(a).then((function(t){var i=t.db;i.auto_compaction=!0;var o={name:a,db:i,sourceDB:n,adapter:n.adapter,mapFun:r,reduceFun:e};return o.db.get("_local/lastSeq").catch((function(n){if(404!==n.status)throw n})).then((function(n){return o.seq=n?n.seq:0,u&&o.db.once("destroyed",(function(){delete u[f]})),o}))}))}))}));return u&&(u[f]=c),c}B(Ue,Error),B(Fe,Error),B(ze,Error),Ze.prototype.add=function(n){return this.promise=this.promise.catch((function(){})).then((function(){return n()})),this.promise},Ze.prototype.finish=function(){return this.promise};var Ye={},Ve=new Ze;function Xe(n){return-1===n.indexOf("/")?[n,n]:n.split("/")}function ni(n,t){try{n.emit("error",t)}catch(r){Me("error","The user's map/reduce function threw an uncaught error.\nYou can debug this error by doing:\nmyDatabase.on('error', function (err) { debugger; });\nPlease double-check your map/reduce function."),Me("error",t)}}function ti(n,t){for(var r=n,e=0,i=t.length;e<i&&(r=r[t[e]]);e++);return r}function ri(n,t,r){for(var e=0,i=t.length;e<i-1;e++){var o=t[e];n=n[o]=n[o]||{}}n[t[i-1]]=r}function ei(n,t){return n<t?-1:n>t?1:0}function ii(n){for(var t=[],r="",e=0,i=n.length;e<i;e++){var o=n[e];"."===o?e>0&&"\\"===n[e-1]?r=r.substring(0,r.length-1)+".":(t.push(r),r=""):r+=o}return t.push(r),t}var oi=["$or","$nor","$not"];function ui(n){return oi.indexOf(n)>-1}function fi(n){return Object.keys(n)[0]}function ci(n){return n[fi(n)]}function ai(n){var t={};return n.forEach((function(n){Object.keys(n).forEach((function(r){var e=n[r];if("object"!=typeof e&&(e={$eq:e}),ui(r))t[r]=e instanceof Array?e.map((function(n){return ai([n])})):ai([e]);else{var i=t[r]=t[r]||{};Object.keys(e).forEach((function(n){var t=e[n];return"$gt"===n||"$gte"===n?function(n,t,r){void 0===r.$eq&&(void 0!==r.$gte?"$gte"===n?t>r.$gte&&(r.$gte=t):t>=r.$gte&&(delete r.$gte,r.$gt=t):void 0!==r.$gt?"$gte"===n?t>r.$gt&&(delete r.$gt,r.$gte=t):t>r.$gt&&(r.$gt=t):r[n]=t)}(n,t,i):"$lt"===n||"$lte"===n?function(n,t,r){void 0===r.$eq&&(void 0!==r.$lte?"$lte"===n?t<r.$lte&&(r.$lte=t):t<=r.$lte&&(delete r.$lte,r.$lt=t):void 0!==r.$lt?"$lte"===n?t<r.$lt&&(delete r.$lt,r.$lte=t):t<r.$lt&&(r.$lt=t):r[n]=t)}(n,t,i):"$ne"===n?function(n,t){"$ne"in t?t.$ne.push(n):t.$ne=[n]}(t,i):"$eq"===n?function(n,t){delete t.$gt,delete t.$gte,delete t.$lt,delete t.$lte,delete t.$ne,t.$eq=n}(t,i):void(i[n]=t)}))}}))})),t}function si(n,t,r){return r.every((function(r){var e=t[r],i=ii(r),o=ti(n,i);return ui(r)?function(n,t,r){return"$or"===n?t.some((function(n){return si(r,n,Object.keys(n))})):"$not"===n?!si(r,t,Object.keys(t)):!t.find((function(n){return si(r,n,Object.keys(n))}))}(r,e,n):vi(e,n,i,o)}))}function vi(n,t,r,e){return!n||("object"==typeof n?Object.keys(n).every((function(i){return function(n,t,r,e,i){if(!yi[n])throw new Error('unknown operator "'+n+'" - should be one of $eq, $lte, $lt, $gt, $gte, $exists, $ne, $in, $nin, $size, $mod, $regex, $elemMatch, $type, $allMatch or $all');return yi[n](t,r,e,i)}(i,t,n[i],r,e)})):n===e)}function di(n){return null!=n}function li(n){return void 0!==n}function hi(n,t){return t.some((function(t){return n instanceof Array?n.indexOf(t)>-1:n===t}))}var yi={$elemMatch:function(n,t,r,e){return!!Array.isArray(e)&&0!==e.length&&e.some("object"==typeof e[0]?function(n){return si(n,t,Object.keys(t))}:function(e){return vi(t,n,r,e)})},$allMatch:function(n,t,r,e){return!!Array.isArray(e)&&0!==e.length&&e.every("object"==typeof e[0]?function(n){return si(n,t,Object.keys(t))}:function(e){return vi(t,n,r,e)})},$eq:function(n,t,r,e){return li(e)&&0===ke(e,t)},$gte:function(n,t,r,e){return li(e)&&ke(e,t)>=0},$gt:function(n,t,r,e){return li(e)&&ke(e,t)>0},$lte:function(n,t,r,e){return li(e)&&ke(e,t)<=0},$lt:function(n,t,r,e){return li(e)&&ke(e,t)<0},$exists:function(n,t,r,e){return t?li(e):!li(e)},$mod:function(n,t,r,e){return di(e)&&function(n,t){var r=t[0],e=t[1];if(0===r)throw new Error("Bad divisor, cannot divide by zero");if(parseInt(r,10)!==r)throw new Error("Divisor is not an integer");if(parseInt(e,10)!==e)throw new Error("Modulus is not an integer");return parseInt(n,10)===n&&n%r===e}(e,t)},$ne:function(n,t,r,e){return t.every((function(n){return 0!==ke(e,n)}))},$in:function(n,t,r,e){return di(e)&&hi(e,t)},$nin:function(n,t,r,e){return di(e)&&!hi(e,t)},$size:function(n,t,r,e){return di(e)&&function(n,t){return n.length===t}(e,t)},$all:function(n,t,r,e){return Array.isArray(e)&&function(n,t){return t.every((function(t){return n.indexOf(t)>-1}))}(e,t)},$regex:function(n,t,r,e){return di(e)&&function(n,t){return new RegExp(t).test(n)}(e,t)},$type:function(n,t,r,e){return function(n,t){switch(t){case"null":return null===n;case"boolean":return"boolean"==typeof n;case"number":return"number"==typeof n;case"string":return"string"==typeof n;case"array":return n instanceof Array;case"object":return"[object Object]"==={}.toString.call(n)}throw new Error(t+" not supported as a type.Please use one of object, string, array, number, boolean or null.")}(e,t)}};function pi(n){return(n=xe(n)).index||(n.index={}),["type","name","ddoc"].forEach((function(t){n.index[t]&&(n[t]=n.index[t],delete n.index[t])})),n.fields&&(n.index.fields=n.fields,delete n.fields),n.type||(n.type="json"),n}function bi(n,t,r,e){var i,o;r.headers=new ye({"Content-type":"application/json"}),n.fetch(t,r).then((function(n){return i=n.status,o=n.ok,n.json()})).then((function(n){if(o)e(null,n);else{n.status=i;var t=de(n);e(t)}})).catch(e)}function wi(n,t,r){t=pi(t),bi(n,"_index",{method:"POST",body:JSON.stringify(t)},r)}function mi(n,t,r){bi(n,"_find",{method:"POST",body:JSON.stringify(t)},r)}function _i(n,t,r){bi(n,"_explain",{method:"POST",body:JSON.stringify(t)},r)}function gi(n,t){bi(n,"_index",{method:"GET"},t)}function ki(n,t,r){var e=t.ddoc,i=t.name;return e?i?void bi(n,"_index/"+[e,t.type||"json",i].map(encodeURIComponent).join("/"),{method:"DELETE"},r):r(new Error("you must provide an index's name")):r(new Error("you must provide an index's ddoc"))}function ji(n){return function(){for(var t=arguments.length,r=new Array(t),e=-1;++e<t;)r[e]=arguments[e];return n.call(this,r)}}function Oi(n){return ji((function(t){var r=t.pop(),e=n.apply(this,t);return function(n,t){n.then((function(n){h((function(){t(null,n)}))}),(function(n){h((function(){t(n)}))}))}(e,r),e}))}var $i=ji((function(n){for(var t=[],r=0,e=n.length;r<e;r++){var i=n[r];Array.isArray(i)?t=t.concat($i.apply(null,i)):t.push(i)}return t}));function qi(n){for(var t={},r=0,e=n.length;r<e;r++)t=Te(t,n[r]);return t}function Ai(n,t){for(var r=0,e=Math.min(n.length,t.length);r<e;r++)if(n[r]!==t[r])return!1;return!0}function Si(n,t){if(n.length!==t.length)return!1;for(var r=0,e=n.length;r<e;r++)if(n[r]!==t[r])return!1;return!0}var Pi=function(){function n(n,t,r){try{t(r)}catch(Vi){ni(n,Vi)}}function t(n,t,r,e,i){try{return{output:t(r,e,i)}}catch(Vi){return ni(n,Vi),{error:Vi}}}function r(n,t){var r=ke(n.key,t.key);return 0!==r?r:ke(n.value,t.value)}function e(n,t,r){return r=r||0,"number"==typeof t?n.slice(r,t+r):r>0?n.slice(r):n}function i(n){var t=n.value;return t&&"object"==typeof t&&t._id||n.id}function o(n){return function(t){return n.include_docs&&n.attachments&&n.binary&&function(n){n.rows.forEach((function(n){var t=n.doc&&n.doc._attachments;t&&Object.keys(t).forEach((function(n){var r=t[n];t[n].data=ge(r.data,r.content_type)}))}))}(t),t}}function u(n,t,r,e){var i=t[n];void 0!==i&&(e&&(i=encodeURIComponent(JSON.stringify(i))),r.push(n+"="+i))}function f(n){if(void 0!==n){var t=Number(n);return isNaN(t)||t!==parseInt(n,10)?n:t}}function c(n,t){var r=n.descending?"endkey":"startkey",e=n.descending?"startkey":"endkey";if(void 0!==n[r]&&void 0!==n[e]&&ke(n[r],n[e])>0)throw new Ue("No rows can match your key range, reverse your start_key and end_key or set {descending : true}");if(t.reduce&&!1!==n.reduce){if(n.include_docs)throw new Ue("{include_docs:true} is invalid for reduce");if(n.keys&&n.keys.length>1&&!n.group&&!n.group_level)throw new Ue("Multi-key fetches for reduce views must use {group: true}")}["group_level","limit","skip"].forEach((function(t){var r=function(n){if(n){if("number"!=typeof n)return new Ue('Invalid value for integer: "'+n+'"');if(n<0)return new Ue('Invalid value for positive integer: "'+n+'"')}}(n[t]);if(r)throw r}))}function a(n){return function(t){if(404===t.status)return n;throw t}}function s(n){var t="string"==typeof n?n:n.name,r=Ye[t];return r||(r=Ye[t]=new Ze),r}function v(t){return Le(s(t),(function(){return function(t){var e,i,o,u=(o=function(n,t){var r={id:i._id,key:je(n)};null!=t&&(r.value=je(t)),e.push(r)},function(n,t){var r=function(n){for(var t=0,r=n.length;t<r;t++)if(-1!==n[t].indexOf("."))return!1;return!0}(n),e=1===n.length;return r?e?function(n,t){return function(r){t(r[n])}}(n[0],t):function(n,t){return function(r){for(var e=[],i=0,o=n.length;i<o;i++)e.push(r[n[i]]);t(e)}}(n,t):e?function(n,t){var r=ii(n);return function(n){for(var e=n,i=0,o=r.length;i<o;i++)if(void 0===(e=e[r[i]]))return;t(e)}}(n[0],t):function(n,t){return function(r){for(var e=[],i=0,o=n.length;i<o;i++){for(var u=ii(n[i]),f=r,c=0,a=u.length;c<a;c++)if(void 0===(f=f[u[c]]))return;e.push(f)}t(e)}}(n,t)}(Object.keys(t.mapFun.fields),o)),f=t.seq||0;function c(n,r){return function(){return function(n,t,r){return n.db.get("_local/lastSeq").catch(a({_id:"_local/lastSeq",seq:0})).then((function(e){var i=We(t);return Promise.all(i.map((function(r){return function(n,t,r){var e="_local/doc_"+n,i={_id:e,keys:[]},o=r.get(n),u=o[0];return(function(n){return 1===n.length&&/^1-/.test(n[0].rev)}(o[1])?Promise.resolve(i):t.db.get(e).catch(a(i))).then((function(n){return function(n){return n.keys.length?t.db.allDocs({keys:n.keys,include_docs:!0}):Promise.resolve({rows:[]})}(n).then((function(t){return function(n,t){for(var r=[],e=new le,i=0,o=t.rows.length;i<o;i++){var f=t.rows[i].doc;if(f&&(r.push(f),e.add(f._id),f._deleted=!u.has(f._id),!f._deleted)){var c=u.get(f._id);"value"in c&&(f.value=c.value)}}var a=We(u);return a.forEach((function(n){if(!e.has(n)){var t={_id:n},i=u.get(n);"value"in i&&(t.value=i.value),r.push(t)}})),n.keys=Ge(a.concat(n.keys)),r.push(n),r}(n,t)}))}))}(r,n,t)}))).then((function(t){var i=Ce(t);return e.seq=r,i.push(e),n.db.bulkDocs({docs:i})}))}))}(t,n,r)}}var s=new Ze;function v(){return t.sourceDB.changes({return_docs:!0,conflicts:!0,include_docs:!0,style:"all_docs",since:f,limit:50}).then(d)}function d(o){var a=o.results;if(a.length){var d=function(o){for(var c=new he,a=0,s=o.length;a<s;a++){var v=o[a];if("_"!==v.doc._id[0]){e=[],(i=v.doc)._deleted||n(t.sourceDB,u,i),e.sort(r);var d=l(e);c.set(v.doc._id,[d,v.changes])}f=v.seq}return c}(a);if(s.add(c(d,f)),!(a.length<50))return v()}}function l(n){for(var t,r=new he,e=0,i=n.length;e<i;e++){var o=n[e],u=[o.key,o.id];e>0&&0===ke(o.key,t)&&u.push(e),r.set(Oe(u),o),t=o.key}return r}return v().then((function(){return s.finish()})).then((function(){t.seq=f}))}(t)}))()}function d(n,r){return Le(s(n),(function(){return function(n,r){var o,u=n.reduceFun&&!1!==r.reduce,f=r.skip||0;function c(t){return t.include_docs=!0,n.db.allDocs(t).then((function(n){return o=n.total_rows,n.rows.map((function(n){if("value"in n.doc&&"object"==typeof n.doc.value&&null!==n.doc.value){var t=Object.keys(n.doc.value).sort(),r=["id","key","value"];if(!(t<r||t>r))return n.doc.value}var e=function(n){for(var t=[],r=[],e=0;;){var i=n[e++];if("\0"!==i)switch(i){case"1":t.push(null);break;case"2":t.push("1"===n[e]),e++;break;case"3":var o=$e(n,e);t.push(o.num),e+=o.length;break;case"4":for(var u="";;){var f=n[e];if("\0"===f)break;u+=f,e++}u=u.replace(/\u0001\u0001/g,"\0").replace(/\u0001\u0002/g,"").replace(/\u0002\u0002/g,""),t.push(u);break;case"5":var c={element:[],index:t.length};t.push(c.element),r.push(c);break;case"6":var a={element:{},index:t.length};t.push(a.element),r.push(a);break;default:throw new Error("bad collationIndex or unexpectedly reached end of input: "+i)}else{if(1===t.length)return t.pop();qe(t,r)}}}(n.doc._id);return{key:e[0],id:e[1],value:"value"in n.doc?n.doc.value:null}}))}))}function a(c){var a;if(a=u?function(n,r,i){0===i.group_level&&delete i.group_level;var o=i.group||i.group_level,u=function(){throw new Error("reduce not supported")}(),f=[],c=isNaN(i.group_level)?Number.POSITIVE_INFINITY:i.group_level;r.forEach((function(n){var t=f[f.length-1],r=o?n.key:null;if(o&&Array.isArray(r)&&(r=r.slice(0,c)),t&&0===ke(t.groupKey,r))return t.keys.push([n.key,n.id]),void t.values.push(n.value);f.push({keys:[[n.key,n.id]],values:[n.value],groupKey:r})})),r=[];for(var a=0,s=f.length;a<s;a++){var v=f[a],d=t(n.sourceDB,u,v.keys,v.values,!1);if(d.error&&d.error instanceof ze)throw d.error;r.push({value:d.error?null:d.output,key:v.groupKey})}return{rows:e(r,i.limit,i.skip)}}(n,c,r):{total_rows:o,offset:f,rows:c},r.update_seq&&(a.update_seq=n.seq),r.include_docs){var s=Ge(c.map(i));return n.sourceDB.allDocs({keys:s,include_docs:!0,conflicts:r.conflicts,attachments:r.attachments,binary:r.binary}).then((function(n){var t=new he;return n.rows.forEach((function(n){t.set(n.id,n.doc)})),c.forEach((function(n){var r=i(n),e=t.get(r);e&&(n.doc=e)})),a}))}return a}if(void 0===r.keys||r.keys.length||(r.limit=0,delete r.keys),void 0!==r.keys){var s=r.keys.map((function(n){var t={startkey:Oe([n]),endkey:Oe([n,{}])};return r.update_seq&&(t.update_seq=!0),c(t)}));return Promise.all(s).then(Ce).then(a)}var v,d,l={descending:r.descending};if(r.update_seq&&(l.update_seq=!0),"start_key"in r&&(v=r.start_key),"startkey"in r&&(v=r.startkey),"end_key"in r&&(d=r.end_key),"endkey"in r&&(d=r.endkey),void 0!==v&&(l.startkey=Oe(r.descending?[v,{}]:[v])),void 0!==d){var h=!1!==r.inclusive_end;r.descending&&(h=!h),l.endkey=Oe(h?[d,{}]:[d])}if(void 0!==r.key){var y=Oe([r.key]),p=Oe([r.key,{}]);l.descending?(l.endkey=y,l.startkey=p):(l.startkey=y,l.endkey=p)}return u||("number"==typeof r.limit&&(l.limit=r.limit),l.skip=f),c(l).then(a)}(n,r)}))()}function l(n,t,r){if("function"==typeof n._query)return function(n,t,r){return new Promise((function(e,i){n._query(t,r,(function(n,t){if(n)return i(n);e(t)}))}))}(n,t,r);if(Je(n))return function(n,t,r){var e,i,f,c=[],a="GET";if(u("reduce",r,c),u("include_docs",r,c),u("attachments",r,c),u("limit",r,c),u("descending",r,c),u("group",r,c),u("group_level",r,c),u("skip",r,c),u("stale",r,c),u("conflicts",r,c),u("startkey",r,c,!0),u("start_key",r,c,!0),u("endkey",r,c,!0),u("end_key",r,c,!0),u("inclusive_end",r,c),u("key",r,c,!0),u("update_seq",r,c),c=""===(c=c.join("&"))?"":"?"+c,void 0!==r.keys){var s="keys="+encodeURIComponent(JSON.stringify(r.keys));s.length+c.length+1<=2e3?c+=("?"===c[0]?"&":"?")+s:(a="POST","string"==typeof t?e={keys:r.keys}:t.keys=r.keys)}if("string"==typeof t){var v=Xe(t);return n.fetch("_design/"+v[0]+"/_view/"+v[1]+c,{headers:new ye({"Content-Type":"application/json"}),method:a,body:JSON.stringify(e)}).then((function(n){return i=n.ok,f=n.status,n.json()})).then((function(n){if(!i)throw n.status=f,de(n);return n.rows.forEach((function(n){if(n.value&&n.value.error&&"builtin_reduce_error"===n.value.error)throw new Error(n.reason)})),n})).then(o(r))}return e=e||{},Object.keys(t).forEach((function(n){e[n]=Array.isArray(t[n])?t[n]:t[n].toString()})),n.fetch("_temp_view"+c,{headers:new ye({"Content-Type":"application/json"}),method:"POST",body:JSON.stringify(e)}).then((function(n){return i=n.ok,f=n.status,n.json()})).then((function(n){if(!i)throw n.status=f,de(n);return n})).then(o(r))}(n,t,r);if("string"!=typeof t)return c(r,t),Ve.add((function(){return He(n,"temp_view/temp_view",t.map,t.reduce,!0,"indexes").then((function(n){return t=v(n).then((function(){return d(n,r)})),e=function(){return n.db.destroy()},t.then((function(n){return e().then((function(){return n}))}),(function(n){return e().then((function(){throw n}))}));var t,e}))})),Ve.finish();var e=t,i=Xe(e),f=i[1];return n.get("_design/"+i[0]).then((function(t){var i=t.views&&t.views[f];if(!i)throw new Fe("ddoc "+t._id+" has no view named "+f);return function(n,t){var r=n.views[t];if(!r.map||!r.map.fields)throw new Error("ddoc "+n._id+" with view "+t+" doesn't have map.fields defined. maybe it wasn't created by this plugin?")}(t,f),c(r,i),He(n,e,i.map,i.reduce,!1,"indexes").then((function(n){return"ok"===r.stale||"update_after"===r.stale?("update_after"===r.stale&&h((function(){v(n)})),d(n,r)):v(n).then((function(){return d(n,r)}))}))}))}var y;return{query:function(n,t,r){var e=this;"function"==typeof t&&(r=t,t={}),t=t?function(n){return n.group_level=f(n.group_level),n.limit=f(n.limit),n.skip=f(n.skip),n}(t):{},"function"==typeof n&&(n={map:n});var i=Promise.resolve().then((function(){return l(e,n,t)}));return Ke(i,r),i},viewCleanup:(y=function(){var n=this;return"function"==typeof n._viewCleanup?function(n){return new Promise((function(t,r){n._viewCleanup((function(n,e){if(n)return r(n);t(e)}))}))}(n):Je(n)?function(n){return n.fetch("_view_cleanup",{headers:new ye({"Content-Type":"application/json"}),method:"POST"}).then((function(n){return n.json()}))}(n):function(n){return n.get("_local/indexes").then((function(t){var r=new he;Object.keys(t.views).forEach((function(n){var t=Xe(n),e="_design/"+t[0],i=t[1],o=r.get(e);o||(o=new le,r.set(e,o)),o.add(i)}));var e={keys:We(r),include_docs:!0};return n.allDocs(e).then((function(e){var i={};e.rows.forEach((function(n){var e=n.key.substring(8);r.get(n.key).forEach((function(r){var o=e+"/"+r;t.views[o]||(o=r);var u=Object.keys(t.views[o]),f=n.doc&&n.doc.views&&n.doc.views[r];u.forEach((function(n){i[n]=i[n]||f}))}))}));var o=Object.keys(i).filter((function(n){return!i[n]})).map((function(t){return Le(s(t),(function(){return new n.constructor(t,n.__opts).destroy()}))()}));return Promise.all(o).then((function(){return{ok:!0}}))}))}),a({ok:!0}))}(n)},E((function(n){var t=n.pop(),r=y.apply(this,n);return"function"==typeof t&&Ke(r,t),r})))}}();function Ei(n){return n._customFindAbstractMapper||Pi}function Bi(n){return n.fields=n.fields.map((function(n){if("string"==typeof n){var t={};return t[n]="asc",t}return n})),n}function xi(n,t){for(var r=[],e=0;e<t.def.fields.length;e++){var i=fi(t.def.fields[e]);r.push(n[i])}return r}function Di(n){return n.allDocs({startkey:"_design/",endkey:"_design/￿",include_docs:!0}).then((function(n){var t={indexes:[{ddoc:null,name:"_all_docs",type:"special",def:{fields:[{_id:"asc"}]}}]};return t.indexes=$i(t.indexes,n.rows.filter((function(n){return"query"===n.doc.language})).map((function(n){return(void 0!==n.doc.views?Object.keys(n.doc.views):[]).map((function(t){return{ddoc:n.id,name:t,type:"json",def:Bi(n.doc.views[t].options.def)}}))}))),t.indexes.sort((function(n,t){return ei(n.name,t.name)})),t.total_rows=t.indexes.length,t}))}var Ii={"￿":{}};function Ni(n,t){for(var r=n.def.fields.map(fi),e=0,i=r.length;e<i;e++)if(t===r[e])return!0;return!1}function Mi(n,t){return"$eq"!==fi(n[t])}function Ti(n,t){var r=t.def.fields.map(fi);return n.slice().sort((function(n,t){var e=r.indexOf(n),i=r.indexOf(t);return-1===e&&(e=Number.MAX_VALUE),-1===i&&(i=Number.MAX_VALUE),ei(e,i)}))}function Ci(n,t,r,e){var i=$i(n,function(n,t,r){for(var e=!1,i=0,o=(r=Ti(r,n)).length;i<o;i++){var u=r[i];if(e||!Ni(n,u))return r.slice(i);i<o-1&&Mi(t,u)&&(e=!0)}return[]}(t,r,e),function(n){var t=[];return Object.keys(n).forEach((function(r){Object.keys(n[r]).forEach((function(n){"$ne"===n&&t.push(r)}))})),t}(r));return Ti(function(n){for(var t={},r=0;r<n.length;r++)t["$"+n[r]]=!0;return Object.keys(t).map((function(n){return n.substring(1)}))}(i),t)}var Ji=["$eq","$gt","$gte","$lt","$lte"];function Ri(n){return-1===Ji.indexOf(n)}function Ui(n,t,r,e){var i=n.def.fields.map(fi);return!!function(n,t,r){if(t){var e=!((o=t).length>(u=n).length)&&Ai(o,u),i=Ai(r,n);return e&&i}var o,u;return function(n,t){n=n.slice();for(var r=0,e=t.length;r<e;r++){var i=t[r];if(!n.length)break;var o=n.indexOf(i);if(-1===o)return!1;n.splice(o,1)}return!0}(r,n)}(i,t,r)&&function(n,t){var r=t[n[0]];return void 0===r||!(1===Object.keys(r).length&&"$ne"===fi(r))}(i,e)}function Fi(n,t){switch(n){case"$eq":return{startkey:t,endkey:t};case"$lte":return{endkey:t};case"$gte":return{startkey:t};case"$lt":return{endkey:t,inclusive_end:!1};case"$gt":return{startkey:t,inclusive_start:!1}}}function zi(n,t){var r=n.selector,e=function(n,t){var r,e=Object.keys(n),i=t?t.map(fi):[];return r=e.length>=i.length?e:i,0===i.length?{fields:r}:{fields:r=r.sort((function(n,t){var r=i.indexOf(n);-1===r&&(r=Number.MAX_VALUE);var e=i.indexOf(t);return-1===e&&(e=Number.MAX_VALUE),r<e?-1:r>e?1:0})),sortOrder:t.map(fi)}}(r,n.sort),i=e.fields,o=function(n,t,r,e,i){var o=function(n,t,r,e){return e.reduce((function(e,i){return Ui(i,r,t,n)&&e.push(i),e}),[])}(n,t,r,e);if(0===o.length){if(i)throw{error:"no_usable_index",message:"There is no index available for this selector."};var u=e[0];return u.defaultUsed=!0,u}if(1===o.length&&!i)return o[0];var f=function(n){for(var t={},r=0,e=n.length;r<e;r++)t[n[r]]=!0;return t}(t);if(i){var c="_design/"+i[0],a=2===i.length&&i[1],s=o.find((function(n){return!(!a||n.ddoc!==c||a!==n.name)||n.ddoc===c}));if(!s)throw{error:"unknown_error",message:"Could not find that index or could not use that index for the query"};return s}return function(n,t){for(var r=null,e=-1,i=0,o=n.length;i<o;i++){var u=n[i],f=t(u);f>e&&(e=f,r=u)}return r}(o,(function(n){for(var t=n.def.fields.map(fi),r=0,e=0,i=t.length;e<i;e++)f[t[e]]&&r++;return r}))}(r,i,e.sortOrder,t,n.use_index),u=function(n,t){return t.defaultUsed?function(n){return{queryOpts:{startkey:null},inMemoryFields:[Object.keys(n)]}}(n):1===t.def.fields.length?function(n,t){var r,e=fi(t.def.fields[0]),i=n[e]||{},o=[];return Object.keys(i).forEach((function(n){Ri(n)&&o.push(e);var t=function(n,t){switch(n){case"$eq":return{key:t};case"$lte":return{endkey:t};case"$gte":return{startkey:t};case"$lt":return{endkey:t,inclusive_end:!1};case"$gt":return{startkey:t,inclusive_start:!1}}return{startkey:null}}(n,i[n]);r=r?qi([r,t]):t})),{queryOpts:r,inMemoryFields:o}}(n,t):function(n,t){var r,e,i=t.def.fields.map(fi),o=[],u=[],f=[];function c(n){!1!==r&&u.push(null),!1!==e&&f.push(Ii),o=i.slice(n)}for(var a=0,s=i.length;a<s;a++){var v=n[i[a]];if(!v||!Object.keys(v).length){c(a);break}if(a>0){if(Object.keys(v).some(Ri)){c(a);break}var d="$gt"in v||"$gte"in v||"$lt"in v||"$lte"in v,l=Object.keys(n[i[a-1]]),h=Si(l,["$eq"]),y=Si(l,Object.keys(v));if(d&&!h&&!y){c(a);break}}for(var p=Object.keys(v),b=null,w=0;w<p.length;w++){var m=p[w],_=Fi(m,v[m]);b=b?qi([b,_]):_}u.push("startkey"in b?b.startkey:null),f.push("endkey"in b?b.endkey:Ii),"inclusive_start"in b&&(r=b.inclusive_start),"inclusive_end"in b&&(e=b.inclusive_end)}var g={startkey:u,endkey:f};return void 0!==r&&(g.inclusive_start=r),void 0!==e&&(g.inclusive_end=e),{queryOpts:g,inMemoryFields:o}}(n,t)}(r,o);return{queryOpts:u.queryOpts,index:o,inMemoryFields:Ci(u.inMemoryFields,o,r,i)}}function Ki(n,t,r){var e,i;return t.selector&&(t.selector=function(n){var t=xe(n),r=!1;(function n(t,r){for(var e in t){"$and"===e&&(r=!0);var i=t[e];"object"==typeof i&&(r=n(i,r))}return r})(t,!1)&&("$and"in(t=function n(t){for(var r in t){if(Array.isArray(t))for(var e in t)t[e].$and&&(t[e]=ai(t[e].$and));var i=t[r];"object"==typeof i&&n(i)}return t}(t))&&(t=ai(t.$and)),r=!0),["$or","$nor"].forEach((function(n){n in t&&t[n].forEach((function(n){for(var t=Object.keys(n),r=0;r<t.length;r++){var e=t[r],i=n[e];"object"==typeof i&&null!==i||(n[e]={$eq:i})}}))})),"$not"in t&&(t.$not=ai([t.$not]));for(var e=Object.keys(t),i=0;i<e.length;i++){var o=e[i],u=t[o];"object"!=typeof u||null===u?u={$eq:u}:"$ne"in u&&!r&&(u.$ne=[u.$ne]),t[o]=u}return t}(t.selector)),t.sort&&(t.sort=function(n){if(!Array.isArray(n))throw new Error("invalid sort json - should be an array");return n.map((function(n){if("string"==typeof n){var t={};return t[n]="asc",t}return n}))}(t.sort)),t.use_index&&(t.use_index=(i=[],"string"==typeof(e=t.use_index)?i.push(e):i=e,i.map((function(n){return n.replace("_design/","")})))),function(n){if("object"!=typeof n.selector)throw new Error("you must provide a selector when you find()")}(t),Di(n).then((function(e){n.constructor.emit("debug",["find","planning query",t]);var i=zi(t,e.indexes);n.constructor.emit("debug",["find","query plan",i]);var o=i.index;!function(n,t){if(t.defaultUsed&&n.sort){var r=n.sort.filter((function(n){return"_id"!==Object.keys(n)[0]})).map((function(n){return Object.keys(n)[0]}));if(r.length>0)throw new Error('Cannot sort on field(s) "'+r.join(",")+'" when using the default index')}}(t,o);var u=Te({include_docs:!0,reduce:!1},i.queryOpts);return"startkey"in u&&"endkey"in u&&ke(u.startkey,u.endkey)>0?{docs:[]}:(t.sort&&"string"!=typeof t.sort[0]&&"desc"===ci(t.sort[0])&&(u.descending=!0,u=function(n){var t=xe(n);return delete t.startkey,delete t.endkey,delete t.inclusive_start,delete t.inclusive_end,"endkey"in n&&(t.startkey=n.endkey),"startkey"in n&&(t.endkey=n.startkey),"inclusive_start"in n&&(t.inclusive_end=n.inclusive_start),"inclusive_end"in n&&(t.inclusive_start=n.inclusive_end),t}(u)),i.inMemoryFields.length||("limit"in t&&(u.limit=t.limit),"skip"in t&&(u.skip=t.skip)),r?Promise.resolve(i,u):Promise.resolve().then((function(){if("_all_docs"===o.name)return function(n,t){var r=xe(t);return r.descending?("endkey"in r&&"string"!=typeof r.endkey&&(r.endkey=""),"startkey"in r&&"string"!=typeof r.startkey&&(r.limit=0)):("startkey"in r&&"string"!=typeof r.startkey&&(r.startkey=""),"endkey"in r&&"string"!=typeof r.endkey&&(r.limit=0)),"key"in r&&"string"!=typeof r.key&&(r.limit=0),n.allDocs(r).then((function(n){return n.rows=n.rows.filter((function(n){return!/^_design\//.test(n.id)})),n}))}(n,u);var t,r=(t=o).ddoc.substring(8)+"/"+t.name;return Ei(n).query.call(n,r,u)})).then((function(n){!1===u.inclusive_start&&(n.rows=function(n,t,r){for(var e=r.def.fields,i=0,o=n.length;i<o;i++){var u=xi(n[i].doc,r);if(1===e.length)u=u[0];else for(;u.length>t.length;)u.pop();if(Math.abs(ke(u,t))>0)break}return i>0?n.slice(i):n}(n.rows,u.startkey,o)),i.inMemoryFields.length&&(n.rows=function(n,t,r){if(n=n.filter((function(n){return si(n.doc,t.selector,r)})),t.sort){var e=function(n){function t(t){return n.map((function(n){var r=ii(fi(n));return ti(t,r)}))}return function(n,r){var e=ke(t(n.doc),t(r.doc));return 0!==e?e:ei(n.doc._id,r.doc._id)}}(t.sort);n=n.sort(e),"string"!=typeof t.sort[0]&&"desc"===ci(t.sort[0])&&(n=n.reverse())}if("limit"in t||"skip"in t){var i=t.skip||0;n=n.slice(i,("limit"in t?t.limit:n.length)+i)}return n}(n.rows,t,i.inMemoryFields));var r={docs:n.rows.map((function(n){var r=n.doc;return t.fields?function(n,t){for(var r={},e=0,i=t.length;e<i;e++){var o=ii(t[e]),u=ti(n,o);void 0!==u&&ri(r,o,u)}return r}(r,t.fields):r}))};return o.defaultUsed&&(r.warning="no matching index found, create an index to optimize query time"),r})))}))}var Li=Oi((function(n,t){var r,e=xe((t=pi(t)).index);function i(){return r||(r=Se(JSON.stringify(t)))}t.index=Bi(t.index),function(n){var t=n.fields.filter((function(n){return"asc"===ci(n)}));if(0!==t.length&&t.length!==n.fields.length)throw new Error("unsupported mixed sorting")}(t.index);var o=t.name||"idx-"+i(),u=t.ddoc||"idx-"+i(),f="_design/"+u,c=!1,a=!1;return n.constructor.emit("debug",["find","creating index",f]),Re(n,f,(function(n){return n._rev&&"query"!==n.language&&(c=!0),n.language="query",n.views=n.views||{},!(a=!!n.views[o])&&(n.views[o]={map:{fields:qi(t.index.fields)},reduce:"_count",options:{def:e}},n)})).then((function(){if(c)throw new Error('invalid language for ddoc with id "'+f+'" (should be "query")')})).then((function(){var t=u+"/"+o;return Ei(n).query.call(n,t,{limit:0,reduce:!1}).then((function(){return{id:f,name:o,result:a?"exists":"created"}}))}))})),Gi=Oi(Ki),Wi=Oi((function(n,t){return Ki(n,t,!0).then((function(r){return{dbname:n.name,index:r.index,selector:t.selector,range:{start_key:r.queryOpts.startkey,end_key:r.queryOpts.endkey},opts:{use_index:t.use_index||[],bookmark:"nil",limit:t.limit,skip:t.skip,sort:t.sort||{},fields:t.fields,conflicts:!1,r:[49]},limit:t.limit,skip:t.skip||0,fields:t.fields}}))})),Zi=Oi(Di),Qi=Oi((function(n,t){if(!t.ddoc)throw new Error("you must supply an index.ddoc when deleting");if(!t.name)throw new Error("you must supply an index.name when deleting");var r=t.ddoc,e=t.name;return Re(n,r,(function(n){return 1===Object.keys(n.views).length&&n.views[e]?{_id:r,_deleted:!0}:(delete n.views[e],n)})).then((function(){return Ei(n).viewCleanup.apply(n)})).then((function(){return{ok:!0}}))})),Hi={};Hi.createIndex=De((function(n,t){if("object"!=typeof n)return t(new Error("you must provide an index to create"));(Je(this)?wi:Li)(this,n,t)})),Hi.find=De((function(n,t){if(void 0===t&&(t=n,n=void 0),"object"!=typeof n)return t(new Error("you must provide search parameters to find()"));(Je(this)?mi:Gi)(this,n,t)})),Hi.explain=De((function(n,t){if(void 0===t&&(t=n,n=void 0),"object"!=typeof n)return t(new Error("you must provide search parameters to explain()"));(Je(this)?_i:Wi)(this,n,t)})),Hi.getIndexes=De((function(n){(Je(this)?gi:Zi)(this,n)})),Hi.deleteIndex=De((function(n,t){if("object"!=typeof n)return t(new Error("you must provide an index to delete"));(Je(this)?ki:Qi)(this,n,t)})),yt.plugin(Hi);class Yi{getDb(n){return new yt(n,{auto_compaction:!0})}upsertDoc(n){return new Promise((t,r)=>{if(!n||!("type"in n)||!n.type){const n="ZeaWcDataConnector: Data must have a type property";console.error(n),t(n)}const e=this.getDb(n.type),i=()=>{e.put(n).then((function(n){t(n)})).catch(n=>{r(n)})};n._id?e.get(n._id).then(t=>{n=Object.assign(Object.assign({},t),n),i()}).catch(()=>{i()}):(n._id=`${n.type}|${(new Date).getTime()}`,i())})}getDoc(n){return new Promise(t=>{if(!n){const n="ZeaWcDataConnector: Id must be provided";console.error(n),t(n)}const r=n.split("|",0);this.getDb(r).get(n).then(n=>{t(n)}).catch((function(n){console.error(n),t(n)}))})}deleteDoc(n){return new Promise((t,r)=>{if(!n){const n="ZeaWcDataConnector: Id to delete must be provided";console.error(n),t(n)}const e=n.split("|")[0];this.getDb(e).get(n).then(n=>{n._deleted=!0,this.upsertDoc(n).then(()=>{t(n)}).catch((function(n){console.error(n),r(n)}))}).catch((function(n){console.error(n),r(n)}))})}getDocs(n){return new Promise((t,r)=>{if(!(n=Object.assign(Object.assign({},{limit:10,skip:0}),n)).type){const n="ZeaWcDataConnector: Type must be provided";console.error(n),t(n)}this.getDb(n.type).find({selector:{},limit:n.limit,skip:n.skip}).then((function(n){t(n)})).catch((function(n){r(n)}))})}destroyDb(n){return new Promise((t,r)=>{this.getDb(n).destroy().then(()=>{t()}).catch(n=>{r(n)})})}}export{Yi as Z}