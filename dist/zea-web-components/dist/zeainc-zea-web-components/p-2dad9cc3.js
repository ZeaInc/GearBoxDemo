import{s as t,e as s}from"./p-36104b6a.js";const i={JOIN_ROOM:"join-room",PING_ROOM:"ping-room",LEAVE_ROOM:"leave-room"};class e{constructor(t,s){this.userData=t,this.socketUrl=s,this.users={},this.userStreams={},this.callbacks={},this.envIsBrowser="undefined"!=typeof window}stopCamera(t=!0){this.stream&&(this.stream.getVideoTracks()[0].enabled=!1,t&&this.pub(e.actions.USER_VIDEO_STOPPED,{}))}startCamera(t=!0){this.stream&&(this.stream.getVideoTracks()[0].enabled=!0,t&&this.pub(e.actions.USER_VIDEO_STARTED,{}))}muteAudio(t=!0){this.stream&&(this.stream.getAudioTracks()[0].enabled=!1,t&&this.pub(e.actions.USER_VIDEO_STOPPED,{}))}unmuteAudio(t=!0){this.stream&&(this.stream.getAudioTracks()[0].enabled=!0,t&&this.pub(e.actions.USER_AUDIO_STARTED,{}))}getVideoStream(t){return this.userStreams[t]}setVideoStream(t,s){if(this.userStreams[s])return;const i=document.createElement("video");i.srcObject=t,this.userStreams[s]=i,i.onloadedmetadata=()=>{i.play()},document.body.appendChild(i)}static concatFullRoomId(t,s,i){return t+(s||"_ALL_FILES_")+(i||"_ALL_ROOMS_")}isJoiningTheSameRoom(t,s,i){return this.fullRoomId===e.concatFullRoomId(t,s,i)}joinRoom(h,o,r){this.projectId=h,this.fileId=o,this.roomId=r,this.fullRoomId=e.concatFullRoomId(this.projectId,this.fileId,this.roomId),this.leaveRoom(),this.socket=t(this.socketUrl,{"sync disconnect on unload":!0,query:`userId=${this.userData.id}&roomId=${this.fullRoomId}`}),s(t.Manager)(this.socket),this.socket.on("*",t=>{const[s,e]=t.data;s in i||this._emit(s,e.payload,e.userId)}),this.envIsBrowser&&window.addEventListener("beforeunload",()=>{this.leaveRoom()}),this.pub(i.JOIN_ROOM),this.socket.on(i.JOIN_ROOM,t=>{console.info(i.JOIN_ROOM+":",t),this._addUserIfNew(t.userData),this.pub(i.PING_ROOM)}),this.socket.on(i.LEAVE_ROOM,t=>{console.info(i.LEAVE_ROOM+":",t);const s=t.userData,h=s.id;if(h in this.users)return delete this.users[h],void this._emit(e.actions.USER_LEFT,s);console.warn("Outgoing user was not found in room.")}),this.socket.on(i.PING_ROOM,t=>{console.info(i.PING_ROOM+":",t),this._addUserIfNew(t.userData)})}_prepareMediaStream(){return this.__streamPromise||(this.__streamPromise=new window.Promise((t,s)=>{this.stream?t():navigator.mediaDevices.getUserMedia({audio:!0,video:{width:400,height:300}}).then(s=>{this.stream=s,this.stopCamera(!1),this.muteAudio(!1),t()}).catch(t=>{s(t)})})),this.__streamPromise}leaveRoom(){this._emit(e.actions.LEFT_ROOM),this.users={},this.socket&&this.pub(i.LEAVE_ROOM,void 0,()=>{this.socket.close()})}_addUserIfNew(t){t.id in this.users||(this.users[t.id]=t,this._emit(e.actions.USER_JOINED,t))}createRoom(){return this.roomId=shortid.generate(),this.joinRoom(this.projectId,this.fileId,this.roomId),this.envIsBrowser&&window.history.pushState(null,null,`?project-id=${this.projectId}&file-id=${this.fileId}&room-id=${this.roomId}`),this.roomId}getUsers(){return this.users}getUser(t){return this.users[t]}pub(t,s,i){if(!t)throw new Error("Missing messageType");this.socket.emit(t,{userData:this.userData,userId:this.userData.id,payload:s},i)}_emit(t,s,i){const e=this.callbacks[t];e&&e.forEach(t=>t(s,i))}sub(t,s){if(!t)throw new Error("Missing messageType");if(!s)throw new Error("Missing callback");return this.callbacks[t]=this.callbacks[t]||[],this.callbacks[t].push(s),()=>{this.callbacks[t].splice(this.callbacks[t].indexOf(s),1)}}}e.actions={USER_JOINED:"user-joined",USER_VIDEO_STARTED:"user-video-started",USER_VIDEO_STOPPED:"user-video-stopped",USER_AUDIO_STARTED:"user-audio-started",USER_AUDIO_STOPPED:"user-audio-stopped",USER_LEFT:"user-left",LEFT_ROOM:"left-room",TEXT_MESSAGE:"text-message",POSE_CHANGED:"pose-message",COMMAND_ADDED:"command-added",COMMAND_UPDATED:"command-updated",FILE_WITH_PROGRESS:"file-with-progress"};class h{static setSocketURL(t){this.socketUrl=t}static getInstance(t,s,i,h){if(!this.session){if(!this.socketUrl)throw new Error("Missing #socketUrl. Call #setSocketURL first.");this.session=new e(t,this.socketUrl)}return this.session.isJoiningTheSameRoom(s,i,h)||this.session.joinRoom(s,i,h),this.session}static getCurrentSession(){return this.session}}export{e as i,h as o}